jn.define("disk/dialogs/external-link",((e,t,s)=>{const{BaseDialog:i}=e("disk/dialogs/base");const{Loc:n}=e("loc");const{Indent:a,Color:o,Component:l}=e("tokens");const{showToast:d}=e("toast");const{CardList:r}=e("ui-system/layout/card-list");const{Card:c}=e("ui-system/layout/card");const{SettingSelector:h}=e("ui-system/blocks/setting-selector");const{SwitcherSize:u}=e("ui-system/blocks/switcher");const{Text3:g}=e("ui-system/typography/text");const{IconView:b,Icon:k}=e("ui-system/blocks/icon");const{SecuritySettingsDialog:I}=e("disk/dialogs/external-link/security-settings");const{getDeathTimeMessage:T}=e("disk/dialogs/external-link/death-time-util");const{selectById:E}=e("disk/statemanager/redux/slices/files/selector");const{setExternalLink:L}=e("disk/statemanager/redux/slices/files");const _=e("statemanager/redux/store");class m extends i{constructor(e){super(e);this.objectId=Number(e.objectId)||null;this.object=E(_.getState(),this.objectId)??{};this.state={pending:false,linkEnabled:Boolean(this.linkObject),deathTime:this.linkObject?.deathTime??null,hasPassword:this.linkObject?.hasPassword,canEditDocument:this.linkObject?.canEditDocument,password:null}}get linkObject(){return this.object?.links?.external??null}get isEditAvailable(){return this.linkObject?.availableEdit??null}getTestId(e){return`external-link-dialog-${e}`}isButtonDisabled(){return!this.state.linkEnabled}getButtonText(){return n.getMessage("M_DISK_EXTERNAL_LINK_DIALOG_SAVE_BUTTON")}save=()=>{if(this.state.pending){return}Application.copyToClipboard(this.object.links.external.link);d({message:n.getMessage("M_DISK_EXTERNAL_LINK_DIALOG_COPY_TOAST_MESSAGE"),icon:k.COPY});this.layoutWidget.close()};getStartingLayoutHeight(){const e=44;const t=48+l.cardPaddingT.toNumber()+l.cardPaddingB.toNumber();const s=24+l.cardPaddingT.toNumber()+l.cardPaddingB.toNumber();const i=42+a.XL2.toNumber()*2;return e+t+l.cardListGap.getValue()+s+i}getTitleParams(){return{text:n.getMessage("M_DISK_EXTERNAL_LINK_DIALOG_TITLE"),type:"dialog"}}static async open(e,t){super.open(e,t)}renderContent(){return r({divided:true},this.renderTurnLinkCard(),this.renderSecurityCard())}generateLink=()=>{this.setState({pending:true,linkEnabled:true},(()=>{BX.ajax.runAction("diskmobile.ExternalLink.generate",this.prepareGenerateLinkConfig()).then(this.onGenerateLinkFulfilled).catch(this.onGenerateLinkRejected)}))};prepareGenerateLinkConfig=()=>{const e=e=>e?e/1e3:null;const t=e=>e?e*1e3:null;const s=this.state.deathTime?new Date(Date.now()+t(this.state.deathTime)).getTime():null;return{data:{objectId:this.objectId,newPassword:this.state.hasPassword?this.state.password:null,deathTime:e(s),allowEditDocument:this.state.canEditDocument?1:0}}};onGenerateLinkFulfilled=e=>{const t=e.data.externalLink;const s={...t,deathTime:t?.deathTime?(new Date(t.deathTime)-Date.now())/1e3:null};this.saveLinkToStore(s);this.setState({pending:false})};onGenerateLinkRejected=e=>{console.error(e);this.setState({linkEnabled:false,pending:false})};disableLink=()=>{this.setState({pending:true,linkEnabled:false},(()=>{BX.ajax.runAction("disk.api.commonActions.disableExternalLink",{data:{objectId:this.objectId}}).then(this.onDisableFulfilled).catch(this.onDisableRejected)}))};onDisableFulfilled=()=>{this.saveLinkToStore(null);this.setState({pending:false})};onDisableRejected=e=>{console.error(e);this.setState({linkEnabled:true,pending:false})};saveLinkToStore=e=>{_.dispatch(L({objectId:this.objectId,external:e}));this.object=E(_.getState(),this.objectId)??{}};renderTurnLinkCard(){const e=T(this.state.deathTime);const t=` \xb7 ${this.state.hasPassword?n.getMessage("M_DISK_EXTERNAL_LINK_DIALOG_WITH_PASSWORD"):n.getMessage("M_DISK_EXTERNAL_LINK_DIALOG_WITHOUT_PASSWORD")}`;let s=` \xb7 ${this.state.canEditDocument?n.getMessage("M_DISK_EXTERNAL_LINK_DIALOG_WITH_EDIT"):n.getMessage("M_DISK_EXTERNAL_LINK_DIALOG_WITHOUT_EDIT")}`;if(!this.isEditAvailable){s=""}const i=`${e}${t}${s}`;return c({testId:this.getTestId("link-card"),accent:this.state.linkEnabled,border:true},h({testId:this.getTestId("link-selector"),checked:this.state.linkEnabled,title:n.getMessage("M_DISK_EXTERNAL_LINK_DIALOG_ENABLE_LINK"),subtitle:i,switcherSize:u.L,onClick:()=>{if(this.state.linkEnabled){this.disableLink()}else{this.generateLink()}}}))}openSecuritySettings=()=>{I.open({objectId:this.objectId,deathTime:this.state.deathTime,hasPassword:this.state.hasPassword,availableEdit:this.state.availableEdit,canEditDocument:this.state.canEditDocument,password:this.state.password,onSave:({deathTime:e,hasPassword:t,canEditDocument:s,password:i})=>{this.setState({deathTime:e,hasPassword:t,canEditDocument:s,password:i});if(this.state.linkEnabled){this.saveLinkToStore({...this.linkObject,deathTime:e,hasPassword:t,canEditDocument:s,password:i})}else{this.generateLink()}}},this.layoutWidget)};renderSecurityCard(){return c({onClick:this.openSecuritySettings,testId:this.getTestId("security-settings"),border:true},View({style:{flexDirection:"row",justifyContent:"space-between"}},g({text:n.getMessage("M_DISK_EXTERNAL_LINK_DIALOG_SECURITY"),color:o.base1}),b({icon:k.CHEVRON_TO_THE_RIGHT,size:24,color:o.base3})))}}s.exports={ExternalLinkDialog:m}}));
//# sourceMappingURL=extension.map.js