<? namespace Bitrix\Main\Security\W;$GLOBALS['____63015954']= array(base64_decode('dGltZQ=='),base64_decode('dGl'.'tZQ=='),base64_decode('an'.'Nvbl9kZW'.'NvZGU='),base64_decode('YX'.'Jy'.'YX'.'lfbWV'.'yZ2U='),base64_decode('a'.'m9'.'p'.'bg=='),base64_decode('a'.'m'.'9pbg'.'=='),base64_decode('am9pbg=='),base64_decode('YXJyYXlf'.'c'.'G9w'),base64_decode('YXJy'.'YX'.'lfc2hpZn'.'Q='),base64_decode('Y'.'XJyYX'.'lf'.'c'.'2h'.'p'.'ZnQ='),base64_decode(''.'YXJy'.'YXl'.'fc2hpZn'.'Q='),base64_decode('YXJy'.'YXlfc2hpZnQ'.'='),base64_decode('Y'.'XJy'.'YXl'.'fbW'.'VyZ'.'2U='),base64_decode('aX'.'NfYXJy'.'YXk='),base64_decode('YXJ'.'y'.'YXl'.'f'.'bWVy'.'Z2U='),base64_decode('aW'.'5fY'.'XJyY'.'Xk='),base64_decode('aW5fYXJyY'.'X'.'k'.'='),base64_decode('a'.'W5fYXJyYXk='),base64_decode(''.'aW5'.'fYXJ'.'yY'.'Xk='),base64_decode(''.'aW5fYXJyYX'.'k='),base64_decode('d'.'G'.'lt'.'ZQ=='),base64_decode('dG'.'ltZQ=='),base64_decode('YXJyYX'.'lfbW'.'Fw'),base64_decode('Z2V0X2'.'xvY'.'WRlZF9le'.'HRl'.'bnNpb25z'),base64_decode('anNvbl9lbmNvZGU='),base64_decode('an'.'N'.'v'.'bl9'.'lbmN'.'v'.'ZG'.'U='),base64_decode('cGhwd'.'mVyc2lvb'.'g=='),base64_decode(''.'a'.'nNvbl9'.'lbm'.'NvZG'.'U='),base64_decode('am9pb'.'g=='));if(!function_exists(__NAMESPACE__.'\\___533511548')){function ___533511548($_1087303648){static $_416095443= false; if($_416095443 == false) $_416095443=array('V1d'.'BT'.'ExfTE9'.'D'.'Sw'.'='.'=','c2VjdXJp'.'dHk=',''.'REFUQQ==','eyI=',''.'V1dBTE'.'xfTE9DSw==','c2VjdXJpdHk=','U'.'0VDV'.'VJJVFl'.'fV'.'1dBTExfRVhD'.'RVBUS'.'U9O','RkF'.'JTF9D'.'S'.'EV'.'DS'.'0lOR'.'w==','Q2FuIG'.'5vdC'.'BleGVjdXRlIHd3YWxs'.'IHJ1b'.'GV'.'z'.'O'.'i'.'A'.'=','IFRyYWNlOiA=','U'.'kVRVU'.'VT'.'VF9VU'.'kk=','a'.'2V'.'5c'.'w='.'=','dm'.'FsdWVz','U'.'0VDVVJJV'.'FlfV1'.'d'.'BTEx'.'f'.'TU9ESUZZ','Lg==',''.'U0V'.'DVV'.'JJ'.'V'.'Flf'.'V1'.'dBTExfVU5TRVQ=','Lg'.'==',''.'U0VDVV'.'J'.'JVFl'.'fV'.'1d'.'BTEx'.'fR'.'V'.'hJVA==','Lg==','Z2'.'xv'.'YmFs',''.'a2'.'V'.'5c'.'w==','dmFsdWV'.'z','Z'.'2V'.'0','Z'.'2V0','cG9'.'zdA==','c'.'G9zdA'.'==','Y29va2ll','Y29'.'va2ll','cmVxdW'.'Vz'.'dA==','cmVx'.'dWVzdA==','Z2xvYmFs','Z2xv'.'Y'.'mFs','bWFpbl9zZWM=','V1dB'.'TExf'.'QUN'.'UVUFMSVp'.'F'.'X1JV'.'TEVT','dg==','d'.'mVyc2lv'.'bg==','aQ='.'=',''.'aX'.'NJ'.'b'.'nN'.'0YWxsZ'.'WQ'.'=','dg='.'=',''.'aW5'.'p',''.'bW9kdWx'.'lcw==','bGljZW5'.'z'.'ZQ==','cGhw','dg==','Z'.'Xh0','c2Vj'.'d'.'XJ'.'pdH'.'k=',''.'Z'.'G'.'I'.'=','dHl'.'wZQ==','ZGI=','dmV'.'yc2'.'lvbg==','Z'.'G'.'I=','dHl'.'wZQ==','ZGI=','dHlwZQ==','d'.'mVy'.'c2lvb'.'g==','ZGI'.'=','dmV'.'yc2'.'lvbg==','Z'.'W52aX'.'Jvbm1lbnQ=','d'.'m1fdmV'.'yc2'.'lv'.'bg==','dm0=',''.'d'.'g==',''.'Z'.'W52aX'.'Jvbm1l'.'bnQ=','dm1'.'fdmVyc2'.'lvbg==','c2'.'9'.'ja2'.'V0VG'.'l'.'tZW91dA==','c3R'.'yZWFtVGl'.'tZW91dA==',''.'KCc=','ZG'.'F0'.'YQ'.'==','JywgJw='.'=','b'.'W9kdW'.'xl',''.'JywgJw='.'=','bW9kd'.'Wxl'.'X3Zlcn'.'N'.'pb24=','Jyk=','LCA=',''.'U0VD'.'V'.'V'.'JJVFlf'.'V1dBTExf'.'RVh'.'DR'.'VBUS'.'U9O',''.'b'.'W'.'Fpbg='.'=','R'.'kFJTF9SRUZSRVNISU'.'5H',''.'Q2'.'FuIG5vdC'.'B'.'y'.'ZWZy'.'ZXNoIHd3YWxs'.'IHJ1bGVz'.'OiA=',''.'IFRyYWNlO'.'i'.'A=','ZG'.'F0YQ'.'='.'=','eyI=','L'.'S0tLS1CR'.'UdJTiBQVUJ'.'MSUMgS0VZLS0tLS0=','Ck1'.'JSUJJakFO'.'Qmd'.'rcWhraUc5dzBCQVFF'.'Rk'.'F'.'BT0'.'NBU'.'ThBT'.'UlJQkNnS0NBUUVBcThRRTBIam'.'1IS'.'lVT'.'dF'.'dWN'.'m4we'.'m'.'EKUlZvTH'.'gwMkt6YmZ'.'yY'.'lMv'.'UDZzV2F4VHp3OF'.'NlR'.'1R0Yl'.'RDT3JwSGk1UU'.'Y2T'.'1J5'.'a'.'l'.'ovWHh6L'.'0tM'.'VTFHYm9mOUNaMwo'.'0ejdTa'.'3'.'FV'.'d'.'DY2'.'aWJY'.'dk'.'9GQ'.'n'.'g'.'0ZncvQVBQUk'.'dEcXR'.'tMG5EM2'.'ZnR3'.'N1'.'M'.'1JlU'.'G'.'d3Mjlp'.'OCt2bTdtdE'.'JL'.'SlVZbDRy'.'Cl'.'Zw'.'YjZzZlpFV'.'DlLRWI2VD'.'FIRFltRXZjMWhxL2l'.'pdXl'.'4THJaWm'.'k1U'.'TZVZmY0VUV2VEk'.'rNj'.'hzc'.'0'.'ZSa'.'1E'.'rb3dU'.'Un'.'kKZ'.'U9J'.'TWJGaE0vVVRtZ'.'lZZYlRS'.'R'.'nk'.'yb1VR'.'OFdNemEy'.'bk'.'o'.'1'.'U2'.'FoemkxVUt'.'PMWp'.'BalhUUFJye'.'mM'.'3QWp1NjM5ajFP'.'M'.'ApwcHF'.'mbT'.'V4Z1ds'.'RkFKa'.'0hRVGdiZGQ1QVdxRE'.'ZRa3Q5'.'S'.'EtrW'.'StU'.'bmZCTEdWTXZWeVB'.'3VEhOV1'.'FZ'.'QXc0'.'eH'.'B'.'nL'.'3dBClp3SURBU'.'UFC'.'Ci'.'0'.'tLS0tR'.'U5EIFB'.'VQkx'.'J'.'QyBLRVk'.'t'.'LS0tLQ==');return base64_decode($_416095443[$_1087303648]);}}; use Bitrix\Main\Application; use Bitrix\Main\Config\Option; use Bitrix\Main\Data\Cache; use Bitrix\Main\Loader; use Bitrix\Main\ModuleManager; use Bitrix\Main\Security\PublicKeyCipher; use Bitrix\Main\SystemException; use Bitrix\Main\Web\HttpClient; use Bitrix\Main\Web\Json; use Bitrix\Main\Security\W\Rules\Rule; use Bitrix\Main\Security\W\Rules\Results\RuleAction; use Bitrix\Main\Security\W\Rules\Results\RuleResult; use Bitrix\Main\Security\W\Rules\Results\CheckResult; use Bitrix\Main\Security\W\Rules\Results\ModifyResult; use Bitrix\Main\Type\ArrayHelper; use Bitrix\Main\Security\W\Rules\RuleRecordTable; use Bitrix\Main\License\UrlProvider; use CSecuritySystemInformation; use ReflectionExtension; class WWall{ const CACHE_RULES_TTL= 10800; protected $_1546413654= true; public function handle(){ try{  $_643929155= RuleRecordTable::getList([ 'cache' =>['ttl' => 3600* 24* 7]])->fetchAll(); if(empty($_643929155)){ return;}  $_1887912453= Cache::createInstance(); $_2061728710= false; if($_1887912453->initCache(static::CACHE_RULES_TTL, 'WWALL_LOCK', 'security')){ $_2009743537= $_1887912453->getVars(); if($GLOBALS['____63015954'][0]()- $_2009743537> round(0+4+4+4+4+4)){  $_2073796765= Application::getConnection(); $_195809847= RuleRecordTable::getTableName(); $_2073796765->truncateTable($_195809847); RuleRecordTable::cleanCache(); $_1887912453->clean(___533511548(0), ___533511548(1));}} elseif($_1887912453->startDataCache()){  $_1887912453->endDataCache($GLOBALS['____63015954'][1]()); $_2061728710= true;} foreach($_643929155 as $_752514449){ $_2010556612= new PublicKeyCipher; $_266431272= $_2010556612->decrypt($_752514449[___533511548(2)], static::__268626806()); if(!str_starts_with($_266431272, ___533511548(3))){ continue;} $_1762964838= $GLOBALS['____63015954'][2]($_266431272, true); if(!empty($_1762964838)){ $_295731263= Rule::make($_1762964838); $_1806813893= $this->handleRule($_295731263); $this->applyHandlingResults($_1806813893);}}  if($_2061728710){ $_1887912453->clean(___533511548(4), ___533511548(5));}} catch(\Throwable $_220980822){ $this->logEvent( ___533511548(6), ___533511548(7), ___533511548(8). $_220980822->getMessage(). ___533511548(9). $_220980822->getTraceAsString());}}  public function handleRule(Rule $_295731263): array{ $_1806813893=[]; if($_295731263->matchPath($_SERVER[___533511548(10)])){  $_533260636= $this->getContextElements($_295731263->getContext()); foreach($_533260636 as $_550776420 => &$_66396821){ $_1806813893= $GLOBALS['____63015954'][3]($_1806813893, $this->recursiveContextKeyHandle($_550776420, $_66396821,[], $_295731263));}} return $_1806813893;}  public function applyHandlingResults(array $_1806813893){ $_533260636= $this->getContextElements([ 'get', 'post', 'cookie', 'request', 'global']); foreach($_1806813893 as $_1294608474){ $_66396821=& $_533260636[$_1294608474->getContextName()]; $_663558715= $_1294608474->getRuleResult(); $_295731263= $_1294608474->getRule(); if($_663558715 instanceof ModifyResult){ if($_295731263->getProcess() === ___533511548(11)){  static::rewriteContextKey( $_1294608474->getContextName(), $_66396821, $_1294608474->getContextKey(), $_663558715->getCleanValue());} elseif($_295731263->getProcess() === ___533511548(12)){ static::rewriteContextValue( $_1294608474->getContextName(), $_66396821, $_1294608474->getContextKey(), $_663558715->getCleanValue());} $this->logEvent( ___533511548(13), $_1294608474->getContextName(), $GLOBALS['____63015954'][4](___533511548(14), $_1294608474->getContextKey()));} elseif($_663558715 instanceof CheckResult &&!$_663558715->isSuccess()){ if($_663558715->getAction() === RuleAction::UNSET){ static::unsetContextValue( $_1294608474->getContextName(), $_66396821, $_1294608474->getContextKey(),); $this->logEvent( ___533511548(15), $_1294608474->getContextName(), $GLOBALS['____63015954'][5](___533511548(16), $_1294608474->getContextKey()));} elseif($_663558715->getAction() === RuleAction::EXIT){ $this->logEvent( ___533511548(17), $_1294608474->getContextName(), $GLOBALS['____63015954'][6](___533511548(18), $_1294608474->getContextKey())); exit;}}}} public function disableEventLogging(){ $this->_1546413654= false;} protected function rewriteContextKey($_550776420, &$_66396821, $_1448020953, $_960752296){ $_600777430= $_1448020953;  $GLOBALS['____63015954'][7]($_600777430); $_600777430[]= $_960752296; if($_550776420 === ___533511548(19)){ $_1417375920= $GLOBALS['____63015954'][8]($_1448020953); $GLOBALS['____63015954'][9]($_600777430); if(empty($_1448020953)){ $GLOBALS[$_960752296]= $GLOBALS[$_1417375920]; unset($GLOBALS[$_1417375920]);} else{ $_66396821=& $GLOBALS[$_1417375920]; $_884958645= ArrayHelper::getByNestedKey($_66396821, $_1448020953);  ArrayHelper::setByNestedKey($_66396821, $_600777430, $_884958645);  ArrayHelper::unsetByNestedKey($_66396821, $_1448020953);}} else{ $_884958645= ArrayHelper::getByNestedKey($_66396821, $_1448020953);  ArrayHelper::setByNestedKey($_66396821, $_600777430, $_884958645);  ArrayHelper::unsetByNestedKey($_66396821, $_1448020953);}} protected function rewriteContextValue($_550776420, &$_66396821, $_1139576634, $_884958645){ if($_550776420 === 'global'){ $_1417375920= $GLOBALS['____63015954'][10]($_1139576634); if(empty($_1139576634)){ $GLOBALS[$_1417375920]= $_884958645;} else{ $_66396821=& $GLOBALS[$_1417375920]; ArrayHelper::setByNestedKey($_66396821, $_1139576634, $_884958645);}} else{  ArrayHelper::setByNestedKey($_66396821, $_1139576634, $_884958645);}} protected function unsetContextValue($_550776420, &$_66396821, $_1139576634){ if($_550776420 === 'global'){ $_1417375920= $GLOBALS['____63015954'][11]($_1139576634); if(empty($_1139576634)){ unset($GLOBALS[$_1417375920]);} else{ $_66396821=& $GLOBALS[$_1417375920]; ArrayHelper::unsetByNestedKey($_66396821, $_1139576634);}} else{ ArrayHelper::unsetByNestedKey($_66396821, $_1139576634);}}  protected function recursiveContextKeyHandle(string $_550776420, array &$_66396821, array $_88652488, Rule $_295731263): array{  $_1806813893=[]; foreach($_66396821 as $_1696941890 => $_884958645){ $_1139576634= $GLOBALS['____63015954'][12]($_88652488,[$_1696941890]); if($_295731263->matchKey($_1139576634)){  if($_295731263->getProcess() === ___533511548(20)){ $_663558715= $_295731263->evaluate($_1696941890);} elseif($_295731263->getProcess() === ___533511548(21)){ $_663558715= $_295731263->evaluateValue($_884958645);}  if(!empty($_663558715) && $_663558715 instanceof RuleResult){ $_1806813893[]= new HandlingResult($_550776420, $_1139576634, $_663558715, $_295731263);}}  if($GLOBALS['____63015954'][13]($_884958645)){ $_1806813893= $GLOBALS['____63015954'][14]($_1806813893, $this->recursiveContextKeyHandle( $_550776420, $_66396821[$_1696941890], $_1139576634, $_295731263));}} return $_1806813893;} protected function getContextElements(array $_255440589){ $_61643336=[]; if($GLOBALS['____63015954'][15](___533511548(22), $_255440589, true)){ $_61643336[___533511548(23)]= &$_GET;} if($GLOBALS['____63015954'][16](___533511548(24), $_255440589, true)){ $_61643336[___533511548(25)]= &$_POST;} if($GLOBALS['____63015954'][17](___533511548(26), $_255440589, true)){ $_61643336[___533511548(27)]= &$_COOKIE;} if($GLOBALS['____63015954'][18](___533511548(28), $_255440589, true)){ $_61643336[___533511548(29)]= &$_REQUEST;} if($GLOBALS['____63015954'][19](___533511548(30), $_255440589, true)){ $_61643336[___533511548(31)]= $GLOBALS;} return $_61643336;} public static function refreshRules(){ try{ $_1285863138= Option::get('main_sec', 'WWALL_ACTUALIZE_RULES', 0); if(($GLOBALS['____63015954'][20]()- $_1285863138)< static::CACHE_RULES_TTL){ return;} Option::set(___533511548(32), ___533511548(33), $GLOBALS['____63015954'][21]()); $_1162328470= null;  $_524145844= $GLOBALS['____63015954'][22](function($_213211700){ return[___533511548(34) => $_213211700[___533511548(35)], ___533511548(36) => (int) $_213211700[___533511548(37)]];}, ModuleManager::getModulesFromDisk());  $_523530869=[]; foreach($GLOBALS['____63015954'][23]() as $_363641900){ $_665361937= new ReflectionExtension($_363641900); $_523530869[$_363641900]=[ ___533511548(38) => $_665361937->getVersion(), ___533511548(39) => $_665361937->getINIEntries()];} $_1817052130=[ ___533511548(40) => $GLOBALS['____63015954'][24]($_524145844), ___533511548(41) => Application::getInstance()->getLicense()->getHashLicenseKey(), ___533511548(42) => $GLOBALS['____63015954'][25]([ ___533511548(43) => $GLOBALS['____63015954'][26](), ___533511548(44) => $_523530869])]; if(Loader::includeModule(___533511548(45))){ $_1792568394= CSecuritySystemInformation::getSystemInformation(); if(isset($_1792568394[___533511548(46)][___533511548(47)]) && isset($_1792568394[___533511548(48)][___533511548(49)])){ $_1817052130[___533511548(50)]=[ ___533511548(51) => $_1792568394[___533511548(52)][___533511548(53)], ___533511548(54) => $_1792568394[___533511548(55)][___533511548(56)]];} if(isset($_1792568394[___533511548(57)][___533511548(58)])){ $_1817052130[___533511548(59)]=[___533511548(60) => $_1792568394[___533511548(61)][___533511548(62)]];}}  $_1151226999= new HttpClient([ ___533511548(63) => round(0+2.5+2.5), ___533511548(64) => round(0+5)]); $_946847528=(new UrlProvider())->getTechDomain(); $_90131713="https://wwall.{$_946847528}/rules.php"; $_407222159= $_1151226999->post($_90131713, $_1817052130); if($_1151226999->getStatus() == round(0+50+50+50+50) &&!empty($_407222159)){ $_1162328470= Json::decode($_407222159);}  if($_1162328470 !== null){ $_2073796765= Application::getConnection(); $_195809847= RuleRecordTable::getTableName(); if(!empty($_1162328470)){ foreach($_1162328470 as $_1098001499){ if(!static::checkRuleSign($_1098001499)){ throw new SystemException('Invalid sign for rule '.$GLOBALS['____63015954'][27]($_1098001499));}}}  $_2073796765->truncateTable($_195809847);  if(!empty($_1162328470)){ $_218156562=[]; foreach($_1162328470 as $_1098001499){ $_218156562[]= ___533511548(65). $_2073796765->getSqlHelper()->forSql($_1098001499[___533511548(66)]). ___533511548(67). $_2073796765->getSqlHelper()->forSql($_1098001499[___533511548(68)]). ___533511548(69). $_2073796765->getSqlHelper()->forSql($_1098001499[___533511548(70)]). ___533511548(71);} $_1296409049= $GLOBALS['____63015954'][28](___533511548(72), $_218156562);  $_2073796765->query("INSERT INTO {$_195809847} (DATA, MODULE, MODULE_VERSION) VALUES {$_1296409049}");  RuleRecordTable::cleanCache();}}} catch(\Throwable $_220980822){ \CEventLog::log( \CEventLog::SEVERITY_SECURITY, ___533511548(73), ___533511548(74), ___533511548(75), ___533511548(76). $_220980822->getMessage(). ___533511548(77). $_220980822->getTraceAsString());}} protected static function checkRuleSign($_295731263){ $_2010556612= new PublicKeyCipher; $_1762964838= $_2010556612->decrypt($_295731263[___533511548(78)], static::__268626806()); return str_starts_with($_1762964838, ___533511548(79));} private static function __268626806(){ $_1787057924= ''; $_1787057924 .= ___533511548(80); $_1787057924 .= ___533511548(81); return $_1787057924;} protected function logEvent($_474242947, $_1381871228, $_38922655){ if($this->_1546413654){ \CEventLog::log( \CEventLog::SEVERITY_SECURITY, $_474242947, 'main', $_1381871228, $_38922655);}}}?>