this.BX=this.BX||{};this.BX.Humanresources=this.BX.Humanresources||{};(function(t,e,n,s,i,o,r,a,c,d,l,u,E,_,h,m,p,T,R,C,M,A,S,N,I,U){"use strict";const g=Object.freeze({HR_DEPARTMENT_CONNECT:"hr-department-connect",HR_DEPARTMENT_DISCONNECT:"hr-department-disconnect",HR_DEPARTMENT_ADAPT_SIBLINGS:"hr-department-adapt-siblings",HR_DEPARTMENT_ADAPT_CONNECTOR_HEIGHT:"hr-department-adapt-connector-height",HR_DEPARTMENT_FOCUS:"hr-department-focus",HR_DEPARTMENT_CONTROL:"hr-department-control",HR_DEPARTMENT_MENU_CLOSE:"hr-department-menu-close",HR_ORG_CHART_CLOSE_BY_ESC:"SidePanel.Slider:onCloseByEsc",HR_ORG_CHART_CLOSE:"SidePanel.Slider:onClose",HR_FIRST_POPUP_SHOW:"HR.company-structure:first-popup-showed",HR_DRAG_DEPARTMENT:"hr-drag-department",HR_DROP_DEPARTMENT:"hr-drop-department",HR_DEPARTMENT_TOGGLE_CONNECTORS:"hr-department-toggle-connectors",HR_DEPARTMENT_SLIDER_ON_MESSAGE:"SidePanel.Slider:onMessage",HR_ENTITY_SHOW_WIZARD:"hr-entity-show-wizard",HR_ENTITY_REMOVE:"hr-entity-remove",HR_PUBLIC_FOCUS_NODE:"HumanResources.CompanyStructure:focusNode",INTRANET_USER_MINIPROFILE_CLOSE:"Intranet.User.MiniProfile:close"});const v=364;const f=Object.freeze({addDepartment:"add-department",addEmployee:"add-employee"});const D={name:"AddButton",components:{RouteActionMenu:u.RouteActionMenu},emits:["addDepartment"],data(){return{actionMenu:{visible:false}}},computed:{MenuOption(){return f}},mounted(){const t=A.PermissionChecker.getInstance();if(!t){return}this.dropdownItems=[{id:f.addDepartment,title:this.loc("HUMANRESOURCES_COMPANY_STRUCTURE_ADD_BUTTON_MENU_ADD_DEPARTMENT_TITLE"),description:this.loc("HUMANRESOURCES_COMPANY_STRUCTURE_ADD_BUTTON_MENU_ADD_DEPARTMENT_DESCR"),bIcon:{name:N.Main.CUBE_PLUS,size:20,color:S.getColorCode("paletteBlue50")},permission:{action:A.PermissionActions.departmentCreate}},{id:f.addEmployee,title:this.loc("HUMANRESOURCES_COMPANY_STRUCTURE_ADD_BUTTON_MENU_ADD_EMPLOYEE_TITLE"),description:this.loc("HUMANRESOURCES_COMPANY_STRUCTURE_ADD_BUTTON_MENU_ADD_EMPLOYEE_DESCR"),bIcon:{name:N.CRM.PERSON_PLUS_2,size:20,color:S.getColorCode("paletteBlue50")},permission:{action:A.PermissionActions.employeeAddToDepartment}}];this.dropdownItems=this.dropdownItems.filter((e=>{if(!e.permission){return false}return t.hasPermissionOfAction(e.permission.action)}))},methods:{loc(t,e={}){return this.$Bitrix.Loc.getMessage(t,e)},addDepartment(){this.$emit("addDepartment")},actionMenuItemClickHandler(t){if(t===f.addDepartment){this.$emit("addDepartment")}}},template:`\n\t\t<div\n\t\t\tclass="ui-btn ui-btn-success ui-btn-round ui-btn-sm humanresources-title-panel__add-button"\n\t\t\tdata-test-id="hr-org-chart_title-panel__add-button"\n\t\t\t@click="addDepartment"\n\t\t>\n\t\t\t{{ loc('HUMANRESOURCES_COMPANY_STRUCTURE_ADD_BUTTON') }}\n\t\t</div>\n\t`};const O={applyData:(t,e,n)=>{const s=T.useChartStore();s.$patch({departments:t,currentDepartments:e,userId:n,searchedUserId:n})},focusDepartment:t=>{const e=T.useChartStore();e.focusedNode=t},searchUserInDepartment:t=>{const e=T.useChartStore();e.searchedUserId=t},moveSubordinatesToParent:t=>{const e=T.useChartStore();const{departments:n,currentDepartments:s}=e;const i=n.get(t);const{parentId:o,entityType:r,children:a=[],userCount:c,heads:d,employees:u=[]}=i;const E=n.get(o);a.forEach((t=>{const e=n.get(t);e.parentId=o}));if(c>0&&r===S.EntityTypes.department){var _,h;const t=new Set([...E.heads,...(_=E.employees)!=null?_:[]].map((t=>t.id)));const e=[...d,...u];const n=e.filter((e=>!t.has(e.id)));for(const t of n){t.role=l.memberRoles.employee}E.userCount+=n.length;E.employees=[...(h=E.employees)!=null?h:[],...n]}E.children=[...E.children,...a];if(s.includes(t)&&r===S.EntityTypes.department){e.changeCurrentDepartment(t,o)}},markDepartmentAsRemoved:t=>{const{departments:e}=T.useChartStore();const n=e.get(t);const{parentId:s}=n;const i=e.get(s);i.children=i.children.filter((e=>e!==t));delete n.parentId;e.set(t,{...n,prevParentId:s})},removeDepartment:t=>{const{departments:e}=T.useChartStore();e.delete(t)},inviteUser:t=>{const{nodeId:e,...n}=t;const{departments:s}=T.useChartStore();const i=s.get(e);if(i.employees){s.set(e,{...i,employees:[...i.employees,{...n}],userCount:i.userCount+1})}},orderDepartments:async(t,e,n,s)=>{const{departments:i}=T.useChartStore();const o=i.get(t);const{parentId:r}=o;const a=i.get(r);const{children:c}=a;const d=c.indexOf(e);const u=c.filter((e=>e!==t));u.splice(d,0,t);i.set(r,{...a,children:u});try{await l.postData("humanresources.api.Structure.Node.changeOrder",{nodeId:t,direction:n,count:s});return true}catch{i.set(r,{...a,children:c});return false}},clearNodesChatLists:t=>{const{departments:e}=T.useChartStore();t.forEach((t=>{const n=e.get(t);e.set(t,{...n,chats:null,channels:null})}))}};const y={name:"search-bar",components:{BIcon:p.BIcon},directives:{focus:{mounted(t){t.focus()}}},emits:["locate"],data(){return{canEditPermissions:false,showSearchBar:false}},computed:{set(){return p.Set},...c.mapState(T.useChartStore,["departments"])},watch:{departments:{handler(){this.searchDialog.destroy()},deep:true}},created(){this.searchDialog=this.getSearchDialog()},methods:{loc(t,e={}){return this.$Bitrix.Loc.getMessage(t,e)},showSearchbar(){if(this.showSearchBar){this.showSearchBar=false;return}C.sendData({tool:"structure",category:"structure",event:"search"});this.showSearchBar=true},hideSearchbar(){this.showSearchBar=false},getSearchDialog(){const t=new i.Dialog({width:425,height:320,multiple:false,entities:[{id:"user",searchFields:[{name:"supertitle",type:"string",system:true,searchable:true},{name:"position",type:"string"}],options:{intranetUsersOnly:true,emailUsers:false,inviteEmployeeLink:false}},{id:"structure-node",options:{selectMode:"departmentsOnly",useMultipleTabs:true,restricted:"view",flatMode:true,includedNodeEntityTypes:["department","team"]}}],recentTabOptions:{id:"recents",visible:true},dropdownMode:true,enableSearch:false,hideOnDeselect:false,context:"HR_STRUCTURE",events:{"Item:onSelect":e=>{const n=e.getData().item;if(n.entityType==="employee"){this.$emit("locate",n.customData.get("nodeId"));O.searchUserInDepartment(n.id);t.recentItemsToSave.push(n);t.saveRecentItems();return}t.recentItemsToSave.push(n);t.saveRecentItems();this.$emit("locate",n.id)},onLoad:t=>{var e;(e=t.target.items.get("user"))==null?void 0:e.forEach((t=>{if(!t.getSubtitle()){t.setSubtitle(t.customData.get("position"))}}))},"SearchTab:onLoad":t=>{var e;(e=t.target.items.get("user"))==null?void 0:e.forEach((t=>{if(!t.getSubtitle()){t.setSubtitle(t.customData.get("position"))}}))},onDestroy:()=>{this.searchDialog=this.getSearchDialog()}}});const e=t.getContainer();U.Dom.attr(e,"data-test-id","hr-org-chart_title-panel__search-dialog-container");return t},onEnter(){if(this.$refs.searchName){this.searchDialog.setTargetNode(this.$refs.searchName);if(!this.searchDialog.isOpen()){this.searchDialog.show()}U.Event.bind(window,"mousedown",this.handleClickOutside)}},handleClickOutside(t){if(this.$refs.searchName&&!this.$refs.searchName.parentElement.contains(t.target)&&!this.searchDialog.isOpen()){this.clearSearch();this.hideSearchbar();U.Event.unbind(window,"mousedown",this.handleClickOutside)}},search(t){if(!this.searchDialog.isOpen()){this.searchDialog.show()}this.searchDialog.search(t)},clearSearch(){this.searchDialog.getSearchTab().clearResults();this.searchDialog.selectTab("recents");if(this.$refs.searchName){this.$refs.searchName.value="";this.$refs.searchName.focus()}}},template:`\n\t\t<div\n\t\t    class="humanresources-title-panel-search-bar-container"\n\t\t    :class="{'--opened': showSearchBar}"\n\t\t>\n\t\t  <div\n\t\t      class="humanresources-title-panel-search-bar-block__search"\n\t\t      @click="showSearchbar"\n\t\t\t\tdata-test-id="hr-org-chart_title-panel__search-bar-button"\n\t\t  >\n\t\t    <BIcon :name="set.SEARCH_2" :size="24" class="hr-title-search-icon"></BIcon>\n\t\t  </div>\n\t\t  <transition name="humanresources-title-panel-search-bar-fade" mode="in-out" @after-enter="onEnter">\n\t\t    <div v-if="showSearchBar"\n\t\t         class="humanresources-title-panel-search-bar-block__search-bar"\n\t\t    >\n\t\t      <input\n\t\t          ref="searchName"\n\t\t          key="searchInput"\n\t\t          type="text"\n\t\t          :placeholder="loc('HUMANRESOURCES_SEARCH_PLACEHOLDER_MSGVER_1')"\n\t\t          v-focus\n\t\t          class="humanresources-title-panel-search-bar-block__search-input"\n\t\t          @click="onEnter"\n\t\t          @input="search($event.target.value)"\n\t\t\t\t\tdata-test-id="hr-org-chart_title-panel__search-bar-input"\n\t\t      >\n\t\t      <div\n\t\t          key="searchReset"\n\t\t          @click="clearSearch"\n\t\t          class="humanresources-title-panel-search-bar-block__search-reset"\n\t\t      >\n\t\t        <div class="humanresources-title-panel-search-bar-block__search-cursor"></div>\n\t\t        <BIcon\n\t\t            :name="set.CROSS_CIRCLE_50"\n\t\t            :size="24"\n\t\t            color="#2FC6F6"\n\t\t        ></BIcon>\n\t\t      </div>\n\t\t    </div>\n\t\t  </transition>\n\t\t</div>\n\t`};const P=Object.freeze({accessRights:"access-rights",teamAccessRights:"team-access-rights"});const b={name:"BurgerMenuButton",components:{RouteActionMenu:u.RouteActionMenu},data(){return{actionMenu:{visible:false}}},mounted(){const t=A.PermissionChecker.getInstance();this.dropdownItems=[{id:P.accessRights,title:this.loc("HUMANRESOURCES_COMPANY_STRUCTURE_CONFIG_PERMISSION_TITLE_MSGVER_1"),description:this.loc("HUMANRESOURCES_COMPANY_STRUCTURE_CONFIG_PERMISSION_DESCR_MSGVER_1"),bIcon:{name:N.Main.PERSONS_2,size:20,color:S.getColorCode("paletteBlue50")},dataTestId:"hr-org-chart_title-panel__access-rights-button",permission:t.hasPermissionOfAction(A.PermissionActions.accessEdit)},{id:P.teamAccessRights,title:this.loc("HUMANRESOURCES_COMPANY_STRUCTURE_CONFIG_TEAM_PERMISSION_TITLE"),description:this.loc("HUMANRESOURCES_COMPANY_STRUCTURE_CONFIG_TEAM_PERMISSION_DESCR"),bIcon:{name:N.Main.MY_PLAN,size:20,color:S.getColorCode("paletteBlue50")},dataTestId:"hr-org-chart_title-panel__team-access-rights-button",permission:t.hasPermissionOfAction(A.PermissionActions.teamAccessEdit)}]},methods:{loc(t,e={}){return this.$Bitrix.Loc.getMessage(t,e)},actionMenuItemClickHandler(t){if(t===P.accessRights){C.sendData({tool:"structure",category:"structure",event:"open_roles"});BX.SidePanel.Instance.open("/hr/config/permission/",{usePadding:true})}if(t===P.teamAccessRights){C.sendData({tool:"structure",category:"structure",event:"open_roles"});BX.SidePanel.Instance.open("/hr/config/permission/?category=TEAM",{usePadding:true})}}},template:`\n\t\t<span\n\t\t\tref="burgerMenuButton"\n\t\t\t@click="actionMenu.visible = true"\n\t\t\tclass="humanresources-title-panel__burger-menu-button"\n\t\t\tdata-test-id="hr-org-chart_title-panel__burger-menu-button"\n\t\t>\n\t\t\t<svg\n\t\t\t\tviewBox="0 0 24 24"\n\t\t\t\tfill="none"\n\t\t\t\tclass="humanresources-title-panel__icon"\n\t\t\t\t:class="{'--selected': actionMenu.visible }"\n\t\t\t\t>\n\t\t\t\t\t<path fill-rule="evenodd" clip-rule="evenodd" d="M18.7067 15.5577C18.8172 15.5577 18.9067 15.6473 18.9067 15.7577L18.9067 17.2424C18.9067 17.3528 18.8172 17.4424 18.7067 17.4424H5.29375C5.1833 17.4424 5.09375 17.3528 5.09375 17.2424L5.09379 15.7577C5.09379 15.6473 5.18333 15.5577 5.29379 15.5577H18.7067ZM18.7067 11.5577C18.8172 11.5577 18.9067 11.6473 18.9067 11.7577L18.9067 13.2424C18.9067 13.3528 18.8172 13.4424 18.7067 13.4424H5.29375C5.1833 13.4424 5.09375 13.3528 5.09375 13.2424L5.09379 11.7577C5.09379 11.6473 5.18333 11.5577 5.29379 11.5577H18.7067ZM18.7067 7.55774C18.8172 7.55774 18.9067 7.64729 18.9067 7.75774L18.9067 9.24238C18.9067 9.35284 18.8172 9.44238 18.7067 9.44238H5.29375C5.1833 9.44238 5.09375 9.35283 5.09375 9.24237L5.09379 7.75773C5.09379 7.64728 5.18333 7.55774 5.29379 7.55774H18.7067Z" fill="#959ca4"/>\n\t\t\t</svg>\n\t\t </span>\n\t\t<RouteActionMenu\n\t\t\tv-if="actionMenu.visible"\n\t\t\tid="title-panel-burger-menu"\n\t\t\t:items="dropdownItems.filter(item => item.permission)"\n\t\t\t:bindElement="this.$refs.burgerMenuButton"\n\t\t\t@action="actionMenuItemClickHandler($event)"\n\t\t\t@close="this.actionMenu.visible = false"\n\t\t\tcontainerDataTestId="hr-org-chart_title-panel__burger-menu-container"\n\t\t/>\n\t`};const L={components:{AddButton:D,BurgerMenuButton:b,SearchBar:y,BIcon:p.BIcon,Set:p.Set},data(){return{canEditPermissions:false,canAddNode:false,toolbarStarActive:false,isHovered:false}},created(){this.toolbarStarElement=document.getElementById("uiToolbarStar")},mounted(){try{const t=A.PermissionChecker.getInstance();this.canEditPermissions=t&&(t.hasPermissionOfAction(A.PermissionActions.accessEdit)||t.hasPermissionOfAction(A.PermissionActions.teamAccessEdit));this.canAddNode=t&&(t.hasPermissionWithAnyNode(A.PermissionActions.departmentCreate)||t.hasPermissionWithAnyNode(A.PermissionActions.teamCreate))}catch(t){console.error("Failed to fetch data:",t)}const t=new MutationObserver((()=>{this.toolbarStarActive=U.Dom.hasClass(this.toolbarStarElement,"ui-toolbar-star-active")}));t.observe(this.toolbarStarElement,{attributes:true,attributeFilter:["class"]});this.toolbarStarActive=U.Dom.hasClass(this.toolbarStarElement,"ui-toolbar-star-active")},name:"title-panel",emits:["showWizard","locate"],computed:{set(){return p.Set},toolbarStarIcon(){if(this.isAirTemplate){return null}if(this.isHovered||this.toolbarStarActive){return this.set.FAVORITE_1}return this.set.FAVORITE_0},isAirTemplate(){return BX.Reflection.getClass("top.BX.Intranet.Bitrix24.Template")!==null},toolbarClassIcon(){if(!this.isAirTemplate){return"humanresources-title-panel__star"}return this.toolbarStarActive?"humanresources-title-panel__unpin":"humanresources-title-panel__pin"}},methods:{loc(t,e={}){return this.$Bitrix.Loc.getMessage(t,e)},addDepartment(){this.$emit("showWizard",{source:l.AnalyticsSourceType.HEADER})},onLocate(t){this.$emit("locate",t)},triggerFavoriteStar(){this.toolbarStarElement.click();r.UI.Notification.Center.notify({content:this.toolbarStarActive?this.loc("HUMANRESOURCES_COMPANY_STRUCTURE_LEFT_MENU_UN_SAVED"):this.loc("HUMANRESOURCES_COMPANY_STRUCTURE_LEFT_MENU_SAVED"),autoHideDelay:2e3})}},template:`\n\t\t<div class="humanresources-title-panel">\n\t\t\t<p class="humanresources-title-panel__title">\n\t\t\t\t{{ loc('HUMANRESOURCES_COMPANY_STRUCTURE_TITLE') }}\n\t\t\t</p>\n\t\t\t<BIcon\n\t\t\t\t:name="toolbarStarIcon"\n\t\t\t\t:size="24"\n\t\t\t\tcolor="rgba(149, 156, 164, 1)"\n\t\t\t\t:class="toolbarClassIcon"\n\t\t\t\t@mouseover="isHovered = true"\n\t\t\t\t@mouseleave="isHovered = false" @click="triggerFavoriteStar"\n\t\t\t></BIcon>\n\t\t\t<AddButton\n\t\t\t\tv-if="canAddNode"\n\t\t\t\t@addDepartment="addDepartment"\n\t\t\t/>\n\t\t\t<div class="humanresources-title-panel__icon-buttons">\n\t\t\t\t<BurgerMenuButton v-if="canEditPermissions"/>\n\t\t\t\t<SearchBar @locate="onLocate"/>\n\t\t\t</div>\n\t\t</div>\n\t`};const H=Object.freeze({FocusNodeId:"focusNodeId"});var B=babelHelpers.classPrivateFieldLooseKey("getParamsFromUrl");var w=babelHelpers.classPrivateFieldLooseKey("castAndValidate");class x{static getParams(){const t=babelHelpers.classPrivateFieldLooseBase(this,B)[B]();return{focusNodeId:babelHelpers.classPrivateFieldLooseBase(this,w)[w](H.FocusNodeId,t.get(H.FocusNodeId))}}}function Y(){const t=new Map;const e=new URLSearchParams(document.location.search);Object.values(H).forEach((n=>{const s=e.get(n);if(!s){return}t.set(n,s)}));return t}function k(t,e){if(U.Type.isUndefined(e)){return null}let n=e;if(t===H.FocusNodeId){n=Number(e);if(!U.Type.isInteger(n)){return null}}return n}Object.defineProperty(x,w,{value:k});Object.defineProperty(x,B,{value:Y});const F={name:"headList",components:{UserListActionMenu:u.UserListActionMenu},props:{items:{type:Array,required:false,default:()=>[]},title:{type:String,required:false,default:""},collapsed:{type:Boolean,required:false,default:false},type:{type:String,required:false,default:"head"},isTeamEntity:{type:Boolean,required:false,default:false}},data(){return{isCollapsed:false,isUpdating:true,headsVisible:false}},computed:{defaultAvatar(){return"/bitrix/js/humanresources/company-structure/org-chart/src/images/default-user.svg"},dropdownItems(){return this.items.map((t=>{const e=this.getPositionText(t);return{...t,workPosition:e}}))},titleBar(){return this.type===this.userTypes.deputy?this.loc("HUMANRESOURCES_COMPANY_STRUCTURE_WIZARD_EMPLOYEE_DEPUTY_TITLE"):this.loc("HUMANRESOURCES_COMPANY_STRUCTURE_WIZARD_EMPLOYEE_HEAD_TITLE")}},created(){this.userTypes={head:"head",deputy:"deputy"}},methods:{loc(t,e={}){return this.$Bitrix.Loc.getMessage(t,e)},handleUserClick(t){BX.SidePanel.Instance.open(t,{cacheable:false})},closeHeadList(){if(this.headsVisible){this.headsVisible=false;I.EventEmitter.unsubscribe(g.HR_DEPARTMENT_MENU_CLOSE,this.closeHeadList);I.EventEmitter.unsubscribe(g.HR_DRAG_DEPARTMENT,this.closeHeadList)}},openHeadList(){if(!this.headsVisible){this.headsVisible=true;I.EventEmitter.subscribe(g.HR_DEPARTMENT_MENU_CLOSE,this.closeHeadList);I.EventEmitter.subscribe(g.HR_DRAG_DEPARTMENT,this.closeHeadList)}},getPositionText(t){return t.workPosition||this.loc("HUMANRESOURCES_COMPANY_STRUCTURE_HEAD_POSITION")}},template:`\n\t\t<div v-if="items.length">\n\t\t\t<p v-if="title" class="humanresources-tree__node_employees-title">\n\t\t\t\t{{ title }}\n\t\t\t</p>\n\t\t\t<div\n\t\t\t\tclass="humanresources-tree__node_head"\n\t\t\t\t:class="{ '--collapsed': collapsed }"\n\t\t\t\tv-for="(item, index) in items.slice(0, 2)"\n\t\t\t>\n\t\t\t\t<img\n\t\t\t\t\t:src="item.avatar ? encodeURI(item.avatar) : defaultAvatar"\n\t\t\t\t\tclass="humanresources-tree__node_avatar --head"\n\t\t\t\t\t:class="{ '--collapsed': collapsed }"\n\t\t\t\t\t@click.stop="handleUserClick(item.url)"\n\t\t\t\t/>\n\t\t\t\t<div class="humanresources-tree__node_head-text">\n\t\t\t\t\t<span\n\t\t\t\t\t\t:bx-tooltip-user-id="item.id"\n\t\t\t\t\t\tbx-tooltip-context="b24"\n\t\t\t\t\t\tclass="humanresources-tree__node_head-name"\n\t\t\t\t\t\t@click.stop="handleUserClick(item.url)"\n\t\t\t\t\t>\n\t\t\t\t\t\t{{ item.name }}\n\t\t\t\t\t</span>\n\t\t\t\t\t<span v-if="!collapsed" class="humanresources-tree__node_head-position">\n\t\t\t\t\t\t{{ getPositionText(item) }}\n\t\t\t\t\t</span>\n\t\t\t\t</div>\n\t\t\t\t<span\n\t\t\t\t\tv-if="index === 1 && items.length > 2"\n\t\t\t\t\tclass="humanresources-tree__node_head-rest"\n\t\t\t\t\t:class="{ '--active': headsVisible }"\n\t\t\t\t\t:data-test-id="'hr-company-structure_org-chart-tree__node-' + type + '-rest'"\n\t\t\t\t\tref="showMoreHeadList"\n\t\t\t\t\t@click.stop="openHeadList"\n\t\t\t\t>\n\t\t\t\t\t{{ '+' + String(items.length - 2) }}\n\t\t\t\t</span>\n\t\t\t</div>\n\t\t</div>\n\t\t<UserListActionMenu\n\t\t\tv-if="headsVisible"\n\t\t\t:id="type === userTypes.head ? 'head-list-popup-head' : 'head-list-popup-deputy'"\n\t\t\t:items="dropdownItems"\n\t\t\t:width="228"\n\t\t\t:bindElement="$refs.showMoreHeadList[0]"\n\t\t\t@close="closeHeadList"\n\t\t\t:titleBar="titleBar"\n\t\t/>\n\t`};let V=t=>t,$;const z=278;const W=24;const G=({target:t,currentTarget:e})=>{if(!U.Dom.hasClass(t,"humanresources-tree__node_dnd-icon")){return}event.stopPropagation();const n=t.closest(".humanresources-tree__node");const s=Number(n.dataset.id);const i=[...e.children];const o=i.indexOf(n);const r=X(n);U.Dom.append(r,e);let a=0;let c=[];let d=null;const l=t=>{U.Dom.style(document.body,"userSelect","none");U.Dom.style(document.body,"cursor","grabbing");U.Dom.addClass(e,"--drag-progress");U.Dom.addClass(n,"--dragging");a+=t.movementX/e.dataset.zoom;j(n,a);c.forEach((t=>j(t)));d=Math.trunc((n.offsetLeft+a)/(z+W));if(d===o){j(r,n.offsetLeft);return}const s=o<d?1:-1;const l=s>0?i.slice(o+1,d+1):i.slice(d,o);const u=z+W;l.forEach((t=>j(t,-s*u)));j(r,n.offsetLeft+s*l.length*u);c=l};const u=()=>{U.Dom.style(document.body,"userSelect","");U.Dom.style(document.body,"cursor","");U.Event.unbind(document,"mousemove",l);U.Event.unbind(document,"mouseup",u);[...c,n].forEach((t=>j(t)));U.Dom.removeClass(e,"--drag-progress");U.Dom.removeClass(n,"--dragging");U.Dom.remove(r);I.EventEmitter.emit(g.HR_DEPARTMENT_TOGGLE_CONNECTORS,{draggedId:s,shouldShow:true});if(o===d){return}const t=i[d]?Number(i[d].dataset.id):0;if(t){I.EventEmitter.emit(g.HR_DROP_DEPARTMENT,{draggedId:s,targetId:t,affectedItems:c.map((t=>Number(t.dataset.id))),direction:o<d?1:-1})}};U.Event.bind(document,"mousemove",l);U.Event.bind(document,"mouseup",u);I.EventEmitter.emit(g.HR_DEPARTMENT_TOGGLE_CONNECTORS,{draggedId:s,shouldShow:false});I.EventEmitter.emit(g.HR_DRAG_DEPARTMENT,{draggedId:s})};const X=t=>{const{offsetWidth:e,offsetHeight:n,offsetLeft:s}=t;return U.Tag.render($||($=V`
		<div
			class="humanresources-tree__node_dnd-ghost"
			style="width: ${0}px; height: ${0}px; transform: translateX(${0}px);"
		></div>
	`),e,n,s)};const j=(t,e)=>{U.Dom.style(t,"transform",e?`translate3d(${e}px, 0, 0)`:"")};const Z={mounted(t){U.Event.bind(t,"mousedown",G)},updated(t,{value:e}){t.setAttribute("data-zoom",e)}};class q{constructor(t){this.permissionChecker=A.PermissionChecker.getInstance();this.entityId=t}getItems(){throw new Error("Must override this function")}getFilteredItems(){if(!this.permissionChecker){return[]}const t=this.getItems();return t.filter((t=>{if(U.Type.isFunction(t.hasPermission)){return t.hasPermission(this.permissionChecker,this.entityId)}return false}))}onActionMenuItemClick(t){const e=this.items.find((e=>e.id===t));e==null?void 0:e.invoke({entityId:this.entityId,analyticSource:this.analyticSource,entityType:this.entityType})}}class K{constructor({id:t,title:e,description:n,bIcon:s,permissionAction:i,dataTestId:o}){this.id=t;this.title=e;this.description=n;this.bIcon=s;this.permissionAction=i;this.dataTestId=o}invoke(t){throw new Error("Must override this function")}hasPermission(t,e){return t.hasPermission(this.permissionAction,e)}}const J=Object.freeze({editDepartment:"editDepartment",addDepartment:"addDepartment",addEmployee:"addEmployee",editEmployee:"editEmployee",removeDepartment:"removeDepartment",moveEmployee:"moveEmployee",userInvite:"userInvite",teamRights:"teamRights",moveUserToAnotherDepartment:"moveUserToAnotherDepartment",removeUserFromDepartment:"removeUserFromDepartment",fireUserFromCompany:"fireUserFromCompany"});class Q extends K{constructor(t){let e="";let n="";const s=A.PermissionChecker.getInstance();if(s.isTeamsAvailable){e=t===S.EntityTypes.team?U.Loc.getMessage("HUMANRESOURCES_COMPANY_STRUCTURE_DEPARTMENT_DETAIL_EDIT_MENU_ADD_TEAM_TITLE"):U.Loc.getMessage("HUMANRESOURCES_COMPANY_STRUCTURE_DEPARTMENT_DETAIL_EDIT_MENU_ADD_DEPARTMENT_TITLE_MSGVER_1");n=t===S.EntityTypes.team?U.Loc.getMessage("HUMANRESOURCES_COMPANY_STRUCTURE_DEPARTMENT_DETAIL_EDIT_MENU_ADD_TEAM_SUBTITLE"):U.Loc.getMessage("HUMANRESOURCES_COMPANY_STRUCTURE_DEPARTMENT_DETAIL_EDIT_MENU_ADD_DEPARTMENT_SUBTITLE_MSGVER_1")}else{e=U.Loc.getMessage("HUMANRESOURCES_COMPANY_STRUCTURE_DEPARTMENT_DETAIL_EDIT_MENU_ADD_DEPARTMENT_TITLE_NO_TEAM");n=U.Loc.getMessage("HUMANRESOURCES_COMPANY_STRUCTURE_DEPARTMENT_DETAIL_EDIT_MENU_ADD_DEPARTMENT_SUBTITLE_NO_TEAM")}super({id:J.addDepartment,title:e,description:n,bIcon:{name:N.Main.CUBE_PLUS,size:20,color:S.getColorCode("paletteBlue50")},permissionAction:null,dataTestId:"hr-company-structure_menu__add-department-item"});this.permissionChecker=s}invoke({entityId:t,analyticSource:e,entityType:n}){if(n===S.EntityTypes.team){if(!this.permissionChecker.isTeamsAvailable){r.UI.Notification.Center.notify({content:U.Loc.getMessage("HUMANRESOURCES_COMPANY_STRUCTURE_TEAMS_DISABLED_ERROR_MSGVER_1"),autoHideDelay:2e3});return}I.EventEmitter.emit(g.HR_ENTITY_SHOW_WIZARD,{nodeId:t,isEditMode:false,showEntitySelector:false,source:e,entityType:n})}else{I.EventEmitter.emit(g.HR_ENTITY_SHOW_WIZARD,{nodeId:t,isEditMode:false,showEntitySelector:true,source:e})}}hasPermission(t,e){if(this.entityType===S.EntityTypes.team){return t.hasPermission(A.PermissionActions.teamCreate,e)}return t.hasPermission(A.PermissionActions.departmentCreate,e)||t.hasPermission(A.PermissionActions.teamCreate,e)}}class tt extends K{constructor(t){const e=t===S.EntityTypes.team?U.Loc.getMessage("HUMANRESOURCES_COMPANY_STRUCTURE_DEPARTMENT_DETAIL_EDIT_MENU_EDIT_TEAM_TITLE"):U.Loc.getMessage("HUMANRESOURCES_COMPANY_STRUCTURE_DEPARTMENT_DETAIL_EDIT_MENU_EDIT_DEPARTMENT_TITLE");const n=t===S.EntityTypes.team?U.Loc.getMessage("HUMANRESOURCES_COMPANY_STRUCTURE_DEPARTMENT_DETAIL_EDIT_MENU_EDIT_TEAM_SUBTITLE"):U.Loc.getMessage("HUMANRESOURCES_COMPANY_STRUCTURE_DEPARTMENT_DETAIL_EDIT_MENU_EDIT_DEPARTMENT_SUBTITLE");const s=t===S.EntityTypes.team?A.PermissionActions.teamEdit:A.PermissionActions.departmentEdit;super({id:J.editDepartment,title:e,description:n,bIcon:{name:N.Main.EDIT_PENCIL,size:20,color:S.getColorCode("paletteBlue50")},permissionAction:s,dataTestId:"hr-company-structure_menu__edit-department-item"})}invoke({entityId:t,analyticSource:e,refToFocus:n="title"}){I.EventEmitter.emit(g.HR_ENTITY_SHOW_WIZARD,{nodeId:t,isEditMode:true,type:"department",source:e,refToFocus:n})}}class et extends K{constructor(t){const e=t===S.EntityTypes.team?U.Loc.getMessage("HUMANRESOURCES_COMPANY_STRUCTURE_DEPARTMENT_DETAIL_EDIT_MENU_REMOVE_TEAM_TITLE"):U.Loc.getMessage("HUMANRESOURCES_COMPANY_STRUCTURE_DEPARTMENT_DETAIL_EDIT_MENU_REMOVE_DEPARTMENT_TITLE");const n=t===S.EntityTypes.team?U.Loc.getMessage("HUMANRESOURCES_COMPANY_STRUCTURE_DEPARTMENT_DETAIL_EDIT_MENU_REMOVE_TEAM_SUBTITLE"):U.Loc.getMessage("HUMANRESOURCES_COMPANY_STRUCTURE_DEPARTMENT_DETAIL_EDIT_MENU_REMOVE_DEPARTMENT_SUBTITLE");const s=t===S.EntityTypes.team?A.PermissionActions.teamDelete:A.PermissionActions.departmentDelete;super({id:J.removeDepartment,title:e,description:n,bIcon:{name:N.Main.TRASH_BIN,size:20,color:S.getColorCode("paletteRed40")},permissionAction:s,dataTestId:"hr-company-structure_menu__remove-department-item"})}invoke({entityId:t,entityType:e}){I.EventEmitter.emit(g.HR_ENTITY_REMOVE,{nodeId:t,entityType:e})}}class nt extends K{constructor(){super({id:J.teamRights,title:U.Loc.getMessage("HUMANRESOURCES_COMPANY_STRUCTURE_DEPARTMENT_DETAIL_EDIT_MENU_TEAM_RIGHTS_TITLE"),description:U.Loc.getMessage("HUMANRESOURCES_COMPANY_STRUCTURE_DEPARTMENT_DETAIL_EDIT_MENU_TEAM_RIGHTS_SUBTITLE"),bIcon:{name:N.Actions.SETTINGS_2,size:20,color:S.getColorCode("paletteBlue50")},permissionAction:A.PermissionActions.teamSettingsEdit,dataTestId:"hr-company-structure_menu__team-rights-item"})}invoke({entityId:t,analyticSource:e,entityType:n}){I.EventEmitter.emit(g.HR_ENTITY_SHOW_WIZARD,{nodeId:t,isEditMode:true,type:"teamRights",source:e})}}class st extends K{constructor(t,e){const n=t===S.EntityTypes.team?A.PermissionActions.teamAddMember:A.PermissionActions.employeeAddToDepartment;super({id:J.addEmployee,bIcon:{name:N.CRM.PERSON_PLUS_2,size:20,color:S.getColorCode("paletteBlue50")},permissionAction:n,dataTestId:"hr-company-structure_menu__add-employee-item"});this.localize(t,e)}localize(t,e){const n=["head","employee"].includes(e)?e:"default";const s=t===S.EntityTypes.team?"team":"default";const i={head:{team:{title:U.Loc.getMessage("HUMANRESOURCES_COMPANY_STRUCTURE_DEPARTMENT_DETAIL_TAB_USERS_MEMBER_ACTION_MENU_ADD_HEAD_TITLE"),description:U.Loc.getMessage("HUMANRESOURCES_COMPANY_STRUCTURE_DEPARTMENT_DETAIL_TAB_USERS_MEMBER_ACTION_MENU_ADD_TEAM_HEAD_SUBTITLE"),role:l.teamMemberRoles.head},default:{title:U.Loc.getMessage("HUMANRESOURCES_COMPANY_STRUCTURE_DEPARTMENT_DETAIL_TAB_USERS_MEMBER_ACTION_MENU_ADD_HEAD_TITLE"),description:U.Loc.getMessage("HUMANRESOURCES_COMPANY_STRUCTURE_DEPARTMENT_DETAIL_TAB_USERS_MEMBER_ACTION_MENU_ADD_HEAD_SUBTITLE"),role:l.memberRoles.head}},employee:{team:{title:U.Loc.getMessage("HUMANRESOURCES_COMPANY_STRUCTURE_DEPARTMENT_DETAIL_TAB_USERS_MEMBER_ACTION_MENU_ADD_TEAM_EMPLOYEE_TITLE"),description:U.Loc.getMessage("HUMANRESOURCES_COMPANY_STRUCTURE_DEPARTMENT_DETAIL_TAB_USERS_MEMBER_ACTION_MENU_ADD_TEAM_EMPLOYEE_SUBTITLE"),role:l.teamMemberRoles.employee},default:{title:U.Loc.getMessage("HUMANRESOURCES_COMPANY_STRUCTURE_DEPARTMENT_DETAIL_TAB_USERS_MEMBER_ACTION_MENU_ADD_EMPLOYEE_TITLE"),description:U.Loc.getMessage("HUMANRESOURCES_COMPANY_STRUCTURE_DEPARTMENT_DETAIL_TAB_USERS_MEMBER_ACTION_MENU_ADD_EMPLOYEE_SUBTITLE"),role:l.memberRoles.employee}},default:{team:{title:U.Loc.getMessage("HUMANRESOURCES_COMPANY_STRUCTURE_DEPARTMENT_DETAIL_EDIT_MENU_ADD_TEAM_EMPLOYEE_TITLE"),description:U.Loc.getMessage("HUMANRESOURCES_COMPANY_STRUCTURE_DEPARTMENT_DETAIL_EDIT_MENU_ADD_TEAM_EMPLOYEE_SUBTITLE"),role:null},default:{title:U.Loc.getMessage("HUMANRESOURCES_COMPANY_STRUCTURE_DEPARTMENT_DETAIL_EDIT_MENU_ADD_EMPLOYEE_TITLE"),description:U.Loc.getMessage("HUMANRESOURCES_COMPANY_STRUCTURE_DEPARTMENT_DETAIL_EDIT_MENU_ADD_EMPLOYEE_SUBTITLE"),role:null}}};this.title=i[n][s].title;this.description=i[n][s].description;this.role=i[n][s].role}invoke({entityId:t,entityType:e}){a.UserManagementDialog.openDialog({nodeId:t,type:"add",role:this.role,entityType:e})}}class it extends K{constructor(t,e){const n=t===S.EntityTypes.team?A.PermissionActions.teamAddMember:A.PermissionActions.employeeAddToDepartment;super({id:J.editEmployee,imageClass:"-hr-department-org-chart-menu-edit-list",bIcon:{name:N.Main.EDIT_MENU,size:20,color:S.getColorCode("paletteBlue50")},permissionAction:n,dataTestId:"hr-company-structure_menu__edit-employee-item"});this.localize(t,e)}localize(t,e){const n=["head","employee"].includes(e)?e:"default";const s=t===S.EntityTypes.team?"team":"default";const i={head:{team:{title:U.Loc.getMessage("HUMANRESOURCES_COMPANY_STRUCTURE_DEPARTMENT_DETAIL_TAB_USERS_MEMBER_ACTION_MENU_EDIT_TEAM_HEAD_TITLE"),description:U.Loc.getMessage("HUMANRESOURCES_COMPANY_STRUCTURE_DEPARTMENT_DETAIL_TAB_USERS_MEMBER_ACTION_MENU_EDIT_TEAM_HEAD_SUBTITLE")},default:{title:U.Loc.getMessage("HUMANRESOURCES_COMPANY_STRUCTURE_DEPARTMENT_DETAIL_TAB_USERS_MEMBER_ACTION_MENU_EDIT_HEAD_TITLE"),description:U.Loc.getMessage("HUMANRESOURCES_COMPANY_STRUCTURE_DEPARTMENT_DETAIL_TAB_USERS_MEMBER_ACTION_MENU_EDIT_HEAD_SUBTITLE")}},employee:{team:{title:U.Loc.getMessage("HUMANRESOURCES_COMPANY_STRUCTURE_DEPARTMENT_DETAIL_TAB_USERS_MEMBER_ACTION_MENU_EDIT_TEAM_EMPLOYEE_TITLE"),description:U.Loc.getMessage("HUMANRESOURCES_COMPANY_STRUCTURE_DEPARTMENT_DETAIL_TAB_USERS_MEMBER_ACTION_MENU_EDIT_TEAM_EMPLOYEE_SUBTITLE")},default:{title:U.Loc.getMessage("HUMANRESOURCES_COMPANY_STRUCTURE_DEPARTMENT_DETAIL_TAB_USERS_MEMBER_ACTION_MENU_EDIT_EMPLOYEE_TITLE"),description:U.Loc.getMessage("HUMANRESOURCES_COMPANY_STRUCTURE_DEPARTMENT_DETAIL_TAB_USERS_MEMBER_ACTION_MENU_EDIT_TEAM_EMPLOYEE_SUBTITLE")}},default:{team:{title:U.Loc.getMessage("HUMANRESOURCES_COMPANY_STRUCTURE_DEPARTMENT_DETAIL_EDIT_MENU_EDIT_TEAM_EMPLOYEE_LIST_TITLE"),description:U.Loc.getMessage("HUMANRESOURCES_COMPANY_STRUCTURE_DEPARTMENT_DETAIL_EDIT_MENU_EDIT_TEAM_EMPLOYEE_LIST_SUBTITLE")},default:{title:U.Loc.getMessage("HUMANRESOURCES_COMPANY_STRUCTURE_DEPARTMENT_DETAIL_EDIT_MENU_EDIT_EMPLOYEE_LIST_TITLE"),description:U.Loc.getMessage("HUMANRESOURCES_COMPANY_STRUCTURE_DEPARTMENT_DETAIL_EDIT_MENU_EDIT_EMPLOYEE_LIST_SUBTITLE")}}};this.title=i[n][s].title;this.description=i[n][s].description}invoke({entityId:t,analyticSource:e}){I.EventEmitter.emit(g.HR_ENTITY_SHOW_WIZARD,{nodeId:t,isEditMode:true,type:"employees",source:e})}}class ot extends K{constructor(){super({id:J.moveEmployee,title:U.Loc.getMessage("HUMANRESOURCES_COMPANY_STRUCTURE_DEPARTMENT_DETAIL_EDIT_MENU_MOVE_EMPLOYEE_TITLE"),description:U.Loc.getMessage("HUMANRESOURCES_COMPANY_STRUCTURE_DEPARTMENT_DETAIL_EDIT_MENU_MOVE_EMPLOYEE_SUBTITLE"),bIcon:{name:N.Main.PERSON_ARROW_LEFT_1,size:20,color:S.getColorCode("paletteBlue50")},permissionAction:A.PermissionActions.employeeAddToDepartment,dataTestId:"hr-company-structure_menu__move-employee-item"})}invoke({entityId:t,analyticSource:e}){a.UserManagementDialog.openDialog({nodeId:t,type:"move"})}hasPermission(t,e){return t.currentUserPermissions.ACTION_EMPLOYEE_REMOVE_FROM_DEPARTMENT&&t.hasPermission(this.permissionAction,e)}}class rt extends K{constructor(){super({id:J.userInvite,title:U.Loc.getMessage("HUMANRESOURCES_COMPANY_STRUCTURE_DEPARTMENT_DETAIL_EDIT_MENU_USER_INVITE_TITLE"),description:U.Loc.getMessage("HUMANRESOURCES_COMPANY_STRUCTURE_DEPARTMENT_DETAIL_EDIT_MENU_USER_INVITE_SUBTITLE"),bIcon:{name:N.Main.PERSON_LETTER,size:20,color:S.getColorCode("paletteBlue50")},permissionAction:A.PermissionActions.inviteToDepartment,dataTestId:"hr-company-structure_menu__user-invite-item"})}invoke({entityId:t}){BX.SidePanel.Instance.open("/bitrix/services/main/ajax.php?action=getSliderContent"+"&c=bitrix%3Aintranet.invitation&mode=ajax"+`&departments[]=${Number(t)}&firstInvitationBlock=invite-with-group-dp`,{cacheable:false,allowChangeHistory:false,width:1100})}}class at extends q{constructor(t,e,n){super(t);this.entityType=e;this.analyticSource=n;this.items=this.getFilteredItems()}getItems(){if(this.entityType===S.EntityTypes.team){return[new tt(this.entityType),new Q(this.entityType),new it(this.entityType,null),new nt,new st(this.entityType),new et(this.entityType)]}return[new tt(this.entityType),new Q(this.entityType),new st(this.entityType),new it(this.entityType,null),new ot,new rt,new et(this.entityType)]}}const ct={name:"DepartmentMenuButton",components:{RouteActionMenu:u.RouteActionMenu},props:{entityId:{type:Number,required:true},entityType:{type:String,default:S.EntityTypes.department}},data(){return{menuVisible:false}},computed:{menu(){return new at(this.entityId,this.entityType,l.AnalyticsSourceType.DETAIL)}},methods:{loc(t,e={}){return this.$Bitrix.Loc.getMessage(t,e)},onActionMenuItemClick(t){this.menu.onActionMenuItemClick(t)},closeMenu(){if(this.menuVisible){this.menuVisible=false;I.EventEmitter.unsubscribe(g.HR_DEPARTMENT_MENU_CLOSE,this.closeMenu);I.EventEmitter.unsubscribe(g.HR_DRAG_DEPARTMENT,this.closeMenu)}},openMenu(){if(!this.menuVisible){this.menuVisible=true;I.EventEmitter.subscribe(g.HR_DEPARTMENT_MENU_CLOSE,this.closeMenu);I.EventEmitter.subscribe(g.HR_DRAG_DEPARTMENT,this.closeMenu)}}},template:`\n\t\t<div\n\t\t\tv-if="menu.items.length"\n\t\t\tclass="ui-icon-set --more humanresources-tree__node_department-menu-button"\n\t\t\t:class="{ '--focused': this.menuVisible }"\n\t\t\tref="departmentMenuButton"\n\t\t\tdata-test-id="tree-node-more-button"\n\t\t\t@click.stop="openMenu"\n\t\t>\n\t\t</div>\n\n\t\t<RouteActionMenu\n\t\t\tv-if="menuVisible"\n\t\t\t:id="'tree-node-department-menu-' + entityId"\n\t\t\t:width="302"\n\t\t\t:items="menu.items"\n\t\t\t:bindElement="this.$refs.departmentMenuButton"\n\t\t\t@action="onActionMenuItemClick"\n\t\t\t@close="closeMenu"\n\t\t/>\n\t`};const dt={name:"DepartmentInfoIconButton",components:{BasePopup:u.BasePopup},props:{entityId:{type:Number,required:true},canvasZoom:{type:Number,required:true},description:{type:[String,null],default:null}},data(){return{showPopup:false}},computed:{popupConfig(){const t=340;const e=22*this.canvasZoom;const n=41-this.canvasZoom;const s=33;return{width:t,bindElement:this.$refs.departmentMenuButton,bindOptions:{position:"top"},borderRadius:"12px",contentNoPaddings:true,contentPadding:0,padding:16,offsetTop:-2*this.canvasZoom,offsetLeft:e/2-t/2+n,angleOffset:t/2-s/2}}},created(){this.menuItem=new tt(S.EntityTypes.team);const t=A.PermissionChecker.getInstance();this.canEdit=this.menuItem.hasPermission(t,this.entityId)},methods:{loc(t,e={}){return this.$Bitrix.Loc.getMessage(t,e)},onClose(){if(this.showPopup){this.showPopup=false;I.EventEmitter.unsubscribe(g.HR_DEPARTMENT_MENU_CLOSE,this.onClose);I.EventEmitter.unsubscribe(g.HR_DRAG_DEPARTMENT,this.onClose)}},onOpen(){if(!this.showPopup){this.showPopup=true;I.EventEmitter.subscribe(g.HR_DEPARTMENT_MENU_CLOSE,this.onClose);I.EventEmitter.subscribe(g.HR_DRAG_DEPARTMENT,this.onClose)}},addDescription(){this.onClose();this.menuItem.invoke({entityId:this.entityId,analyticSource:l.AnalyticsSourceType.CARD,refToFocus:"description"})}},template:`\n\t\t<div\n\t\t\tv-if="canEdit || description"\n\t\t\tclass="ui-icon-set --info-1 humanresources-tree__node_department-menu-button"\n\t\t\t:class="{ '--focused': this.showPopup }"\n\t\t\tref="departmentMenuButton"\n\t\t\t@click.stop="onOpen"\n\t\t\tdata-test-id="tree-node-info-button"\n\t\t>\n\t\t</div>\n\t\t<BasePopup\n\t\t\tv-if="showPopup"\n\t\t\t:config="popupConfig"\n\t\t\t:id="'humanresources-tree__node_info-popup' + entityId"\n\t\t\t@close="onClose"\n\t\t>\n\t\t\t<div class="humanresources-tree__node_info-popup-content_description" v-if="description">\n\t\t\t\t{{ description }}\n\t\t\t</div>\n\t\t\t<div v-else class="humanresources-tree__node_info-popup-content">\n\t\t\t\t<div class="humanresources-tree__node_info-popup-content_left"></div>\n\t\t\t\t<div class="humanresources-tree__node_info-popup-content_right">\n\t\t\t\t\t<div class="humanresources-tree__node_info-popup-content_right_title">\n\t\t\t\t\t\t{{ loc('HUMANRESOURCES_COMPANY_STRUCTURE_INFO_POPUP_ADD_DESCRIPTION_TITLE') }}\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class="humanresources-tree__node_info-popup-content_right_text">\n\t\t\t\t\t\t{{ loc('HUMANRESOURCES_COMPANY_STRUCTURE_INFO_POPUP_ADD_DESCRIPTION_TEXT') }}\n\t\t\t\t\t</div>\n\t\t\t\t\t<div\n\t\t\t\t\t\tclass="ui-btn ui-btn-primary ui-btn-round ui-btn-xs ui-btn-no-caps"\n\t\t\t\t\t\tdata-test-id="tree-node-info-popup_add-button"\n\t\t\t\t\t\t@click="addDescription"\n\t\t\t\t\t>\n\t\t\t\t\t\t{{ loc('HUMANRESOURCES_COMPANY_STRUCTURE_INFO_POPUP_ADD_DESCRIPTION_BUTTON') }}\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t</BasePopup>\n\t`};const lt={name:"SubdivisionAddButton",components:{BIcon:p.BIcon},props:{entityId:{type:Number,required:true},entityType:{type:String,default:S.EntityTypes.department}},computed:{set(){return p.Set}},created(){this.menuItem=new Q(this.entityType);const t=A.PermissionChecker.getInstance();this.canShow=this.menuItem.hasPermission(t,this.entityId)},methods:{loc(t,e={}){return this.$Bitrix.Loc.getMessage(t,e)},addSubdivision(){this.menuItem.invoke({entityId:this.entityId,analyticSource:l.AnalyticsSourceType.PLUS,entityType:this.entityType})}},template:`\n\t\t<div class="humanresources-tree__node_add-subdivision" v-if="canShow">\n\t\t  <button class="humanresources-tree__node_add-button" @click="addSubdivision">\n\t\t    <BIcon :name="set.PLUS_20" :size="32" class="humanresources-tree__node_add-icon"></BIcon>\n\t\t  </button>\n\t\t</div>\n\t`};const ut={name:"treeNode",components:{DepartmentMenuButton:ct,HeadList:F,SubdivisionAddButton:lt,DepartmentInfoIconButton:dt},directives:{hint:u.Hint,dnd:Z},inject:["getTreeBounds"],props:{nodeId:{type:Number,required:true},expandedNodes:{type:Array,required:true},canvasZoom:{type:Number,required:true},currentDepartments:{type:Array,required:true},isShown:{type:Boolean,required:false,default:true}},emits:["calculatePosition"],data(){return{childrenOffset:0,childrenMounted:false,showInfo:true,showDnd:true}},computed:{memberRoles(){return l.getMemberRoles(this.nodeData.entityType)},nodeData(){return this.departments.get(this.nodeId)},nodeClass(){return{"--expanded":this.expandedNodes.includes(this.nodeId),"--current-department":this.isCurrentDepartment,"--focused":this.focusedNode===this.nodeId,"--with-restricted-access-rights":!this.showInfo,"--team":this.isTeamEntity}},subdivisionsClass(){return{"humanresources-tree__node_arrow":this.hasChildren,"--up":this.hasChildren&&this.isExpanded,"--down":this.hasChildren&&!this.isExpanded,"--transparent":!this.hasChildren}},hasChildren(){var t;return((t=this.nodeData.children)==null?void 0:t.length)>0},isExpanded(){return this.expandedNodes.includes(this.nodeId)},isCurrentDepartment(){return this.currentDepartments.includes(this.nodeId)},head(){var t;return(t=this.nodeData.heads)==null?void 0:t.filter((t=>t.role===this.memberRoles.head))},deputy(){var t;return(t=this.nodeData.heads)==null?void 0:t.filter((t=>t.role===this.memberRoles.deputyHead))},employeeCount(){return this.nodeData.userCount-this.nodeData.heads.length},childNodeStyle(){return{left:`${this.childrenOffset}px`}},showSubdivisionAddButton(){return this.expandedNodes.includes(this.nodeId)||this.focusedNode===this.nodeId},isTeamEntity(){return this.nodeData.entityType===S.EntityTypes.team},nodeDataTitle(){if(!this.isCurrentDepartment){return null}return this.isTeamEntity?this.loc("HUMANRESOURCES_COMPANY_CURRENT_TEAM"):this.loc("HUMANRESOURCES_COMPANY_CURRENT_DEPARTMENT")},subdivisionsText(){var t;if(this.isTeamEntity){var e;return(e=this.nodeData.children)!=null&&e.length?this.locPlural("HUMANRESOURCES_COMPANY_TEAM_CHILDREN_COUNT",this.nodeData.children.length):this.loc("HUMANRESOURCES_COMPANY_STRUCTURE_TREE_TEAM_NO_SUBDEPARTMENTS")}if(!((t=this.nodeData.children)!=null&&t.length)){return this.loc("HUMANRESOURCES_COMPANY_STRUCTURE_TREE_NO_SUBDEPARTMENTS")}const n=[...this.departments.values()].filter((t=>t.entityType===S.EntityTypes.department&&this.nodeData.children.includes(t.id))).length;const s=[...this.departments.values()].filter((t=>t.entityType===S.EntityTypes.team&&this.nodeData.children.includes(t.id))).length;if(s>0&&n>0){return this.loc("HUMANRESOURCES_COMPANY_DEPARTMENT_CHILDREN_COUNT_WITH_CONJUNCTION",{"#DEPT_COUNT#":this.locPlural("HUMANRESOURCES_COMPANY_DEPARTMENT_CHILDREN_COUNT",n),"#TEAM_COUNT#":this.locPlural("HUMANRESOURCES_COMPANY_TEAM_CHILDREN_COUNT",s)})}if(n>0){return this.locPlural("HUMANRESOURCES_COMPANY_DEPARTMENT_CHILDREN_COUNT",n)}if(s>0){return this.locPlural("HUMANRESOURCES_COMPANY_TEAM_CHILDREN_COUNT",s)}return this.loc("HUMANRESOURCES_COMPANY_STRUCTURE_TREE_NO_SUBDEPARTMENTS")},...c.mapState(T.useChartStore,["departments","focusedNode"])},watch:{head(){this.adaptHeight()},isShown(){this.adaptHeight()},isExpanded:{handler(t){if(t&&!this.childrenMounted){this.childrenMounted=true}},immediate:true}},created(){this.width=278;this.gap=24;this.prevChildrenOffset=0;this.prevHeight=0},async mounted(){if(this.isTeamEntity){this.showInfo=A.PermissionChecker.getInstance().hasPermission(A.PermissionActions.teamView,this.nodeId)}else{this.showInfo=A.PermissionChecker.getInstance().hasPermission(A.PermissionActions.structureView,this.nodeId)}this.showDnd=A.PermissionChecker.getInstance().hasPermission(A.PermissionActions.departmentEdit,this.nodeData.parentId,A.PermissionLevels.selfAndSub)&&A.PermissionChecker.getInstance().hasPermission(A.PermissionActions.structureView,this.nodeData.parentId,A.PermissionLevels.selfAndSub);this.$emit("calculatePosition",this.nodeId);await this.$nextTick();this.prevHeight=this.$el.offsetHeight;I.EventEmitter.emit(g.HR_DEPARTMENT_CONNECT,{id:this.nodeId,parentId:this.nodeData.parentId,html:this.$el,parentsPath:this.getParentsPath(this.nodeData.parentId),...this.calculateNodePoints()})},unmounted(){U.Dom.remove(this.$el);const{prevParentId:t}=this.nodeData;if(!t){return}this.$emit("calculatePosition",this.nodeId);I.EventEmitter.emit(g.HR_DEPARTMENT_DISCONNECT,{id:this.nodeId,parentId:t})},methods:{loc(t,e={}){return this.$Bitrix.Loc.getMessage(t,e)},onDepartmentClick(t){if(!this.showInfo){return}I.EventEmitter.emit(g.HR_DEPARTMENT_FOCUS,{nodeId:this.nodeId,showEmployees:t==="employees",subdivisionsSelected:t==="subdivisions"})},calculatePosition(t){const e=this.departments.get(this.nodeId);if(e.children.length===0){this.childrenOffset=0}else{const t=this.gap*(e.children.length-1);this.prevChildrenOffset=this.childrenOffset;this.childrenOffset=(this.width-(this.width*e.children.length+t))/2}const n=this.childrenOffset-this.prevChildrenOffset;if(n!==0){I.EventEmitter.emit(g.HR_DEPARTMENT_ADAPT_SIBLINGS,{parentId:this.nodeId,nodeId:t,offset:n})}},locPlural(t,e){return U.Loc.getMessagePlural(t,e,{"#COUNT#":e})},calculateNodePoints(){const{left:t,top:e,width:n}=this.$el.getBoundingClientRect();const{$el:s}=this.$parent.$parent;const{left:i,top:o,width:r,height:a}=s.getBoundingClientRect();const{x:c,y:d}=this.getTreeBounds();return{startPoint:{x:(i-c+r/2)/this.canvasZoom,y:(o-d+a)/this.canvasZoom},endPoint:{x:(t-c+n/2)/this.canvasZoom,y:(e-d)/this.canvasZoom}}},getParentsPath(t){let e=t;const n=[t];while(e){const t=this.departments.get(e);e=t.parentId;if(e){n.push(e)}}return n},async adaptHeight(){if(!this.isShown){return}await this.$nextTick();const t=this.$el.offsetHeight-this.prevHeight;if(t!==0){I.EventEmitter.emit(g.HR_DEPARTMENT_ADAPT_CONNECTOR_HEIGHT,{nodeId:this.nodeId,shift:t});this.prevHeight=this.$el.offsetHeight}}},template:`\n\t\t<div\n\t\t\t:data-id="nodeId"\n\t\t\t:class="nodeClass"\n\t\t\t:data-title="nodeDataTitle"\n\t\t\tclass="humanresources-tree__node"\n\t\t\t:style="{\n\t\t\t\t'--team-bubble-background': nodeData.teamColor?.bubbleBackground,\n\t\t\t\t'--team-focused-border-color': nodeData.teamColor?.focusedBorderColor,\n\t\t\t\t'--node-expanded-color': nodeData.teamColor?.expandedBorderColor,\n\t\t\t}"\n\t\t>\n\t\t\t<div\n\t\t\t\tclass="humanresources-tree__node_summary"\n\t\t\t\t@click.stop="onDepartmentClick('department')"\n\t\t\t>\n\t\t\t\t<template v-if="showInfo">\n\t\t\t\t\t<div\n\t\t\t\t\t\tclass="humanresources-tree__node_department"\n\t\t\t\t\t\t:style="{ 'background-color': nodeData.teamColor?.treeHeadBackground}"\n\t\t\t\t\t>\n\t\t\t\t\t\t<div class="humanresources-tree__node_department-title">\n\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\tv-if="nodeData.parentId !== 0 && showDnd"\n\t\t\t\t\t\t\t\tclass="humanresources-tree__node_dnd-icon ui-icon-set --more-points"\n\t\t\t\t\t\t\t\t:class="{ '--team': isTeamEntity }"\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t<span\n\t\t\t\t\t\t\t\tv-hint\n\t\t\t\t\t\t\t\tclass="humanresources-tree__node_department-title_text"\n\t\t\t\t\t\t\t\t:class="{ '--no-dnd': !showDnd }"\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t{{nodeData.name}}\n\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t<div class="humanresources-tree__node_department-menu-icons">\n\t\t\t\t\t\t\t<DepartmentInfoIconButton\n\t\t\t\t\t\t\t\tv-if="isTeamEntity"\n\t\t\t\t\t\t\t\t:description="nodeData.description"\n\t\t\t\t\t\t\t\t:entityId="nodeId"\n\t\t\t\t\t\t\t\t:canvasZoom="canvasZoom"\n\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t<DepartmentMenuButton\n\t\t\t\t\t\t\t\tv-if="head && deputy"\n\t\t\t\t\t\t\t\t:entityId="nodeId"\n\t\t\t\t\t\t\t\t:entityType="nodeData.entityType"\n\t\t\t\t\t\t\t></DepartmentMenuButton>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class="humanresources-tree__node_description">\n\t\t\t\t\t\t<HeadList v-if="head" :items="head" :isTeamEntity="isTeamEntity"></HeadList>\n\t\t\t\t\t\t<div\n\t\t\t\t\t\t\tv-else\n\t\t\t\t\t\t\tclass="humanresources-tree__node_load-skeleton --heads"\n\t\t\t\t\t\t></div>\n\t\t\t\t\t\t<div v-if="deputy" class="humanresources-tree__node_employees">\n\t\t\t\t\t\t\t<div>\n\t\t\t\t\t\t\t\t<p class="humanresources-tree__node_employees-title">\n\t\t\t\t\t\t\t\t\t{{\n\t\t\t\t\t\t\t\t\t\tisTeamEntity\n\t\t\t\t\t\t\t\t\t\t\t? loc('HUMANRESOURCES_COMPANY_STRUCTURE_TREE_TEAM_EMPLOYEES_TITLE')\n\t\t\t\t\t\t\t\t\t\t\t: loc('HUMANRESOURCES_COMPANY_STRUCTURE_TREE_EMPLOYEES_TITLE')\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t</p>\n\t\t\t\t\t\t\t\t<span\n\t\t\t\t\t\t\t\t\tclass="humanresources-tree__node_employees-count"\n\t\t\t\t\t\t\t\t\t@click.stop="onDepartmentClick('employees')"\n\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t{{locPlural('HUMANRESOURCES_COMPANY_STRUCTURE_TREE_EMPLOYEES_COUNT', employeeCount)}}\n\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t<div v-if="!deputy.length"></div>\n\t\t\t\t\t\t\t<HeadList\n\t\t\t\t\t\t\t\t:items="deputy"\n\t\t\t\t\t\t\t\t:title="loc('HUMANRESOURCES_COMPANY_STRUCTURE_TREE_DEPUTY_TITLE')"\n\t\t\t\t\t\t\t\t:collapsed="true"\n\t\t\t\t\t\t\t\t:type="'deputy'"\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t</HeadList>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t<div\n\t\t\t\t\t\t\tv-else\n\t\t\t\t\t\t\tclass="humanresources-tree__node_load-skeleton --deputies"\n\t\t\t\t\t\t></div>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div\n\t\t\t\t\t\tclass="humanresources-tree__node_subdivisions"\n\t\t\t\t\t\t:class="subdivisionsClass"\n\t\t\t\t\t\t@click.stop="onDepartmentClick('subdivisions')"\n\t\t\t\t\t>\n\t\t\t\t\t\t<span>{{ subdivisionsText }}</span>\n\t\t\t\t\t</div>\n\t\t\t\t</template>\n\t\t\t\t<svg v-else width="24" height="24" viewBox="0 0 24 24" fill="none" class="humanresources-tree__node_lock">\n\t\t\t\t\t<path d="M12.0646 4.231C13.9529 4.231 15.4836 5.76968 15.4836 7.66775V10.5612H17.2905V7.66775C17.2905 4.76657 14.9507 2.41476 12.0645 2.41476C9.17827 2.41476 6.83847 4.76657 6.83847 7.66775V10.5612H8.64544V7.66775C8.64544 5.76968 10.1762 4.231 12.0646 4.231Z" fill="#D5D7DB"/>\n\t\t\t\t\t<path fill-rule="evenodd" clip-rule="evenodd" d="M7.14721 10.3237C6.12854 10.3237 5.30273 11.1495 5.30273 12.1682V18.506C5.30273 19.5246 6.12854 20.3504 7.14722 20.3504H17.1029C18.1216 20.3504 18.9474 19.5246 18.9474 18.506V12.1682C18.9474 11.1495 18.1216 10.3237 17.1029 10.3237H7.14721ZM12.9216 15.5869C12.9216 15.5685 12.93 15.5512 12.944 15.5392C13.2142 15.3085 13.3859 14.9643 13.3859 14.5797C13.3859 13.8847 12.8259 13.3214 12.1353 13.3214C11.4446 13.3214 10.8846 13.8847 10.8846 14.5797C10.8846 14.9643 11.0563 15.3085 11.3266 15.5392C11.3406 15.5512 11.3489 15.5685 11.3489 15.5869V16.7572C11.3489 17.1915 11.701 17.5435 12.1353 17.5435C12.5696 17.5435 12.9216 17.1915 12.9216 16.7572V15.5869Z" fill="#D5D7DB"/>\n\t\t\t\t</svg>\n\t\t\t\t<SubdivisionAddButton\n\t\t\t\t\tv-if="showSubdivisionAddButton"\n\t\t\t\t\t:entityId="nodeId"\n\t\t\t\t\t:entityType="nodeData.entityType"\n\t\t\t\t\t@click.stop\n\t\t\t\t></SubdivisionAddButton>\n\t\t\t</div>\n\t\t\t<div\n\t\t\t\tv-if="nodeData.parentId === 0 && !hasChildren"\n\t\t\t\tclass="humanresources-tree__node_empty-skeleton"\n\t\t\t></div>\n\t\t\t<div\n\t\t\t\tv-if="hasChildren"\n\t\t\t\tv-dnd="canvasZoom"\n\t\t\t\tref="childrenNode"\n\t\t\t\tclass="humanresources-tree__node_children"\n\t\t\t\t:style="childNodeStyle"\n\t\t\t>\n\t\t\t\t<TransitionGroup>\n\t\t\t\t\t<treeNode\n\t\t\t\t\t\tv-for="id in nodeData.children"\n\t\t\t\t\t\tv-if="isExpanded || childrenMounted"\n\t\t\t\t\t\tv-show="isExpanded"\n\t\t\t\t\t\t:ref="'node-' + id"\n\t\t\t\t\t\t:key="id"\n\t\t\t\t\t\t:nodeId="id"\n\t\t\t\t\t\t:expandedNodes="expandedNodes"\n\t\t\t\t\t\t:canvasZoom="canvasZoom"\n\t\t\t\t\t\t:currentDepartments="currentDepartments"\n\t\t\t\t\t\t:isShown="isExpanded"\n\t\t\t\t\t\t@calculatePosition="calculatePosition"\n\t\t\t\t\t/>\n\t\t\t\t</TransitionGroup>\n\t\t\t</div>\n\t\t</div>\n\t`};const Et={name:"companyTreeConnectors",expose:["toggleConnectorsVisibility","toggleConnectorHighlighting","adaptConnectorsAfterReorder"],props:{isLocatedDepartmentVisible:{type:Boolean,required:true},treeNodes:{type:Object,required:true}},data(){return{connectors:{}}},computed:{...c.mapState(T.useChartStore,["focusedNode","departments"])},created(){this.subscribeOnEvents();this.prevWindowWidth=window.innerWidth},beforeUnmount(){this.unsubscribeFromEvents()},methods:{onAddConnector({data:t}){var e;const{id:n,parentId:s}=t;if(!s){return}const i=(e=this.connectors[`${s}-${n}`])!=null?e:{};Object.assign(i,t);if(i.highlighted){delete this.connectors[`${s}-${n}`]}this.connectors[`${s}-${n}`]={show:true,highlighted:false,...i}},onRemoveConnector({data:t}){const{parentId:e,id:n}=t;delete this.connectors[`${e}-${n}`]},onAdaptSiblingConnectors({data:t}){const{nodeId:e,parentId:n,offset:s}=t;const i=this.departments.get(n);if(i.children.includes(e)){this.adaptConnectorsAfterMount(n,e,s);return}this.adaptConnectorsAfterUnmount(n,e,s)},adaptConnectorsAfterMount(t,e,n){Object.values(this.connectors).forEach((e=>{if(!e.id){return}if(e.parentId===t){const{x:t}=e.endPoint;Object.assign(e.endPoint,{x:t+n});return}if(e.parentsPath.includes(t)){const{startPoint:t,endPoint:s}=e;Object.assign(t,{x:t.x+n});Object.assign(s,{x:s.x+n})}}))},adaptConnectorsAfterUnmount(t,e,n){const s=Object.values(this.connectors);const{endPoint:i}=this.connectors[`${t}-${e}`];const o=s.reduce(((n,s)=>{const{endPoint:o,id:r,parentId:a}=s;if(a!==t||r===e){return n}const c=i.x>o.x?1:-1;return{...n,[r]:c}}),{});s.forEach((s=>{const{id:i,parentId:r,parentsPath:a,endPoint:c,startPoint:d}=s;if(i===e){return}if(r===t){const{x:t}=c;const e=o[i];Object.assign(c,{x:t+n*e});return}const l=a==null?void 0:a.find((t=>Boolean(o[t])));if(l){const t=o[l];Object.assign(d,{x:d.x+n*t});Object.assign(c,{x:c.x+n*t})}}))},adaptConnectorsAfterReorder(t,e,n){t.forEach((t=>{const{parentId:s,children:i}=this.departments.get(t);const o=this.connectors[`${s}-${t}`];if(!o){return}Object.assign(o.endPoint,{x:o.endPoint.x+e});if(!n){Object.assign(o.startPoint,{x:o.startPoint.x+e})}if((i==null?void 0:i.length)>0){this.adaptConnectorsAfterReorder(i,e,false)}}))},onAdaptConnectorHeight({data:t}){const{shift:e,nodeId:n}=t;Object.values(this.connectors).forEach((t=>{if(t.parentId===n){Object.assign(t.startPoint,{y:t.startPoint.y+e})}}))},toggleConnectorsVisibility(t,e,n){const{children:s}=this.departments.get(t);s.forEach((s=>{var i;const o=(i=this.connectors[`${t}-${s}`])!=null?i:{};this.connectors={...this.connectors,[`${t}-${s}`]:{...o,show:e}};if(n.includes(s)){this.toggleConnectorsVisibility(s,e,n)}}))},toggleConnectorHighlighting(t,e){var n;const{parentId:s}=this.departments.get(t);if(!s){return}if(!e){this.connectors[`${s}-${t}`]={...this.connectors[`${s}-${t}`],highlighted:false};return}const i=(n=this.connectors[`${s}-${t}`])!=null?n:{};delete this.connectors[`${s}-${t}`];this.connectors={...this.connectors,[`${s}-${t}`]:{...i,highlighted:true}}},getPath(t){const e=this.connectors[t];const{startPoint:n,endPoint:s,parentId:i}=e;if(!n||!s){return""}let o=115;const r=this.treeNodes.get(i);const a=getComputedStyle(r);const c=parseInt(a.getPropertyValue("--min-height"),10);const d=r.offsetHeight-c;o=d>0?o-d:o;const l=1;const u=n.y-l;const E=this.focusedNode===e.id?12:0;const _={start:"",end:""};let h=0;if(Math.round(n.x)>Math.round(s.x)){h=15;_.start="a15,15 0 0 1 -15,15";_.end="a15,15 0 0 0 -15,15"}else if(Math.round(n.x)<Math.round(s.x)){h=-15;_.start="a15,15 0 0 0 15,15";_.end="a15,15 0 0 1 15,15"}const m=s.y-E;return[`M${n.x} ${u}`,`V${u+o}`,`${String(_.start)}`,`H${s.x+h}`,`${String(_.end)}`,`V${m}`].join("")},subscribeOnEvents(){this.events={[g.HR_DEPARTMENT_CONNECT]:this.onAddConnector,[g.HR_DEPARTMENT_DISCONNECT]:this.onRemoveConnector,[g.HR_DEPARTMENT_ADAPT_SIBLINGS]:this.onAdaptSiblingConnectors,[g.HR_DEPARTMENT_ADAPT_CONNECTOR_HEIGHT]:this.onAdaptConnectorHeight};Object.entries(this.events).forEach((([t,e])=>{I.EventEmitter.subscribe(t,e)}));U.Event.bind(window,"resize",this.onResizeWindow)},unsubscribeFromEvents(){Object.entries(this.events).forEach((([t,e])=>{I.EventEmitter.unsubscribe(t,e)}));U.Event.unbind(window,"resize",this.onResizeWindow)},onResizeWindow(){const t=(window.innerWidth-this.prevWindowWidth)/2;this.prevWindowWidth=window.innerWidth;if(t===0){return}Object.keys(this.connectors).forEach((e=>{const n=this.connectors[e];if(n.startPoint&&n.endPoint){const e=n.startPoint.x;const s=n.endPoint.x;Object.assign(n.startPoint,{x:e+t});Object.assign(n.endPoint,{x:s+t})}}))}},template:`\n\t\t<svg class="humanresources-tree__connectors" fill="none">\n\t\t\t<marker\n\t\t\t\tid='arrow'\n\t\t\t\tmarkerUnits='userSpaceOnUse'\n\t\t\t\tmarkerWidth='20'\n\t\t\t\tmarkerHeight='12'\n\t\t\t\trefX='10'\n\t\t\t\trefY='10.5'\n\t\t\t>\n\t\t\t\t<path d="M1 1L10 10L19 1" class="--highlighted" />\n\t\t\t</marker>\n\t\t\t<path\n\t\t\t\tv-for="(connector, id) in connectors"\n\t\t\t\tv-show="connector.show"\n\t\t\t\t:ref="id"\n\t\t\t\t:marker-end="connector.highlighted ? 'url(#arrow)' : null"\n\t\t\t\t:class="{ '--highlighted': connector.highlighted }"\n\t\t\t\t:id="id"\n\t\t\t\t:d="getPath(id)"\n\t\t\t></path>\n\t\t</svg>\n\t`};const _t=t=>{const e=new Map;t.forEach((t=>{var n,s,i;const{id:o,parentId:r,colorName:a,entityType:c}=t;const d=(n=e.get(o))!=null?n:{};const l=S.getNodeColorSettings(a,c);e.set(o,{...d,...t,teamColor:l});if(r===0){return}const u=(s=e.get(r))!=null?s:{};const E=(i=u.children)!=null?i:[];e.set(r,{...u,children:[...E,o]})}));return e};const ht={removeDepartment:t=>l.getData("humanresources.api.Structure.Node.delete",{nodeId:t}),getDepartmentsData:()=>l.getData("humanresources.api.Structure.get",{},{tool:"structure",category:"structure",event:"open_structure"}),getCurrentDepartments:()=>l.getData("humanresources.api.Structure.Node.current"),getDictionary:()=>l.getData("humanresources.api.Structure.dictionary"),getUserId:()=>l.getData("humanresources.api.User.getCurrentId"),firstTimeOpened:()=>l.postData("humanresources.api.User.firstTimeOpen"),createTreeDataStore:_t};const mt={name:"companyTree",components:{TreeNode:ut,Connectors:Et},provide(){return{getTreeBounds:()=>this.getTreeBounds()}},props:{canvasZoom:{type:Number,required:true}},emits:["moveTo","showWizard","controlDetail"],data(){return{expandedNodes:[],isLocatedDepartmentVisible:false}},computed:{rootId(){const{id:t}=[...this.departments.values()].find((t=>t.parentId===0));return t},connectors(){return this.$refs.connectors},...c.mapState(T.useChartStore,["currentDepartments","userId","focusedNode","departments"])},created(){this.treeNodes=new Map;this.subscribeOnEvents();this.loadHeads([this.rootId])},mounted(){const t=this.getDepartmentIdForInitialFocus();this.currentDepartmentsLocated=[t];if(t!==this.rootId){this.expandDepartmentParents(t);this.focus(t,{expandAfterFocus:true});return}this.expandLowerDepartments();this.focus(t)},beforeUnmount(){this.unsubscribeFromEvents()},methods:{getDepartmentIdForInitialFocus(){const t=x.getParams().focusNodeId;if(t){const e=this.departments.get(t);if(e){return t}}for(const t of this.currentDepartments){const e=this.departments.get(t);if(e.entityType===S.EntityTypes.department){return t}}return this.rootId},loc(t,e={}){return this.$Bitrix.Loc.getMessage(t,e)},getTreeBounds(){return this.$el.getBoundingClientRect()},onConnectDepartment({data:t}){const{id:e,html:n}=t;this.treeNodes.set(e,n);const s=this.getDepartmentIdForInitialFocus();if(e===s){const t=1800;U.Runtime.debounce((()=>{this.moveTo(s)}),t)()}},onDisconnectDepartment({data:t}){const{id:e}=t;const n=this.departments.get(e);delete n.prevParentId;if(!n.parentId){O.removeDepartment(e)}},onDragDepartment({data:t}){const{draggedId:e}=t;const n=this.departments.get(e);const{parentId:s}=n;const i=this.departments.get(s);i.children.forEach((t=>{if(this.expandedNodes.includes(t)){this.collapse(t)}}))},onToggleConnectors({data:t}){const{draggedId:e,shouldShow:n}=t;const s=this.departments.get(e);const{parentId:i}=s;this.connectors.toggleConnectorsVisibility(i,n,this.expandedNodes)},async onDropDepartment({data:t}){const{draggedId:e,targetId:n,affectedItems:s,direction:i}=t;const o=O.orderDepartments(e,n,i,s.length);const r=302;const a=s.length*i*r;this.connectors.adaptConnectorsAfterReorder([e],a,true);const c=-i*r;this.connectors.adaptConnectorsAfterReorder(s,c,true);const d=await o;if(!d){this.connectors.adaptConnectorsAfterReorder([e],-a,true);this.connectors.adaptConnectorsAfterReorder(s,-c,true)}},onPublicFocusNode({data:t}){const{nodeId:e}=t;const n=this.departments.get(e);if(!n){return}void this.locateToDepartment(e)},collapse(t){this.expandedNodes=this.expandedNodes.filter((e=>e!==t));this.connectors.toggleConnectorsVisibility(t,false,this.expandedNodes);this.connectors.toggleConnectorHighlighting(t,false)},collapseRecursively(t){const e=t=>{var n;this.collapse(t);const s=this.departments.get(t);(n=s.children)==null?void 0:n.forEach((t=>{if(this.expandedNodes.includes(t)){e(t)}}))};const{parentId:n}=this.departments.get(t);const s=this.expandedNodes.find((t=>{const e=this.departments.get(t);return e.parentId===n}));if(s){e(s)}},expand(t){this.collapseRecursively(t);this.expandedNodes=[...this.expandedNodes,t];this.connectors.toggleConnectorsVisibility(t,true,this.expandedNodes);this.connectors.toggleConnectorHighlighting(t,true);const e=this.departments.get(t);const n=e.children.filter((t=>!this.departments.get(t).heads));if(n.length>0){this.loadHeads(n)}C.sendData({tool:"structure",category:"structure",event:"expand_department"})},focus(t,e={}){var n;const{expandAfterFocus:s=false,showEmployees:i=false,subdivisionsSelected:o=false}=e;const r=((n=this.departments.get(t).children)==null?void 0:n.length)>0;let a=s||!this.expandedNodes.includes(t);if(i){a=this.expandedNodes.includes(t)}if(o||!r){this.collapseRecursively(t)}if(r&&a){this.expand(t)}if(this.focusedNode&&!this.expandedNodes.includes(this.focusedNode)){this.connectors.toggleConnectorHighlighting(this.focusedNode,false)}O.focusDepartment(t);this.connectors.toggleConnectorHighlighting(this.focusedNode,true)},onFocusDepartment({data:t}){const{nodeId:e,showEmployees:n,subdivisionsSelected:s}=t;this.focus(e,{showEmployees:n,subdivisionsSelected:s});this.$emit("controlDetail",{showEmployees:n,preventSwitch:s})},tryRemoveDepartment(t,e){const n={team:{title:this.loc("HUMANRESOURCES_COMPANY_STRUCTURE_CONFIRM_REMOVE_TEAM_TITLE"),message:this.loc("HUMANRESOURCES_COMPANY_STRUCTURE_CONFIRM_REMOVE_TEAM_MESSAGE"),success:this.loc("HUMANRESOURCES_COMPANY_STRUCTURE_CONFIRM_REMOVE_TEAM_REMOVED"),error:this.loc("HUMANRESOURCES_COMPANY_STRUCTURE_CONFIRM_REMOVE_TEAM_ERROR")},default:{title:this.loc("HUMANRESOURCES_COMPANY_STRUCTURE_CONFIRM_REMOVE_DEPARTMENT_TITLE"),message:this.loc("HUMANRESOURCES_COMPANY_STRUCTURE_CONFIRM_REMOVE_DEPARTMENT_MESSAGE"),success:this.loc("HUMANRESOURCES_COMPANY_STRUCTURE_CONFIRM_REMOVE_DEPARTMENT_REMOVED"),error:this.loc("HUMANRESOURCES_COMPANY_STRUCTURE_CONFIRM_REMOVE_DEPARTMENT_ERROR")}};const s=e===S.EntityTypes.team?"team":"default";const i=o.MessageBox.create({title:n[s].title,message:n[s].message,buttons:o.MessageBoxButtons.OK_CANCEL,onOk:async e=>{try{await this.removeDepartment(t);r.UI.Notification.Center.notify({content:n[s].success,autoHideDelay:2e3});e.close()}catch{r.UI.Notification.Center.notify({content:n[s].error,autoHideDelay:2e3})}},onCancel:t=>t.close(),minWidth:250,maxWidth:320,minHeight:175,okCaption:this.loc("HUMANRESOURCES_COMPANY_STRUCTURE_CONFIRM_REMOVE_DEPARTMENT_OK_CAPTION"),popupOptions:{className:"humanresources-tree__message-box",overlay:{opacity:40}}});const a=i.getOkButton();const c=i.getCancelButton();a.setRound(true);c.setRound(true);a.setColor(h.ButtonColor.DANGER);c.setColor(h.ButtonColor.LIGHT_BORDER);i.show()},async removeDepartment(t){await ht.removeDepartment(t);const e=this.departments.get(t);const{parentId:n,children:s=[]}=e;if(s.length>0){this.collapse(t)}O.moveSubordinatesToParent(t);await this.$nextTick();O.markDepartmentAsRemoved(t);this.focus(n,{expandAfterFocus:true});this.moveTo(n)},expandDepartmentParents(t){let{parentId:e}=this.departments.get(t);while(e){if(!this.expandedNodes.includes(e)){this.expand(e)}e=this.departments.get(e).parentId}},expandLowerDepartments(){let t=0;const e=s=>{var i;const{children:o=[]}=this.departments.get(s);if(t===4||o.length===0){return}this.expand(s);t+=1;const r=Math.trunc(o.length/2);const a=o[r];if(((i=this.departments.get(a).children)==null?void 0:i.length)>0){e(a);return}for(let t=r-1;t>=0;t--){if(n(o[t])){return}}for(let t=r+1;t<o.length;t++){if(n(o[t])){return}}};const n=t=>{const{children:n=[]}=this.departments.get(t);if(n.length>0){e(t);return true}return false};e(this.rootId)},async locateToCurrentDepartment(){if(this.currentDepartmentsLocated.length===this.currentDepartments.length){this.currentDepartmentsLocated=[]}const t=this.currentDepartments.find((t=>!this.currentDepartmentsLocated.includes(t)));if(!t){return}this.currentDepartmentsLocated.push(t);await this.locateToDepartment(t);O.searchUserInDepartment(this.userId)},async locateToDepartment(t){this.isLocatedDepartmentVisible=false;this.expandDepartmentParents(t);this.focus(t,{expandAfterFocus:true});await this.$nextTick();this.isLocatedDepartmentVisible=true;await this.moveTo(t)},async moveTo(t){await this.$nextTick();const e=this.getTreeBounds();const n=e.x+e.width/2;const s=e.y+e.height/2;const i=this.treeNodes.get(t);const o=i.getBoundingClientRect();this.$emit("moveTo",{x:n-o.x-o.width/2,y:s-o.y-o.height/2,nodeId:t})},loadHeads(t){const e=T.useChartStore();e.loadHeads(t)},subscribeOnEvents(){this.events={[g.HR_DEPARTMENT_CONNECT]:this.onConnectDepartment,[g.HR_DEPARTMENT_DISCONNECT]:this.onDisconnectDepartment,[g.HR_DEPARTMENT_FOCUS]:this.onFocusDepartment,[g.HR_DRAG_DEPARTMENT]:this.onDragDepartment,[g.HR_DROP_DEPARTMENT]:this.onDropDepartment,[g.HR_DEPARTMENT_TOGGLE_CONNECTORS]:this.onToggleConnectors,[g.HR_PUBLIC_FOCUS_NODE]:this.onPublicFocusNode};Object.entries(this.events).forEach((([t,e])=>{I.EventEmitter.subscribe(t,e)}))},unsubscribeFromEvents(){Object.entries(this.events).forEach((([t,e])=>{I.EventEmitter.unsubscribe(t,e)}))}},template:`\n\t\t<div\n\t\t\tclass="humanresources-tree"\n\t\t\tv-if="departments.size > 0"\n\t\t>\n\t\t\t<TreeNode\n\t\t\t\tclass="--root"\n\t\t\t\t:key="rootId"\n\t\t\t\t:nodeId="rootId"\n\t\t\t\t:expandedNodes="[...expandedNodes]"\n\t\t\t\t:canvasZoom="canvasZoom"\n\t\t\t\t:currentDepartments="currentDepartments"\n\t\t\t></TreeNode>\n\t\t\t<Connectors\n\t\t\t\tref="connectors"\n\t\t\t\t:isLocatedDepartmentVisible="isLocatedDepartmentVisible"\n\t\t\t\t:treeNodes="treeNodes"\n\t\t\t></Connectors>\n\t\t</div>\n\t`};const pt={name:"transform-panel",props:{modelValue:{type:Object,required:true}},emits:["locate","update:modelValue"],data(){return{selectedId:""}},computed:{zoomInPercent(){const t='<span class="humanresources-transform-panel__zoom_percent">%</span>';return`${(this.modelValue.zoom*100).toFixed(0)}${t}`}},created(){this.actions=Object.freeze({zoomIn:"zoomIn",zoomOut:"zoomOut",locate:"locate",navigate:"navigate"})},methods:{loc(t,e={}){return this.$Bitrix.Loc.getMessage(t,e)},onZoom(t){const e=.2;const n=3;let s=-1;if(t){s=1;this.selectedId=this.actions.zoomIn}else{this.selectedId=this.actions.zoomOut}const i=Number((this.modelValue.zoom+e*s).toFixed(1));if(i<e||i>n){return}const o=this.$parent.$refs.tree.getTreeBounds();const r=o.width/2/this.modelValue.zoom-v/2;const a=o.height/2/this.modelValue.zoom;const c=(r-this.modelValue.x)/this.modelValue.zoom;const d=(a-this.modelValue.y)/this.modelValue.zoom;const l=r-c*i;const u=a-d*i;this.$emit("update:modelValue",{...this.modelValue,zoom:i,x:l,y:u})},onLocate(){const{locate:t}=this.actions;this.$emit(t);this.selectedId=t},onfocusout(){this.selectedId=""}},template:`\n\t\t<div class="humanresources-transform-panel" @focusout="onfocusout" tabindex="-1">\n\t\t\t<div\n\t\t\t\tclass="humanresources-transform-panel__locate"\n\t\t\t\t:class="{ '--selected': selectedId === actions.locate }"\n\t\t\t\t@click="onLocate"\n\t\t\t>\n\t\t\t\t{{loc('HUMANRESOURCES_COMPANY_STRUCTURE_TREE_LOCATE')}}\n\t\t\t</div>\n\t\t\t<div class="humanresources-transform-panel__separator"></div>\n\t\t\t<div class="humanresources-transform-panel__zoom">\n\t\t\t\t<svg\n\t\t\t\t\tviewBox="0 0 16 16"\n\t\t\t\t\tfill="none"\n\t\t\t\t\tclass="humanresources-transform-panel__icon --zoom-out"\n\t\t\t\t\t:class="{ '--selected': selectedId === actions.zoomOut }"\n\t\t\t\t\t@click="onZoom(false)"\n\t\t\t\t>\n\t\t\t\t\t<path fill-rule="evenodd" clip-rule="evenodd" d="M4 8.66671V7.33337H7.33333H8.66667H12V8.66671H8.66667H7.33333H4Z" fill="#6A737F"/>\n\t\t\t\t</svg>\n\t\t\t\t<span v-html="zoomInPercent"></span>\n\t\t\t\t<svg\n\t\t\t\t\tviewBox="0 0 16 16"\n\t\t\t\t\tfill="none"\n\t\t\t\t\tclass="humanresources-transform-panel__icon --zoom-in"\n\t\t\t\t\t:class="{ '--selected': selectedId === actions.zoomIn }"\n\t\t\t\t\t@click="onZoom(true)"\n\t\t\t\t>\n\t\t\t\t\t<path fill-rule="evenodd" clip-rule="evenodd" d="M7.83333 4H9.16667V7.33333H12.5V8.66667H9.16667V12H7.83333V8.66667H4.5V7.33333H7.83333V4Z" fill="#6A737F"/>\n\t\t\t\t</svg>\n\t\t\t</div>\n\t\t</div>\n\t`};const Tt={name:"detailPanelCollapsedTitle",props:{title:{type:String,required:true},avatars:{type:Array,required:true}},computed:{maxVisibleAvatarsCount(){return 2},additionalCount(){return this.avatars.length>this.maxVisibleAvatarsCount?this.avatars.length-this.maxVisibleAvatarsCount:0}},template:`\n\t\t<div class="humanresources-detail-panel__collapsed-title">\n\t\t\t<template v-for="(avatar, index) in avatars">\n\t\t\t\t<img\n\t\t\t\t\tv-if="index < this.maxVisibleAvatarsCount"\n\t\t\t\t\t:key="index"\n\t\t\t\t\t:src="encodeURI(avatar)"\n\t\t\t\t\tclass="humanresources-detail-panel__collapsed-title-avatar"\n\t\t\t\t/>\n\t\t\t</template>\n\t\t\t<div\n\t\t\t\tv-if="avatars.length > maxVisibleAvatarsCount"\n\t\t\t\tclass="humanresources-detail-panel__collapsed-title-avatar --additional"\n\t\t\t>\n\t\t\t +{{ additionalCount }}\n\t\t\t</div>\n\t\t\t<div class="humanresources-detail-panel__title">{{ title }}</div>\n\t\t</div>\n\t`};const Rt={name:"detailPanelEditButton",components:{BIcon:p.BIcon,RouteActionMenu:u.RouteActionMenu},props:{entityId:{type:Number,required:true},entityType:{type:String,default:S.EntityTypes.department}},data(){return{menuVisible:false}},computed:{set(){return p.Set},menu(){return new at(this.entityId,this.entityType,l.AnalyticsSourceType.DETAIL)}},methods:{loc(t,e={}){return this.$Bitrix.Loc.getMessage(t,e)},onActionMenuItemClick(t){this.menu.onActionMenuItemClick(t)}},template:`\n\t\t<div\n\t\t\tv-if="menu.items.length"\n\t\t\tclass="humanresources-detail-panel__edit-button"\n\t\t\t:class="{ '--focused': menuVisible }"\n\t\t\t:ref="'detailPanelEditButton'"\n\t\t\tdata-id="hr-department-detail-panel__edit-menu-button"\n\t\t\t@click.stop="menuVisible = true"\n\t\t>\n\t\t\t<BIcon\n\t\t\t\tclass="humanresources-detail-panel__edit-button-icon"\n\t\t\t\t:name="set.MORE"\n\t\t\t\t:size="20"\n\t\t\t/>\n\t\t</div>\n\t\t<RouteActionMenu\n\t\t\tv-if="menuVisible"\n\t\t\tid="department-detail-content-edit-menu"\n\t\t\t:items="menu.items"\n\t\t\t:width="302"\n\t\t\t:bindElement="$refs.detailPanelEditButton"\n\t\t\t@action="onActionMenuItemClick"\n\t\t\t@close="menuVisible = false"\n\t\t/>\n\t`};const Ct={name:"detailPanel",components:{DepartmentContent:d.DepartmentContent,DetailPanelCollapsedTitle:Tt,DetailPanelEditButton:Rt},directives:{hint:u.Hint},props:{preventPanelSwitch:Boolean,modelValue:Boolean},emits:["showWizard","removeDepartment","update:modelValue"],data(){return{title:"",isTeamEntity:false,teamColor:null,isCollapsed:true,isLoading:true,needToShowLoader:false}},computed:{...c.mapState(T.useChartStore,["focusedNode","departments"]),defaultAvatar(){return"/bitrix/js/humanresources/company-structure/org-chart/src/images/default-user.svg"},headAvatarsArray(){var t,e,n;const s=(t=this.departments.get(this.focusedNode).heads)!=null?t:[];return(e=s==null?void 0:(n=s.filter((t=>t.role===this.memberRoles.head)))==null?void 0:n.map((t=>t.avatar||this.defaultAvatar)))!=null?e:[]},entityType(){return this.departments.get(this.focusedNode).entityType},memberRoles(){return l.getMemberRoles(this.entityType)}},watch:{focusedNode(t,e){this.updateDetailPageHandler(t,e)},modelValue(t){this.isCollapsed=t},departments:{handler(t){const e=t.get(this.focusedNode);if(e){var n;this.title=(n=e.name)!=null?n:""}},deep:true}},methods:{toggleCollapse(){this.$emit("update:modelValue",!this.isCollapsed)},updateDetailPageHandler(t,e){var n,s;if(!this.preventPanelSwitch&&e!==0){this.$emit("update:modelValue",false)}this.isLoading=true;const i=this.departments.get(t);this.isTeamEntity=i.entityType===S.EntityTypes.team;this.title=(n=i.name)!=null?n:"";this.teamColor=(s=i.teamColor)!=null?s:null;this.isLoading=false},showLoader(){this.needToShowLoader=true},hideLoader(){this.needToShowLoader=false}},template:`\n\t\t<div\n\t\t\t:class="['humanresources-detail-panel', { '--collapsed': isCollapsed }]"\n\t\t\tv-on="isCollapsed ? { click: toggleCollapse } : {}"\n\t\t\tdata-id="hr-department-detail-panel__container"\n\t\t>\n\t\t\t<div\n\t\t\t\tv-if="!isLoading"\n\t\t\t\tclass="humanresources-detail-panel-container"\n\t\t\t\t:class="{ '--hide': needToShowLoader && !isCollapsed }"\n\t\t\t>\n\t\t\t\t<div class="humanresources-detail-panel__head" \n\t\t\t\t\t :class="{ '--team': isTeamEntity, '--collapsed': isCollapsed }"\n\t\t\t\t\t :style="{ '--team-head-background': teamColor?.treeHeadBackground }"\n\t\t\t\t>\n\t\t\t\t\t<span\n\t\t\t\t\t\tv-if="!isCollapsed"\n\t\t\t\t\t\tv-hint\n\t\t\t\t\t\tclass="humanresources-detail-panel__title"\n\t\t\t\t\t>\n\t\t\t\t\t\t{{ title }}\n\t\t\t\t\t</span>\n\t\t\t\t\t<DetailPanelCollapsedTitle\n\t\t\t\t\t\tv-else\n\t\t\t\t\t\t:title="title"\n\t\t\t\t\t\t:avatars="headAvatarsArray"\n\t\t\t\t\t>\n\t\t\t\t\t</DetailPanelCollapsedTitle>\n\t\t\t\t\t<div class="humanresources-detail-panel__header_buttons_container">\n\t\t\t\t\t\t<DetailPanelEditButton\n\t\t\t\t\t\t\tv-if="!isCollapsed"\n\t\t\t\t\t\t\t:entityId="focusedNode"\n\t\t\t\t\t\t\t:entityType="entityType"\n\t\t\t\t\t\t/>\n\t\t\t\t\t\t<div\n\t\t\t\t\t\t\tclass="humanresources-detail-panel__collapse_button --icon"\n\t\t\t\t\t\t\t@click="toggleCollapse"\n\t\t\t\t\t\t\t:class="{ '--collapsed': isCollapsed }"\n\t\t\t\t\t\t\tdata-id="hr-department-detail-panel__collapse-button"\n\t\t\t\t\t\t/>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t\t<div class="humanresources-detail-panel__content" v-show="!isCollapsed">\n\t\t\t\t\t<DepartmentContent\n\t\t\t\t\t\t@showDetailLoader="showLoader"\n\t\t\t\t\t\t@hideDetailLoader="hideLoader"\n\t\t\t\t\t\t:isCollapsed="isCollapsed"\n\t\t\t\t\t/>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t\t<div v-if="needToShowLoader && !isCollapsed" class="humanresources-detail-panel-loader-container"/>\n\t\t</div>\n\t`};const Mt={name:"FirstPopup",components:{BIcon:p.BIcon},data(){return{show:false,title:"",description:"",subDescription:"",features:[]}},computed:{set(){return p.Set}},async mounted(){this.title=this.loc("HUMANRESOURCES_COMPANY_STRUCTURE_FIRST_OPEN_TITLE");this.description=this.loc("HUMANRESOURCES_COMPANY_STRUCTURE_FIRST_OPEN_DESCRIPTION");this.subDescription=this.loc("HUMANRESOURCES_COMPANY_STRUCTURE_FIRST_OPEN_SUB_DESCRIPTION");this.features=[this.loc("HUMANRESOURCES_COMPANY_STRUCTURE_FIRST_OPEN_FEATURE_1"),this.loc("HUMANRESOURCES_COMPANY_STRUCTURE_FIRST_OPEN_FEATURE_2"),this.loc("HUMANRESOURCES_COMPANY_STRUCTURE_FIRST_OPEN_FEATURE_3"),this.loc("HUMANRESOURCES_COMPANY_STRUCTURE_FIRST_OPEN_FEATURE_4"),this.loc("HUMANRESOURCES_COMPANY_STRUCTURE_FIRST_OPEN_FEATURE_5"),this.loc("HUMANRESOURCES_COMPANY_STRUCTURE_FIRST_OPEN_FEATURE_6"),this.loc("HUMANRESOURCES_COMPANY_STRUCTURE_FIRST_OPEN_FEATURE_7")];const{firstTimeOpened:t}=await ht.getDictionary();this.show=t==="N"&&this.title.length>0},methods:{closePopup(){ht.firstTimeOpened();this.show=false;top.BX.Event.EventEmitter.emit(g.HR_FIRST_POPUP_SHOW)},loc(t,e={}){return this.$Bitrix.Loc.getMessage(t,e)}},template:`\n\t\t<div v-if="show" class="first-popup">\n\t\t\t<div class="first-popup-overlay" @click="closePopup"></div>\n\t\t\t<div class="first-popup-content">\n\t\t\t\t<div class="title">{{ title }}</div>\n\t\t\t\t<div class="first-popup-left">\n\t\t\t\t\t<p class="description">{{ description }}</p>\n\t\t\t\t\t<p class="sub-description">{{ subDescription }}</p>\n\t\t\t\t\t<div class="first-popup-list">\n\t\t\t\t\t\t<div class="first-popup-list-item" v-for="(feature, index) in features" :key="index">\n\t\t\t\t\t\t\t<div class="first-popup-list-item-point">\u2022</div>\n\t\t\t\t\t\t\t<div class="first-popup-list-item-feature">{{ feature }}</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t\t<button class="ui-btn ui-btn-success first-popup-ui-btn" @click="closePopup">\n\t\t\t\t\t\t{{ loc('HUMANRESOURCES_COMPANY_STRUCTURE_FIRST_OPEN_BUTTON_START') }}\n\t\t\t\t\t</button>\n\t\t\t\t</div>\n\t\t\t\t<div class="first-popup-right">\n\t\t\t\t\t<video\n\t\t\t\t\t\tsrc="/bitrix/js/humanresources/company-structure/org-chart/src/components/first-popup/images/preview.webm"\n\t\t\t\t\t\tautoplay\n\t\t\t\t\t\tloop\n\t\t\t\t\t\tmuted\n\t\t\t\t\t\tplaysinline\n\t\t\t\t\t\tclass="first-popup-animation"\n\t\t\t\t\t></video>\n\t\t\t\t</div>\n\t\t\t\t<BIcon :name="set.CROSS_25" :size="24" class="first-popup-close" @click="closePopup"></BIcon>\n\t\t\t</div>\n\t\t</div>\n\t`};const At={components:{TransformCanvas:s.TransformCanvas,Tree:mt,TransformPanel:pt,ChartWizard:R.ChartWizard,FirstPopup:Mt,DetailPanel:Ct,TitlePanel:L},data(){return{canvas:{shown:false,moving:false,modelTransform:{x:0,y:0,zoom:.3}},wizard:{shown:false,isEditMode:false,showEntitySelector:true,entity:"",nodeId:0,source:""},detailPanel:{collapsed:true,preventSwitch:false},initTransitionCompleted:false}},computed:{rootId(){const{id:t}=[...this.departments.values()].find((t=>t.parentId===0));return t},...c.mapState(T.useChartStore,["departments","currentDepartments"])},async created(){const t=BX.SidePanel.Instance.getTopSlider();t==null?void 0:t.showLoader();const[e,n,s]=await Promise.all([ht.getDepartmentsData(),ht.getCurrentDepartments(),ht.getUserId()]);t==null?void 0:t.closeLoader();const i=ht.createTreeDataStore(e);const o=n.filter((t=>i.has(t)));O.applyData(i,o,s);this.rootOffset=100;this.transformCanvas();this.canvas.shown=true;this.showConfetti=false;I.EventEmitter.subscribe(g.HR_DEPARTMENT_SLIDER_ON_MESSAGE,this.handleInviteSliderMessage);BX.PULL.subscribe({type:BX.PullClient.SubscriptionType.Server,moduleId:"humanresources",command:"linkChatsToNodes",callback:t=>this.clearChatLists(t)});I.EventEmitter.subscribe(g.HR_ENTITY_SHOW_WIZARD,this.showWizardEventHandler);I.EventEmitter.subscribe(g.HR_ENTITY_REMOVE,this.removeDepartmentEventHandler)},unmounted(){I.EventEmitter.unsubscribe(g.HR_DEPARTMENT_SLIDER_ON_MESSAGE,this.handleInviteSliderMessage);I.EventEmitter.unsubscribe(g.HR_ENTITY_SHOW_WIZARD,this.showWizardEventHandler);I.EventEmitter.unsubscribe(g.HR_ENTITY_REMOVE,this.removeDepartmentEventHandler)},methods:{onMoveTo({x:t,y:e,nodeId:n}){const{x:s,y:i,zoom:o}=this.canvas.modelTransform;const r=v*o;const a=t-r/2;const c=n===this.rootId?this.rootOffset:e/o;const d=Math.round(a)===Math.round(s)&&Math.round(e)===Math.round(i);this.detailPanel={...this.detailPanel,collapsed:false};if(d){return}this.canvas={...this.canvas,moving:true,modelTransform:{...this.canvas.modelTransform,x:a/o,y:c,zoom:1}};this.onUpdateTransform()},onLocate(t){if(t){this.$refs.tree.locateToDepartment(t);return}this.$refs.tree.locateToCurrentDepartment()},showWizardEventHandler({data:t}){this.onShowWizard(t)},onShowWizard({nodeId:t=0,isEditMode:e=false,type:n,showEntitySelector:s=true,source:i="",entityType:o,refToFocus:r}={}){this.wizard={...this.wizard,shown:true,isEditMode:e,showEntitySelector:s,entity:n,nodeId:t,source:i,entityType:o,refToFocus:r};if(!e&&i!==l.AnalyticsSourceType.HEADER){C.sendData({tool:"structure",category:"structure",event:"create_dept_step1",c_element:i})}switch(n){case"department":C.sendData({tool:"structure",category:"structure",event:"create_dept_step1",c_element:i});break;case"employees":C.sendData({tool:"structure",category:"structure",event:"create_dept_step2",c_element:i});break;case"bindChat":C.sendData({tool:"structure",category:"structure",event:"create_dept_step3",c_element:i});break;case"teamRights":C.sendData({tool:"structure",category:"structure",event:"create_dept_step4",c_element:i});break}},async onModifyTree({id:t,parentId:e,showConfetti:n}){this.showConfetti=n!=null?n:false;const{tree:s}=this.$refs;s.expandDepartmentParents(t);s.focus(t,{expandAfterFocus:true});await this.$nextTick();s.moveTo(t)},onWizardClose(){this.wizard.shown=false},removeDepartmentEventHandler({data:t}){this.onRemoveDepartment(t.nodeId,t.entityType)},onRemoveDepartment(t,e){const{tree:n}=this.$refs;n.tryRemoveDepartment(t,e)},onTransitionEnd(){if(this.canvas.moving){this.initTransitionCompleted=true}this.canvas.moving=false;if(this.showConfetti){n.Confetti.fire({particleCount:300,startVelocity:10,spread:400,ticks:100,origin:{y:.4,x:.37}});this.showConfetti=false}},onControlDetail({showEmployees:t,preventSwitch:e}){this.detailPanel={...this.detailPanel,preventSwitch:e};if(!t){return}this.detailPanel={...this.detailPanel,collapsed:false}},transformCanvas(){const{zoom:t}=this.canvas.modelTransform;const{offsetWidth:e,offsetHeight:n}=this.$el;const[s]=this.currentDepartments;const i=s===this.rootId?this.rootOffset:n/2-n*t/2;this.canvas.modelTransform={...this.canvas.modelTransform,x:e/2-e*t/2,y:i}},onUpdateTransform(){I.EventEmitter.emit(g.INTRANET_USER_MINIPROFILE_CLOSE);I.EventEmitter.emit(g.HR_DEPARTMENT_MENU_CLOSE)},handleInviteSliderMessage(t){const[e]=t.getData();const n=e.getEventId();if(n!=="BX.Intranet.Invitation:onAdd"){return}const{users:s}=e.getData();s.forEach((t=>{const e=S.getInvitedUserData(t);O.inviteUser(e)}))},clearChatLists(t){const e=Object.keys(t).map((t=>Number(t)));O.clearNodesChatLists(e)},onKeyDown(t){if(!this.initTransitionCompleted){t.preventDefault()}}},template:`\n\t\t<div\n\t\t\tclass="humanresources-chart"\n\t\t\t:class="{ '--locked': !initTransitionCompleted }"\n\t\t\t@keydown="onKeyDown"\n\t\t>\n\t\t\t<TitlePanel @showWizard="onShowWizard" @locate="onLocate"></TitlePanel>\n\t\t\t<TransformCanvas\n\t\t\t\tv-if="canvas.shown"\n\t\t\t\tv-slot="{transform}"\n\t\t\t\tv-model="canvas.modelTransform"\n\t\t\t\t@update:modelValue="onUpdateTransform"\n\t\t\t\t:class="{ '--moving': canvas.moving }"\n\t\t\t\t@transitionend="onTransitionEnd"\n\t\t\t>\n\t\t\t\t<Tree\n\t\t\t\t\t:canvasZoom="transform.zoom"\n\t\t\t\t\tref="tree"\n\t\t\t\t\t@moveTo="onMoveTo"\n\t\t\t\t\t@showWizard="onShowWizard"\n\t\t\t\t\t@controlDetail="onControlDetail"\n\t\t\t\t></Tree>\n\t\t\t</TransformCanvas>\n\t\t\t<DetailPanel\n\t\t\t\t@showWizard="onShowWizard"\n\t\t\t\t@removeDepartment="onRemoveDepartment"\n\t\t\t\tv-model="detailPanel.collapsed"\n\t\t\t\t:preventPanelSwitch="detailPanel.preventSwitch"\n\t\t\t></DetailPanel>\n\t\t\t<TransformPanel\n\t\t\t\tv-model="canvas.modelTransform"\n\t\t\t\t@locate="onLocate"\n\t\t\t></TransformPanel>\n\t\t\t<ChartWizard\n\t\t\t\tv-if="wizard.shown"\n\t\t\t\t:nodeId="wizard.nodeId"\n\t\t\t\t:isEditMode="wizard.isEditMode"\n\t\t\t\t:showEntitySelector="wizard.showEntitySelector"\n\t\t\t\t:entity="wizard.entity"\n\t\t\t\t:entityType="wizard.entityType"\n\t\t\t\t:source="wizard.source"\n\t\t\t\t:refToFocus="wizard.refToFocus"\n\t\t\t\t@modifyTree="onModifyTree"\n\t\t\t\t@close="onWizardClose"\n\t\t\t></ChartWizard>\n\t\t\t<FirstPopup></FirstPopup>\n\t\t\t<div class="humanresources-chart__back"></div>\n\t\t</div>\n\t`};class St extends q{constructor(t,e,n,s){super(t);this.analyticSource=e;this.role=n;this.entityType=s;this.items=this.getFilteredItems()}getItems(){return[new st(this.entityType,this.role),new it(this.entityType,this.role)]}}class Nt extends q{constructor(t,e,n,s){super(t);this.entityType=s;this.analyticSource=e;this.role=n;this.items=this.getFilteredItems()}getItems(){if(this.entityType===S.EntityTypes.team){return[new st(this.entityType,this.role)]}return[new ot,new rt,new st(this.entityType,this.role)]}}class It extends K{constructor(t){super({id:J.fireUserFromCompany,title:t?U.Loc.getMessage("HUMANRESOURCES_COMPANY_STRUCTURE_USER_LIST_ACTION_MENU_DELETE_FROM_COMPANY_TITLE"):U.Loc.getMessage("HUMANRESOURCES_COMPANY_STRUCTURE_USER_LIST_ACTION_MENU_FIRE_FROM_COMPANY_TITLE"),description:U.Loc.getMessage("HUMANRESOURCES_COMPANY_STRUCTURE_USER_LIST_ACTION_MENU_FIRE_FROM_COMPANY_SUBTITLE"),bIcon:{name:N.Main.PERSONS_DENY,size:20,color:S.getColorCode("paletteRed40")},permissionAction:t?"":A.PermissionActions.employeeFire,dataTestId:"hr-department-detail-content__user-list_fire-user-from-department"})}hasPermission(t,e){return t.hasPermissionOfAction(this.permissionAction)}}class Ut extends K{constructor(t){const e=t===S.EntityTypes.team?U.Loc.getMessage("HUMANRESOURCES_COMPANY_STRUCTURE_USER_LIST_ACTION_MENU_MOVE_TO_ANOTHER_TEAM_TITLE"):U.Loc.getMessage("HUMANRESOURCES_COMPANY_STRUCTURE_USER_LIST_ACTION_MENU_MOVE_TO_ANOTHER_DEPARTMENT_TITLE");const n=t===S.EntityTypes.team?U.Loc.getMessage("HUMANRESOURCES_COMPANY_STRUCTURE_USER_LIST_ACTION_MENU_MOVE_TO_ANOTHER_TEAM_SUBTITLE"):U.Loc.getMessage("HUMANRESOURCES_COMPANY_STRUCTURE_USER_LIST_ACTION_MENU_MOVE_TO_ANOTHER_DEPARTMENT_SUBTITLE");super({id:J.moveUserToAnotherDepartment,title:e,description:n,bIcon:{name:N.Main.PERSON_ARROW_LEFT_1,size:20,color:S.getColorCode("paletteBlue50")},permissionAction:null,dataTestId:"hr-department-detail-content__user-list_move-from-department"});this.entityType=t}hasPermission(t,e){const n=t.currentUserPermissions;const s=this.entityType===S.EntityTypes.team?A.PermissionActions.teamAddMember:A.PermissionActions.employeeAddToDepartment;const i=this.entityType===S.EntityTypes.team?A.PermissionActions.teamRemoveMember:A.PermissionActions.employeeRemoveFromDepartment;const o=this.entityType===S.EntityTypes.team?n.ACTION_TEAM_MEMBER_ADD:n.ACTION_EMPLOYEE_ADD_TO_DEPARTMENT;const r=this.entityType===S.EntityTypes.team?n.ACTION_TEAM_MEMBER_REMOVE:n.ACTION_EMPLOYEE_REMOVE_FROM_DEPARTMENT;const a=o<r?s:i;return t.hasPermission(a,e)}}class gt extends K{constructor(t){const e=t===S.EntityTypes.team?U.Loc.getMessage("HUMANRESOURCES_COMPANY_STRUCTURE_USER_LIST_ACTION_MENU_REMOVE_FROM_TEAM_TITLE"):U.Loc.getMessage("HUMANRESOURCES_COMPANY_STRUCTURE_USER_LIST_ACTION_MENU_REMOVE_FROM_DEPARTMENT_TITLE");const n=t===S.EntityTypes.team?U.Loc.getMessage("HUMANRESOURCES_COMPANY_STRUCTURE_USER_LIST_ACTION_MENU_REMOVE_FROM_TEAM_SUBTITLE"):U.Loc.getMessage("HUMANRESOURCES_COMPANY_STRUCTURE_USER_LIST_ACTION_MENU_REMOVE_FROM_DEPARTMENT_SUBTITLE");const s=t===S.EntityTypes.team?S.getColorCode("paletteRed40"):S.getColorCode("paletteBlue50");const i=t===S.EntityTypes.team?A.PermissionActions.teamRemoveMember:A.PermissionActions.employeeRemoveFromDepartment;super({id:J.removeUserFromDepartment,title:e,description:n,bIcon:{name:N.Main.TRASH_BIN,size:20,color:s},permissionAction:i,dataTestId:"hr-department-detail-content__user-list_remove-from-department"})}}class vt extends q{constructor(t,e,n){super(t);this.isUserInvited=n;this.entityType=e;this.items=this.getFilteredItems()}getItems(){if(this.entityType===S.EntityTypes.team){return[new Ut(this.entityType),new gt(this.entityType)]}return[new Ut(this.entityType),new gt(this.entityType),new It(this.isUserInvited)]}}let ft=t=>t,Dt;var Ot=babelHelpers.classPrivateFieldLooseKey("subscribeOnEvents");var yt=babelHelpers.classPrivateFieldLooseKey("getNotConvertedStateScreen");class Pt{static async mount(t){const e=document.getElementById(t);U.Dom.append(babelHelpers.classPrivateFieldLooseBase(this,yt)[yt](),e);babelHelpers.classPrivateFieldLooseBase(this,Ot)[Ot]();const n=3e4;this.updateConvertedStatusInterval=setInterval((async()=>{try{await ht.getDictionary()}catch(t){if(t.code==="STRUCTURE_IS_NOT_CONVERTED"){return}if(t.code==="STRUCTURE_ACCESS_DENIED"){clearInterval(this.updateConvertedStatusInterval);window.location.reload()}throw t}clearInterval(this.updateConvertedStatusInterval);window.location.reload()}),n)}}function bt(){const t=t=>{const[e]=t.data;e.denyAction()};const e=()=>{I.EventEmitter.unsubscribe(g.HR_ORG_CHART_CLOSE_BY_ESC,t);I.EventEmitter.unsubscribe(g.HR_ORG_CHART_CLOSE,e);clearInterval(this.updateConvertedStatusInterval)};I.EventEmitter.subscribe(g.HR_ORG_CHART_CLOSE_BY_ESC,t);I.EventEmitter.subscribe(g.HR_ORG_CHART_CLOSE,e)}function Lt(){return U.Tag.render(Dt||(Dt=ft`
			<div class="humanresources-not-converted-state-screen">
				<div class="humanresources-not-converted-state-screen__icon"></div>
				<div class="humanresources-not-converted-state-screen__title">
					${0}
				</div>
				<div class="humanresources-not-converted-state-screen__description">
					${0}
				</div>
			</div>
		`),U.Loc.getMessage("HUMANRESOURCES_COMPANY_STRUCTURE_NOT_CONVERTED_SCREEN_LOADING_TITLE"),U.Loc.getMessage("HUMANRESOURCES_COMPANY_STRUCTURE_NOT_CONVERTED_SCREEN_LOADING_DESCRIPTION"))}Object.defineProperty(Pt,yt,{value:Lt});Object.defineProperty(Pt,Ot,{value:bt});var Ht=babelHelpers.classPrivateFieldLooseKey("subscribeOnEvents");class Bt{static async mount(t){const n=document.getElementById(t);const s=e.BitrixVue.createApp(At);const i=c.createPinia();s.use(i);babelHelpers.classPrivateFieldLooseBase(Bt,Ht)[Ht](s);const o=BX.SidePanel.Instance.getTopSlider();if(o){o.showLoader()}U.Dom.addClass(n,"humanresources-chart__back");await A.PermissionChecker.init();if(o){o.closeLoader()}U.Dom.removeClass(n,"humanresources-chart__back");s.mount(n)}}function wt(t){const e=t=>{const[e]=t.data;e.denyAction()};const n=()=>{I.EventEmitter.unsubscribe(g.HR_ORG_CHART_CLOSE_BY_ESC,e);I.EventEmitter.unsubscribe(g.HR_ORG_CHART_CLOSE,n);t.unmount()};I.EventEmitter.subscribe(g.HR_ORG_CHART_CLOSE_BY_ESC,e);I.EventEmitter.subscribe(g.HR_ORG_CHART_CLOSE,n)}Object.defineProperty(Bt,Ht,{value:wt});t.App=Bt;t.UsersTabActionMenu=St;t.EmptyUsersTabActionMenu=Nt;t.UserListActionMenu=vt;t.MenuActions=J;t.NotConvertedState=Pt})(this.BX.Humanresources.CompanyStructure=this.BX.Humanresources.CompanyStructure||{},BX.Vue3,BX.UI,BX.UI,BX.UI.EntitySelector,BX.UI.Dialogs,BX,BX.Humanresources.CompanyStructure,BX.Vue3.Pinia,BX.Humanresources.CompanyStructure,BX.Humanresources.CompanyStructure,BX.Humanresources.CompanyStructure,BX,BX,BX.UI,BX,BX.UI.IconSet,BX.Humanresources.CompanyStructure,BX.Humanresources.CompanyStructure,BX.UI.Analytics,BX,BX.Humanresources.CompanyStructure,BX.Humanresources.CompanyStructure,BX.UI.IconSet,BX.Event,BX);
//# sourceMappingURL=org-chart.bundle.map.js