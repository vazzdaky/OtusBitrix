this.BX=this.BX||{};(function(exports,ui_counterpanel,main_core,main_core_events){"use strict";var EntityCounterType=function e(){babelHelpers.classCallCheck(this,e)};babelHelpers.defineProperty(EntityCounterType,"UNDEFINED",0);babelHelpers.defineProperty(EntityCounterType,"IDLE",1);babelHelpers.defineProperty(EntityCounterType,"PENDING",2);babelHelpers.defineProperty(EntityCounterType,"OVERDUE",4);babelHelpers.defineProperty(EntityCounterType,"INCOMING_CHANNEL",8);babelHelpers.defineProperty(EntityCounterType,"READY_TODO",16);babelHelpers.defineProperty(EntityCounterType,"CURRENT",20);babelHelpers.defineProperty(EntityCounterType,"ALL_DEADLINE_BASED",7);babelHelpers.defineProperty(EntityCounterType,"ALL",31);babelHelpers.defineProperty(EntityCounterType,"IDLE_NAME","IDLE");babelHelpers.defineProperty(EntityCounterType,"PENDING_NAME","PENDING");babelHelpers.defineProperty(EntityCounterType,"OVERDUE_NAME","OVERDUE");babelHelpers.defineProperty(EntityCounterType,"READY_TODO_NAME","READYTODO");babelHelpers.defineProperty(EntityCounterType,"CURRENT_NAME","CURRENT");babelHelpers.defineProperty(EntityCounterType,"INCOMING_CHANNEL_NAME","INCOMINGCHANNEL");babelHelpers.defineProperty(EntityCounterType,"ALL_DEADLINE_BASED_NAME","ALLDEADLINEBASED");babelHelpers.defineProperty(EntityCounterType,"ALL_NAME","ALL");function _classPrivateMethodInitSpec(e,t){_checkPrivateRedeclaration(e,t);t.add(e)}function _classPrivateFieldInitSpec(e,t,a){_checkPrivateRedeclaration(e,t);t.set(e,a)}function _checkPrivateRedeclaration(e,t){if(t.has(e)){throw new TypeError("Cannot initialize the same private elements twice on an object")}}function _classPrivateMethodGet(e,t,a){if(!t.has(e)){throw new TypeError("attempted to get private field on non-instance")}return a}var _filterManager=new WeakMap;var _fields=new WeakMap;var _isActive=new WeakMap;var _bindEvents=new WeakSet;var _onFilterApply=new WeakSet;var _isFilteredByField=new WeakSet;var EntityCounterFilterManager=function(){function e(){babelHelpers.classCallCheck(this,e);_classPrivateMethodInitSpec(this,_isFilteredByField);_classPrivateMethodInitSpec(this,_onFilterApply);_classPrivateMethodInitSpec(this,_bindEvents);_classPrivateFieldInitSpec(this,_filterManager,{writable:true,value:void 0});_classPrivateFieldInitSpec(this,_fields,{writable:true,value:void 0});_classPrivateFieldInitSpec(this,_isActive,{writable:true,value:false})}babelHelpers.createClass(e,[{key:"bindToFilter",value:function e(){var t=main_core.Type.isObject(BX.Main.filterManager)&&BX.Main.filterManager.hasOwnProperty("getList")?BX.Main.filterManager.getList():Object.values(BX.Main.filterManager.data);if(t.length===0){babelHelpers.classPrivateFieldSet(this,_isActive,false);console.warn("BX.Crm.EntityCounterFilter: Unable to define filter.")}else{babelHelpers.classPrivateFieldSet(this,_isActive,true);babelHelpers.classPrivateFieldSet(this,_filterManager,t[0]);_classPrivateMethodGet(this,_bindEvents,_bindEvents2).call(this);this.updateFields()}}},{key:"getManager",value:function e(){return babelHelpers.classPrivateFieldGet(this,_filterManager)}},{key:"isActive",value:function e(){return babelHelpers.classPrivateFieldGet(this,_isActive)}},{key:"getFields",value:function e(){var t=this;var a=arguments.length>0&&arguments[0]!==undefined?arguments[0]:false;if(a){var i=Object.entries(babelHelpers.classPrivateFieldGet(this,_fields)).filter((function(e){var a=babelHelpers.slicedToArray(e,2),i=a[0],r=a[1];return _classPrivateMethodGet(t,_isFilteredByField,_isFilteredByField2).call(t,i)}));return Object.fromEntries(i)}return babelHelpers.classPrivateFieldGet(this,_fields)}},{key:"getApi",value:function e(){return babelHelpers.classPrivateFieldGet(this,_filterManager).getApi()}},{key:"updateFields",value:function e(){babelHelpers.classPrivateFieldSet(this,_fields,babelHelpers.classPrivateFieldGet(this,_filterManager).getFilterFieldsValues())}},{key:"isFilteredByFieldEx",value:function e(t){if(!Object.keys(babelHelpers.classPrivateFieldGet(this,_fields)).includes(t)||t.endsWith("_datesel")||t.endsWith("_numsel")||t.endsWith("_label")){return false}return _classPrivateMethodGet(this,_isFilteredByField,_isFilteredByField2).call(this,t)}},{key:"isFiltered",value:function t(a,i,r,l,s){var n=this;if(a===0||i===EntityCounterType.UNDEFINED){return false}var c=this.isFilteredByFieldEx(s)&&main_core.Type.isArray(babelHelpers.classPrivateFieldGet(this,_fields)[s])&&babelHelpers.classPrivateFieldGet(this,_fields)[s].length===1&&(l?babelHelpers.classPrivateFieldGet(this,_fields)[s][0]===e.FILTER_OTHER_USERS:parseInt(babelHelpers.classPrivateFieldGet(this,_fields)[s][0],10)===a);var o=this.isFilteredByFieldEx(e.COUNTER_TYPE_FIELD)&&main_core.Type.isObject(babelHelpers.classPrivateFieldGet(this,_fields)[e.COUNTER_TYPE_FIELD]);var d=o?Object.values(babelHelpers.classPrivateFieldGet(this,_fields)[e.COUNTER_TYPE_FIELD]).map((function(e){return parseInt(e,10)})).sort():[];var b=d.length===1&&d[0]===i||d.length===2&&i===EntityCounterType.CURRENT&&d[0]===EntityCounterType.READY_TODO&&d[1]===EntityCounterType.OVERDUE;var _=[s,e.COUNTER_TYPE_FIELD].concat(babelHelpers.toConsumableArray(e.EXCLUDED_FIELDS));var p=Object.keys(babelHelpers.classPrivateFieldGet(this,_fields));var u=_.filter((function(e){return!p.includes(e)})).concat(p.filter((function(e){return!_.includes(e)})));var v=u.some((function(e){return n.isFilteredByFieldEx(e)}));return c&&b&&!v}}]);return e}();function _bindEvents2(){main_core_events.EventEmitter.subscribe("BX.Main.Filter:apply",_classPrivateMethodGet(this,_onFilterApply,_onFilterApply2).bind(this))}function _onFilterApply2(){this.updateFields()}function _isFilteredByField2(e){if(main_core.Type.isArray(babelHelpers.classPrivateFieldGet(this,_fields)[e])){return babelHelpers.classPrivateFieldGet(this,_fields)[e].length>0}if(main_core.Type.isObject(babelHelpers.classPrivateFieldGet(this,_fields)[e])){return Object.values(babelHelpers.classPrivateFieldGet(this,_fields)[e]).length>0}return babelHelpers.classPrivateFieldGet(this,_fields)[e]!==""}babelHelpers.defineProperty(EntityCounterFilterManager,"COUNTER_TYPE_FIELD","ACTIVITY_COUNTER");babelHelpers.defineProperty(EntityCounterFilterManager,"EXCLUDED_FIELDS",["FIND"]);babelHelpers.defineProperty(EntityCounterFilterManager,"FILTER_OTHER_USERS","other-users");function _classPrivateMethodInitSpec$1(e,t){_checkPrivateRedeclaration$1(e,t);t.add(e)}function _classPrivateFieldInitSpec$1(e,t,a){_checkPrivateRedeclaration$1(e,t);t.set(e,a)}function _checkPrivateRedeclaration$1(e,t){if(t.has(e)){throw new TypeError("Cannot initialize the same private elements twice on an object")}}function _classPrivateMethodGet$1(e,t,a){if(!t.has(e)){throw new TypeError("attempted to get private field on non-instance")}return a}var _id=new WeakMap;var _entityTypeId=new WeakMap;var _codes=new WeakMap;var _extras=new WeakMap;var _withExcludeUsers=new WeakMap;var _counterData=new WeakMap;var _isRequestRunning=new WeakMap;var _lastPullEventData=new WeakMap;var _isTabActive=new WeakMap;var _openedSlidersCount=new WeakMap;var _onPullEvent=new WeakSet;var _tryRecalculate=new WeakSet;var _startRecalculationRequest=new WeakSet;var _onRecalculationSuccess=new WeakSet;var _fetchCounterData=new WeakSet;var _isRecalculationRequired=new WeakSet;var EntityCounterManager=function(){function e(t){babelHelpers.classCallCheck(this,e);_classPrivateMethodInitSpec$1(this,_isRecalculationRequired);_classPrivateMethodInitSpec$1(this,_fetchCounterData);_classPrivateMethodInitSpec$1(this,_onRecalculationSuccess);_classPrivateMethodInitSpec$1(this,_startRecalculationRequest);_classPrivateMethodInitSpec$1(this,_tryRecalculate);_classPrivateMethodInitSpec$1(this,_onPullEvent);_classPrivateFieldInitSpec$1(this,_id,{writable:true,value:void 0});_classPrivateFieldInitSpec$1(this,_entityTypeId,{writable:true,value:void 0});_classPrivateFieldInitSpec$1(this,_codes,{writable:true,value:void 0});_classPrivateFieldInitSpec$1(this,_extras,{writable:true,value:void 0});_classPrivateFieldInitSpec$1(this,_withExcludeUsers,{writable:true,value:false});_classPrivateFieldInitSpec$1(this,_counterData,{writable:true,value:void 0});_classPrivateFieldInitSpec$1(this,_isRequestRunning,{writable:true,value:void 0});_classPrivateFieldInitSpec$1(this,_lastPullEventData,{writable:true,value:void 0});_classPrivateFieldInitSpec$1(this,_isTabActive,{writable:true,value:void 0});_classPrivateFieldInitSpec$1(this,_openedSlidersCount,{writable:true,value:void 0});if(!main_core.Type.isPlainObject(t)){throw new TypeError('BX.Crm.EntityCounterManager: The "options" argument must be object.')}babelHelpers.classPrivateFieldSet(this,_id,main_core.Type.isString(t.id)?t.id:"");if(babelHelpers.classPrivateFieldGet(this,_id)===""){throw new RangeError('BX.Crm.EntityCounterManager: The "id" argument must be specified.')}babelHelpers.classPrivateFieldSet(this,_entityTypeId,t.entityTypeId?main_core.Text.toInteger(t.entityTypeId):0);babelHelpers.classPrivateFieldSet(this,_codes,main_core.Type.isArray(t.codes)?t.codes:[]);babelHelpers.classPrivateFieldSet(this,_extras,main_core.Type.isObject(t.extras)?t.extras:{});babelHelpers.classPrivateFieldSet(this,_withExcludeUsers,main_core.Type.isBoolean(t.withExcludeUsers)?t.withExcludeUsers:false);babelHelpers.classPrivateFieldSet(this,_counterData,{});babelHelpers.classPrivateFieldSet(this,_isTabActive,true);babelHelpers.classPrivateFieldSet(this,_openedSlidersCount,0);this.constructor.lastInstance=this}babelHelpers.createClass(e,[{key:"bindEvents",value:function e(){var t=this;main_core_events.EventEmitter.subscribe("onPullEvent-main",main_core.Runtime.debounce(_classPrivateMethodGet$1(this,_onPullEvent,_onPullEvent2),3e3,this));main_core.Event.ready((function(){main_core.Event.bind(document,"visibilitychange",(function(){babelHelpers.classPrivateFieldSet(t,_isTabActive,document.visibilityState==="visible");if(babelHelpers.classPrivateFieldGet(t,_isTabActive)&&_classPrivateMethodGet$1(t,_isRecalculationRequired,_isRecalculationRequired2).call(t)){_classPrivateMethodGet$1(t,_tryRecalculate,_tryRecalculate2).call(t,babelHelpers.classPrivateFieldGet(t,_lastPullEventData))}}))}));main_core_events.EventEmitter.subscribe("SidePanel.Slider:onOpen",(function(){var e,a;babelHelpers.classPrivateFieldSet(t,_openedSlidersCount,(e=babelHelpers.classPrivateFieldGet(t,_openedSlidersCount),a=e++,e)),a;babelHelpers.classPrivateFieldSet(t,_isTabActive,false)}));main_core_events.EventEmitter.subscribe("SidePanel.Slider:onClose",(function(){var e,a;babelHelpers.classPrivateFieldSet(t,_openedSlidersCount,(e=babelHelpers.classPrivateFieldGet(t,_openedSlidersCount),a=e--,e)),a;if(babelHelpers.classPrivateFieldGet(t,_openedSlidersCount)<=0){babelHelpers.classPrivateFieldSet(t,_openedSlidersCount,0);babelHelpers.classPrivateFieldSet(t,_isTabActive,true);if(_classPrivateMethodGet$1(t,_isRecalculationRequired,_isRecalculationRequired2).call(t)){_classPrivateMethodGet$1(t,_tryRecalculate,_tryRecalculate2).call(t,babelHelpers.classPrivateFieldGet(t,_lastPullEventData))}}}))}},{key:"getId",value:function e(){return babelHelpers.classPrivateFieldGet(this,_id)}},{key:"getCounterData",value:function e(){return babelHelpers.classPrivateFieldGet(this,_counterData)}},{key:"setCounterData",value:function e(t){babelHelpers.classPrivateFieldSet(this,_counterData,t)}}],[{key:"getLastInstance",value:function e(){return this.lastInstance}}]);return e}();function _onPullEvent2(e){var t=e.getData(),a=babelHelpers.slicedToArray(t,2),i=a[0],r=a[1];if(i!=="user_counter"){return}babelHelpers.classPrivateFieldSet(this,_lastPullEventData,r);if(!babelHelpers.classPrivateFieldGet(this,_isTabActive)){return}_classPrivateMethodGet$1(this,_tryRecalculate,_tryRecalculate2).call(this,r)}function _tryRecalculate2(e){var t=false;var a=false;var i=_classPrivateMethodGet$1(this,_fetchCounterData,_fetchCounterData2).call(this,e);for(var r in i){if(!Object.hasOwn(i,r)||!babelHelpers.classPrivateFieldGet(this,_codes).includes(r)){continue}var l=BX.prop.getInteger(i,r,0);if(l<0){a=true;break}var s=BX.prop.getInteger(babelHelpers.classPrivateFieldGet(this,_counterData),r,0);if(s!==l){t=true;babelHelpers.classPrivateFieldGet(this,_counterData)[r]=l}}if(a){_classPrivateMethodGet$1(this,_startRecalculationRequest,_startRecalculationRequest2).call(this)}if(t){main_core_events.EventEmitter.emit(this,"BX.Crm.EntityCounterManager:onRecalculate")}}function _startRecalculationRequest2(){if(babelHelpers.classPrivateFieldGet(this,_isRequestRunning)){return}if(!babelHelpers.classPrivateFieldGet(this,_isTabActive)){return}babelHelpers.classPrivateFieldSet(this,_isRequestRunning,true);var e={entityTypeId:babelHelpers.classPrivateFieldGet(this,_entityTypeId),extras:babelHelpers.classPrivateFieldGet(this,_extras),withExcludeUsers:babelHelpers.classPrivateFieldGet(this,_withExcludeUsers)?1:0};void main_core.ajax.runAction("crm.counter.list",{data:e}).then(_classPrivateMethodGet$1(this,_onRecalculationSuccess,_onRecalculationSuccess2).bind(this))}function _onRecalculationSuccess2(e){babelHelpers.classPrivateFieldSet(this,_isRequestRunning,false);var t=main_core.Type.isPlainObject(e.data)?e.data:null;if(t===null){return}this.setCounterData(t);main_core_events.EventEmitter.emit("BX.Crm.EntityCounterManager:onRecalculate",this)}function _fetchCounterData2(e){var t=main_core.Loc.getMessage("SITE_ID");return main_core.Type.isPlainObject(e[t])?e[t]:{}}function _isRecalculationRequired2(){if(!babelHelpers.classPrivateFieldGet(this,_lastPullEventData)){return false}var e=_classPrivateMethodGet$1(this,_fetchCounterData,_fetchCounterData2).call(this,babelHelpers.classPrivateFieldGet(this,_lastPullEventData));return Object.values(e).includes(-1)}babelHelpers.defineProperty(EntityCounterManager,"lastInstance",null);function ownKeys(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,i)}return a}function _objectSpread(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?ownKeys(Object(a),!0).forEach((function(t){babelHelpers.defineProperty(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):ownKeys(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function _classPrivateMethodInitSpec$2(e,t){_checkPrivateRedeclaration$2(e,t);t.add(e)}function _classPrivateFieldInitSpec$2(e,t,a){_checkPrivateRedeclaration$2(e,t);t.set(e,a)}function _checkPrivateRedeclaration$2(e,t){if(t.has(e)){throw new TypeError("Cannot initialize the same private elements twice on an object")}}function _classPrivateMethodGet$2(e,t,a){if(!t.has(e)){throw new TypeError("attempted to get private field on non-instance")}return a}var namespace=main_core.Reflection.namespace("BX.Crm");var _id$1=new WeakMap;var _entityTypeId$1=new WeakMap;var _entityTypeName=new WeakMap;var _userId=new WeakMap;var _userName=new WeakMap;var _codes$1=new WeakMap;var _data=new WeakMap;var _counterManager=new WeakMap;var _filterManager$1=new WeakMap;var _filterLastPresetId=new WeakMap;var _filterLastPreset=new WeakMap;var _filterResponsibleFiledName=new WeakMap;var _lockedCallback=new WeakMap;var _onActivateItem=new WeakSet;var _onDeactivateItem=new WeakSet;var _onFilterApply$1=new WeakSet;var _onRecalculate=new WeakSet;var _processItemSelection=new WeakSet;var _makeFilterAnalyticsLabel=new WeakSet;var _prepareFilterTypeId=new WeakSet;var _markCounters=new WeakSet;var _isAllDeactivated=new WeakSet;var _deactivateLinkedMenuItem=new WeakSet;var _getParentItemTotalValue=new WeakSet;var EntityCounterPanel=function(_CounterPanel){babelHelpers.inherits(EntityCounterPanel,_CounterPanel);function EntityCounterPanel(e){var t;babelHelpers.classCallCheck(this,EntityCounterPanel);if(!main_core.Type.isPlainObject(e)){throw'BX.Crm.EntityCounterPanel: The "options" argument must be object.'}var a=main_core.Type.isPlainObject(e.data)?e.data:{};var i=main_core.Type.isBoolean(e.withExcludeUsers)?e.withExcludeUsers:false;t=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(EntityCounterPanel).call(this,{target:BX(e.id),items:EntityCounterPanel.getCounterItems(a,e),multiselect:false,title:main_core.Loc.getMessage("NEW_CRM_COUNTER_TITLE_MY")}));_classPrivateMethodInitSpec$2(babelHelpers.assertThisInitialized(t),_getParentItemTotalValue);_classPrivateMethodInitSpec$2(babelHelpers.assertThisInitialized(t),_deactivateLinkedMenuItem);_classPrivateMethodInitSpec$2(babelHelpers.assertThisInitialized(t),_isAllDeactivated);_classPrivateMethodInitSpec$2(babelHelpers.assertThisInitialized(t),_markCounters);_classPrivateMethodInitSpec$2(babelHelpers.assertThisInitialized(t),_prepareFilterTypeId);_classPrivateMethodInitSpec$2(babelHelpers.assertThisInitialized(t),_makeFilterAnalyticsLabel);_classPrivateMethodInitSpec$2(babelHelpers.assertThisInitialized(t),_processItemSelection);_classPrivateMethodInitSpec$2(babelHelpers.assertThisInitialized(t),_onRecalculate);_classPrivateMethodInitSpec$2(babelHelpers.assertThisInitialized(t),_onFilterApply$1);_classPrivateMethodInitSpec$2(babelHelpers.assertThisInitialized(t),_onDeactivateItem);_classPrivateMethodInitSpec$2(babelHelpers.assertThisInitialized(t),_onActivateItem);_classPrivateFieldInitSpec$2(babelHelpers.assertThisInitialized(t),_id$1,{writable:true,value:void 0});_classPrivateFieldInitSpec$2(babelHelpers.assertThisInitialized(t),_entityTypeId$1,{writable:true,value:void 0});_classPrivateFieldInitSpec$2(babelHelpers.assertThisInitialized(t),_entityTypeName,{writable:true,value:void 0});_classPrivateFieldInitSpec$2(babelHelpers.assertThisInitialized(t),_userId,{writable:true,value:void 0});_classPrivateFieldInitSpec$2(babelHelpers.assertThisInitialized(t),_userName,{writable:true,value:void 0});_classPrivateFieldInitSpec$2(babelHelpers.assertThisInitialized(t),_codes$1,{writable:true,value:void 0});_classPrivateFieldInitSpec$2(babelHelpers.assertThisInitialized(t),_data,{writable:true,value:void 0});_classPrivateFieldInitSpec$2(babelHelpers.assertThisInitialized(t),_counterManager,{writable:true,value:void 0});_classPrivateFieldInitSpec$2(babelHelpers.assertThisInitialized(t),_filterManager$1,{writable:true,value:void 0});_classPrivateFieldInitSpec$2(babelHelpers.assertThisInitialized(t),_filterLastPresetId,{writable:true,value:void 0});_classPrivateFieldInitSpec$2(babelHelpers.assertThisInitialized(t),_filterLastPreset,{writable:true,value:void 0});_classPrivateFieldInitSpec$2(babelHelpers.assertThisInitialized(t),_filterResponsibleFiledName,{writable:true,value:void 0});_classPrivateFieldInitSpec$2(babelHelpers.assertThisInitialized(t),_lockedCallback,{writable:true,value:void 0});babelHelpers.classPrivateFieldSet(babelHelpers.assertThisInitialized(t),_id$1,e.id);babelHelpers.classPrivateFieldSet(babelHelpers.assertThisInitialized(t),_entityTypeId$1,e.entityTypeId?main_core.Text.toInteger(e.entityTypeId):0);babelHelpers.classPrivateFieldSet(babelHelpers.assertThisInitialized(t),_entityTypeName,e.entityTypeName);babelHelpers.classPrivateFieldSet(babelHelpers.assertThisInitialized(t),_userId,e.userId?main_core.Text.toInteger(e.userId):0);babelHelpers.classPrivateFieldSet(babelHelpers.assertThisInitialized(t),_userName,main_core.Type.isStringFilled(e.userName)?e.userName:babelHelpers.classPrivateFieldGet(babelHelpers.assertThisInitialized(t),_userId));babelHelpers.classPrivateFieldSet(babelHelpers.assertThisInitialized(t),_codes$1,main_core.Type.isArray(e.codes)?e.codes:[]);babelHelpers.classPrivateFieldSet(babelHelpers.assertThisInitialized(t),_data,a);babelHelpers.classPrivateFieldSet(babelHelpers.assertThisInitialized(t),_filterResponsibleFiledName,e.filterResponsibleFiledName);if(BX.CrmEntityType.isDefined(babelHelpers.classPrivateFieldGet(babelHelpers.assertThisInitialized(t),_entityTypeId$1))){babelHelpers.classPrivateFieldSet(babelHelpers.assertThisInitialized(t),_counterManager,new EntityCounterManager({id:babelHelpers.classPrivateFieldGet(babelHelpers.assertThisInitialized(t),_id$1),entityTypeId:babelHelpers.classPrivateFieldGet(babelHelpers.assertThisInitialized(t),_entityTypeId$1),codes:babelHelpers.classPrivateFieldGet(babelHelpers.assertThisInitialized(t),_codes$1),extras:main_core.Type.isObject(e.extras)?e.extras:{},withExcludeUsers:i}))}babelHelpers.classPrivateFieldSet(babelHelpers.assertThisInitialized(t),_filterManager$1,new EntityCounterFilterManager);babelHelpers.classPrivateFieldSet(babelHelpers.assertThisInitialized(t),_filterLastPresetId,e.filterLastPresetId);babelHelpers.classPrivateFieldSet(babelHelpers.assertThisInitialized(t),_filterLastPreset,main_core.Type.isArray(e.filterLastPresetData)?JSON.parse(e.filterLastPresetData[0]):{presetId:null});babelHelpers.classPrivateFieldSet(babelHelpers.assertThisInitialized(t),_lockedCallback,main_core.Type.isStringFilled(e.lockedCallback)?e.lockedCallback:null);return t}babelHelpers.createClass(EntityCounterPanel,[{key:"bindToFilter",value:function e(){babelHelpers.classPrivateFieldGet(this,_filterManager$1).bindToFilter();_classPrivateMethodGet$2(this,_markCounters,_markCounters2).call(this)}},{key:"bindEvents",value:function bindEvents(){var _babelHelpers$classPr,_this2=this;(_babelHelpers$classPr=babelHelpers.classPrivateFieldGet(this,_counterManager))===null||_babelHelpers$classPr===void 0?void 0:_babelHelpers$classPr.bindEvents();if(main_core.Type.isStringFilled(babelHelpers.classPrivateFieldGet(this,_lockedCallback))){var elem=document.getElementById(babelHelpers.classPrivateFieldGet(this,_id$1));main_core.Event.bind(elem,"click",(function(){eval(babelHelpers.classPrivateFieldGet(_this2,_lockedCallback))}));return}main_core_events.EventEmitter.subscribe("BX.UI.CounterPanel.Item:activate",_classPrivateMethodGet$2(this,_onActivateItem,_onActivateItem2).bind(this));main_core_events.EventEmitter.subscribe("BX.UI.CounterPanel.Item:deactivate",_classPrivateMethodGet$2(this,_onDeactivateItem,_onDeactivateItem2).bind(this));main_core_events.EventEmitter.subscribe("BX.Main.Filter:apply",_classPrivateMethodGet$2(this,_onFilterApply$1,_onFilterApply2$1).bind(this));main_core_events.EventEmitter.subscribe("BX.Crm.EntityCounterManager:onRecalculate",_classPrivateMethodGet$2(this,_onRecalculate,_onRecalculate2).bind(this))}},{key:"init",value:function e(){babelHelpers.get(babelHelpers.getPrototypeOf(EntityCounterPanel.prototype),"init",this).call(this);_classPrivateMethodGet$2(this,_markCounters,_markCounters2).call(this)}},{key:"getId",value:function e(){return babelHelpers.classPrivateFieldGet(this,_id$1)}}],[{key:"getCounterItems",value:function e(t,a){var i=main_core.Type.isBoolean(a.withExcludeUsers)?a.withExcludeUsers:false;var r=main_core.Type.isStringFilled(a.lockedCallback);var l=EntityCounterPanel.getMenuParentItemId(main_core.Type.isArray(a.codes)?a.codes:[]);var s=[];if(i&&!main_core.Type.isUndefined(l)){var n=0;s=Object.entries(t).map((function(e){var t=babelHelpers.slicedToArray(e,2),a=t[0],i=t[1];if(a.endsWith(EntityCounterPanel.EXCLUDE_USERS_CODE_SUFFIX)){var r=parseInt(i.VALUE,10);n+=r;var s=EntityCounterPanel.detectCounterItemColor(i.TYPE_NAME,r);return{id:a,title:main_core.Loc.getMessage("NEW_CRM_COUNTER_TYPE_OTHER_"+i.TYPE_NAME),value:{value:r,order:-1},color:s==="THEME"?"GRAY":s,parentId:l}}}),this);s=[{id:l,title:main_core.Loc.getMessage("NEW_CRM_COUNTER_TYPE_OTHER_TITLE"),value:{value:n,order:-1},isRestricted:r,color:"THEME"}].concat(s)}var c=Object.entries(t).map((function(e){var t=babelHelpers.slicedToArray(e,2),a=t[0],i=t[1];if(!a.endsWith(EntityCounterPanel.EXCLUDE_USERS_CODE_SUFFIX)){var l=parseInt(i.VALUE,10);return{id:a,title:main_core.Loc.getMessage("NEW_CRM_COUNTER_TYPE_"+i.TYPE_NAME),value:l,isRestricted:r,color:EntityCounterPanel.detectCounterItemColor(i.TYPE_NAME,l)}}}),this);return c.concat(s).filter((function(e){return main_core.Type.isObject(e)}))}},{key:"getMenuParentItemId",value:function e(t){return t.find((function(e){return e.endsWith(EntityCounterPanel.EXCLUDE_ALL_USERS_CODE_SUFFIX)}))}},{key:"detectCounterItemColor",value:function e(t,a){var i=[EntityCounterType.IDLE_NAME,EntityCounterType.OVERDUE_NAME,EntityCounterType.CURRENT_NAME].includes(t);var r=[EntityCounterType.INCOMING_CHANNEL_NAME].includes(t);return a>0?i?"DANGER":r?"SUCCESS":"THEME":"THEME"}}]);return EntityCounterPanel}(ui_counterpanel.CounterPanel);function _onActivateItem2(e){var t=e.getData();if(!_classPrivateMethodGet$2(this,_processItemSelection,_processItemSelection2).call(this,t)){e.preventDefault()}}function _onDeactivateItem2(e){_classPrivateMethodGet$2(this,_deactivateLinkedMenuItem,_deactivateLinkedMenuItem2).call(this,e.getData());if(_classPrivateMethodGet$2(this,_isAllDeactivated,_isAllDeactivated2).call(this)&&babelHelpers.classPrivateFieldGet(this,_filterManager$1).isActive()){var t=babelHelpers.classPrivateFieldGet(this,_filterManager$1).getApi();if(babelHelpers.classPrivateFieldGet(this,_filterLastPreset).presetId==="tmp_filter"){t.setFields(babelHelpers.classPrivateFieldGet(this,_filterLastPreset).fields);t.apply()}else{t.setFilter({preset_id:babelHelpers.classPrivateFieldGet(this,_filterLastPreset).presetId})}}}function _onFilterApply2$1(){if(babelHelpers.classPrivateFieldGet(this,_filterManager$1).isActive()){babelHelpers.classPrivateFieldGet(this,_filterManager$1).updateFields()}_classPrivateMethodGet$2(this,_markCounters,_markCounters2).call(this)}function _onRecalculate2(){var e=babelHelpers.classPrivateFieldGet(this,_counterManager).getCounterData();var t=this.getItemById(EntityCounterPanel.getMenuParentItemId(babelHelpers.classPrivateFieldGet(this,_codes$1)));for(var a in e){if(!e.hasOwnProperty(a)||!(a.indexOf("crm")===0&&e[a]>=0)||!babelHelpers.classPrivateFieldGet(this,_data).hasOwnProperty(a)||main_core.Text.toNumber(babelHelpers.classPrivateFieldGet(this,_data)[a].VALUE)===main_core.Text.toNumber(e[a])){continue}babelHelpers.classPrivateFieldGet(this,_data)[a].VALUE=e[a];var i=this.getItemById(a);i.updateValue(main_core.Text.toNumber(e[a]));i.updateColor(EntityCounterPanel.detectCounterItemColor(babelHelpers.classPrivateFieldGet(this,_data)[a].TYPE_NAME,main_core.Text.toNumber(e[a])))}if(t){t.updateValue(_classPrivateMethodGet$2(this,_getParentItemTotalValue,_getParentItemTotalValue2).call(this))}}function _processItemSelection2(e){var t=e.id.endsWith(EntityCounterPanel.EXCLUDE_USERS_CODE_SUFFIX);var a=parseInt(babelHelpers.classPrivateFieldGet(this,_data)[e.id].TYPE_ID,10);if(a>0){if(babelHelpers.classPrivateFieldGet(this,_filterManager$1).isActive()){var i;var r=babelHelpers.classPrivateFieldGet(this,_filterManager$1).getFields(true);if(typeof r[EntityCounterFilterManager.COUNTER_TYPE_FIELD]==="undefined"){babelHelpers.classPrivateFieldGet(this,_filterLastPreset).presetId=babelHelpers.classPrivateFieldGet(this,_filterManager$1).getApi().parent.getPreset().getCurrentPresetId();if(babelHelpers.classPrivateFieldGet(this,_filterLastPreset).presetId==="tmp_filter"){babelHelpers.classPrivateFieldGet(this,_filterLastPreset).fields=r}BX.userOptions.save("crm",babelHelpers.classPrivateFieldGet(this,_filterLastPresetId),"",JSON.stringify(babelHelpers.classPrivateFieldGet(this,_filterLastPreset)))}var l=t?EntityCounterFilterManager.FILTER_OTHER_USERS:babelHelpers.classPrivateFieldGet(this,_userId).toString();var s=t?main_core.Loc.getMessage("NEW_CRM_COUNTER_TYPE_OTHER"):babelHelpers.classPrivateFieldGet(this,_userName);var n=_classPrivateMethodGet$2(this,_prepareFilterTypeId,_prepareFilterTypeId2).call(this,a);var c=babelHelpers.classPrivateFieldGet(this,_filterManager$1).getApi();var o={ACTIVITY_COUNTER:BX.Type.isPlainObject(n)?n:{0:n}};var d=babelHelpers.classPrivateFieldGet(this,_filterResponsibleFiledName);o=_objectSpread(_objectSpread({},o),{},(i={},babelHelpers.defineProperty(i,d,{0:l}),babelHelpers.defineProperty(i,d+"_label",[s]),i));c.setFields(o);c.apply({COUNTER:_classPrivateMethodGet$2(this,_makeFilterAnalyticsLabel,_makeFilterAnalyticsLabel2).call(this,n)})}else{return false}}return true}function _makeFilterAnalyticsLabel2(e){if(babelHelpers.classPrivateFieldGet(this,_entityTypeName)&&e){return"CRM_"+babelHelpers.classPrivateFieldGet(this,_entityTypeName)+"_COUNTER_TYPE_"+e}return""}function _prepareFilterTypeId2(e){if(e===EntityCounterType.CURRENT){return{0:EntityCounterType.OVERDUE.toString(),1:EntityCounterType.READY_TODO.toString()}}return e.toString()}function _markCounters2(){var e=this;if(!babelHelpers.classPrivateFieldGet(this,_filterManager$1).isActive()){return}var t=this.getItemById(EntityCounterPanel.getMenuParentItemId(babelHelpers.classPrivateFieldGet(this,_codes$1)));var a=false;Object.entries(babelHelpers.classPrivateFieldGet(this,_data)).forEach((function(t){var i=babelHelpers.slicedToArray(t,2),r=i[0],l=i[1];var s=e.getItemById(r);var n=s.id.endsWith(EntityCounterPanel.EXCLUDE_USERS_CODE_SUFFIX);var c=babelHelpers.classPrivateFieldGet(e,_filterManager$1).isFiltered(babelHelpers.classPrivateFieldGet(e,_userId),parseInt(l.TYPE_ID,10),babelHelpers.classPrivateFieldGet(e,_entityTypeId$1),n,babelHelpers.classPrivateFieldGet(e,_filterResponsibleFiledName));if(c){s.activate(false);if(n){a=true}}else{s.deactivate(false)}if(s.value!==s.counter.getValue()){s.updateValue(s.value)}}));if(t){a?t.activate(false):t.deactivate(false)}}function _isAllDeactivated2(){return this.getItems().every((function(e){return!e.isActive}))}function _deactivateLinkedMenuItem2(e){var t=this;if(e.hasParentId()){var a=this.getItemById(EntityCounterPanel.getMenuParentItemId(babelHelpers.classPrivateFieldGet(this,_codes$1)));a.deactivate(false);return}if(e.parent){e.getItems().forEach((function(e){var a=t.getItemById(e);if(a.isActive){a.deactivate(false)}}))}}function _getParentItemTotalValue2(){var e=0;this.getItems().forEach((function(t){if(t.hasParentId()){e+=t.value}}));return e}babelHelpers.defineProperty(EntityCounterPanel,"EXCLUDE_USERS_CODE_SUFFIX","excl");babelHelpers.defineProperty(EntityCounterPanel,"EXCLUDE_ALL_USERS_CODE_SUFFIX","all_excl");namespace.EntityCounterPanel=EntityCounterPanel})(this.BX.Crm=this.BX.Crm||{},BX.UI,BX,BX.Event);
//# sourceMappingURL=script.map.js