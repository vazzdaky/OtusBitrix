(function(){"use strict";BX.namespace("BX.CRM.Kanban");BX.CRM.Kanban.Grid=function(t){BX.Event.EventEmitter.setMaxListeners("Kanban.Grid:onFirstRender",50);BX.Kanban.Grid.apply(this,arguments);BX.addCustomEvent(this,"Kanban.DropZone:onBeforeItemCaptured",BX.delegate(this.onBeforeItemCaptured,this));BX.addCustomEvent(this,"Kanban.DropZone:onBeforeItemRestored",BX.delegate(this.onBeforeItemRestored,this));BX.addCustomEvent(this,"Kanban.DropZone:onItemCaptured",BX.delegate(this.onItemCaptured,this));BX.addCustomEvent(this,"Kanban.Grid:onBeforeItemMoved",BX.delegate(this.onBeforeItemMoved,this));BX.addCustomEvent(this,"Kanban.Grid:onColumnAddedAsync",BX.delegate(this.onColumnAddedAsync,this));BX.addCustomEvent(this,"Kanban.Grid:onColumnUpdated",BX.delegate(this.onColumnUpdated,this));BX.addCustomEvent(this,"Kanban.Grid:onColumnMoved",BX.delegate(this.onColumnMoved,this));BX.addCustomEvent(this,"Kanban.Grid:onColumnRemovedAsync",BX.delegate(this.onColumnRemovedAsync,this));BX.addCustomEvent(this,"Kanban.Grid:onColumnLoadAsync",BX.delegate(this.onColumnLoadAsync,this));BX.addCustomEvent(this,"Kanban.Grid:onItemDragStart",BX.delegate(this.onItemDragStartHandler,this));BX.addCustomEvent(this,"Kanban.Grid:onItemDragStart",BX.delegate(this.setKanbanDragMode,this));BX.addCustomEvent(this,"Kanban.Grid:onItemDragStop",BX.delegate(this.unSetKanbanDragMode,this));BX.addCustomEvent("BX.Main.Filter:apply",BX.delegate(this.onApplyFilter,this));BX.addCustomEvent("Crm.PartialEditorDialog.Close",BX.delegate(this.onPartialEditorClose,this));BX.addCustomEvent("onPullEvent-crm",BX.proxy(this.onPullEventHandlerCrm,this));BX.addCustomEvent("onPullEvent-im",BX.proxy(this.onPullEventHandlerCrm,this));BX.addCustomEvent("onCrmActivityTodoChecked",BX.proxy(this.onCrmActivityTodoChecked,this));BX.addCustomEvent("SidePanel.Slider:onClose",BX.proxy(this.onSliderClose,this));BX.addCustomEvent("BX.CRM.Kanban.Item.select",BX.proxy(this.startActionPanel,this));BX.addCustomEvent("BX.CRM.Kanban.Item.unSelect",BX.proxy(this.onItemUnselect,this));BX.addCustomEvent("BX.UI.ActionPanel:clickResetAllBlock",BX.proxy(this.resetMultiSelectMode,this));BX.addCustomEvent("BX.UI.ActionPanel:hidePanel",BX.proxy(this.showUiToolbarContainer,this));BX.addCustomEvent("BX.UI.ActionPanel:showPanel",BX.proxy(this.hideUiToolbarContainer,this));BX.addCustomEvent("BX.Crm.EntityEditorSection:onOpenChildMenu",BX.proxy(this.onOpenEditorMenu,this));BX.addCustomEvent("BX.Crm.EntityEditor:onConfigScopeChange",BX.proxy(this.onConfigEditorScopeChange,this));BX.addCustomEvent("BX.Crm.EntityEditor:onConfigReset",BX.proxy(this.onConfigEditorReset,this));BX.addCustomEvent("BX.Crm.EntityEditor:onForceCommonConfigScopeForAll",BX.proxy(this.onForceCommonEditorConfigScopeForAll,this));BX.addCustomEvent("onPopupShow",BX.proxy(this.onPopupShow,this));BX.addCustomEvent("onPopupClose",BX.proxy(this.onPopupClose,this));BX.addCustomEvent("CrmDragItemDragRelease",BX.proxy(this.onEditorDragItemRelease,this));BX.addCustomEvent(window,"onCrmEntityCreate",BX.delegate(this.onCrmEntityCreateDeadlinesView,this));BX.addCustomEvent(this,"Kanban.Grid:onRender",BX.Runtime.debounce(this.handleHintForNotVisibleColumns,400,this));this.bindEvents();BX.CRM.Kanban.Grid.Instance=this};BX.CRM.Kanban.Grid.Instance=null;BX.CRM.Kanban.Grid.getInstance=function(){return BX.CRM.Kanban.Grid.Instance};BX.CRM.Kanban.Grid.prototype={__proto__:BX.Kanban.Grid.prototype,constructor:BX.CRM.Kanban.Grid,accessNotifyDialog:null,loadNewInterval:25,ajaxParams:{},customFieldsPopup:null,customFieldsContainer:null,actionPanel:null,customActionPanel:null,currentNode:null,itemMoving:null,actionItems:[],checkedItems:[],progressBarEditor:null,ccItem:null,restItem:null,popupCancel:null,handleScrollWithOpenPopupInKanbanColumn:null,dropZonesShow:false,isBindEvents:false,fieldsSelectors:{},animationDuration:800,hintForNotVisibleItems:null,handleHideHintForNotVisibleItems:null,canUpdateItemAtItsPosition:false,_analyticsDictionary:BX.Crm.Integration.Analytics.Dictionary,_analyticsBuilder:BX.Crm.Integration.Analytics.Builder,getChecked(){return this.checkedItems},getCheckedId(){return this.getChecked().map((t=>t.id))},checkItem(t){const e=this.getItem(t);if(!BX.util.in_array(e,this.checkedItems)){e.checked=true;if(!this.isCheckedItem(e)){this.checkedItems.push(e)}BX.Dom.addClass(e.checkedButton,"crm-kanban-item-checkbox-checked");BX.Dom.addClass(e.container,"crm-kanban-item-selected");BX.onCustomEvent("BX.CRM.Kanban.Item.select",[e])}},isCheckedItem(t){const e=this.checkedItems;for(let i=0,n=e.length;i<n;i++){if(e[i]["id"]===t["id"]){return true}}return false},onCrmEntityCreateDeadlinesView(t){const e=t.sender.getContext();if(e["VIEW_MODE"]===BX.Crm.Kanban.ViewMode.MODE_DEADLINES){void this.loadNew(t.entityId,true)}},onEditorDragItemRelease(){this.getColumns().forEach((t=>{if(!t.isEditorOpen()){t.cleanEditorNode();t.editor=null}}))},unCheckItem(t){const e=this.getItem(t);if(BX.util.in_array(e,this.checkedItems)){this.checkedItems.splice(this.checkedItems.indexOf(e),1);e.checked=false;BX.Dom.removeClass(e.checkedButton,"crm-kanban-item-checkbox-checked");BX.Dom.removeClass(e.container,"crm-kanban-item-selected");BX.onCustomEvent("BX.CRM.Kanban.Item.unSelect",[e])}},getPopupCancel(t){if(!this.popupCancel){this.popupCancel=new BX.PopupWindow("crm-kanban-popup-cancel",window,{className:"crm-kanban-popup-cancel",autoHide:false,overlay:true,maxWidth:350,buttons:[new BX.PopupWindowButton({text:"OK",className:"ui-btn ui-btn-primary",events:{click:()=>{this.popupCancel.close()}}})],closeByEsc:true,closeIcon:true})}this.popupCancel.setContent(t);return this.popupCancel},getItemsForAction(t){const e=this.getChecked();if(t){e.splice(this.actionItems.indexOf(t),1)}this.actionItems=[];e.forEach((t=>{this.actionItems.push(parseInt(t.id,10))}));return this.actionItems},bindEvents(){if(this.isBindEvents){return}BX.bind(window,"click",(t=>{if(this.dropZonesShow){return}this.isItKanban(t.target)?this.currentNode=t.target:this.currentNode=null;const e=["main-kanban-item","ui-action-panel","ui-action-panel-item-popup-menu","bx-finder-popup","responsible-user-selector-dialog"];const i=e.find((e=>BX.findParent(t.target,{className:e})));if(!i&&(top.BX.SidePanel?.Instance?.getTopSlider()?.url??"").indexOf("/company/personal/user/")!==0){const t=BX.PopupWindowManager.getCurrentPopup();if(!t?.isShown()){this.unSetKanbanDragMode();this.resetMultiSelectMode()}}}));BX.bind(window,"keydown",(t=>{if(this.dropZonesShow){return}if(t.code==="Escape"){this.resetMultiSelectMode();this.unSetKanbanDragMode()}}));BX.addCustomEvent(window,"Crm.PartialEditorDialog.Close",((t,e)=>{if(e.isCancelled&&this.itemMoving.item){this.moveItem(this.itemMoving.item,this.itemMoving.oldColumn,this.itemMoving.oldNextSiblingId)}}));BX.Event.EventEmitter.subscribe("Crm.Kanban.Column:onItemAdded",(t=>{if(this.itemMoving?.item.id===t.data.item.id&&this.items[this.itemMoving.item.id]!==undefined&&this.itemMoving.item.columnId===this.items[this.itemMoving.item.id].columnId){const e=this.getColumn(t.data.item.columnId);const{data:i}=t;if(i.item.columnId===i.oldColumn.id&&e.data.type==="PROGRESS"){return}this.onItemMoved(i.item,i.targetColumn,i.beforeItem)}}));BX.Event.EventEmitter.subscribe("crm-kanban-settings-fields-view",(()=>{this.showFieldsSelectPopup("view")}));BX.Event.EventEmitter.subscribe("crm-kanban-settings-fields-edit",(()=>{this.loadHiddenQuickEditorForFirstColumn();this.showFieldsSelectPopup("edit")}));const t=BX.Reflection.getClass("BX.Crm.ToolbarComponent")?BX.Reflection.getClass("BX.Crm.ToolbarComponent").Instance:null;if(this.getData().isDynamicEntity&&t){t.subscribeTypeUpdatedEvent((()=>{if(BX.Reflection.getClass("BX.Crm.Router.Instance.getKanbanUrl")){const t=this.getData().hasOwnProperty("entityTypeInt")?BX.Text.toInteger(this.getData().entityTypeInt):0;const e=this.getData().params.hasOwnProperty("CATEGORY_ID")?BX.Text.toInteger(this.getData().params.CATEGORY_ID):0;const i=BX.Crm.Router.Instance.getKanbanUrl(t,e);if(i){window.location.href=i;return}}window.location.reload()}));t.subscribeCategoriesUpdatedEvent((()=>{this.reload()}))}this.isBindEvents=true},isItKanban(t){return Boolean(BX.findParent(t,{className:"main-kanban"}))},setKanbanDragMode(){BX.Dom.addClass(document.body,"crm-kanban-drag-mode")},unSetKanbanDragMode(){this.stopActionPanel(true);BX.Dom.removeClass(document.body,"crm-kanban-drag-mode")},renderLayout(){const t=this.getData();BX.Kanban.Grid.prototype.renderLayout.apply(this,arguments);this.setDropAreaFirstItemWidth();if(this.ccItem&&!t.contactCenterShow){this.hideItem(this.ccItem)}if(this.restItem&&!t.restDemoBlockShow){this.hideItem(this.restItem)}},setDropAreaFirstItemWidth(){if(this.layout.gridContainer.firstChild===null){return}const t=BX.create("style",{attrs:{type:"text/css"}});const e=".main-kanban-dropzone:first-child, main-kanban-dropzone:last-child";const i=this.layout.gridContainer.firstChild.offsetWidth+3;const n=`${e}(max-width: ${i}px, min-width: ${i}px)`;const o=document.createTextNode(n);t.appendChild(o);document.head.appendChild(t)},getAjaxHandlerPath(){const t=this.getData();return BX.type.isNotEmptyString(t.ajaxHandlerPath)?t.ajaxHandlerPath:"/bitrix/components/bitrix/crm.kanban/ajax.old.php"},setAjaxParams(t){this.ajaxParams=t},ajax(t,e,i,n){const o=this.getData();if(BX.Type.isUndefined(n)){n="json"}t.sessid=BX.bitrix_sessid();t.extra=o.params;t.entity_type=o.entityType;t.viewMode=o.viewMode;t.version=2;t.ajaxParams=this.ajaxParams;t.entityPath=o.entityPath;this.setAjaxParams({});let s=this.getAjaxHandlerPath();if(!BX.Type.isUndefined(t.action)){s+=s.indexOf("?")===-1?"?":"&";s+="action="+t.action}if(this.isMultiSelectMode()){s+="&group=yes"}if(this.isCycleRequest(t)){this.reload()}else{BX.ajax({method:"POST",dataType:n,url:s,data:t,onsuccess:e,onfailure:i})}},isCycleRequest(t){if(t.action!=="page"){return false}const e=8*1e3;const i=5;const n=t=>{BX.localStorage.set("crm-kanban-cycle-request-params",t,e)};let o=BX.localStorage.get("crm-kanban-cycle-request-params");if(!o){o=this.getEmptyCycleRequestParams();o.total+=1;n(o);return false}const s=Date.now()-o.startTime;if(s<e&&o.total>=i){n(this.getEmptyCycleRequestParams());return true}if(s>e){o=this.getEmptyCycleRequestParams()}o.total+=1;n(o);return false},getEmptyCycleRequestParams(){return{total:0,startTime:Date.now()}},accessNotify:function(){if(typeof BX.Intranet!=="undefined"&&typeof BX.Intranet.NotifyDialog!=="undefined"){if(this.accessNotifyDialog===null){var t=this.getData();this.accessNotifyDialog=new BX.Intranet.NotifyDialog({listUserData:this.getData().admins,notificationHandlerUrl:this.getAjaxHandlerPath()+"?action=notifyAdmin&version=2&entity_type="+t.entityType,popupTexts:{sendButton:BX.message("CRM_KANBAN_NOTIFY_BUTTON"),title:BX.message("CRM_KANBAN_NOTIFY_TITLE"),header:BX.message("CRM_KANBAN_NOTIFY_HEADER"),description:BX.message("CRM_KANBAN_NOTIFY_TEXT2")}})}this.accessNotifyDialog.show()}},addStage:function(t){var e=new BX.Promise;var i=this.getPreviousColumnSibling(t);var n=i?i.getId():0;this.ajax({action:"modifyStage",columnName:t.getName(),columnColor:t.getColor(),afterColumnId:n},function(t){if(t&&!t.error){this.resetActionPanel();e.fulfill(t)}else if(t){BX.Kanban.Utils.showErrorDialog(t.error,t.fatal);e.reject(t.error)}}.bind(this),function(t){BX.Kanban.Utils.showErrorDialog("Error: "+t,true);e.reject("Error: "+t)}.bind(this));return e},removeStage:function(t){var e=new BX.Promise;this.ajax({action:"modifyStage",columnId:t.getId(),delete:1},function(t){if(t&&!t.error){this.resetActionPanel();e.fulfill()}else if(t){e.reject(t.error)}}.bind(this),function(t){BX.Kanban.Utils.showErrorDialog("Error: "+t,true);e.reject("Error: "+t)}.bind(this));return e},getColumnItems:function(t){const e=new BX.Promise;const i=t.getTotal();this.data.params.total=i;const n=t.getItemsCount();this.data.params.itemsCount=n;const o=t.getPagination();const{skipColumnCountCheck:s}=this.getData();const{blockSize:a,canLoadMoreItems:r}=t;if(!s&&i<o.getPage()*a||s&&!r){t.setTotal(n);e.fulfill([]);return e}t.setLoadingInProgress();const l=o.getPage()+1;this.ajax({action:"page",page:l,column:t.getId(),onlyItems:l>1?"Y":"N"},(i=>{if(i&&!i.error&&(Array.isArray(i)||Array.isArray(i.items))){const o=Array.isArray(i)?i:i.items;if(o.length===0){t.setLoadingMoreItem(false);if(s){t.setTotal(n+o.length);t.showTotalCount()}}e.fulfill(o);return}if(i){BX.Kanban.Utils.showErrorDialog(i.error,i.fatal);e.reject(i.error);return}if(this.ccItem){const t=this.getData();if(!t.contactCenterShow){this.hideItem(this.ccItem)}}}),(t=>{BX.Kanban.Utils.showErrorDialog(`Error: ${t}`,true);e.reject(`Error: ${t}`)}));return e},addItemTop:function(t,e){var i=this.getColumn(t.columnId);var n=i?i.getItems():[];e=typeof e!=="undefined"?e:true;if(n.length>0){t.targetId=n[0].getId()}i&&e?i.incPrice(t.data.price):null;this.addItem(t)},updateItemAtItsPosition(t){this.canUpdateItemAtItsPosition=true;this.moveItem(t,t.getColumn(),t,true).finally((()=>{this.canUpdateItemAtItsPosition=true}))},moveItem:function(t,e,i,n){n=n||false;return this.movePromisedItem(t,e,i,n)},movePromisedItem:function(t,e,i,n){var o=t.notChangeTotal||false;t=this.getItem(t);t.notChangeTotal=o;e=this.getColumn(e);if(!t||!e||t===i&&!this.canUpdateItemAtItsPosition){if(n){return Promise.resolve({status:false})}return false}i=i?this.getItem(i):e.items[0]||null;var s=t.getColumn();if(this.getChecked().length>1){return this.moveManyItems(t,e,i,n)}t.beforeItem=i;s.removeItem(t).then((()=>{e.addItem(t,t.beforeItem)}));this.stopActionPanel();if(n){return Promise.resolve({status:true})}return true},moveManyItems(primaryItem,targetColumn,beforeItem,usePromise){let error=false;const targetColumnId=targetColumn.getId();const targetColumnData=targetColumn.getData();const items=this.getChecked();for(let i=0,itemsCount=items.length;i<itemsCount;i++){const itemData=items[i].getData();const currentColumnId=items[i].getColumn().getId();if(this.getTypeInfoParam("hasRestictionToMoveToWinColumn")&&targetColumnData.type==="WIN"){error=true;if(itemsCount===i+1){this.resetMultiSelectMode()}}else if(BX.Type.isArrayFilled(this.getRequiredFieldsForColumnId(targetColumnId,itemData))&&targetColumnId!==currentColumnId){if(itemData.required_fm){const t=[];const e=this.getRequiredFieldsForColumnId(targetColumnId,itemData);for(let n=0,o=e.length;n<o;n++){const o=e[n];if(items[i].isRequiredFmField(o)||!items[i].isValidFmFieldName(o)){t.push(o)}}itemData.required[targetColumnId]=t}if(BX.Type.isArrayFilled(this.getRequiredFieldsForColumnId(targetColumnId,itemData))){error=true;if(itemsCount===i+1){this.resetMultiSelectMode()}}}else if(itemData["updateRestrictionCallback"]){try{eval(itemData["updateRestrictionCallback"])}catch(t){console.log("update action restricted")}this.resetMultiSelectMode();if(usePromise){return Promise.resolve()}return}}if(error){const t=this.getData();this.showNotCompletedPopup(t)}const removePromises=[];const currentColumns=new Map;for(let t=0;t<items.length;t++){const e=items[t].getColumn();if(items[t]!==primaryItem&&e!==targetColumn){e.layout.total.textContent=+e.layout.total.innerHTML-1}items[t].useAnimation=false;removePromises.push(e.removeItem(items[t]));currentColumns.set(items[t].getId(),e)}if(usePromise){return Promise.all(removePromises).then((()=>{items.forEach((t=>{t.useAnimation=false;t.layout.container.style.opacity=1}));targetColumn.addItems(items,beforeItem);this.resetMultiSelectMode();this.stopActionPanel()}))}targetColumn.addItems(items,beforeItem);this.resetMultiSelectMode();this.stopActionPanel()},loadNew:function(t,e,i,n,o){var s=this.getData();var a=typeof t!=="undefined"?Array.isArray(t)?t:[t]:0;if(document.hidden){return Promise.reject(new Error("Tab is not active"))}var r=0;r=a.reduce(function(t,e,i,n){var o=this.getItem(e);if(o&&o.getData().updateRestrictionCallback){delete n[i];return t}return++t}.bind(this),0);if(!r){return Promise.resolve()}o=BX.Type.isBoolean(o)?o:false;return new Promise(function(t,r){this.ajax(a[0]?{action:"get",entity_id:a,force:e===true?"Y":"N",onlyItems:n===true?"Y":"N"}:{action:"get",min_entity_id:s.lastId,force:e===true?"Y":"N",onlyItems:n===true?"Y":"N"},function(e){if(!e){t(e)}if(BX.Type.isObject(e.config)&&Object.keys(e.config).length>0){const t=this.getData();if(BX.Type.isArrayFilled(e.config?.users)){e.config.users.forEach((e=>{const i=t.itemsConfig?.users.some((t=>Number(t.id)===Number(e.id)));if(!i){t.itemsConfig.users.push(e)}}))}if(BX.Type.isArrayFilled(e.config?.fields)){e.config.fields.forEach((e=>{const i=t.itemsConfig?.fields.some((t=>t.code===e.code));if(!i){t.itemsConfig?.fields.push(e)}}))}}if(e.items){var n=false;if(e.items.length){var r={};for(var l=e.items.length-1;l>=0;l--){var c=e.items[l];c.useAnimation=o;var d=this.getItem(c.id);if(c.id<=0){continue}n=true;if(d){var m=d.getData();var u=d.getColumn();var h=this.getColumn(c.columnId);u.decPrice(parseFloat(m.price));r[u.getId()]=u;if(h){h.incPrice(parseFloat(c.data.price));d.data.price=c.data.price;const t=BX.CRM.Kanban.Sort.Sorter.createWithCurrentSortType(h.getItems());const e=t.calcBeforeItemByParams(c.data.sort);if(h!==u||i===true){c.notChangeTotal=true;if(e){c.targetId=e.getId()}this.updateItem(c.id,c);r[h.getId()]=h}else if(h.getPreviousItemSibling(d)!==e){this.moveItem(d,h,e)}}else{this.removeItem(d)}}else if(c.id&&this.getColumn(c.columnId)===null){BX.onCustomEvent(this,"Kanban.Column:render")}else if(c.id){this.addItemTop(c)}if(!a[0]){s.lastId=c.id;this.setData(s)}}for(var g in r){r[g].renderSubTitle()}}if(!n&&a[0]){var c=this.getItem(a[0]);if(c){var p=c.getData();var f=c.getColumn();f.decPrice(p.price);this.removeItem(a[0])}}}t(e)}.bind(this),function(t){r()}.bind(this))}.bind(this))},updateItem:function(t,e){t=this.getItem(t);if(!t){return false}if(BX.Kanban.Utils.isValidId(e.columnId)&&e.columnId!==t.getColumn().getId()){if(e.notChangeTotal){t.notChangeTotal=e.notChangeTotal}if(e.useAnimation){t.useAnimation=e.useAnimation}this.moveItem(t,this.getColumn(e.columnId),this.getItem(e.targetId))}var i=["UPDATE",{task:t,options:e}];BX.onCustomEvent(window,"tasksTaskEvent",i);t.setOptions(e);t.render();return true},onItemDragStart:function(t){this.setDragMode(BX.Kanban.DragMode.ITEM);if(parseInt(t.getId())<0){return}var e=this.getItems();var i=t.getColumnId();if(t.isItemMoveDisabled()){for(var n in e){var o=e[n].getColumnId();if(o===i){e[n].enableDropping()}}return}BX.Kanban.Grid.prototype.onItemDragStart.apply(this,arguments);if(this.progressBarEditor){this.progressBarEditor.close()}},onItemDragStartHandler:function(t){t.setLastPosition()},onColumnLoadAsync:function(t){t.push(BX.delegate(this.getColumnItems,this))},onColumnRemovedAsync:function(t){t.push(BX.delegate(this.removeStage,this))},onColumnAddedAsync:function(t){t.push(BX.delegate(this.addStage,this))},onBeforeItemCaptured:function(t){BX.onCustomEvent("Crm.Kanban.Grid:onBeforeItemCapturedStart",[this,t]);if(t.isActionAllowed()){var e=t.getItem();var i=e.getColumn();var n=t.getDropZone();const o=this.getItemsForAction();this.itemMoving={item:e,price:parseFloat(e.getData().price),oldColumn:i,oldNextSiblingId:i.getNextItemSibling(e),newColumn:null,newNextSibling:null,dropEvent:t,groupIds:o};t.groupIds=o;this.onItemMoved(e,n,null,true)}},onItemCaptured:function(t,e,i){if(e.getId()==="DELETED"){if(BX.Type.isArray(i)&&i.length===0){i=parseInt(t.getId(),10)}i=i??grid.getCheckedId();if(!BX.Type.isArray(i)){i=[i]}const n={ids:i,showNotify:false};new BX.CRM.Kanban.Actions.DeleteAction(this,n).setDropZone(e).execute()}},onBeforeItemRestored:function(t){const e=t.getItem();const i=e.getColumn();const n=parseFloat(e.getData().price);i.incPrice(n);const o=this.itemMoving.groupIds?this.itemMoving.groupIds.toString():e.getId();const s=this.getDefaultAnalyticsCloseEvent(e,i.getData().type,o);s.c_sub_section=this._analyticsDictionary.SUB_SECTION_KANBAN_DROPZONE;s.c_element=this._analyticsDictionary.ELEMENT_CANCEL_BUTTON;this.registerAnalyticsCloseEvent(s,this._analyticsDictionary.STATUS_CANCEL);this.onItemMoved(e,i)},onBeforeItemMoved:function(t){if(this.isBlockedIncomingMoving(t.targetColumn)){BX.UI.Notification.Center.notify({content:BX.message("CRM_KANBAN_MOVE_ITEM_TO_COLUMN_BLOCKED_2"),autoHideDelay:5e3});t.denyAction();return}var e=t.getItem();var i=e.getColumn();this.itemMoving={item:e,price:parseFloat(e.getData().price),oldColumn:i,oldNextSiblingId:i.getNextItemSibling(e),newColumn:null,newNextSibling:null}},onItemMoved:function(item,targetColumn,beforeItem,skipHandler){const itemData=item.getData();var columnId=targetColumn.getId();var gridData=this.getData();var isDropZone=targetColumn instanceof BX.Kanban.DropZone;if(targetColumn.getId()!=="DELETED"&&itemData["updateRestrictionCallback"]&&BX.Type.isString(itemData["updateRestrictionCallback"])&&columnId!==this.itemMoving.oldColumn.getId()){try{eval(itemData["updateRestrictionCallback"])}catch(t){console.log("update action restricted")}if(isDropZone){this.itemMoving.dropEvent.denyAction()}else{this.moveItem(item,this.itemMoving.oldColumn,this.itemMoving.oldNextSiblingId)}return}if(BX.Type.isArrayFilled(this.getRequiredFieldsForColumnId(columnId,itemData))&&this.itemMoving.oldColumn.getId()!==targetColumn.getId()&&!item.isChangedInPullRequest()){if(itemData.required_fm){const t=[];const e=this.getRequiredFieldsForColumnId(columnId,itemData);for(let i=0,n=e.length;i<n;i++){const n=e[i];if(item.isRequiredFmField(n)||!item.isValidFmFieldName(n)){t.push(e[i])}}itemData.required[columnId]=t}if(item.rawData&&typeof item.rawData==="object"){const t=this.getRequiredFieldsForColumnId(columnId,itemData);for(var i=0,c=t.length;i<c;i++){var key=t[i];if(!(typeof item.rawData[key]==="undefined"||item.rawData[key]===null||item.rawData[key]===""||Array.isArray(item.rawData[key])&&!item.rawData[key].length)){t.splice(i,1)}}itemData.required[columnId]=t}if((BX.Type.isArrayFilled(itemData.required?.[columnId])||BX.Type.isArrayFilled(itemData.required.ALL))&&this.getTypeInfoParam("isQuickEditorEnabled")){this.itemMoving.newColumn=targetColumn;this.itemMoving.newNextSibling=beforeItem;if(isDropZone){this.itemMoving.dropEvent.denyAction()}if(this.getChecked().length>1){this.showNotCompletedPopup(gridData);this.resetMultiSelectMode()}else{const t=this.getRequiredFieldsForColumnId(columnId,itemData);this.openPartialEditor(item.getId(),columnId,t);BX.Dom.addClass(item.layout.container,"main-kanban-item-waiting")}return}}if(!item.isChangedInPullRequest()){if(this.getTypeInfoParam("canShowPopupForLeadConvert")&&targetColumn.getId()==="CONVERTED"&&this.itemMoving.dropEvent){BX.Crm.KanbanComponent.dropPopup(this,this.itemMoving.dropEvent)}if(!item.notChangeTotal){if(this.itemMoving.item.getData().runtimePrice!==true){this.itemMoving.oldColumn.decPrice(this.itemMoving.price)}if(!isDropZone){targetColumn.incPrice(this.itemMoving.price);targetColumn.renderSubTitle();this.itemMoving.oldColumn.renderSubTitle()}}item.notChangeTotal=false}this.itemMoving.item.setDataKey("runtimePrice",false);if(skipHandler!==true&&!item.isChangedInPullRequest()){var handlerData={grid:this,item:item,targetColumn:targetColumn,beforeItem:beforeItem,skip:false};BX.onCustomEvent("Crm.Kanban.Grid:onItemMovedFinal",[handlerData]);if(handlerData.skip===true){return}}var afterItemId=0;var itemId=item.getId();if(targetColumn instanceof BX.Kanban.DropZone){afterItemId=0}else{var afterItem=targetColumn.getPreviousItemSibling(item);if(afterItem){afterItemId=afterItem.getId()}}BX.Dom.removeClass(item.layout.container,"main-kanban-item-waiting");if(item.isChangedInPullRequest()){this.clearItemMoving();item.dropChangedInPullRequest()}else{const{groupIds:t}=this.itemMoving;if(BX.Type.isArray(t)&&!BX.Type.isArrayFilled(t)){t.push(itemId)}this.checkItemStatusAfterMoved(item,afterItemId,targetColumn)}},checkItemStatusAfterMoved:function(t,e,i){const n=t.getId();const o=i?i.getId():0;const s={action:"status",entity_id:this.itemMoving?.groupIds??n,prev_entity_id:e,status:o,eventId:BX.Pull.QueueManager.registerRandomEventId()};const a=this.itemMoving?.groupIds?this.itemMoving?.groupIds.toString():n;const r=this.getDefaultAnalyticsCloseEvent(t,i.getData().type,a);this.registerAnalyticsCloseEvent(r,this._analyticsDictionary.STATUS_ATTEMPT);this.ajax(s,(e=>{if(!e){this.registerAnalyticsCloseEvent(r,this._analyticsDictionary.STATUS_ERROR);return}if(this.hasResponseError(e)){this.rollbackItemsMovement([t.id],o);this.showResponseError(e);this.registerAnalyticsCloseEvent(r,this._analyticsDictionary.STATUS_ERROR);return}this.registerAnalyticsCloseEvent(r,this._analyticsDictionary.STATUS_SUCCESS);if(this.getData().useItemPlanner&&!this.itemMoving?.groupIds&&BX.CRM.Kanban.Restriction.Instance.isTodoActivityCreateAvailable()){setTimeout((()=>this.showItemPlannerMenu(t)),500)}const{items:i}=e;let{isShouldUpdateCard:s}=e;if(BX.Type.isArrayFilled(i)){this.updateItem(n,i[0]);return}const a=t.getLastPosition()?.columnId;if(a){const e=this.getColumn(a);const i=t.getColumn();if(e?.isHiddenTotalSum()!==i?.isHiddenTotalSum()){s=true}}else{s=true}t.setDataKey("columnId",o);if(s){void this.loadNew(n,false,true,true,true)}}),(t=>{this.registerAnalyticsCloseEvent(r,this._analyticsDictionary.STATUS_ERROR);BX.Kanban.Utils.showErrorDialog(`Error: ${t}`,true)}))},getDefaultAnalyticsCloseEvent(t,e,i){let n=e;if(n==="WIN"){n="won"}else if(n==="LOOSE"){n="lose"}else{n="progress"}let o=this._analyticsDictionary.SUB_SECTION_KANBAN;if(this.dropZonesShow){o=this._analyticsDictionary.SUB_SECTION_KANBAN_DROPZONE}return this._analyticsBuilder.Entity.CloseEvent.createDefault(t.getGridData().entityType,i).setSubSection(o).setElement(n).buildData()},registerAnalyticsCloseEvent(t,e){if(!t||t.c_element==="progress"&&e!==this._analyticsDictionary.STATUS_CANCEL){return}t.status=e;BX.UI.Analytics.sendData(t)},registerAnalyticsSpecialItemLinkClick(t,e){const i={REST_DEMO:"rest_demo",CONTACT_CENTER:"contact_center",MARKETPLACE:"marketplace"};if(!(e.toUpperCase()in i)){return}let n=this._analyticsDictionary.ELEMENT_ITEM_CONTACT_CENTER;if(e===i.REST_DEMO){n=this._analyticsDictionary.ELEMENT_ITEM_INDUSTRY_BUTTON}if(e===i.MARKETPLACE){n=this._analyticsDictionary.ELEMENT_CONTACT_CENTER_MARKETPLACE}const o=this._analyticsBuilder.Block.LinkEvent.createDefault(t.getGridData().entityType).setElement(n);if(e===i.REST_DEMO){o.setType(this._analyticsDictionary.TYPE_ITEM_INDUSTRY)}this.sendAnalyticsEvent(o)},registerAnalyticsSpecialItemCloseEvent(t,e,i,n=null){const o=this._analyticsBuilder.Block.CloseEvent.createDefault(t.getGridData().entityType).setSubSection(e).setElement(i);if(n===this._analyticsDictionary.TYPE_ITEM_INDUSTRY){o.setType(n)}this.sendAnalyticsEvent(o)},registerAnalyticsSpecialItemEnableEvent(t,e,i,n=null){const o=this._analyticsBuilder.Block.EnableEvent.createDefault(t.getGridData().entityType).setSubSection(e).setElement(i);if(n==="industry_block"){o.setType(this._analyticsDictionary.TYPE_ITEM_INDUSTRY)}this.sendAnalyticsEvent(o)},sendAnalyticsEvent(t){BX.UI.Analytics.sendData(t.buildData())},rollbackItemsMovement(t,e){this.clearItemMoving();t.forEach((t=>{const i=this.getItem(t);if(i===null){return}const n=this.getColumn(e);if(n===null){return}const o=this.getColumn(i.options.columnId);if(o===null){return}const s=this.getItem(i.lastPosition.targetId);n.removeItem(i).then((()=>{const{price:t}=i.data;this.moveItemPriceBetweenColumns(n,o,t);o.addItem(i,s)}))}))},moveItemPriceBetweenColumns(t,e,i){if(BX.Type.isNumber(i)){t.decPrice(i);t.renderSubTitle();e.incPrice(i);e.renderSubTitle()}},hasResponseError(t){return BX.Type.isString(t.error)},showResponseError(t){const e=t.error;if(t.fatal){BX.Kanban.Utils.showErrorDialog(e,true)}else{BX.UI.Notification.Center.notify({content:e,autoHideDelay:5e3})}},showItemPlannerMenu:function(t){t.showPlannerMenu(t.getContainer(),BX.Crm.Activity.TodoEditorMode.UPDATE,true)},showNotCompletedPopup:function(t){var e;if(t.isDynamicEntity){e=BX.message("CRM_KANBAN_SET_STATUS_NOT_COMPLETED_TEXT_DYNAMIC_MSGVER_1")}else{e=BX.message("CRM_KANBAN_SET_STATUS_NOT_COMPLETED_TEXT_"+t.entityType+"_MSGVER_1")}this.getPopupCancel(e).show()},onColumnUpdated:function(t){var e=t.getId();var i=t.getName();var n=t.getColor();this.ajax({action:"modifyStage",columnId:e,columnName:i,columnColor:n},function(t){if(t&&t.error){BX.Kanban.Utils.showErrorDialog(t.error,t.fatal)}else{this.resetActionPanel()}}.bind(this),function(t){BX.Kanban.Utils.showErrorDialog("Error: "+t,true)}.bind(this))},onColumnMoved:function(t,e){var i=t.getId();var n=this.getPreviousColumnSibling(t);var o=n?n.getId():0;this.ajax({action:"modifyStage",columnId:i,afterColumnId:o},function(t){if(t&&t.error){BX.Kanban.Utils.showErrorDialog(t.error,true)}else{this.resetActionPanel()}}.bind(this),function(t){BX.Kanban.Utils.showErrorDialog("Error: "+t,true)}.bind(this))},onApplyFilter:function(t,e,i,n,o){this.clearItemMoving();this.fadeOut();if(BX.Type.isObject(o)){o.autoResolve=false}this.ajax({action:"get"},(t=>{const e=this.getData();if(!BX.Type.isUndefined(t.customFields)){e.customFields=t.customFields}if(BX.Type.isArray(t.customEditFields)){e.customEditFields=t.customEditFields}if(BX.Type.isObject(t.config)&&Object.keys(t.config).length>0){Object.keys(t.config).forEach((i=>{const n=t.config[i];if(BX.Type.isArrayFilled(n)||BX.Type.isObject(n)&&Object.keys(n).length>0){e.itemsConfig[i]=n}}))}this.setData(e);this.destroyFieldsSelectPopup();this.destroyHideColumnSumPopups();const i=[];let o=null;let s=this.getColumns();for(let t=0,e=s.length;t<e;t++){o=s[t].getId();i.push(o);this.removeColumn(o)}this.removeItems();this.loadData(t);const a=this.getDropZoneArea();const r=this.getDropZoneArea().getDropZones();for(let t=0,e=r.length;t<e;t++){a.removeDropZone(r[t])}if(t.dropzones){for(let e=0,i=t.dropzones.length;e<i;e++){a.addDropZone(t.dropzones[e])}}let l=null;s=this.getColumns();for(let t=0,e=s.length;t<e;t++){o=s[t].getId();if(!BX.util.in_array(o,i)){l=s[t]}}if(l!==null){this.addClassEar()}this.fadeIn();this.resetMultiSelectMode();setTimeout((()=>{if(this.hasOnlyNotVisibleColumnsWithItems()){this.showHintForNotVisibleItems()}}),20);if(typeof n!=="undefined"){n.fulfill()}}),(t=>{if(typeof n!=="undefined"){n.reject()}this.fadeIn()}))},handleHintForNotVisibleColumns:function(){if(this.hintForNotVisibleItems||!this.hasOnlyNotVisibleColumnsWithItems()){return}this.showHintForNotVisibleItems()},hasOnlyNotVisibleColumnsWithItems:function(){const t=this.getColumns();let e=false;for(let i=0;i<t.length;i++){const n=t[i];const o=n.items.filter((t=>t.id>-1)).length>0;if(!o){continue}if(this.isVisibleColumn(n)){e=false;break}else{e=true}}return e},isVisibleColumn:function(t){if(!t||!this.layout.gridContainer){return false}const e=BX.Dom.getPosition(this.layout.gridContainer);const i=BX.Dom.getPosition(t.layout.container);return i.left<e.right},showHintForNotVisibleItems:function(){if(this.hintForNotVisibleItems){return}const t=this.getData().entityType;const e=BX.Loc.getMessage(`CRM_GRID_HINT_FOR_NOT_VISIBLE_${t}_TITLE`)||BX.Loc.getMessage(`CRM_GRID_HINT_FOR_NOT_VISIBLE_${t}_TITLE_MSGVER_1`)||BX.Loc.getMessage("CRM_GRID_HINT_FOR_NOT_VISIBLE_ELEMENT_TITLE");const i=BX.Loc.getMessage(`CRM_GRID_HINT_FOR_NOT_VISIBLE_${t}_TEXT`)||BX.Loc.getMessage(`CRM_GRID_HINT_FOR_NOT_VISIBLE_${t}_TEXT_MSGVER_1`)||BX.Loc.getMessage("CRM_GRID_HINT_FOR_NOT_VISIBLE_ELEMENT_TEXT");this.hintForNotVisibleItems=new BX.UI.Tour.Guide({onEvents:true,simpleMode:true,steps:[{target:".main-kanban-ear-right",title:e,text:i,position:"left"}]});this.hintForNotVisibleItems.showNextStep();this.adjustHintForNotVisibleItems();this.handleHideHintForNotVisibleItems=this.hideHintForNotVisibleItems.bind(this);BX.Event.bind(window,"scroll",this.handleHideHintForNotVisibleItems);BX.Event.bind(this.layout.gridContainer,"scroll",this.handleHideHintForNotVisibleItems);BX.addCustomEvent("BX.Main.Filter:apply",this.handleHideHintForNotVisibleItems);this.addClassEar()},hideHintForNotVisibleItems:function(){if(this.hintForNotVisibleItems){BX.Event.unbind(this.layout.gridContainer,"scroll",this.handleHideHintForNotVisibleItems);BX.Event.unbind(window,"scroll",this.handleHideHintForNotVisibleItems);this.hintForNotVisibleItems.close();this.hintForNotVisibleItems=null}},adjustHintForNotVisibleItems:function(){if(!this.hintForNotVisibleItems){return}const t=this.hintForNotVisibleItems.getPopup();const e=BX.Dom.getPosition(t.bindElement);const{width:i}=BX.Dom.getPosition(t.getPopupContainer());const n=18;const o=13;const s=16;const a=e.top+e.height/2-n/2-s+"px";const r=e.left-i-o+"px";BX.Dom.style(t.getPopupContainer(),"top",a);BX.Dom.style(t.getPopupContainer(),"left",r)},adjustLayout:function(){BX.Kanban.Grid.prototype.adjustLayout.apply(this,arguments);this.adjustHintForNotVisibleItems()},clearItemMoving:function(){this.itemMoving=null},addClassEar:function(){var t=document.querySelector(".main-kanban-ear-right");t.classList.contains("crm-kanban-ear-animate")?BX.Dom.removeClass("crm-kanban-ear-animate"):null;BX.Dom.addClass(t,"crm-kanban-ear-animate")},toggleCC:function(t){let e=this._analyticsDictionary.SUB_SECTION_GRID_ROW_MENU;let i=this._analyticsDictionary.ELEMENT_HIDE_CONTACT_CENTER;if(t===undefined){t=BX.PopupMenu.getCurrentMenu();e=this._analyticsDictionary.SUB_SECTION_KANBAN;i=this._analyticsDictionary.ELEMENT_CLOSE_BUTTON}if(t){t.close()}if(this.ccItem){var n=this.getData();if(n.contactCenterShow){this.hideItem(this.ccItem);this.registerAnalyticsSpecialItemCloseEvent(this.ccItem,e,i)}else{this.unhideItem(this.ccItem);this.registerAnalyticsSpecialItemEnableEvent(this.ccItem,this._analyticsDictionary.SUB_SECTION_GRID_ROW_MENU,this._analyticsDictionary.ELEMENT_ENABLE_CONTACT_CENTER)}n.contactCenterShow=!n.contactCenterShow;if(t){t.removeMenuItem("crm_kanban_cc_delimiter");t.removeMenuItem("crm_kanban_cc")}}this.ajax({action:"toggleCC"},function(){}.bind(this),function(t){}.bind(this))},toggleRest:function(){if(this.restItem){this.hideItem(this.restItem)}this.ajax({action:"toggleRest"},function(){}.bind(this),function(t){}.bind(this))},unhideItem:function(t){const e=this.unhideItemWithoutColumnRender(t);if(e){t.getColumn().render()}return e},unhideItemWithoutColumnRender:function(t){t=this.getItem(t);if(!t||t.isVisible()){return false}t.setOptions({visible:true});if(t.layout.container&&BX.Dom.hasClass(t.layout.container,"main-kanban-item-disabled")){BX.Dom.removeClass(t.layout.container,"main-kanban-item-disabled")}if(t.isCountable()){t.getColumn().incrementTotal()}return true},addMenuAdditionalFields:function(t){var e=BX.PopupMenu.getCurrentMenu(t);var i=e.getMenuItems();if(e&&i&&e.bindElement&&BX(e.bindElement)&&BX.hasClass(BX(e.bindElement),"ui-btn-icon-setting")){var n=i.length>0?i[0].getId():0;const t=[{text:BX.Loc.getMessage("CRM_KANBAN_SETTINGS_FIELDS_VIEW"),onclick:()=>this.showFieldsSelectPopup("view")}];if(this.getData().entityType!=="ORDER"){t.push({text:BX.message("CRM_KANBAN_SETTINGS_FIELDS_EDIT"),onclick:()=>{this.loadHiddenQuickEditorForFirstColumn();this.showFieldsSelectPopup("edit")}})}e.addMenuItem({text:BX.message("CRM_KANBAN_SETTINGS_TITLE"),items:t},n)}},loadHiddenQuickEditorForFirstColumn:function(){const t=this.columnsOrder[0]?.id;if(t){this.columns[t].showQuickEditor(true)}},addMenuToggleCS:function(t){var e=this.getData();var i=BX.PopupMenu.getCurrentMenu(t);if(i&&i.bindElement&&BX(i.bindElement)&&BX.hasClass(BX(i.bindElement),"ui-btn-icon-setting")){i.addMenuItem({text:"",delimiter:true},null);i.addMenuItem({text:e.contactCenterShow?BX.message("CRM_KANBAN_HIDE_CC"):BX.message("CRM_KANBAN_SHOW_CC"),onclick:function(t,e){this.toggleCC()}.bind(this)},null)}},getQuickEditor:function(){var t=this.getColumns();for(var e=0,i=t.length;e<i;e++){var n=t[e].getQuickEditor();if(n){return n}}return null},showFieldsSelectPopup:function(t){if(this.fieldsSelectors[t]){this.fieldsSelectors[t].show();return}const e=this.getData();BX.Runtime.loadExtension("ui.dialogs.checkbox-list").then((()=>{const i=t==="view"?e.customFields:e.customEditFields;this.fetchFields(t,e.entityType,i).then((e=>{this.fieldsSelectors[t]=this.createFieldsSelector(t,e);this.fieldsSelectors[t].show()}))}))},fetchFields:function(t,e,i){return new Promise((n=>{BX.ajax.runComponentAction("bitrix:crm.kanban","getPreparedFields",{mode:"ajax",data:{entityType:e,viewType:t,selectedFields:i}}).then((({status:t,data:i})=>{if(t==="success"){n(i);return}console.error(`Fields for ${e} not fetched`)}),(()=>{console.error(`Fields for ${e} not fetched`)}))}))},createFieldsSelector:function(t,e){const i=3;const n=BX.Loc.getMessage(`CRM_KANBAN_CUSTOM_FIELDS_${t.toUpperCase()}`);const o=BX.Loc.getMessage("CRM_EDITOR_FIELD_SEARCH_PLACEHOLDER");const s=BX.Loc.getMessage("CRM_EDITOR_FIELD_EMPTY_STATE_TITLE");const a=BX.Loc.getMessage("CRM_EDITOR_FIELD_EMPTY_STATE_DESCRIPTION");const r=BX.Loc.getMessage("CRM_EDITOR_FIELD_ALL_SECTIONS_DISABLED");const{sections:l,categories:c,options:d}=e;return new BX.UI.CheckboxList({columnCount:i,lang:{title:n,placeholder:o,emptyStateTitle:s,emptyStateDescription:a,allSectionsDisabledTitle:r},sections:l,categories:c,options:d,params:{destroyPopupAfterClose:false},events:{onApply:e=>this.onApplyCheckboxList(t,e.data.fields,d)}})},onApplyCheckboxList:function(t,e,i){const n={};e.forEach((t=>{const e=i.find((e=>e.id===t));n[t]=e?.title}));let o;const s=this.getData();if(t==="view"){o=s.customFields;s.customFields=Object.keys(n)}else{o=s.customEditFields;s.customEditFields=Object.keys(n)}this.ajax({action:"saveFields",fields:n,type:t},(()=>this.onSuccessFieldsSave(t,o)))},onSuccessFieldsSave:function(t,e){if(t==="view"){this.onApplyFilter();return}const i=this.getData();this.applyCustomEditFields(i.customEditFields,e)},applyCustomEditFields:function(t,e){var i=this.getQuickEditor().getControlById("main");var n=t.filter((function(t){return e.indexOf(t)<0&&i.getChildById(t)===null}));var o=e.filter((function(e){return t.indexOf(e)<0&&i.getChildById(e)!==null}));var s=this.getColumns();for(var a=0;a<s.length;a++){var r=s[a].getQuickEditor();if(!r){continue}var l;for(var c=0;c<n.length;c++){l=r.getAvailableSchemeElementByName(n[c]);if(l){var d=r.createControl(l.getType(),l.getName(),{schemeElement:l,model:r._model,mode:r._mode});if(d){r.getControlById("main").addChild(d,{layout:{forceDisplay:true},enableSaving:false})}}}for(var m=0;m<o.length;m++){l=r.getSchemeElementByName(o[m]);if(l){var u=r.getControlById("main");var h=u.getChildById(o[m]);if(h){u.removeChild(h,{enableSaving:false})}}}r.commitSchemeChanges()}this.getQuickEditor().saveSchemeChanges().then((function(){for(var t=0;t<s.length;t++){var e=s[t].getQuickEditor();if(e){e.refreshLayout()}}}))},destroyFieldsSelectPopup:function(){var t=BX.Main.PopupManager.getPopupById("kanban_custom_fields");if(t){t.destroy()}},destroyHideColumnSumPopups(){this.getColumns().forEach((t=>{BX.PopupWindowManager.getPopupById(t.getHideColumnSumPopupId())?.destroy()}))},onPartialEditorClose:function(t,e){BX.Dom.removeClass(this.itemMoving.item.layout.container,"main-kanban-item-waiting");if(e.isCancelled){return}var i=false;if(e.entityData){var n=this.itemMoving.item.getData();var o=this.itemMoving.newColumn.getId();const t=this.getRequiredFieldsForColumnId(o,n);if(BX.Type.isArrayFilled(t)){let o=false;const u={};const h=["PHONE","EMAIL","IM","WEB"];h.forEach((t=>{if(e.entityData[t]){n.required_fm[t]=false;u[t]=true}}));for(var s=0,a=t.length;s<a;s++){var r=t[s];if(u[r]){o=false}else if(e.entityData[r]&&(typeof e.entityData[r]==="object"&&e.entityData[r].IS_EMPTY===false||typeof e.entityData[r]!=="object"&&e.entityData[r]!=="")){o=false}else if(r==="OPPORTUNITY_WITH_CURRENCY"&&parseFloat(e.entityData["OPPORTUNITY"])>0){this.itemMoving.item.setDataKey("runtimePrice",true);o=false}else if(r==="CLIENT"&&(parseInt(e.entityData["CONTACT_ID"])>0||parseInt(e.entityData["COMPANY_ID"])>0)){o=false}else if(r==="FILES"&&(BX.Type.isArray(e.entityData["STORAGE_ELEMENT_IDS"])&&e.entityData["STORAGE_ELEMENT_IDS"].reduce((function(t,e){return t+e}),0)>0)){o=false}else if(r==="OBSERVER"&&e.entityData["OBSERVER_IDS"].length){o=false}else{o=true}if(!o){for(var l in n.required){var c=n.required[l];for(var d=0,m=c.length;d<m;d++){if(c[d]===r){c=BX.util.deleteFromArray(c,d);break}}n.required[l]=c}}else{i=true}}this.itemMoving.item.setDataKey("required",n.required);this.itemMoving.item.setDataKey("required_fm",this.itemMoving.item.getRequiredFm());if(e.entityData["OPPORTUNITY_ACCOUNT"]){this.itemMoving.price=parseFloat(e.entityData["OPPORTUNITY_ACCOUNT"]);this.itemMoving.item.setDataKey("price",this.itemMoving.price);this.itemMoving.item.setDataKey("price_formatted",e.entityData["FORMATTED_OPPORTUNITY_ACCOUNT_WITH_CURRENCY"])}}}if(this.itemMoving.newColumn instanceof BX.Kanban.DropZone){this.itemMoving.newColumn.captureItem(this.itemMoving.item)}else{if(!i){if(this.itemMoving?.oldColumn?.id){this.itemMoving.item.columnId=this.itemMoving.oldColumn.id}this.moveItem(this.itemMoving.item,this.itemMoving.newColumn,this.itemMoving.newNextSibling)}}},getRequiredFieldsForColumnId(t,e){return[...e.required?.[t]??[],...e.required?.ALL??[]]},onPullEventHandlerCrm:function(t,e){var i=this.getData();if(t==="notify"){if(i.entityType==="INVOICE"&&e.settingName==="crm|invoice_responsible_changed"){var n=e.originalTag.match(new RegExp("CRM\\|"+i.entityType+"\\|([\\d]+)"));if(n&&n[1]){this.loadNew(n[1])}}}},onCrmActivityTodoChecked:function(t,e,i,n){const o=this.getItem(e);if(!o){return}if(n){let t=o.getActivityErrorTotal();t--;o.setDataKey("activityErrorTotal",t)}let s=o.getActivityProgress();s--;o.setDataKey("activityProgress",s);o.switchPlanner()},onSliderClose:function(t){var e=this.getData();var i=e.entityPath;var n=t.slider.getUrl();i=i.replace(/\#([^\#]+)\#/,"([\\d]+)");var o=n.match(new RegExp(i));if(o&&o[1]){this.loadNew(o[1],false,true,true,true)}},onPopupShow:function(t){if(this.isPopupInKanbanColumn(t)){if(this.handleScrollWithOpenPopupInKanbanColumn){this.onPopupClose()}this.handleScrollWithOpenPopupInKanbanColumn=e=>{t.close()};BX.Event.EventEmitter.subscribe(this,"Kanban.Column:onScroll",this.handleScrollWithOpenPopupInKanbanColumn);BX.Event.bind(window,"scroll",this.handleScrollWithOpenPopupInKanbanColumn);BX.Event.bind(this.layout.gridContainer,"scroll",this.handleScrollWithOpenPopupInKanbanColumn)}var e=["menu-popup-toolbar_lead_list_menu","menu-popup-toolbar_deal_list_menu","menu-popup-toolbar_order_kanban_menu","menu-popup-toolbar_quote_list_menu"];var i=["menu-popup-toolbar_order_kanban_menu","menu-popup-toolbar_quote_list_menu"];var n=["toolbar_lead_list_settings_menu","toolbar_deal_list_settings_menu"];if(e.indexOf(t.uniquePopupId)!==-1){var o=t.uniquePopupId.substr(11);this.addMenuAdditionalFields(o);if(i.indexOf(t.uniquePopupId)===-1){this.addMenuToggleCS(o)}}else if(n.indexOf(t.uniquePopupId)!==-1){var s=this.getSettingsButtonMenu();if(s!==null){var a=this.getData();s.addMenuItem({id:"crm_kanban_cc_delimiter",delimiter:true},null);s.addMenuItem({id:"crm_kanban_cc",text:a.contactCenterShow?BX.message("CRM_KANBAN_HIDE_CC"):BX.message("CRM_KANBAN_SHOW_CC"),onclick:function(t){this.toggleCC(s)}.bind(this)},null)}}},onPopupClose:function(){if(this.handleScrollWithOpenPopupInKanbanColumn){BX.Event.EventEmitter.unsubscribe(this,"Kanban.Column:onScroll",this.handleScrollWithOpenPopupInKanbanColumn);BX.Event.unbind(window,"scroll",this.handleScrollWithOpenPopupInKanbanColumn);BX.Event.unbind(this.layout.gridContainer,"scroll",this.handleScrollWithOpenPopupInKanbanColumn);this.handleScrollWithOpenPopupInKanbanColumn=null}},isPopupInKanbanColumn(t){const e="main-kanban-column";let i=t.bindElement;const n=BX.hasClass(t.popupContainer,"popup-window-ui-tour");if(n){return false}while(i&&!BX.Dom.hasClass(i,e)){i=i.parentNode}return!!i},setMultiSelectMode:function(){this.multiSelectMode=true;this.setKanbanDragMode()},initActionPanel:function(){var t=this.getData();var e=document.querySelector(".page-navigation");const i=BX.Reflection.getClass("BX.Intranet.Bitrix24.Template")!==null;if(!e){e=i?document.querySelector(".page__actions"):document.getElementById("uiToolbarContainer")}if(this.customActionPanel){this.customActionPanel.renderTo=e;this.actionPanel=this.customActionPanel;this.actionPanel.draw();return}this.actionPanel=new BX.UI.ActionPanel({renderTo:e,removeLeftPosition:true,maxHeight:58,parentPosition:"bottom",autoHide:false});this.actionPanel.draw();this.actionPanel.appendItem({id:"kanban_delete",text:BX.message("CRM_KANBAN_PANEL_DELETE"),icon:"/bitrix/js/crm/kanban/images/crm-kanban-actionpanel-delete.svg",onclick:()=>{BX.CRM.Kanban.Actions.deleteAll(this)}});if(this.getTypeInfoParam("canUseIgnoreItemInPanel")){this.actionPanel.appendItem({id:"kanban_ignore",text:BX.message("CRM_KANBAN_PANEL_IGNORE"),icon:"/bitrix/js/crm/kanban/images/crm-kanban-actionpanel-ignore.svg",onclick:()=>{BX.CRM.Kanban.Actions.ignore(this)}})}var n=[],o=[],s=this.getColumns(),a=this.getDropZoneArea().getDropZones();for(var r=0,l=s.length;r<l;r++){o.push({id:s[r].id,name:s[r].name,blockedIncomingMoving:this.isBlockedIncomingMoving(s[r]),type:s[r].data.type})}for(var r=0,l=a.length;r<l;r++){var c=a[r].getData();if(t.entityType==="LEAD"&&c.type==="LOOSE"||t.entityType!=="LEAD"&&c.type){o.push({id:a[r].id,name:a[r].name,blockedIncomingMoving:this.isBlockedIncomingMoving(s[r]),type:a[r].data.type})}}for(var r=0,l=o.length;r<l;r++){if(o[r].blockedIncomingMoving){continue}n.push({id:"kanban_column_"+o[r].id,column:o[r],text:BX.util.htmlspecialchars(o[r].name),onclick:function(t,e){e.menuWindow.close();BX.CRM.Kanban.Actions.changeColumn(this,e.column)}.bind(this)})}this.actionPanel.appendItem({id:"kanban_column",text:BX.message("CRM_KANBAN_PANEL_STAGE"),items:n,icon:t.entityType==="DEAL"||t.isDynamicEntity?"/bitrix/js/crm/kanban/images/crm-kanban-actionpanel-stage.svg":"/bitrix/js/crm/kanban/images/crm-kanban-actionpanel-status.svg"});this.appendChangeCategoryItem();this.appendAssignedItem();if(this.getTypeInfoParam("canUseCreateTaskInPanel")){this.actionPanel.appendItem({id:"kanban_task",text:BX.message("CRM_KANBAN_PANEL_TASK"),icon:"/bitrix/js/crm/kanban/images/crm-kanban-actionpanel-create.svg",onclick:function(){BX.CRM.Kanban.Actions.task(this)}.bind(this)})}if(this.getTypeInfoParam("canUseCallListInPanel")){this.actionPanel.appendItem({id:"kanban_calllist",text:BX.message("CRM_KANBAN_PANEL_CALLLIST"),icon:"/bitrix/js/crm/kanban/images/crm-kanban-actionpanel-call.svg",onclick:function(){BX.CRM.Kanban.Actions.startCallList(this,false)}.bind(this)})}if(this.getTypeInfoParam("canUseMergeInPanel")){this.actionPanel.appendItem({id:"kanban_merge",text:BX.message("CRM_KANBAN_PANEL_MERGE"),icon:"/bitrix/js/crm/kanban/images/crm-kanban-actionpanel-merge.svg",onclick:function(){BX.CRM.Kanban.Actions.merge(this)}.bind(this)})}},appendChangeCategoryItem:function(){const t=this.getData();if(!BX.type.isArrayFilled(t?.categories)){return}const e=[];t.categories.forEach((t=>{e.push({id:`kanban_category_${t.ID}`,category:t,text:BX.Text.encode(t.NAME),onclick:(t,e)=>{e.menuWindow.close();BX.CRM.Kanban.Actions.changeCategory(this,e.category)}})}));if(e.length<=1){return}this.actionPanel.appendItem({id:"kanban_category",text:BX.Loc.getMessage("CRM_KANBAN_PANEL_CATEGORY2"),icon:"/bitrix/js/crm/kanban/images/crm-kanban-actionpanel-fulling.svg",items:e})},appendAssignedItem:function(){if(BX.type.isUndefined(BX.UI.EntityEditorUserSelector)){return}this.actionPanel.appendItem({id:"kanban_assigned",text:BX.Loc.getMessage("CRM_KANBAN_PANEL_ASSIGNED"),icon:"/bitrix/js/crm/kanban/images/crm-kanban-actionpanel-responsible.svg",onclick:(t,e)=>{setTimeout((()=>{const t=BX.type.isUndefined(e.layout.container)?e.actionPanel.layout.more:e.layout.container;this.getResponsibleUserSelectorDialog(t).show()}),100)}})},getResponsibleUserSelectorDialog(t){return new BX.UI.EntitySelector.Dialog({id:"crm-kanban-responsible-user-selector-dialog",targetNode:t,context:"CRM_KANBAN_RESPONSIBLE_USER",multiple:false,enableSearch:true,width:450,entities:[{id:"user",options:{inviteEmployeeLink:false,emailUsers:false,inviteGuestLink:false,intranetUsersOnly:true}},{id:"structure-node",options:{selectMode:"usersOnly"}}],events:{"Item:onSelect":t=>{this.onResponsibleUserSelect(t)}},popupOptions:{className:"responsible-user-selector-dialog"}})},onResponsibleUserSelect(t){const{item:e}=t.getData();if(e){BX.CRM.Kanban.Actions.setAssigned(this,{entityId:e.getId(),name:BX.Text.encode(e.getTitle())})}},isBlockedIncomingMoving:function(t){return t&&t.data&&t.data.blockedIncomingMoving||false},hideUiToolbarContainer(){var t=document.getElementById("uiToolbarContainer");BX.Dom.addClass(t,"--transparent")},showUiToolbarContainer(){var t=document.getElementById("uiToolbarContainer");BX.Dom.removeClass(t,"--transparent")},startActionPanel:function(){if(!this.actionPanel){this.initActionPanel()}this.actionPanel.showPanel()},stopActionPanel:function(t=false,e=false){if(!this.actionPanel){return}if(t||!this.getChecked().length){this.actionPanel.hidePanel()}},resetActionPanel:function(){if(this.actionPanel){this.actionPanel.removeItems();this.actionPanel=null}if(this.customActionPanel){this.customActionPanel.removeItems();this.customActionPanel=null}},onItemUnselect:function(t){this.stopActionPanel()},setCustomActionPanel:function(t){this.customActionPanel=t},reload:function(){this.resetMultiSelectMode();this.unSetKanbanDragMode();this.onApplyFilter()},calculateTotalCheckItems:function(){if(!this.actionPanel){this.initActionPanel()}this.actionPanel.setTotalSelectedItems(this.getChecked().length)},isMultiSelectMode:function(){return this.multiSelectMode},onMultiSelectMode:function(){if(this.multiSelectMode)return;this.multiSelectMode=true;BX.Dom.addClass(this.layout.gridContainer,"crm-kanban-multi-select-mode")},resetMultiSelectMode:function(){for(var t=0;t<this.getChecked().length;t++){this.getChecked()[t].unSelectItem();if(this.getChecked()[t].layout.container&&this.getChecked()[t].layout.container.classList.contains("main-kanban-item-disabled")){BX.Dom.removeClass(this.getChecked()[t].layout.container,"main-kanban-item-disabled")}}this.checkedItems=[];this.actionItems=[];this.multiSelectMode=false;BX.Dom.removeClass(this.layout.gridContainer,"crm-kanban-multi-select-mode")},onOpenEditorMenu:function(t,e){var i=this.getData();var n=this.getQuickEditor();if(n){i.customEditFields=[];var o=n.getControlById("main");for(var s=0,a=o._fields.length;s<a;s++){i.customEditFields.push(o._fields[s].getId())}this.setData(i)}var r=[],l=null;r.push({id:r.length+1,text:BX.message("CRM_KANBAN_CUSTOM_FIELDS_VIEW"),onclick:function(){this.showFieldsSelectPopup("view",t)}.bind(this)});r.push({id:r.length+1,text:BX.message("CRM_KANBAN_CUSTOM_FIELDS_EDIT"),onclick:function(){this.showFieldsSelectPopup("edit",t)}.bind(this)});l=new BX.PopupMenuWindow("crm-kanban-qiuck-form-add-fields-popup",t._addChildButton,r,{autohide:true,bindOptions:{forceBindPosition:true},autoHide:true,cacheable:false,closeByEsc:true});l.show();e["cancel"]=true},onConfigEditorScopeChange:function(){this.onApplyFilter()},onConfigEditorReset:function(){this.setAjaxParams({editorReset:"Y"});this.onApplyFilter()},onForceCommonEditorConfigScopeForAll:function(){this.setAjaxParams({editorSetCommon:"Y"});this.onApplyFilter()},insertItem:function(t,e={}){const i=e.hasOwnProperty("newColumnId")?e.newColumnId:t.columnId;const n=this.getColumn(i);if(n){const i=BX.CRM.Kanban.Sort.Sorter.createWithCurrentSortType(n.getItems());const o=i.calcBeforeItem(t);if(i.getSortType()===BX.CRM.Kanban.Sort.Type.BY_LAST_ACTIVITY_TIME&&e.canShowLastActivitySortTour){BX.Event.EventEmitter.emit("Kanban.Grid::onShowSortByLastActivityTour",{target:".main-kanban-item[data-id='"+t.id+"']",stepId:"step-sort-by-last-activity-time",delay:1e3})}if(t.columnId===n.getId()&&o===null){this.updateItemAtItsPosition(t)}else{this.moveItem(t,n.getId(),o)}}else{this.removeItem(t)}},removeItem:function(t){var e=this.getItem(t);if(e){e.useAnimation=true;var i=e.getColumn();delete this.items[e.getId()];i.removeItem(e);e.dispose()}return e},openPartialEditor:function(t,e,i){var n=this.getData();var o={};var s={entityTypeId:n.entityTypeInt,entityId:t,fieldNames:i,context:o};o[this.getTypeInfoParam("stageIdKey")]=e;o["NOT_CHANGE_STATUS"]="Y";if(this.getTypeInfoParam("useFactoryBasedApproach")){s.title=BX.message("CRM_TYPE_ITEM_PARTIAL_EDITOR_TITLE");s.isController=true;s.entityTypeName=n.entityType;s.stageId=e}else{s.title=BX.message("CRM_TYPE_ITEM_PARTIAL_EDITOR_TITLE")}this.progressBarEditor=BX.Crm.PartialEditorDialog.create("progressbar-entity-editor",s);window.setTimeout(function(){this.progressBarEditor.open()}.bind(this),150)},getTypeInfoParam:function(t){var e=this.getTypeInfo();return e[t]?e[t]:false},getTypeInfo:function(){return this.getData().typeInfo},getSettingsButtonMenu:function(){const t=BX.Crm.ToolbarComponent.Instance.getSettingsButton();return t?t.getMenuWindow():null},setCurrentSortType(t){return new Promise(((e,i)=>{this.ajax({action:"setCurrentSortType",sortType:t},e,i)}))}}})();
//# sourceMappingURL=grid.map.js