this.BX=this.BX||{};(function(exports,crm_clientSelector,ui_dialogs_messagebox,ui_navigationpanel,crm_router,main_core,main_core_events,main_popup,ui_buttons,ui_tour){"use strict";function _classPrivateMethodInitSpec(e,t){_checkPrivateRedeclaration(e,t);t.add(e)}function _classPrivateFieldInitSpec(e,t,i){_checkPrivateRedeclaration(e,t);t.set(e,i)}function _checkPrivateRedeclaration(e,t){if(t.has(e)){throw new TypeError("Cannot initialize the same private elements twice on an object")}}function _classPrivateMethodGet(e,t,i){if(!t.has(e)){throw new TypeError("attempted to get private field on non-instance")}return i}var _settings=new WeakMap;var _button=new WeakMap;var _isMenuOpened=new WeakMap;var _menuPopup=new WeakMap;var _isEnabled=new WeakMap;var _clientSelector=new WeakMap;var _getOwnerTypeName=new WeakSet;var _getOwnerId=new WeakSet;var _hasData=new WeakSet;var _enable=new WeakSet;var _openClientSelector=new WeakSet;var _openPopupMenu=new WeakSet;var _closeMenu=new WeakSet;var _onReceiversChange=new WeakSet;let CommunicationButton=function(){function e(t){babelHelpers.classCallCheck(this,e);_classPrivateMethodInitSpec(this,_onReceiversChange);_classPrivateMethodInitSpec(this,_closeMenu);_classPrivateMethodInitSpec(this,_openPopupMenu);_classPrivateMethodInitSpec(this,_openClientSelector);_classPrivateMethodInitSpec(this,_enable);_classPrivateMethodInitSpec(this,_hasData);_classPrivateMethodInitSpec(this,_getOwnerId);_classPrivateMethodInitSpec(this,_getOwnerTypeName);_classPrivateFieldInitSpec(this,_settings,{writable:true,value:{}});_classPrivateFieldInitSpec(this,_button,{writable:true,value:void 0});_classPrivateFieldInitSpec(this,_isMenuOpened,{writable:true,value:false});_classPrivateFieldInitSpec(this,_menuPopup,{writable:true,value:void 0});_classPrivateFieldInitSpec(this,_isEnabled,{writable:true,value:false});_classPrivateFieldInitSpec(this,_clientSelector,{writable:true,value:void 0});babelHelpers.classPrivateFieldSet(this,_settings,t||{});babelHelpers.classPrivateFieldSet(this,_button,babelHelpers.classPrivateFieldGet(this,_settings).button);babelHelpers.classPrivateFieldGet(this,_button).bindEvent("click",this.onButtonClick.bind(this));this.ownerInfo=BX.prop.getObject(babelHelpers.classPrivateFieldGet(this,_settings),"ownerInfo",{});this.data=BX.prop.getObject(babelHelpers.classPrivateFieldGet(this,_settings),"data",{});_classPrivateMethodGet(this,_enable,_enable2).call(this,_classPrivateMethodGet(this,_hasData,_hasData2).call(this));this.useClientSelector=BX.prop.getBoolean(babelHelpers.classPrivateFieldGet(this,_settings),"useClientSelector",false);main_core_events.EventEmitter.subscribe("BX.Crm.MessageSender.ReceiverRepository:OnReceiversChanged",_classPrivateMethodGet(this,_onReceiversChange,_onReceiversChange2).bind(this))}babelHelpers.createClass(e,[{key:"getOwnerInfo",value:function e(){return{ownerID:this.ownerInfo.ENTITY_ID,ownerType:this.ownerInfo.ENTITY_TYPE_NAME,ownerUrl:this.ownerInfo.SHOW_URL,ownerTitle:this.ownerInfo.TITLE}}},{key:"getMultifieldTypeName",value:function e(){return""}},{key:"isEnabled",value:function e(){return babelHelpers.classPrivateFieldGet(this,_isEnabled)}},{key:"getAddAddressSourceMessage",value:function e(t){return""}},{key:"onButtonClick",value:function e(t,i){}},{key:"prepareMenuItem",value:function e(t,i){}},{key:"openMenu",value:function e(){if(babelHelpers.classPrivateFieldGet(this,_isMenuOpened)){_classPrivateMethodGet(this,_closeMenu,_closeMenu2).call(this);return}const t=[];for(const[e,i]of Object.entries(this.data)){for(const n of i){t.push(this.prepareMenuItem(e,n))}}if(this.useClientSelector){_classPrivateMethodGet(this,_openClientSelector,_openClientSelector2).call(this,t)}else{_classPrivateMethodGet(this,_openPopupMenu,_openPopupMenu2).call(this,t)}}},{key:"onClientSelectorSelect",value:function e({data:{item:t}}){}}]);return e}();function _getOwnerTypeName2(){return BX.prop.getString(this.ownerInfo,"ENTITY_TYPE_NAME","")}function _getOwnerId2(){return BX.prop.getInteger(this.ownerInfo,"ENTITY_ID",0)}function _hasData2(){return main_core.Type.isPlainObject(this.data)&&main_core.Type.isArrayFilled(Object.keys(this.data))}function _enable2(e){babelHelpers.classPrivateFieldSet(this,_isEnabled,Boolean(e));babelHelpers.classPrivateFieldGet(this,_button).setDisabled(!babelHelpers.classPrivateFieldGet(this,_isEnabled));if(!babelHelpers.classPrivateFieldGet(this,_isEnabled)){const e=this.getAddAddressSourceMessage(_classPrivateMethodGet(this,_getOwnerTypeName,_getOwnerTypeName2).call(this));if(e){babelHelpers.classPrivateFieldGet(this,_button).getContainer().title=e}}}function _openClientSelector2(e){if(!babelHelpers.classPrivateFieldGet(this,_clientSelector)){babelHelpers.classPrivateFieldSet(this,_clientSelector,BX.Crm.ClientSelector.createFromItems({targetNode:babelHelpers.classPrivateFieldGet(this,_button).getContainer(),items:e,events:{onSelect:this.onClientSelectorSelect.bind(this),onShow:()=>{babelHelpers.classPrivateFieldSet(this,_isMenuOpened,true)},onHide:()=>{babelHelpers.classPrivateFieldSet(this,_isMenuOpened,false)}}}))}babelHelpers.classPrivateFieldGet(this,_clientSelector).show()}function _openPopupMenu2(e){babelHelpers.classPrivateFieldSet(this,_menuPopup,new main_popup.Menu({bindElement:babelHelpers.classPrivateFieldGet(this,_button).getContainer(),offsetTop:0,offsetLeft:0,cacheable:false,items:e,events:{onPopupShow:()=>{babelHelpers.classPrivateFieldSet(this,_isMenuOpened,true)},onPopupClose:()=>{babelHelpers.classPrivateFieldSet(this,_isMenuOpened,false)},onPopupDestroy:()=>{babelHelpers.classPrivateFieldSet(this,_isMenuOpened,false);babelHelpers.classPrivateFieldSet(this,_menuPopup,null)}}}));babelHelpers.classPrivateFieldGet(this,_menuPopup).show()}function _closeMenu2(){var e,t;(e=babelHelpers.classPrivateFieldGet(this,_menuPopup))===null||e===void 0?void 0:e.close();(t=babelHelpers.classPrivateFieldGet(this,_clientSelector))===null||t===void 0?void 0:t.hide()}function _onReceiversChange2(e){const{item:t,current:i}=e.getData();if(t.entityTypeName!==_classPrivateMethodGet(this,_getOwnerTypeName,_getOwnerTypeName2).call(this)||t.entityId!==_classPrivateMethodGet(this,_getOwnerId,_getOwnerId2).call(this)){return}this.data={};for(const e of i){var n,a;if(e.address.typeId!==this.getMultifieldTypeName()){continue}const t=`${e.addressSource.entityTypeId}_${e.addressSource.entityId}`;(a=(n=this.data)[t])!==null&&a!==void 0?a:n[t]=[];this.data[t].push({ID:e.address.id,ENTITY_ID:e.addressSource.entityId,ENTITY_TYPE_NAME:e.addressSource.entityTypeName,TYPE_ID:e.address.typeId,VALUE_TYPE:e.address.valueType,VALUE:e.address.value,VALUE_FORMATTED:e.address.valueFormatted,COMPLEX_ID:e.address.complexId,COMPLEX_NAME:e.address.complexName,OWNER:{ID:e.addressSource.entityId,TYPE_ID:e.addressSource.entityTypeId,TITLE:e.addressSourceData.title}})}_classPrivateMethodGet(this,_enable,_enable2).call(this,_classPrivateMethodGet(this,_hasData,_hasData2).call(this))}let EmailButton=function(e){babelHelpers.inherits(t,e);function t(){babelHelpers.classCallCheck(this,t);return babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).apply(this,arguments))}babelHelpers.createClass(t,[{key:"getAddAddressSourceMessage",value:function e(t){return main_core.Loc.getMessage(`CRM_TOOLBAR_COMPONENT_ADD_CLIENT_FOR_EMAIL_SEND_${t}`)||main_core.Loc.getMessage("CRM_TOOLBAR_COMPONENT_ADD_CLIENT_FOR_EMAIL_SEND")}},{key:"onButtonClick",value:function e(t,i){if(!this.isEnabled()){return}if(!this.useClientSelector){BX.CrmActivityEditor.addEmail(this.getOwnerInfo());return}const n=Object.keys(this.data);if(n.length===1){const e=n[0];const t=this.data[e];if(t.length===1){BX.CrmActivityEditor.addEmail(this.getOwnerInfo());return}}this.openMenu()}},{key:"prepareMenuItem",value:function e(t,i){var n,a;if(!main_core.Type.isPlainObject(i)||!this.useClientSelector){return{}}return{id:i.ID,title:i.OWNER?i.OWNER.TITLE:i.VALUE_FORMATTED,subtitle:i.OWNER?`${i.VALUE_FORMATTED}, ${i.COMPLEX_NAME}`:i.COMPLEX_NAME,avatar:null,customData:{entityId:i.OWNER?i.OWNER.ID:null,entityTypeId:i.OWNER?i.OWNER.TYPE_ID:null,value:(n=i.VALUE)!==null&&n!==void 0?n:null,valueType:(a=i.VALUE_TYPE)!==null&&a!==void 0?a:null}}}},{key:"onClientSelectorSelect",value:function e({data:{item:t}}){const{customData:i}=t;const n=i.get("entityTypeId");const a=this.getOwnerInfo();a.mailDefaultCommunications=[{ENTITY_ID:i.get("entityId"),ENTITY_TYPE_ID:n,ENTITY_TYPE_NAME:BX.CrmEntityType.resolveName(n),TYPE:this.getMultifieldTypeName(),VALUE:i.get("value"),VALUE_TYPE:i.get("valueType")}];BX.CrmActivityEditor.addEmail(a)}},{key:"getMultifieldTypeName",value:function e(){return"EMAIL"}}]);return t}(CommunicationButton);function _classPrivateMethodInitSpec$1(e,t){_checkPrivateRedeclaration$1(e,t);t.add(e)}function _checkPrivateRedeclaration$1(e,t){if(t.has(e)){throw new TypeError("Cannot initialize the same private elements twice on an object")}}function _classPrivateMethodGet$1(e,t,i){if(!t.has(e)){throw new TypeError("attempted to get private field on non-instance")}return i}var _openChat=new WeakSet;let MessengerButton=function(e){babelHelpers.inherits(t,e);function t(...e){var i;babelHelpers.classCallCheck(this,t);i=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this,...e));_classPrivateMethodInitSpec$1(babelHelpers.assertThisInitialized(i),_openChat);return i}babelHelpers.createClass(t,[{key:"onButtonClick",value:function e(t,i){const n=Object.keys(this.data);if(n.length===1){const e=n[0];const t=this.data[e];if(t.length===1){const i=e.split("_");if(i.length>=2){_classPrivateMethodGet$1(this,_openChat,_openChat2).call(this,e,t[0]);return}}}this.openMenu()}},{key:"prepareMenuItem",value:function e(t,i){let n="";let a="";if(main_core.Type.isPlainObject(i)){a=BX.prop.getString(i,"VALUE","");const e=BX.prop.getString(i,"VALUE_TYPE","");if(e==="OPENLINE"){n=BX.prop.getString(i,"COMPLEX_NAME","")}else{n=`${BX.prop.getString(i,"COMPLEX_NAME","")}: ${BX.prop.getString(i,"VALUE_FORMATTED","")}`}}else{n=i;a=i}return{text:n,onclick:()=>{_classPrivateMethodGet$1(this,_openChat,_openChat2).call(this,t,a)}}}},{key:"getMultifieldTypeName",value:function e(){return"IM"}}]);return t}(CommunicationButton);function _openChat2(e,t){if(main_core.Type.isNil(window.top.BXIM)){console.error("crm.toolbar-component: messaging not supported");return}const i=main_core.Type.isPlainObject(t)?t.VALUE:t;window.top.BXIM.openMessengerSlider(i,{RECENT:"N",MENU:"N"})}function _classPrivateMethodInitSpec$2(e,t){_checkPrivateRedeclaration$2(e,t);t.add(e)}function _checkPrivateRedeclaration$2(e,t){if(t.has(e)){throw new TypeError("Cannot initialize the same private elements twice on an object")}}function _classPrivateMethodGet$2(e,t,i){if(!t.has(e)){throw new TypeError("attempted to get private field on non-instance")}return i}var _createClientSelectorMenuItem=new WeakSet;var _createPopupMenuItem=new WeakSet;var _addCall=new WeakSet;let PhoneButton=function(e){babelHelpers.inherits(t,e);function t(...e){var i;babelHelpers.classCallCheck(this,t);i=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this,...e));_classPrivateMethodInitSpec$2(babelHelpers.assertThisInitialized(i),_addCall);_classPrivateMethodInitSpec$2(babelHelpers.assertThisInitialized(i),_createPopupMenuItem);_classPrivateMethodInitSpec$2(babelHelpers.assertThisInitialized(i),_createClientSelectorMenuItem);return i}babelHelpers.createClass(t,[{key:"getAddAddressSourceMessage",value:function e(t){return main_core.Loc.getMessage(`CRM_TOOLBAR_COMPONENT_ADD_CLIENT_FOR_CALL_${t}`)||main_core.Loc.getMessage("CRM_TOOLBAR_COMPONENT_ADD_CLIENT_FOR_CALL")}},{key:"onButtonClick",value:function e(t,i){if(!this.isEnabled()){return}const n=Object.keys(this.data);if(n.length===1){const e=n[0];const t=this.data[e];if(t.length===1){const i=e.split("_");if(i.length>=2){_classPrivateMethodGet$2(this,_addCall,_addCall2).call(this,e,t[0]);return}}}this.openMenu()}},{key:"prepareMenuItem",value:function e(t,i){let n=i;let a=i;if(main_core.Type.isPlainObject(i)){const e=BX.prop.getString(i,"COMPLEX_NAME","");const t=BX.prop.getString(i,"VALUE_FORMATTED","");n=`${e}: ${t}`;a=BX.prop.getString(i,"VALUE","");if(this.useClientSelector){return _classPrivateMethodGet$2(this,_createClientSelectorMenuItem,_createClientSelectorMenuItem2).call(this,i)}}return _classPrivateMethodGet$2(this,_createPopupMenuItem,_createPopupMenuItem2).call(this,t,a,n)}},{key:"onClientSelectorSelect",value:function e({data:{item:t}}){const{customData:i}=t;const n=`${i.get("entityTypeId")}_${i.get("entityId")}`;const a=i.get("value");_classPrivateMethodGet$2(this,_addCall,_addCall2).call(this,n,a)}},{key:"getMultifieldTypeName",value:function e(){return"PHONE"}}]);return t}(CommunicationButton);function _createClientSelectorMenuItem2(e){const t=BX.prop.getString(e,"COMPLEX_NAME","");const i=BX.prop.getString(e,"VALUE_FORMATTED","");const n=BX.prop.getString(e,"VALUE","");const a=main_core.Type.isObjectLike(e.OWNER)?e.OWNER:null;return{id:e.ID,title:a?a.TITLE:i,subtitle:a?`${i}, ${t}`:t,avatar:null,customData:{entityId:a?a.ID:null,entityTypeId:a?a.TYPE_ID:null,value:n}}}function _createPopupMenuItem2(e,t,i){return{text:i,onclick:()=>{_classPrivateMethodGet$2(this,_addCall,_addCall2).call(this,e,t)}}}function _addCall2(e,t){if(main_core.Type.isNil(window.top.BXIM)){ui_dialogs_messagebox.MessageBox.alert(main_core.Loc.getMessage("CRM_TOOLBAR_COMPONENT_TELEPHONY_NOT_SUPPORTED"),null,main_core.Loc.getMessage("CRM_TOOLBAR_COMPONENT_TELEPHONY_NOT_SUPPORTED_OK"));return}const i=e.split("_");if(i.length<2){return}const n=main_core.Text.toInteger(i[0]);const a=main_core.Text.toInteger(i[1]);const s=BX.prop.getInteger(this.ownerInfo,"ENTITY_TYPE_ID",0);const r=BX.prop.getInteger(this.ownerInfo,"ENTITY_ID",0);const o=main_core.Type.isPlainObject(t)?t.VALUE:t;const l={ENTITY_TYPE_NAME:BX.CrmEntityType.resolveName(n),ENTITY_ID:a,AUTO_FOLD:true};if(s!==n||r!==a){l.BINDINGS=[{OWNER_TYPE_NAME:BX.CrmEntityType.resolveName(s),OWNER_ID:r}]}window.top.BXIM.phoneTo(o,l)}function _classPrivateFieldInitSpec$1(e,t,i){_checkPrivateRedeclaration$3(e,t);t.set(e,i)}function _checkPrivateRedeclaration$3(e,t){if(t.has(e)){throw new TypeError("Cannot initialize the same private elements twice on an object")}}var _id=new WeakMap;var _binding=new WeakMap;let NavigationBar=function(_NavigationPanel){babelHelpers.inherits(NavigationBar,_NavigationPanel);function NavigationBar(options){var _this;babelHelpers.classCallCheck(this,NavigationBar);if(!main_core.Type.isPlainObject(options)){throw'BX.Crm.NavigationBar: The "options" argument must be object.'}options.items=main_core.Type.isArray(options.items)?options.items:[];options.items.forEach((item=>{if(!item.hasOwnProperty("active")&&item.hasOwnProperty("isActive")){item.active=item.isActive}if(main_core.Type.isStringFilled(item.lockedCallback)){item.locked=true;item.url="";item.events={click:()=>eval(item.lockedCallback)}}if(main_core.Type.isStringFilled(item.url)){item.events={click:()=>_this.openUrl(item.id,item.url)}}}));_this=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(NavigationBar).call(this,{target:BX(options.id),items:options.items}));_classPrivateFieldInitSpec$1(babelHelpers.assertThisInitialized(_this),_id,{writable:true,value:void 0});_classPrivateFieldInitSpec$1(babelHelpers.assertThisInitialized(_this),_binding,{writable:true,value:void 0});babelHelpers.classPrivateFieldSet(babelHelpers.assertThisInitialized(_this),_id,options.id);babelHelpers.classPrivateFieldSet(babelHelpers.assertThisInitialized(_this),_binding,options.binding);return _this}babelHelpers.createClass(NavigationBar,[{key:"openUrl",value:function e(t,i){if(!main_core.Type.isStringFilled(i)){return}if(babelHelpers.classPrivateFieldGet(this,_binding)&&main_core.Type.isPlainObject(babelHelpers.classPrivateFieldGet(this,_binding))){const e=main_core.Type.isStringFilled(babelHelpers.classPrivateFieldGet(this,_binding).category)?babelHelpers.classPrivateFieldGet(this,_binding).category:"";const i=main_core.Type.isStringFilled(babelHelpers.classPrivateFieldGet(this,_binding).name)?babelHelpers.classPrivateFieldGet(this,_binding).name:"";const n=main_core.Type.isStringFilled(babelHelpers.classPrivateFieldGet(this,_binding).key)?babelHelpers.classPrivateFieldGet(this,_binding).key:"";if(e!==""&&i!==""&&n!==""){const a=t+":"+BX.formatDate(new Date,"YYYYMMDD");BX.userOptions.save(e,i,n,a,false)}}setTimeout((function(){window.location.href=i}),150)}}]);return NavigationBar}(ui_navigationpanel.NavigationPanel);function _classPrivateMethodInitSpec$3(e,t){_checkPrivateRedeclaration$4(e,t);t.add(e)}function _checkPrivateRedeclaration$4(e,t){if(t.has(e)){throw new TypeError("Cannot initialize the same private elements twice on an object")}}function _classPrivateMethodGet$3(e,t,i){if(!t.has(e)){throw new TypeError("attempted to get private field on non-instance")}return i}const MENU_ID_PREFIX="toolbar-category-";let instance=null;let ToolbarEvents=function e(){babelHelpers.classCallCheck(this,e)};babelHelpers.defineProperty(ToolbarEvents,"TYPE_UPDATED","TypeUpdated");babelHelpers.defineProperty(ToolbarEvents,"CATEGORIES_UPDATED","CategoriesUpdated");babelHelpers.defineProperty(ToolbarEvents,"AUTOMATED_SOLUTION_UPDATED","CategoriesUpdated");var _bindAutomationGuide=new WeakSet;var _reloadCategoriesMenu=new WeakSet;var _reloadAddButtonMenu=new WeakSet;var _tryRedirectToDefaultCategory=new WeakSet;let ToolbarComponent=function(e){babelHelpers.inherits(t,e);function t(){var e;babelHelpers.classCallCheck(this,t);e=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this));_classPrivateMethodInitSpec$3(babelHelpers.assertThisInitialized(e),_tryRedirectToDefaultCategory);_classPrivateMethodInitSpec$3(babelHelpers.assertThisInitialized(e),_reloadAddButtonMenu);_classPrivateMethodInitSpec$3(babelHelpers.assertThisInitialized(e),_reloadCategoriesMenu);_classPrivateMethodInitSpec$3(babelHelpers.assertThisInitialized(e),_bindAutomationGuide);e.initHints();e.setEventNamespace("BX.Crm.ToolbarComponent");main_core.Event.ready(e.bindEvents.bind(babelHelpers.assertThisInitialized(e)));return e}babelHelpers.createClass(t,[{key:"initHints",value:function e(){BX.UI.Hint.init(BX("ui-toolbar-after-title-buttons"));BX.UI.Hint.popupParameters={closeByEsc:true,autoHide:true,angle:{offset:60},offsetLeft:40}}},{key:"bindEvents",value:function e(){const t=document.querySelector('[data-role="bx-crm-toolbar-categories-button"]');if(t){const e=BX.UI.ToolbarManager.getDefaultToolbar();const i=e.getButton(main_core.Dom.attr(t,"data-btn-uniqid"));const n=Number(t.dataset.entityTypeId);if(i.counterNode&&i.counterNode.innerText>99){i.counterNode.innerText="99+"}if(i&&n>0){this.subscribeCategoriesUpdatedEvent((()=>{_classPrivateMethodGet$3(this,_reloadCategoriesMenu,_reloadCategoriesMenu2).call(this,i,n,t.dataset.categoryId)}))}}_classPrivateMethodGet$3(this,_bindAutomationGuide,_bindAutomationGuide2).call(this)}},{key:"emitTypeUpdatedEvent",value:function e(t){this.emit(ToolbarEvents.TYPE_UPDATED,t)}},{key:"emitAutomatedSolutionUpdatedEvent",value:function e(t){this.emit(ToolbarEvents.AUTOMATED_SOLUTION_UPDATED,t)}},{key:"emitCategoriesUpdatedEvent",value:function e(t){this.emit(ToolbarEvents.CATEGORIES_UPDATED,t)}},{key:"subscribeTypeUpdatedEvent",value:function e(t){this.subscribe(ToolbarEvents.TYPE_UPDATED,t)}},{key:"subscribeCategoriesUpdatedEvent",value:function e(t){this.subscribe(ToolbarEvents.CATEGORIES_UPDATED,t)}},{key:"subscribeAutomatedSolutionUpdatedEvent",value:function e(t){this.subscribe(ToolbarEvents.AUTOMATED_SOLUTION_UPDATED,t)}},{key:"unsubscribeAutomatedSolutionUpdatedEvent",value:function e(t){this.unsubscribe(ToolbarEvents.AUTOMATED_SOLUTION_UPDATED,t)}},{key:"getSettingsButton",value:function e(){const t=BX.UI.ToolbarManager.getDefaultToolbar();if(!t){return null}for(const[e,i]of Object.entries(t.getButtons())){if(i.getIcon()===ui_buttons.ButtonIcon.SETTING){return i}}return null}}],[{key:"Instance",get:function(){if(window.top!==window&&main_core.Reflection.getClass("top.BX.Crm.ToolbarComponent")){return window.top.BX.Crm.ToolbarComponent.Instance}if(instance===null){instance=new t}return instance}}]);return t}(main_core_events.EventEmitter);function _bindAutomationGuide2(){const e=document.location.hash;let t=null;if(e==="#robots"){const e=document.querySelector(".crm-robot-btn");if(e){t=new ui_tour.Guide({steps:[{target:e,title:main_core.Loc.getMessage("CRM_TOOLBAR_COMPONENT_ROBOTS_GUIDE_TEXT_1"),text:""}],onEvents:true})}}else if(e==="#scripts"){const e=document.querySelector(".intranet-binding-menu-btn");if(e){t=new ui_tour.Guide({steps:[{target:e,title:main_core.Loc.getMessage("CRM_TOOLBAR_COMPONENT_SCRIPTS_GUIDE_TEXT"),article:"13281632",text:""}],onEvents:true})}}if(t){t.start();t.getPopup().setAutoHide(true);t.getPopup().setClosingByEsc(true)}}function _reloadCategoriesMenu2(e,t,i){const n=e.getMenuWindow();if(!n){return}main_core.ajax.runAction("crm.controller.category.list",{data:{entityTypeId:t}}).then((a=>{let s=0;const r=[];const o=a.data.categories;n.menuItems.forEach((e=>{if(e.id.indexOf(MENU_ID_PREFIX)!==0){r.push(e.options)}else if(e.id==="toolbar-category-all"){r.push(e.options);s=1}}));n.destroy();main_core.Event.unbindAll(e.getContainer(),"click");o.forEach((n=>{var a,o;const l=t===BX.CrmEntityType.enumeration.deal?(a=crm_router.Router.Instance.getDealKanbanUrl(n.id))===null||a===void 0?void 0:a.toString():(o=crm_router.Router.Instance.getItemListUrlInCurrentView(t,n.id))===null||o===void 0?void 0:o.toString();r.splice(s,0,{id:`${MENU_ID_PREFIX}${n.id}`,text:main_core.Text.encode(n.name),href:l||null,dataset:{isDefault:n.isDefault||false,categoryId:n.id}});if(n.id>0&&i>0&&Number(i)===Number(n.id)){e.setText(n.name)}s++}));const l=n.params;l.items=r;e.menuWindow=new main_popup.Menu(l);main_core.Event.bind(e.getContainer(),"click",e.menuWindow.show.bind(e.menuWindow));if(t===BX.CrmEntityType.enumeration.deal){_classPrivateMethodGet$3(this,_reloadAddButtonMenu,_reloadAddButtonMenu2).call(this,o)}_classPrivateMethodGet$3(this,_tryRedirectToDefaultCategory,_tryRedirectToDefaultCategory2).call(this,r)})).catch((e=>{console.log("error trying reload categories",e.errors)}))}function _reloadAddButtonMenu2(e){const t=document.querySelector(".ui-btn-split.ui-btn-success");if(!t){return}const i=t.dataset.btnUniqid;const n=BX.UI.ToolbarManager.getDefaultToolbar();const a=n.getButton(i,"data-btn-uniqid");if(!a){return}const s=a.menuWindow;if(!s){return}const r=s.getMenuItems().map((e=>e.id)).filter((e=>main_core.Type.isInteger(e)));const o=new Set(e.map((e=>e.id)));const l=r.filter((e=>!o.has(e)));const c=e.filter((e=>!r.includes(e.id)&&e.id>0));if(l.length>0){l.forEach((e=>s.removeMenuItem(e)))}if(c.length>0){const e=s.getMenuItems().map((e=>e.id)).filter((e=>main_core.Type.isString(e))).at(1);c.forEach((t=>{s.addMenuItem({id:t.id,text:t.name,onclick(){BX.SidePanel.Instance.open(`/crm/deal/details/0/?category_id=${t.id}`)}},e)}))}}function _tryRedirectToDefaultCategory2(e){const t=window.location.pathname;const i=t.match(/\/(\d+)\/?$/);const n=i?parseInt(i[1],10):null;const a=main_core.Type.isUndefined(e.find((e=>{var t;return(e===null||e===void 0?void 0:(t=e.dataset)===null||t===void 0?void 0:t.categoryId)===n})));if(a){const t=e.find((e=>{var t;return e===null||e===void 0?void 0:(t=e.dataset)===null||t===void 0?void 0:t.isDefault}));if(main_core.Type.isObject(t)&&main_core.Type.isStringFilled(t.href)){window.location.href=t.href}}}ToolbarComponent.Communications=Object.freeze({PhoneButton:PhoneButton,EmailButton:EmailButton,MessengerButton:MessengerButton});exports.ToolbarComponent=ToolbarComponent;exports.NavigationBar=NavigationBar})(this.BX.Crm=this.BX.Crm||{},BX.Crm,BX.UI.Dialogs,BX.UI,BX.Crm,BX,BX.Event,BX.Main,BX.UI,BX.UI.Tour);
//# sourceMappingURL=toolbar-component.bundle.map.js