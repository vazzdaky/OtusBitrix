this.BX=this.BX||{};this.BX.Crm=this.BX.Crm||{};(function(e,s,t,a,r,i){"use strict";let l=e=>e,o,c;var n=babelHelpers.classPrivateFieldLooseKey("data");var d=babelHelpers.classPrivateFieldLooseKey("popup");var b=babelHelpers.classPrivateFieldLooseKey("bindElement");var _=babelHelpers.classPrivateFieldLooseKey("isConfettiShowed");var P=babelHelpers.classPrivateFieldLooseKey("showConfetti");class v{constructor(e={}){Object.defineProperty(this,P,{value:u});Object.defineProperty(this,n,{writable:true,value:null});Object.defineProperty(this,d,{writable:true,value:null});Object.defineProperty(this,b,{writable:true,value:null});Object.defineProperty(this,_,{writable:true,value:true});this.params={};this.params=e;if(a.Type.isBoolean(this.params.showConfetti)){babelHelpers.classPrivateFieldLooseBase(this,_)[_]=!this.params.showConfetti}}getType(){throw new Error("Must be implement in child class")}async show(e=false){const s=await this.getData();if(babelHelpers.classPrivateFieldLooseBase(this,d)[d]===null){babelHelpers.classPrivateFieldLooseBase(this,d)[d]=new r.Popup(this.getPopupParams(s,{forceShowConfetti:e}))}babelHelpers.classPrivateFieldLooseBase(this,d)[d].show()}getPopupParams(e,s={}){const t=Boolean(babelHelpers.classPrivateFieldLooseBase(this,b)[b].closest("button"));const a=Boolean(babelHelpers.classPrivateFieldLooseBase(this,b)[b].closest("a"));let r=babelHelpers.classPrivateFieldLooseBase(this,b)[b];if(t){r=babelHelpers.classPrivateFieldLooseBase(this,b)[b].closest("button")}else if(a){r=babelHelpers.classPrivateFieldLooseBase(this,b)[b].closest("a")}const i=r.getBoundingClientRect();return{id:`crm_repeat_sale_widget_${this.getType()}`,bindElement:{top:i.top+i.height+10,left:i.right-410},content:this.getPopupContent(e),cacheable:false,isScrollBlock:true,className:`crm-repeat-sale-widget-popup --${this.getType()}`,closeByEsc:true,closeIcon:true,padding:16,width:410,maxHeight:500,overlay:null,autoHide:true,events:{onclose:()=>{this.onClose()},onFirstShow:()=>{if(babelHelpers.classPrivateFieldLooseBase(this,_)[_]&&(s==null?void 0:s.forceShowConfetti)!==true){return}setTimeout((()=>{babelHelpers.classPrivateFieldLooseBase(this,P)[P]();babelHelpers.classPrivateFieldLooseBase(this,_)[_]=true}),100)}}}}getPopupContent(e){throw new Error("Must be implement in child class")}setPopupContent(e){babelHelpers.classPrivateFieldLooseBase(this,d)[d].setContent(e)}onClose(){if(this.params.showConfetti){void a.ajax.runAction("crm.repeatsale.widget.incrementShowedConfettiCount")}babelHelpers.classPrivateFieldLooseBase(this,d)[d]=null}async getData(){babelHelpers.classPrivateFieldLooseBase(this,n)[n]=await this.fetchData();return babelHelpers.classPrivateFieldLooseBase(this,n)[n]}async fetchData(){return new Promise((e=>{a.ajax.runAction(this.getFetchUrl(),{data:this.getFetchParams()}).then((s=>{if(s.status==="success"){e(s.data);return}this.showError()}),(()=>{this.showError()})).catch((e=>{this.showError();throw e}))}))}getFetchUrl(){throw new Error("Must be implement in child class")}getFetchParams(){return{}}showError(){const e="CRM_REPEAT_SALE_WIDGET_ERROR";t.UI.Notification.Center.notify({content:a.Loc.getMessage(e),autoHideDelay:6e3})}setBindElement(e){babelHelpers.classPrivateFieldLooseBase(this,b)[b]=e;return this}isShown(){var e;return(e=babelHelpers.classPrivateFieldLooseBase(this,d)[d])==null?void 0:e.isShown()}close(){var e;(e=babelHelpers.classPrivateFieldLooseBase(this,d)[d])==null?void 0:e.close()}renderLottieAnimation(){const e=a.Tag.render(o||(o=l`
			<div class="crm-rs__w-lottie-container">
				<div ref="lottie" class="crm-rs__w-lottie"></div>
			</div>
		`));const s=i.Lottie.loadAnimation({path:"/bitrix/js/crm/repeat-sale/widget/lottie/animation.json",container:e.lottie,renderer:"svg",loop:true,autoplay:true});s.setSpeed(.75);return e.root}}function u(){var e;const t=(e=babelHelpers.classPrivateFieldLooseBase(this,d)[d])==null?void 0:e.getPopupContainer();if(!t){return}let r=null;if(t.getElementsByTagName("canvas").length===0){r=a.Tag.render(c||(c=l`<canvas></canvas>`));a.Dom.style(r,{position:"fixed",top:0,left:0,pointerEvents:"none",zIndex:"9",width:"100%",height:"100%"});a.Dom.append(r,babelHelpers.classPrivateFieldLooseBase(this,d)[d].getPopupContainer())}else{r=t.getElementsByTagName("canvas")[0]}const i=s.Confetti.create(r,{resize:true,useWorker:true});i({particleCount:400,origin:{y:1.2,x:0},spread:100})}let p=e=>e,h,T,E;var L=babelHelpers.classPrivateFieldLooseKey("showSettingsButton");var w=babelHelpers.classPrivateFieldLooseKey("onSettingsClick");var g=babelHelpers.classPrivateFieldLooseKey("onFeedbackClick");var S=babelHelpers.classPrivateFieldLooseKey("showFeedbackCrmForm");var m=babelHelpers.classPrivateFieldLooseKey("getFeedbackFormParams");class y{constructor(e=false){Object.defineProperty(this,m,{value:A});Object.defineProperty(this,S,{value:B});Object.defineProperty(this,g,{value:F});Object.defineProperty(this,w,{value:f});Object.defineProperty(this,L,{writable:true,value:false});babelHelpers.classPrivateFieldLooseBase(this,L)[L]=e}getFooterContent(){const e=babelHelpers.classPrivateFieldLooseBase(this,L)[L]?a.Tag.render(h||(h=p`
			<div
				onclick="${0}"
			 	class="crm-rs__w-footer-button --settings"
			 >
				${0}
			</div>
		`),babelHelpers.classPrivateFieldLooseBase(this,w)[w].bind(this),a.Loc.getMessage("CRM_REPEAT_SALE_WIDGET_POPUP_FOOTER_SETTINGS")):"";const s=a.Tag.render(T||(T=p`
			<div
				onclick="${0}"
				class="crm-rs__w-footer-button --feedback"
			>
				${0}
			</div>
		`),babelHelpers.classPrivateFieldLooseBase(this,g)[g].bind(this),a.Loc.getMessage("CRM_REPEAT_SALE_WIDGET_POPUP_FOOTER_FEEDBACK"));return a.Tag.render(E||(E=p`
			<div class="crm-rs__w-footer-row">
				${0}
				${0}
			</div>
		`),a.Type.isArrayFilled(babelHelpers.classPrivateFieldLooseBase(this,m)[m]())?s:"<div></div>",e)}}function f(){window.location.href="/crm/repeat-sale-segment/"}function F(){const[e,s]=babelHelpers.classPrivateFieldLooseBase(this,m)[m]();babelHelpers.classPrivateFieldLooseBase(this,S)[S](e,s)}function B(e,s){BX.SidePanel.Instance.open("bx-repeat-sale-slider",{contentCallback:()=>`<script data-b24-form="inline/${e}/${s}" data-skip-moving="true"><\/script>`,width:664,loader:"default-loader",cacheable:false,closeByEsc:false,data:{rightBoundary:0},events:{onOpen:()=>{(function(e,s,t){var a=s.createElement("script");a.async=true;a.src=t+"?"+(Date.now()/18e4|0);var r=s.getElementsByTagName("script")[0];r.parentNode.insertBefore(a,r)})(window,document,`https://cdn.bitrix24.com/b5309667/crm/form/loader_${e}.js`)}}})}function A(){return a.Extension.getSettings("crm.repeat-sale.widget").get("feedbackFormParams")}let C=e=>e,I,H,R,O;var D=babelHelpers.classPrivateFieldLooseKey("isFlowStarted");var M=babelHelpers.classPrivateFieldLooseKey("showSettingsButton");var U=babelHelpers.classPrivateFieldLooseKey("getTitle");var W=babelHelpers.classPrivateFieldLooseKey("getBodyTitle");var $=babelHelpers.classPrivateFieldLooseKey("getButton");var j=babelHelpers.classPrivateFieldLooseKey("getFooterContent");var G=babelHelpers.classPrivateFieldLooseKey("onButtonClick");var K=babelHelpers.classPrivateFieldLooseKey("hasClients");class k extends v{constructor(e){var s;super(e);Object.defineProperty(this,K,{value:q});Object.defineProperty(this,G,{value:z});Object.defineProperty(this,j,{value:X});Object.defineProperty(this,$,{value:Y});Object.defineProperty(this,W,{value:x});Object.defineProperty(this,U,{value:N});Object.defineProperty(this,D,{writable:true,value:null});Object.defineProperty(this,M,{writable:true,value:true});babelHelpers.classPrivateFieldLooseBase(this,M)[M]=(s=e.showSettingsButton)!=null?s:true}getType(){return he.start}onClose(){super.onClose();void a.ajax.runAction("crm.repeatsale.widget.incrementShowedFlowStartCount")}getPopupContent(e){if(babelHelpers.classPrivateFieldLooseBase(this,D)[D]===null){const{isFlowStarted:s}=e;babelHelpers.classPrivateFieldLooseBase(this,D)[D]=s}return a.Tag.render(I||(I=C`
			<div>
				<header class="crm-rs__w-header">
					${0}
				</header>
				<div class="crm-rs__w-body">
					<div class="crm-rs__w-body-content">
						<div class="crm-rs__w-body-title">
							${0}
						</div>
						${0}
					</div>
					<div class="crm-rs__w-body-bubble ${0}">
						${0}
						<div class="crm-rs__w-body-icon"></div>
					</div>
				</div>
				<footer class="crm-rs__w-footer">
					${0}
				</footer>
			</div>
		`),babelHelpers.classPrivateFieldLooseBase(this,U)[U](e),babelHelpers.classPrivateFieldLooseBase(this,W)[W](e),babelHelpers.classPrivateFieldLooseBase(this,$)[$](e),babelHelpers.classPrivateFieldLooseBase(this,D)[D]?"--flow-started":"",this.renderLottieAnimation(),babelHelpers.classPrivateFieldLooseBase(this,j)[j](e))}getFetchUrl(){return"crm.repeatsale.statistics.getInitData"}getFetchParams(){return{}}}function N(e){if(babelHelpers.classPrivateFieldLooseBase(this,D)[D]){return a.Tag.render(H||(H=C`
				<span>${0}</span>
			`),a.Loc.getMessage("CRM_REPEAT_SALE_WIDGET_START_FLOW_STARTED_POPUP_TITLE"))}const s=babelHelpers.classPrivateFieldLooseBase(this,K)[K](e)?"CRM_REPEAT_SALE_WIDGET_START_POPUP_TITLE_WITH_CLIENTS":"CRM_REPEAT_SALE_WIDGET_START_POPUP_TITLE_WITHOUT_CLIENTS";return a.Loc.getMessage(s)}function x(e){if(babelHelpers.classPrivateFieldLooseBase(this,D)[D]){return a.Tag.render(R||(R=C`
				<span>${0}</span>
			`),a.Loc.getMessage("CRM_REPEAT_SALE_WIDGET_START_POPUP_BODY_FLOW_STARTED_TITLE"))}const s=babelHelpers.classPrivateFieldLooseBase(this,K)[K](e);const t=s?"CRM_REPEAT_SALE_WIDGET_START_POPUP_BODY_TITLE_WITH_CLIENTS":"CRM_REPEAT_SALE_WIDGET_START_POPUP_BODY_TITLE_WITHOUT_CLIENTS";if(s){return a.Loc.getMessagePlural(t,e.count,{"#COUNT#":e.count})}return a.Loc.getMessage(t)}function Y(e){if(babelHelpers.classPrivateFieldLooseBase(this,D)[D]){return null}const s=babelHelpers.classPrivateFieldLooseBase(this,K)[K](e);const t=s?"CRM_REPEAT_SALE_WIDGET_START_POPUP_BTN_WITH_CLIENTS":"CRM_REPEAT_SALE_WIDGET_START_POPUP_BTN_WITHOUT_CLIENTS";return a.Tag.render(O||(O=C`
			<div class="crm-rs__w-body-title-btn ${0}">
				<span
					onclick="${0}"
				>${0}</span>
			</div>
		`),s?"--has-clients":"",babelHelpers.classPrivateFieldLooseBase(this,G)[G].bind(this,e),a.Loc.getMessage(t))}function X(e){if(babelHelpers.classPrivateFieldLooseBase(this,D)[D]){const e=new y(babelHelpers.classPrivateFieldLooseBase(this,M)[M]);return e.getFooterContent()}const s=babelHelpers.classPrivateFieldLooseBase(this,K)[K](e)?"CRM_REPEAT_SALE_WIDGET_START_POPUP_DESC_WITH_CLIENTS":"CRM_REPEAT_SALE_WIDGET_START_POPUP_DESC_WITHOUT_CLIENTS";return a.Loc.getMessage(s)}function z(e){if(babelHelpers.classPrivateFieldLooseBase(this,K)[K](e)){a.ajax.runAction("crm.repeatsale.flow.enable").then((s=>{if(s.status==="success"){babelHelpers.classPrivateFieldLooseBase(this,D)[D]=true;this.setPopupContent(this.getPopupContent(e));return}this.showError();this.close()}),(e=>{this.showError();this.close()})).catch((e=>{this.showError();this.close()}))}else{alert("empty clients, need show manual");void a.ajax.runAction("crm.repeatsale.widget.finalizeShowedFlowStart")}}function q(e){return e.count>0}let Q=e=>e,J,V,Z;var ee=babelHelpers.classPrivateFieldLooseKey("periodType");var se=babelHelpers.classPrivateFieldLooseKey("showSettingsButton");var te=babelHelpers.classPrivateFieldLooseKey("getLoadingPopupContent");var ae=babelHelpers.classPrivateFieldLooseKey("renderLoadingLottieAnimation");var re=babelHelpers.classPrivateFieldLooseKey("getSelectorTitle");var ie=babelHelpers.classPrivateFieldLooseKey("getBubbleSubTitle");var le=babelHelpers.classPrivateFieldLooseKey("getFooterContent");var oe=babelHelpers.classPrivateFieldLooseKey("onPeriodChange");class ce extends v{constructor(e){var s;super(e);Object.defineProperty(this,oe,{value:ve});Object.defineProperty(this,le,{value:Pe});Object.defineProperty(this,ie,{value:_e});Object.defineProperty(this,re,{value:be});Object.defineProperty(this,ae,{value:de});Object.defineProperty(this,te,{value:ne});Object.defineProperty(this,ee,{writable:true,value:pe.day30});Object.defineProperty(this,se,{writable:true,value:true});babelHelpers.classPrivateFieldLooseBase(this,se)[se]=(s=e.showSettingsButton)!=null?s:true}getType(){return he.statistics}getPopupContent(e){var s,t,r,i,l,o,c;return a.Tag.render(J||(J=Q`
			<div>
				<header class="crm-rs__w-header --statistics">
					${0}
				</header>
				<div class="crm-rs__w-body">
					<div class="crm-rs__w-body-content --statistics">
						<div class="crm-rs__w-period-selector">
							${0}
							<span
								onclick="${0}"
								class="crm-rs__w-period-selector-icon"
							></span>
						</div>
						<div class="crm-rs__w-body-statistics">
							<div class="crm-rs__w-body-rs-statistics">
								<div class="crm-rs__w-body-rs-statistics-title">
									${0}
								</div>
								<div class="crm-rs__w-body-statistics-row">
									<div class="crm-rs__w-body-statistics-item">
										${0}
									</div>
									<div class="crm-rs__w-body-statistics-item --sum">
										${0}
									</div>
								</div>
								<div class="crm-rs__w-body-statistics-row">
									<div class="crm-rs__w-body-statistics-item">
										${0}
									</div>
									<div class="crm-rs__w-body-statistics-item --sum">
										${0}
									</div>
								</div>
							</div>
							<div class="crm-rs__w-body-statistics-row">
								<div class="crm-rs__w-body-statistics-item">
									${0}
								</div>
								<div class="crm-rs__w-body-statistics-item --sum">
									${0}
								</div>
							</div>
							<div class="crm-rs__w-body-statistics-row">
								<div class="crm-rs__w-body-statistics-item">
									${0}
								</div>
								<div class="crm-rs__w-body-statistics-item --sum">
									${0}
								</div>
							</div>
						</div>
					</div>
					<div class="crm-rs__w-body-bubble --statistics">
						${0}
						<div class="crm-rs__w-body-icon"></div>
						<div class="crm-rs__w-body-bubble-percent">
							<span>${0}</span>
							<div>
								<div class="crm-rs__w-body-bubble-percent-arrow ${0}"></div>
								<div class="crm-rs__w-body-bubble-percent-icon"></div>
							</div>
						</div>
						<div class="crm-rs__w-body-bubble-subtitle">
							${0}
						</div>
					</div>
				</div>
				<footer class="crm-rs__w-footer --statistics">
					${0}
				</footer>
			</div>
		`),a.Loc.getMessage("CRM_REPEAT_SALE_WIDGET_STATISTICS_POPUP_TITLE"),babelHelpers.classPrivateFieldLooseBase(this,re)[re](),babelHelpers.classPrivateFieldLooseBase(this,oe)[oe].bind(this,babelHelpers.classPrivateFieldLooseBase(this,ee)[ee]),a.Loc.getMessage("CRM_REPEAT_SALE_WIDGET_STATISTICS_POPUP_BODY_TITLE"),a.Loc.getMessagePlural("CRM_REPEAT_SALE_WIDGET_STATISTICS_POPUP_BODY_RS_WIN",(s=e.repeatSaleWinCount)!=null?s:0,{"#COUNT#":(t=e.repeatSaleWinCount)!=null?t:0}),(r=e.repeatSaleWinSum)!=null?r:"",a.Loc.getMessage("CRM_REPEAT_SALE_WIDGET_STATISTICS_POPUP_BODY_RS_PROCESS"),(i=e.repeatSaleProcessSum)!=null?i:0,a.Loc.getMessage("CRM_REPEAT_SALE_WIDGET_STATISTICS_POPUP_BODY_OTHER"),(l=e.otherWinSum)!=null?l:0,a.Loc.getMessage("CRM_REPEAT_SALE_WIDGET_STATISTICS_POPUP_BODY_TOTAL"),(o=e.totalSum)!=null?o:0,this.renderLottieAnimation(),(c=e.percent)!=null?c:0,e.percent>0?"":"--hidden",babelHelpers.classPrivateFieldLooseBase(this,ie)[ie](),babelHelpers.classPrivateFieldLooseBase(this,le)[le]())}getFetchUrl(){return"crm.repeatsale.statistics.getData"}getFetchParams(){return{periodType:babelHelpers.classPrivateFieldLooseBase(this,ee)[ee]}}}function ne(){return a.Tag.render(V||(V=Q`
			<div>
				<header class="crm-rs__w-header --statistics">
					${0}
				</header>
				<div class="crm-rs__w-body">
					<div class="crm-rs__w-body-loading-bubble">
						<div class="crm-rs__w-body-loading-bubble-wrapper">
							${0}
							${0}
						</div>
						<div class="crm-rs__w-body-bubble-subtitle">
							${0}
						</div>
					</div>
				</div>
				<footer class="crm-rs__w-footer --statistics">
					${0}
				</footer>
			</div>
		`),a.Loc.getMessage("CRM_REPEAT_SALE_WIDGET_STATISTICS_POPUP_TITLE"),this.renderLottieAnimation(),babelHelpers.classPrivateFieldLooseBase(this,ae)[ae](),a.Loc.getMessage("CRM_REPEAT_SALE_WIDGET_STATISTICS_POPUP_LOADING"),babelHelpers.classPrivateFieldLooseBase(this,le)[le]())}function de(){const e=a.Tag.render(Z||(Z=Q`
			<div class="crm-rs__w-loading-lottie-container">
				<div ref="lottie" class="crm-rs__w-lottie"></div>
			</div>
		`));const s=i.Lottie.loadAnimation({path:"/bitrix/js/crm/repeat-sale/widget/lottie/loading.json",container:e.lottie,renderer:"svg",loop:true,autoplay:true});s.setSpeed(.75);return e.root}function be(){let e=null;switch(babelHelpers.classPrivateFieldLooseBase(this,ee)[ee]){case pe.day30:e="CRM_REPEAT_SALE_WIDGET_STATISTICS_POPUP_PERIOD_DAY_30";break;case pe.quarter:e="CRM_REPEAT_SALE_WIDGET_STATISTICS_POPUP_PERIOD_QUARTER";break;case pe.halfYear:e="CRM_REPEAT_SALE_WIDGET_STATISTICS_POPUP_PERIOD_HALF_YEAR";break;case pe.year:e="CRM_REPEAT_SALE_WIDGET_STATISTICS_POPUP_PERIOD_YEAR";break;default:throw new RangeError("unknown period type")}return a.Loc.getMessage(e)}function _e(){let e=null;switch(babelHelpers.classPrivateFieldLooseBase(this,ee)[ee]){case pe.day30:e="CRM_REPEAT_SALE_WIDGET_STATISTICS_POPUP_BUBBLE_PERIOD_DAY_30";break;case pe.quarter:e="CRM_REPEAT_SALE_WIDGET_STATISTICS_POPUP_BUBBLE_PERIOD_QUARTER";break;case pe.halfYear:e="CRM_REPEAT_SALE_WIDGET_STATISTICS_POPUP_BUBBLE_PERIOD_HALF_YEAR";break;case pe.year:e="CRM_REPEAT_SALE_WIDGET_STATISTICS_POPUP_BUBBLE_PERIOD_YEAR";break;default:throw new RangeError("unknown period type")}return a.Loc.getMessage(e)}function Pe(){const e=new y(babelHelpers.classPrivateFieldLooseBase(this,se)[se]);return e.getFooterContent()}function ve(e){let s=pe.day30;const t=Object.values(pe);if(t.includes(e)){const a=t.indexOf(e);if(a+1<t.length){s=a+1}}const i={periodTypeId:s};a.ajax.runAction(this.getFetchUrl(),{data:i}).then((e=>{if(e.status==="success"){const t=r.PopupManager.getPopupById(`crm_repeat_sale_widget_${this.getType()}`);if(t===null){return}this.data=e.data;babelHelpers.classPrivateFieldLooseBase(this,ee)[ee]=s;t.setContent(this.getPopupContent(this.data));return}this.showError()}),(e=>{this.showError()})).catch((e=>{this.showError()}))}class ue{static getContentInstance(e,s={}){switch(e){case he.start:return new k(s);case he.statistics:return new ce(s);default:return null}}}const pe=Object.freeze({day30:0,quarter:1,halfYear:2,year:3});const he=Object.freeze({start:"start",statistics:"statistics"});var Te=babelHelpers.classPrivateFieldLooseKey("contentPopupInstance");class Ee{static execute(e,s=null,t={},a=null){if(!this.instance[e]){this.instance[e]=new Ee(e,s,t)}if(this.instance[e].isShown()){this.instance[e].close()}else{var r;const s=(r=(a==null?void 0:a.altKey)&&(a==null?void 0:a.ctrlKey))!=null?r:false;this.instance[e].show(s)}}constructor(e,s=null,t={}){Object.defineProperty(this,Te,{writable:true,value:null});babelHelpers.classPrivateFieldLooseBase(this,Te)[Te]=ue.getContentInstance(e,t);if(s){babelHelpers.classPrivateFieldLooseBase(this,Te)[Te].setBindElement(s)}}show(e=false){babelHelpers.classPrivateFieldLooseBase(this,Te)[Te].show(e)}isShown(){return babelHelpers.classPrivateFieldLooseBase(this,Te)[Te].isShown()}close(){babelHelpers.classPrivateFieldLooseBase(this,Te)[Te].close()}}Ee.instance=[];e.PeriodType=pe;e.WidgetType=he;e.Widget=Ee})(this.BX.Crm.RepeatSale=this.BX.Crm.RepeatSale||{},BX.UI,BX,BX,BX.Main,BX.UI);
//# sourceMappingURL=widget.bundle.map.js