(function(){"use strict";if(BX.SalecenterPaySystem)return;BX.SalecenterPaySystem={init:function(e){this.slider=null;this.paySystemHandler=e.paySystemHandler;this.paySystemMode=e.paySystemMode;this.paySystemId=e.paySystemId;this.containerNode=BX(e.containerId);this.buttonSaveNode=BX(e.buttonSaveId);this.formId=e.formId;this.auth=e.auth;this.errorMessageNode=BX(e.errorMessageId);this.paySystemFormData=[];this.checkedAuthStatus=false;this.settingsFormLinkNameCodeMap=e.settingsFormLinkNameCodeMap;this.handlerClassName=e.handlerClassName;this.isExistsSettings=e.isExistsSettings;this.isExistsOnlyCommonSettings=e.isExistsOnlyCommonSettings;this.settingsMenu=null;this.settingsMenuNode=BX(e.settingsMenuId);this.buttonPanelId=e.buttonPanelId;this.myCompanyList=e.myCompanyList;this.selectedCompanyId=e.selectedCompanyId;this.hasChangesMyCompanyList=false;this.uiNodes={name:this.containerNode.querySelector("[data-bx-salescenter-auth-name]"),link:this.containerNode.querySelector("[data-bx-salescenter-auth-link]"),logout:this.containerNode.querySelector("[data-bx-salescenter-auth-logout]")};if(e.isInitBusinessConnectComponents&&!this.auth.PROFILE){this.initBusinessConnectComponents()}this.initExpertMenu();this.showBlockByAuth();this.bindEvents();var t=top.BX.adminSidePanel||BX.adminSidePanel;if(t){if(!top.window["adminSidePanel"]||!BX.is_subclass_of(top.window["adminSidePanel"],t)){top.window["adminSidePanel"]=new t({publicMode:true})}}},bindEvents:function(){BX.bind(BX("bx-salescenter-add-button"),"click",BX.proxy(this.openSlider,this));BX.bind(BX("bx-salescenter-connect-button"),"click",BX.proxy(this.openPopup,this));BX.bind(BX("LOGOTIP"),"bxchange",BX.proxy(this.showLogotip,this));BX.bind(this.buttonSaveNode,"click",BX.proxy(this.savePaySystemAction,this));BX.bind(this.uiNodes.logout,"click",BX.proxy(this.logoutAction,this));BX.addCustomEvent(window,"seo-client-auth-result",BX.proxy(this.checkAuthStatusAction,this));BX.addCustomEvent("onPopupOpen",BX.proxy(this.onPopupOpenHandler,this));BX.addCustomEvent("SidePanel.Slider:onLoad",BX.proxy(this.onLoadSlider,this));BX.addCustomEvent("SidePanel.Slider:onClose",BX.proxy(this.onCloseSlider,this));BX.addCustomEvent("SidePanel.Slider:onMessage",BX.proxy(this.onMessageSlider,this));BX.addCustomEvent("BX.Sale.PaySystem.Registration.Robokassa:onAddSettings",BX.proxy(this.onAddSettings,this))},initExpertMenu(){var e=this;this.settingsMenu=new BX.Main.Menu({bindElement:this.settingsMenuNode,angle:true,offsetLeft:20,closeByEsc:true,items:[]});this.settingsMenu.addMenuItem({text:BX.message("SALESCENTER_SP_PAY_SYSTEM_EXPERT_SETTINGS"),onclick:function(){e.settingsMenu.close();e.openSlider()}.bind(this)});if(this.paySystemId>0){this.settingsMenu.addMenuItem({text:BX.message("SALESCENTER_SP_PAY_SYSTEM_DELETE"),onclick:function(t){e.settingsMenu.close();e.remove(t)}.bind(this)})}if(this.isExistsOnlyCommonSettings){this.addLogoutMenuItem()}},initBusinessConnectComponents(){this.uiNodes.businessAlert=BX("bx-salescenter-business-alert-block");this.uiNodes.companyInfoNode=BX("bx-salescenter-business-company-info");this.uiNodes.companyEmpty=BX("bx-salescenter-business-company-empty");this.uiNodes.companyNode={titleNode:this.uiNodes.companyInfoNode.querySelector(".salescenter-paysystem-business-company-name"),detailsNode:this.uiNodes.companyInfoNode.querySelector(".salescenter-paysystem-business-company-details")};BX.bind(this.uiNodes.companyInfoNode,"click",BX.proxy(this.openCompanySelectorDialog,this));BX.bind(BX("bx-salescenter-business-connect-button"),"click",BX.proxy(this.openBusinessPopup,this));BX.bind(BX("bx-salescenter-business-company-create-button"),"click",BX.proxy(this.openCompanyCreateSlider,this));BX.bind(BX("bx-salescenter-business-company-edit-button"),"click",BX.proxy(this.openCompanyEditSlider,this));BX.bind(BX("bx-salescenter-business-company-fill-button"),"click",BX.proxy(this.openCompanyEditSlider,this));this.companySelectorDialog=new BX.UI.EntitySelector.Dialog({targetNode:this.uiNodes.companyInfoNode,height:250,dropdownMode:true,multiple:false,focusOnFirst:false,showAvatars:true,footer:this.getCompanySelectorFooter(),events:{"Item:onSelect":e=>{const{item:t}=e.getData();if(!t||!t.id||t.id<0){return}this.selectedCompanyId=t.id;this.refreshBusinessConnectComponents()}}});this.refreshCompanySelectorItems();this.refreshBusinessConnectComponents()},refreshCompanySelectorItems(){if(!this.companySelectorDialog){return}if(this.companySelectorDialog.getItems().length>0){this.companySelectorDialog.removeItems()}Object.keys(this.myCompanyList).forEach((e=>{const t=this.myCompanyList[e];this.companySelectorDialog.addItem({id:t.ID,entityId:"company",title:t.TITLE,subtitle:t.LABEL.DETAILS,tabs:"recents",selected:t.ID===this.selectedCompanyId,deselectable:false,avatar:"data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzYiIGhlaWdodD0iMzYiIHZpZXdCb3g9IjAgMCAzNiAzNiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjM2IiBoZWlnaHQ9IjM2IiByeD0iMTgiIGZpbGw9IiMyRkM2RjYiLz4KPHBhdGggZmlsbC1ydWxlPSJldmVub2RkIiBjbGlwLXJ1bGU9ImV2ZW5vZGQiIGQ9Ik0yMC45OTk4IDIyLjgyNDRWMTYuNTkyOEMyMC45OTk4IDE2LjU0MzggMjEuMDA1OCAxNi40OTQ5IDIxLjAxNzcgMTYuNDQ3M0MyMS4wOTggMTYuMTI1OCAyMS40MjM4IDE1LjkzMDQgMjEuNzQ1MyAxNi4wMTA3TDI0LjU0NTMgMTYuNzEwN0MyNC44MTI0IDE2Ljc3NzUgMjQuOTk5OCAxNy4wMTc1IDI0Ljk5OTggMTcuMjkyOFYyMi44MjQ0SDI1Ljk5OThWMjQuODI0NEg5Ljk5OTc2VjIyLjgyNDRIMTAuOTk5OFYxMy4xMzc2QzEwLjk5OTggMTIuNjQ3MyAxMS4zNTUzIDEyLjIyOTIgMTEuODM5MyAxMi4xNTA2TDE4LjgzOTMgMTEuMDEzQzE4Ljg5MjQgMTEuMDA0MyAxOC45NDYgMTEgMTguOTk5OCAxMUMxOS41NTIgMTEgMTkuOTk5OCAxMS40NDc3IDE5Ljk5OTggMTJWMjIuODI0NEgyMC45OTk4Wk0xMy45OTk4IDIyLjgyNDRIMTYuOTk5OFYxOS44MjQ0SDEzLjk5OThWMjIuODI0NFpNMjMuOTk5OCAxOUgyMS45OTk4VjIxSDIzLjk5OThWMTlaTTE3Ljk5OTggMTMuODI0NEgxNS45OTk4VjE1LjgyNDRIMTcuOTk5OFYxMy44MjQ0Wk0xNC45OTk4IDEzLjgyNDRIMTIuOTk5OFYxNS44MjQ0SDE0Ljk5OThWMTMuODI0NFpNMTcuOTk5OCAxNi44MjQ0SDE1Ljk5OThWMTguODI0NEgxNy45OTk4VjE2LjgyNDRaTTE0Ljk5OTggMTYuODI0NEgxMi45OTk4VjE4LjgyNDRIMTQuOTk5OFYxNi44MjQ0WiIgZmlsbD0id2hpdGUiLz4KPC9zdmc+Cg==",avatarOptions:{bgSize:"35px"}})}))},getCompanySelectorFooter(){const e=BX.Tag.render`<span class="ui-selector-footer-link ui-selector-footer-link-add">${BX.Loc.getMessage("SALESCENTER_SP_CONNECT_CREATE_COMPANY")}</span>`;BX.bind(e,"click",BX.proxy(this.openCompanyCreateSlider,this));return e},refreshBusinessConnectComponents(){const e=this.selectedCompanyId>0&&Object.keys(this.myCompanyList).length>0;this.displayBlock("data-bx-salescenter-company-list",e?"selector":"empty","flex");if(this.companySelectorDialog&&this.hasChangesMyCompanyList){this.hasChangesMyCompanyList=false;this.refreshCompanySelectorItems()}const t=this.myCompanyList[this.selectedCompanyId];if(t){const e=this.uiNodes.companyNode.titleNode;const s=this.uiNodes.companyNode.detailsNode;if(e.innerText!==t.TITLE){e.innerText=t.TITLE;e.setAttribute("title",t.TITLE)}if(s.innerText!==t.LABEL.DETAILS){s.innerText=t.LABEL.DETAILS}}if(t&&t.IS_DETAILS_COMPLETE){this.hideAlert();this.displayBlock("data-bx-salescenter-action","edit");BX.removeClass(BX("bx-salescenter-business-connect-button"),"ui-btn-disabled")}else{if(t&&t.LABEL.ALERT){this.displayAlert(t.LABEL.ALERT)}this.displayBlock("data-bx-salescenter-action","fill");BX.addClass(BX("bx-salescenter-business-connect-button"),"ui-btn-disabled")}},addLogoutMenuItem(){var e=this;this.settingsMenu.addMenuItem({id:"logoutMenuItem",text:BX.message("SALESCENTER_SP_PAY_SYSTEM_SETTINGS_LOGOUT"),onclick:function(){e.settingsMenu.close();e.logoutFromSettings()}.bind(this)})},removeLogoutMenuItem(){this.settingsMenu.removeMenuItem("logoutMenuItem")},showExpertSettingsMenu(e){e.preventDefault();this.settingsMenu.show()},onLoadSlider:function(e){this.slider=e.slider;top.BX.addCustomEvent("AdminSidePanel:onSendRequest",BX.proxy(this.onSendAdminSidePanelRequest.bind(this,this.slider)));var t=this.getSliderDocument(this.slider);this.formData=this.getAllFormDataJson(t)},onCloseSlider:function(e){this.onCloseSliderPopup(e)},openPopup:function(e){var t;if(this.auth&&this.auth.URL){t=BX.util.popup(this.auth.URL,800,600);if(t){BX.onCustomEvent("onPopupOpen",[t])}}},openCompanySelectorDialog:function(e){this.companySelectorDialog.show()},openCompanyEditSlider:function(e){let t=0;if(this.auth.HAS_AUTH&&this.auth.PROFILE){t=this.auth.PROFILE.ID}else if(this.selectedCompanyId>0){t=this.selectedCompanyId}this.openCompanySlider(t,{init_mode:"edit"},false)},openCompanyCreateSlider:function(e){this.openCompanySlider(0,{mycompany:"Y"},true)},openCompanySlider(e,t,s){let i=`/crm/company/details/${e}/`;i=BX.Uri.addParam(i,t);BX.SidePanel.Instance.open(i,{events:{onCloseComplete:e=>{BX.SidePanel.Instance.destroy(i);const t=new BX.Loader({size:30,target:Object.keys(this.myCompanyList).length>0?this.uiNodes.companyInfoNode:this.uiNodes.companyEmpty,mode:"inline"});t.show();this.companySelectorDialog.hide();BX.unbind(this.uiNodes.companyInfoNode,"click",BX.proxy(this.openCompanySelectorDialog,this));BX.ajax.runComponentAction("bitrix:salescenter.paysystem","getMyCompanyList",{mode:"class"}).then((i=>{this.myCompanyList=i.data.myCompanyList??{};if(s){const t=this.extractIdFromUrl(e.slider.url);if(t&&t>0){this.selectedCompanyId=t}}if(this.selectedCompanyId===0||!this.myCompanyList[this.selectedCompanyId]){this.selectedCompanyId=i.data.selectedCompanyId??0}this.hasChangesMyCompanyList=true;t.destroy();BX.bind(this.uiNodes.companyInfoNode,"click",BX.proxy(this.openCompanySelectorDialog,this));this.refreshBusinessConnectComponents()}),(e=>{this.showErrorPopup(e.errors);t.destroy();BX.bind(this.uiNodes.companyInfoNode,"click",BX.proxy(this.openCompanySelectorDialog,this))}))}}})},extractIdFromUrl(e){const t=e.split("/");const s=t.filter((e=>e!=="")).pop()??0;return parseInt(s,10)},openBusinessPopup:function(){if(BX.hasClass(BX("bx-salescenter-business-connect-button"),"ui-btn-disabled")){return}if(this.auth&&this.auth.URL){const e=this.selectedCompanyId;if(!e||e<0){BX.UI.Dialogs.MessageBox.alert(BX.Loc.getMessage("SALESCENTER_SP_CONNECT_COMPANY_BAD_SELECTION"));return}if(!this.myCompanyList||!this.myCompanyList[e]){BX.UI.Dialogs.MessageBox.alert(BX.Loc.getMessage("SALESCENTER_SP_CONNECT_COMPANY_DOESNT_EXIST"));return}const t=this.myCompanyList[e];if(!t.IS_DETAILS_COMPLETE){BX.UI.Dialogs.MessageBox.alert(BX.Loc.getMessage("SALESCENTER_SP_CONNECT_COMPANY_EMPTY_DETAILS"));return}if(t.URL_PARAMETERS){this.auth.URL=BX.Uri.addParam(this.auth.URL,{urlParameters:t.URL_PARAMETERS})}this.auth.selectedCompany=e;this.openPopup()}},onPopupOpenHandler:function(e){var t=this,s=setInterval((function(){if(e.closed){clearInterval(s);if(t.checkedAuthStatus===false){t.checkAuthStatusAction()}}}),1e3)},logoutAction:function(){let e=BX.Loc.getMessage("SALESCENTER_SP_LOGOUT_CONFIRMATION_TEXT");let t=BX.Loc.getMessage("SALESCENTER_SP_LOGOUT_CONFIRMATION_TITLE");if(this.auth.TYPE==="tbankbusiness"){t=BX.Loc.getMessage("SALESCENTER_SP_TBANK_BUSINESS_LOGOUT_CONFIRMATION_TITLE");e=BX.Loc.getMessage("SALESCENTER_SP_TBANK_BUSINESS_LOGOUT_CONFIRMATION_TEXT")}BX.UI.Dialogs.MessageBox.confirm(e,t,(e=>{e.close();BX.ajax.runComponentAction("bitrix:salescenter.paysystem","logoutProfile",{mode:"ajax",data:{type:this.auth.TYPE}}).then(function(e){this.toggleLogoutBlock()}.bind(this),function(e){this.showErrorPopup(e.errors)}.bind(this))}),BX.Loc.getMessage("SALESCENTER_SP_LOGOUT_CONFIRMATION_OK"),(e=>e.close()),BX.Loc.getMessage("SALESCENTER_SP_LOGOUT_CONFIRMATION_CANCEL"))},checkAuthStatusAction:function(e){if(!e){return}e.reload=false;this.checkedAuthStatus=true;const t={type:this.auth.TYPE};if(this.auth.selectedCompany&&this.auth.selectedCompany>0){t.selectedCompany=this.auth.selectedCompany}BX.ajax.runComponentAction("bitrix:salescenter.paysystem","getProfileStatus",{mode:"ajax",data:t}).then(function(e){this.toggleAuthBlock(e.data.profile)}.bind(this),function(e){this.showErrorPopup(e.errors)}.bind(this))},toggleAuthBlock:function(e){if(e){this.setProfileData(e);this.showBlock(["profile","settings","form"]);BX.removeClass(BX(this.buttonPanelId),"ui-button-panel-wrapper-hide")}else{this.showBlock(["settings","form"]);BX.addClass(BX(this.buttonPanelId),"ui-button-panel-wrapper-hide")}if(this.slider){this.slider.reload()}},toggleLogoutBlock:function(){this.showBlock(["auth"]);if(this.slider){this.slider.reload()}},setProfileData:function(e){if(this.uiNodes.name&&e.NAME){if(this.auth.TYPE==="yookassa"){this.uiNodes.name.innerText="Shop ID "+e.NAME}else{this.uiNodes.name.innerText=e.NAME}}if(this.uiNodes.link){if(e.LINK){this.uiNodes.link.setAttribute("href",e.LINK)}else{this.uiNodes.link.removeAttribute("href")}}},showBlock:function(e){e=BX.type.isArray(e)?e:[e];var t="data-bx-salescenter-block";var s=this.containerNode.querySelectorAll("["+t+"]");s=BX.convert.nodeListToArray(s);s.forEach((function(s){var i=s.getAttribute(t);var n=BX.util.in_array(i,e);s.style.display=n?"block":"none"}),this)},displayAlert(e){const t=this.uiNodes.businessAlert;BX.Dom.style(t,"display","block");t.querySelector(".ui-label-inner").innerText=e},hideAlert(){const e=this.uiNodes.businessAlert;BX.Dom.style(e,"display","none")},displayBlock(e,t,s="block"){const i=BX.type.isArray(t)?t:[t];let n=this.containerNode.querySelectorAll(`[${e}]`);n=BX.convert.nodeListToArray(n);n.forEach((t=>{const n=t.getAttribute(e);const o=BX.util.in_array(n,i);BX.Dom.style(t,"display",o?s:"none")}))},showBlockByAuth:function(){if(this.auth.HAS_AUTH){this.setProfileData(this.auth.PROFILE);if(this.auth.PROFILE){this.showBlock(["profile","settings","form"])}else{this.showBlock(["profile"])}}else{if(this.auth.PROFILE){this.setProfileData(this.auth.PROFILE);this.showBlock(["profile","settings","form"])}else{if(this.auth.CAN_AUTH){this.showBlock(["auth"])}else{this.showBlock(["settings","form"])}}}},openSlider:function(){var e=true;var t={allowChangeHistory:false,events:{onLoad:function(t){if(e){var s=t.getSlider();this.updatePaySystemForm(s);e=false}}.bind(this),onClose:function(e){var t=e.getSlider(),s;s=this.getPaySystemFormData(t);if(s.hasOwnProperty("ID")&&s.ID>0){this.paySystemId=s.ID;this.updateCommonSettingsForm(s);this.savePaySystem().then(function(e){t.destroy();this.slider.url=BX.util.add_url_param(this.slider.url,{ID:this.paySystemId});this.slider.setFrameSrc();this.slider.reload()}.bind(this))}else{this.updateCommonSettingsForm(s)}}.bind(this)}};BX.SidePanel.Instance.open(this.getConnectPath(),t)},onMessageSlider:function(e){if(e.getEventId()==="save"){if(this.paySystemId>0){this.slider.reload()}else{this.closeSlider()}}},closeSlider:function(){var e=BX("salescenter-form-is-saved");if(e){e.value="y"}if(this.slider){this.slider.close()}},getConnectPath:function(){var e="/shop/settings/sale_pay_system_edit/?publicSidePanel=Y";if(this.paySystemId>0){e+="&ID="+this.paySystemId}else if(this.paySystemHandler){e+="&ACTION_FILE="+this.paySystemHandler;if(this.paySystemMode){e+="&PS_MODE="+this.paySystemMode}}return e},savePaySystemAction:function(e){e.preventDefault();this.savePaySystem().then(function(e){BX.removeClass(this.buttonSaveNode,"ui-btn-wait");this.hideError();this.closeSlider()}.bind(this),function(e){BX.removeClass(this.buttonSaveNode,"ui-btn-wait");this.showError(e.errors);if(e.data.hasOwnProperty("ID")){this.paySystemId=e.data.ID;BX("ID").value=this.paySystemId}window.scrollTo(0,0)}.bind(this))},savePaySystem:function(){var e,t;if(this.paySystemId>0){e="salescenterUpdatePaymentSystem"}else{e="salescenterAddPaymentSystem"}t=this.paySystemHandler;if(this.paySystemMode){t=t+":"+this.paySystemMode}return BX.ajax.runComponentAction("bitrix:salescenter.paysystem","savePaySystem",{mode:"ajax",data:this.getSaveData(),analyticsLabel:{analyticsLabel:e,type:t}})},getSaveData:function(){var e=this.getAllFormData(document);for(var t in this.paySystemFormData){if(this.paySystemFormData.hasOwnProperty(t)){if(this.isObject(this.paySystemFormData[t])){e.append(t,JSON.stringify(this.paySystemFormData[t]))}else{e.append(t,this.paySystemFormData[t])}}}if(this.paySystemFormData.hasOwnProperty("NAME")){e.append("ACTIVE",e.get("ACTIVE"));e.append("NAME",e.get("NAME"));e.append("DESCRIPTION",e.get("DESCRIPTION"));e.append("IS_CASH",e.get("IS_CASH"));e.append("CAN_PRINT_CHECK",e.get("CAN_PRINT_CHECK"))}return e},updatePaySystemForm:function(e){var t,s,i,n,o;t=this.getSliderDocument(e);o=this.getCommonSettingsFormData();if(this.paySystemId>0){this.setPaySystemFormFields(t,o)}else{i=t.getElementById("LOGOTIP").closest("span").firstChild;n=this.elementObserver(i,function(e){this.setPaySystemFormFields(t,o);n.disconnect()}.bind(this));var a=t.getElementById("ACTION_FILE");if(a){s=new Event("change");a.dispatchEvent(s)}}},setPaySystemFormFields:function(e,t){var s,i,n,o,a,r,l;n=e.getElementById("PSA_NAME");if(n&&t.NAME){n.value=t.NAME}o=e.getElementById("NAME");if(o&&t.NAME){o.value=t.NAME}a=e.getElementsByName("IS_CASH");if(a&&t.IS_CASH){a[0].value=t.IS_CASH}s=e.getElementById("ACTION_FILE");if(s){s.closest("tr").style.display="none"}i=e.getElementById("PS_MODE");if(i){i.closest("tr").style.display="none"}if(t.CAN_PRINT_CHECK_SELF&&t.CAN_PRINT_CHECK_SELF==="Y"){r=e.getElementById("CAN_PRINT_CHECK");if(r){r.closest("tr").style.display="none"}}else{r=e.getElementById("CAN_PRINT_CHECK");if(r&&t.CAN_PRINT_CHECK){r.checked=t.CAN_PRINT_CHECK==="Y"}}l=e.getElementById("tab_cont_cashbox_edit");if(l){l.style.display="none";e.getElementById("cashbox_edit").style.display="none"}try{var c=this.lookupDescriptionEditor(e);if(c){c.SetEditorContent(BX.util.htmlspecialchars(t.DESCRIPTION));c.SaveContent();if(c.pEditorDocument){BX.bind(c.pEditorDocument,"click",BX.proxy(c.OnClick,c));BX.bind(c.pEditorDocument,"mousedown",BX.proxy(c.OnMousedown,c))}}}catch(e){}},getPaySystemFormData:function(e){var t,s;t=this.getSliderDocument(e);s=this.getAllFormDataList(t);try{var i=this.lookupDescriptionEditor(t);if(i){i.SaveContent();s.DESCRIPTION=BX.util.htmlspecialcharsback(i.GetContent())}}catch(e){}return s},updateCommonSettingsForm:function(e){var t,s,i,n,o;var a=this.getCommonSettingsFormData();t=BX("ID");s=BX("NAME");i=BX("DESCRIPTION");n=BX("IS_CASH");o=BX("CAN_PRINT_CHECK");if(t&&e.ID){t.value=e.ID}if(s&&e.NAME){s.value=e.NAME}if(i&&e.DESCRIPTION){i.value=e.DESCRIPTION}if(n&&e.IS_CASH){n.value=e.IS_CASH}if(o){if(a.CAN_PRINT_CHECK_SELF&&a.CAN_PRINT_CHECK_SELF==="Y"){o.checked=true}else{o.checked=!!(e.CAN_PRINT_CHECK&&e.CAN_PRINT_CHECK==="Y")}}this.paySystemFormData=e},getCommonSettingsFormData:function(){var e;e=this.getAllFormDataList(document);return e},onSendAdminSidePanelRequest:function(e,t){if(t.indexOf("action=delete")!==-1){e.close()}},elementObserver:function(e,t){if(!window.MutationObserver){return}var s={attributes:true,childList:true,characterData:true};var i=new MutationObserver((function(e){e.forEach((function(e){t(e)}))}));i.observe(e,s);return i},getAllFormDataJson:function(e){var t=this.getAllFormDataList(e);return t?JSON.stringify(t):""},getAllFormData:function(e){var t=new FormData,s=this.getAllFormDataList(e);for(var i in s){if(s.hasOwnProperty(i)){if(this.isObject(s[i])){t.append(i,JSON.stringify(s[i]))}else{t.append(i,s[i])}}}return t},getAllFormDataList:function(e){var t={},s,i,n;if(!e){return t}n=e.getElementsByTagName("form");for(s=0;s<n.length;s++){var o=this.getFormData(n[s]);for(i in o){if(o.hasOwnProperty(i)){t[i]=o[i]}}}return t},getFormData:function(e){var t=BX.ajax.prepareForm(e),s;for(s in t.data){if(t.data.hasOwnProperty(s)&&s===""){delete t.data[s]}}return!!t&&t.data?t.data:{}},showErrorPopup:function(e){var t,s=[];e.forEach((function(e){s.push(BX.create("p",{text:e.message}))}));if(!s.length){return}t=BX.create("div",{children:s});BX.UI.Dialogs.MessageBox.alert(t,(e=>e.close()),BX.Loc.getMessage("SALESCENTER_SP_BUTTON_CLOSE"))},showError:function(e){var t="";e.forEach((function(e){t+=e.message+"<br>"}));if(this.errorMessageNode&&t){this.errorMessageNode.parentNode.style.display="block";this.errorMessageNode.innerHTML=t}},hideError:function(){if(this.errorMessageNode){this.errorMessageNode.innerHTML="";this.errorMessageNode.parentNode.style.display="none"}},getSliderDocument:function(e){var t,s;t=e.iframe;s=t.contentDocument||t.contentWindow.document;return s},lookupDescriptionEditor:function(e){try{var t=e.defaultView||e.parentWindow;var s="LightHTMLEditorhndl_dscr_0";if(this.paySystemId&&this.paySystemId>0){s="LightHTMLEditorhndl_dscr_"+this.paySystemId}return t[s]}catch(e){}},showLogotip:function(e){if(e.currentTarget.files&&e.currentTarget.files[0]){var t=new FileReader;t.onload=function(e){BX("salescenter-img-preload").src=e.target.result};t.readAsDataURL(e.currentTarget.files[0])}},onCloseSliderPopup:function(e){var t=this.getSliderDocument(e.slider);var s=t.getElementById("salescenter-form-is-saved");if(s&&s.value==="y"){return true}var i=this.getAllFormDataJson(t);if(this.formData===i||this.isClose===true){this.isClose=false;return false}e.action=false;if(this.isPopupShown){return false}BX.UI.Dialogs.MessageBox.confirm(BX.Loc.getMessage("SALESCENTER_SP_POPUP_CONTENT_MSGVER_1"),(e=>{this.isPopupShown=false;this.isClose=true;e.close();BX.SidePanel.Instance.getTopSlider().close()}),BX.Loc.getMessage("SALESCENTER_SP_POPUP_BUTTON_CLOSE_MSGVER_1"),(e=>{this.isPopupShown=false;e.close();BX.SidePanel.Instance.getTopSlider().focus()}),BX.Loc.getMessage("SALESCENTER_SP_POPUP_BUTTON_STAY"));this.isPopupShown=true;return false},isObject:function(e){return e&&typeof e==="object"&&e.constructor===Object},remove:function(e){var t=e.target;e.preventDefault();if(this.paySystemId>0&&confirm(BX.message("SALESCENTER_SP_PAYSYSTEM_DELETE_CONFIRM"))){var s=this.paySystemHandler;if(this.paySystemMode){s=s+":"+this.paySystemMode}BX.ajax.runComponentAction("bitrix:salescenter.paysystem","deletePaySystem",{mode:"ajax",data:{paySystemId:this.paySystemId},analyticsLabel:{analyticsLabel:"salescenterDeletePaymentSystem",type:s}}).then(function(){BX.removeClass(t,"ui-btn-wait");this.closeSlider()}.bind(this),function(e){BX.removeClass(t,"ui-btn-wait");this.showError(e.errors)}.bind(this))}else{setTimeout((function(){BX.removeClass(t,"ui-btn-wait")}),100)}},change:function(){if(this.paySystemId<=0){return}var e=this.getSliderDocument(this.slider);var t=this.getAllFormDataJson(e);if(this.formData===t){BX.addClass(BX(this.buttonPanelId),"ui-button-panel-wrapper-hide");return}BX.removeClass(BX(this.buttonPanelId),"ui-button-panel-wrapper-hide")},openSettingsForm(e){BX.SidePanel.Instance.open(e,{cacheable:false,allowChangeHistory:false,width:500})},onAddSettings(e){var t=e.getData();if(t&&t.handlerClassName){this.getPaySystemSettingsData(t.handlerClassName).then(function(e){var s=e.data;this.reloadSettingsBlockOnAdd(t.handlerClassName,s);if(s.IS_SETTINGS_EXISTS){this.showNotificationOnAddSetting()}}.bind(this))}},getPaySystemSettingsData(e){return BX.ajax.runComponentAction("bitrix:salescenter.paysystem","getPaySystemSettingsData",{mode:"class",data:{handlerClassName:e}})},reloadSettingsBlockOnAdd(e,t){var s=t.PAY_SYSTEM_ROBOKASSA_SETTINGS;if(s&&s.IS_SUPPORT_SETTINGS){if(s.IS_ONLY_COMMON_SETTINGS_EXISTS){this.addLogoutMenuItem();var i=this.settingsFormLinkNameCodeMap["DEFAULT"];e=this.handlerClassName.replace(/\/\//g,"/");if(this.settingsFormLinkNameCodeMap.hasOwnProperty(e)){i=this.settingsFormLinkNameCodeMap[e]["EXIST"]}BX("salescenter-settings-paysystem-form-link").text=i}if(s.IS_SETTINGS_EXISTS&&BX("salescenter-settings-paysystem-register-component")){BX.remove(BX("salescenter-settings-paysystem-register-component"))}}},showNotificationOnAddSetting(){window.top.BX.UI.Notification.Center.notify({content:BX.message("SALESCENTER_SP_PAYSYSTEM_SETTINGS_ADD_NOTIFICATION")})},logoutFromSettings(){this.deletePaySystemSettings().then(function(){this.getPaySystemSettingsData(this.handlerClassName).then(function(e){var t=e.data;if(!t.IS_SETTINGS_EXISTS){this.removeLogoutMenuItem();this.getRegisterPaySystemComponentAction().then(function(e){this.reloadSettingsBlockOnLogout(e.data)}.bind(this))}}.bind(this))}.bind(this))},deletePaySystemSettings(){return BX.ajax.runAction("sale.paysystem.settings.robokassa.delete",{})},getRegisterPaySystemComponentAction(){return BX.ajax.runAction("sale.paysystem.settings.robokassa.getRegisterComponent",{})},reloadSettingsBlockOnLogout(e){if(BX("salescenter-settings-paysystem-register-component")){BX.remove(BX("salescenter-settings-paysystem-register-component"))}var t=BX("salescenter-settings-block");if(t){var s=BX.create("span",{props:{id:"salescenter-settings-paysystem-register-component"}});BX.html(s,e.html);t.prepend(s);var i=this.settingsFormLinkNameCodeMap["DEFAULT"];var n=this.handlerClassName.replace(/\/\//g,"/");if(this.settingsFormLinkNameCodeMap.hasOwnProperty(n)){i=this.settingsFormLinkNameCodeMap[n]["NEW"]}BX("salescenter-settings-paysystem-form-link").text=i}}};if(BX.SalecenterPaySystemCashbox)return;BX.SalecenterPaySystemCashbox={init:function(e){this.paySystemId=e.paySystemId;this.formNode=BX(e.formId);this.cashboxContainerInfoNode=BX(e.cashboxContainerInfoId);this.cashboxContainerNode=BX(e.cashboxContainerId);this.cashboxWarningContainerNode=BX(e.cashboxWarningContainerId);this.canPrintCheckNode=BX(e.canPrintCheckId);this.cashboxSwitchet=null;this.containerNodeList={settings:BX(e.containerList.settings),cashboxSettings:BX(e.containerList.cashboxSettings)};this.section=e.section;this.fields=e.fields;this.initSwitcher();this.renderSettings(this.cashboxContainerNode)},renderSettings:function(e){Object.keys(this.section).forEach(function(t){if(this.fields[t]){var s=this.section[t];var i=s.type;if(this.containerNodeList[i]){this.containerNodeList[i].appendChild(this.renderSection(s,this.fields[t]))}else{e.appendChild(this.renderSection(s,this.fields[t]))}}}.bind(this))},renderSection:function(e,t){var s=BX.create("div",{props:{className:"salescenter-editor-section-content"}});var i=BX.create("div",{props:{className:"salescenter-paysystem-section-title salescenter-paysystem-angle-icon-after"},children:[BX.create("div",{props:{className:"salescenter-paysystem-section-title-block"},children:[BX.create("div",{props:{className:"ui-title-6"},text:e.title}),e.hint&&BX.UI.Hint.createNode(e.hint)]}),BX.create("div",{props:{className:"salescenter-paysystem-angle-icon"}})]});s.appendChild(i);s.appendChild(BX.create("div",{props:{className:"ui-hr"}}));var n=BX.create("div");if(e.collapsed==="Y"){BX.hide(n)}s.appendChild(n);if(e.warning){n.appendChild(BX.create("div",{props:{className:"ui-alert ui-alert-warning"},text:e.warning}))}t.forEach(function(e){var t=BX.create("div",{props:{className:"salescenter-editor-content-block"}});this.renderField(e).forEach((function(e){t.appendChild(e)}));n.appendChild(t)}.bind(this));i.addEventListener("click",(function(){BX.toggle(n)}));return s},renderField:function(e){if(e.type==="checkbox"){return this.renderCheckbox(e)}if(e.type==="select"){return this.renderSelect(e)}return this.renderString(e)},renderString:function(e){var t=[];t.push(BX.create("div",{props:{className:"ui-ctl-label-text"+(e.required?" salescenter-paysystem-control-required":"")},text:e.label}));t.push(BX.create("div",{props:{className:"ui-ctl ui-ctl-textbox ui-ctl-w100"},html:e.input}));if(e.hint){t.push(BX.create("div",{props:{className:"ui-ctl-label-text"},style:{marginTop:"5px"},children:[BX.create("span",{props:{className:"salescenter-editor-content-logo-hint"},text:e.hint})]}))}return t},renderSelect:function(e){var t=[];t.push(BX.create("div",{props:{className:"ui-ctl-label-text"+(e.required?" salescenter-paysystem-control-required":"")},text:e.label}));var s=BX.create("div",{props:{className:"ui-ctl ui-ctl-after-icon ui-ctl-dropdown ui-ctl-w100"},children:[BX.create("div",{props:{className:"ui-ctl-after ui-ctl-icon-angle"}})]});s.insertAdjacentHTML("beforeend",e.input);t.push(s);return t},renderCheckbox:function(e){var t=[];var s=BX.create("label",{props:{className:"ui-ctl ui-ctl-checkbox ui-ctl-w100"},html:e.input});s.appendChild(BX.create("div",{props:{className:"ui-ctl-label-text"+(e.required?" salescenter-paysystem-control-required":"")},text:e.label}));t.push(s);return t},initSwitcher:function(){var e=this.formNode.getElementsByClassName("js-cashbox-ui-switcher");e=BX.convert.nodeListToArray(e);e.forEach(function(e){if(e.getAttribute("data-switcher-init")){return}var t=new BX.UI.Switcher({node:e});this.cashboxSwitchet=t;this.canPrintCheckNode.onchange=()=>this.onToggleCanPrintCheckNode(this.canPrintCheckNode);BX.addCustomEvent(t,"unchecked",BX.proxy(this.onToggleCashboxSwitcher.bind(this,t)));BX.addCustomEvent(t,"checked",BX.proxy(this.onToggleCashboxSwitcher.bind(this,t)))}.bind(this))},onToggleCashboxSwitcher:function(e){BX.SalecenterPaySystem.change();if(e.isChecked()){this.canPrintCheckNode.checked=true;this.cashboxContainerInfoNode.classList.remove("salescenter-paysystem-cashbox-block--disabled");if(this.cashboxWarningContainerNode){BX.hide(this.cashboxWarningContainerNode)}this.showCashboxSettings()}else{this.cashboxContainerInfoNode.classList.add("salescenter-paysystem-cashbox-block--disabled");if(this.cashboxWarningContainerNode){BX.show(this.cashboxWarningContainerNode)}this.hideCashboxSettings()}},onToggleCanPrintCheckNode:function(e){if(e.checked===false){this.cashboxSwitchet.check(false)}},showCashboxSettings:function(){BX("salescenter-paysystem-cashbox").style.display="block"},hideCashboxSettings:function(){BX("salescenter-paysystem-cashbox").style.display="none"},reloadCashboxSettings:function(e){var t=this;BX.ajax.runComponentAction("bitrix:salescenter.paysystem","reloadCashboxSettings",{mode:"class",data:{paySystemId:this.paySystemId,kkmId:e.value}}).then((function(e){if(e.data.hasOwnProperty("IS_FISCALIZATION_ENABLE")){var s=e.data.IS_FISCALIZATION_ENABLE;t.cashboxSwitchet.check(s)}t.section=e.data.CASHBOX.section;t.fields=e.data.CASHBOX.fields;t.resetAllSection();if(t.section){t.renderSettings(t.cashboxContainerNode)}}))},resetSection:function(e){e.forEach(function(e){var t=this.section[e].type;if(this.containerNodeList[t]){this.containerNodeList[t].innerHTML=""}}.bind(this))},resetAllSection:function(){Object.keys(this.containerNodeList).forEach(function(e){this.containerNodeList[e].innerHTML=""}.bind(this))}}})(window);
//# sourceMappingURL=script.map.js