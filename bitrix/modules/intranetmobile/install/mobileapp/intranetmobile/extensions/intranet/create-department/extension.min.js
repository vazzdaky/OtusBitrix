jn.define("intranet/create-department",((e,t,r)=>{const{Loc:s}=e("loc");const{Type:n}=e("type");const{Color:a,Corner:o,Indent:i,Component:d}=e("tokens");const{Area:l}=e("ui-system/layout/area");const{Box:c}=e("ui-system/layout/box");const{BoxFooter:u}=e("ui-system/layout/dialog-footer");const{IconView:m,Icon:p}=e("ui-system/blocks/icon");const{InputSize:h,InputDesign:T,InputMode:g,StringInput:f}=e("ui-system/form/inputs/string");const{ButtonSize:E,ButtonDesign:N,Button:A}=e("ui-system/form/buttons/button");const{showToast:D,showErrorToast:R}=e("toast");const{BottomSheet:_}=e("bottom-sheet");const{showAccessRestrictionBox:I}=e("intranet/create-department/src/permissions-box");const{DepartmentSelectorCard:y}=e("intranet/create-department/src/selector-card/department");const{UserSelectorCard:S}=e("intranet/create-department/src/selector-card/user");const{Line:M}=e("utils/skeleton");const{usersSelector:C,usersUpserted:b}=e("statemanager/redux/slices/users");const{usersUpserted:w}=e("intranet/statemanager/redux/slices/employees");const{batchActions:O}=e("statemanager/redux/batched-actions");const{dispatch:P,getState:B}=e("statemanager/redux/store");const x=Application.getPlatform()==="android";const{fetchDepartmentPermissions:H}=e("intranet/create-department/src/api");const L=1;class W extends LayoutComponent{static async open(e){const t=e.parentWidget||PageManager;const r=new W(e);const n=new _({component:r,titleParams:{type:"dialog",text:e.title||s.getMessage("M_INTRANET_CREATE_DEPARTMENT_TITLE"),largeMode:true}});n.setParentWidget(t).setBackgroundColor(a.bgSecondary.toHex()).setNavigationBarColor(a.bgSecondary.toHex()).disableShowOnTop().disableOnlyMediumPosition().setMediumPositionHeight(W.getStartingLayoutHeight()).enableBounce().enableSwipe().disableHorizontalSwipe().enableResizeContent().enableAdoptHeightByKeyboard().open().then((e=>{r.setLayout(e)})).catch((()=>{}))}async fetchCreateDepartmentSettings(){const e=await Promise.allSettled([H(),this.fetchDefaultHeadOfDepartment()]);const t={};if(e[0]?.status==="fulfilled"){const r=e[0].value;if(r.status==="success"){const{data:e}=r;t.canInviteUsers=e.canInviteUsers??false;t.needToBeMemberOfNewDepartment=e.needToBeMemberOfNewDepartment??true;t.canCreateNewDepartment=e.canCreateNewDepartment??false;t.defaultParentDepartment=e.firstPossibleParentForNewDepartment??null}}if(e[1]?.status==="fulfilled"){t.defaultHeadOfDepartment=e[1].value}return t}async fetchDefaultHeadOfDepartment(e=env.userId){const t=C.selectById(B(),e);if(t){return{id:t.id,name:t.fullName}}const r=await BX.ajax.runAction("intranetmobile.employees.getUsersByIds",{data:{ids:[e]}}).catch(console.error);if(r.status!=="success"){return null}const{items:s,users:n}=r.data;this.saveUserToRedux(s,n);return{id:s[0].id,name:s[0].fullName}}saveUserToRedux(e,t){const r=[b(e),w(t)];P(O(r))}static getStartingLayoutHeight(){const e=44;const t=d.areaPaddingB.toNumber()+d.areaPaddingTFirst.toNumber();const r=48;const s=42*2+2*i.XL2.toNumber();const n=42+i.XL2.toNumber();return e+t+r+s+n+(x?i.XL2.toNumber():0)}constructor(e){super(e);this.nameInputRef=null;this.layoutWidget=null;this.state={needToBeMemberOfNewDepartment:true,parentDepartment:null,departmentName:"",headOfDepartment:{id:env.userId},error:null,loading:true}}get showToastAfterCreation(){return this.props.showToastAfterCreation??true}get showToastAfterCreationError(){return this.props.showToastAfterCreationError??true}async componentDidMount(){Keyboard.on(Keyboard.Event.WillHide,(()=>{this.layoutWidget.setBottomSheetHeight(W.getStartingLayoutHeight())}));this.focusOnNameInput();const{canCreateNewDepartment:e,needToBeMemberOfNewDepartment:t,defaultParentDepartment:r,defaultHeadOfDepartment:s}=await this.fetchCreateDepartmentSettings();if(!e){I({parentWidget:this.layoutWidget,onClose:this.close});return}this.setState({needToBeMemberOfNewDepartment:t,parentDepartment:r,headOfDepartment:s,loading:false})}#e=e=>{const t="create-department";return e?`${t}-${e}`:t};setLayout(e){this.layoutWidget=e;this.layoutWidget.on("onViewHidden",(()=>{this.props.onClose?.(this)}))}render(){const{loading:e}=this.state;return c({resizableByKeyboard:true,safeArea:{bottom:true},footer:this.renderFooter()},l({isFirst:true},View({style:{flexDirection:"row",alignItems:"center"}},this.renderDepartmentIcon(),this.renderDepartmentNameInput()),e&&this.renderSkeletonForSelectorCards(),!e&&View({style:{flexDirection:"row",flexWrap:"wrap"}},this.renderParentDepartmentSelector(),this.renderHeadOfDepartmentSelector())))}renderSkeletonForSelectorCards(){return View({style:{flexDirection:"row",flexWrap:"wrap"}},M(100,14,16,7,4),M("100%",16,0,14,4),M("100%",1,0,0,0),M(100,14,17,7,4),M("100%",16,0,0,4))}renderFooter(){const{departmentName:e,loading:t}=this.state;return u({safeArea:!x,keyboardButton:{text:s.getMessage("M_INTRANET_CREATE_DEPARTMENT_CREATE_BUTTON_TEXT"),loading:t,onClick:this.save,disabled:e===""}},A({testId:this.#e("create-button"),design:N.FILLED,size:E.L,text:s.getMessage("M_INTRANET_CREATE_DEPARTMENT_CREATE_BUTTON_TEXT"),stretched:true,onClick:this.save,loading:t,disabled:e===""}))}renderDepartmentIcon(){return View({style:{backgroundColor:a.accentSoftBlue2.toHex(),flexDirection:"row",justifyContent:"center",alignContent:"center",alignItems:"center",width:48,height:48,borderRadius:o.M.toNumber()}},m({icon:p.COMPANY,size:31,color:a.accentMainPrimaryalt}))}renderDepartmentNameInput(){const{error:e}=this.state;return View({style:{flex:1,marginLeft:i.L.toNumber()}},f({testId:this.#e("name-input"),placeholder:s.getMessage("M_INTRANET_CREATE_DEPARTMENT_NAME_INPUT_TITLE"),size:h.L,design:T.PRIMARY,mode:g.STROKE,align:"left",error:e||false,errorText:e,onChange:e=>{const t=n.isStringFilled(e)?null:s.getMessage("M_INTRANET_CREATE_DEPARTMENT_NAME_INPUT_ERROR");this.setState({departmentName:e,error:t})},forwardRef:this.handleInputRef}))}handleInputRef=e=>{this.nameInputRef=e;this.focusOnNameInput()};renderParentDepartmentSelector(){const{parentDepartment:e}=this.state;return y({testId:"parent-department",parentWidget:this.layoutWidget,title:s.getMessage("M_INTRANET_CREATE_DEPARTMENT_PARENT_DEPARTMENT_SELECTOR_TITLE"),text:e?.name??"",selectedId:e?.id??null,showBottomBorder:true,onViewHidden:this.focusOnNameInput,onSelected:e=>{if(Array.isArray(e)&&e.length>0){this.setState({parentDepartment:{id:e[0].id,name:e[0].title}})}}})}renderHeadOfDepartmentSelector(){const{headOfDepartment:e}=this.state;return S({testId:"head-of-department",parentWidget:this.layoutWidget,title:s.getMessage("M_INTRANET_CREATE_DEPARTMENT_HEAD_OF_DEPARTMENT_SELECTOR_TITLE"),text:e?.name??"",selectedId:e?.id??null,onViewHidden:this.focusOnNameInput,editable:this.isHeadOfDepartmentEditable(),onSelected:e=>{if(Array.isArray(e)&&e.length>0){this.setState({headOfDepartment:{id:e[0].id,name:e[0].title}})}}})}isHeadOfDepartmentEditable(){const{needToBeMemberOfNewDepartment:e}=this.state;const{shouldCheckNeedToBeMemberOfNewDepartment:t=false}=this.props;return!t||!e}save=()=>{if(this.state.loading){return}if(!n.isStringFilled(this.state.departmentName)){this.setState({error:s.getMessage("M_INTRANET_CREATE_DEPARTMENT_NAME_INPUT_ERROR")});return}const e={name:this.state.departmentName,parentId:this.state.parentDepartment?.id,userIds:{MEMBER_HEAD:[this.state.headOfDepartment?.id]}};this.setState({loading:true},(()=>{BX.ajax.runAction("humanresources.api.Structure.Department.create",{data:e}).then((e=>{if(e.status==="success"){if(this.showToastAfterCreation){D({message:s.getMessage("M_INTRANET_CREATE_DEPARTMENT_SAVE_TOAST_SUCCESS_MESSAGE")},this.props.parentWidget)}const{id:t,name:r}=e.data[0];this.props.onSave?.({id:t,title:r});this.setState({loading:false},(()=>{this.close()}))}else{this.#t(e)}}),(e=>{this.#t(e)})).catch((e=>console.error(e)))}))};focusOnNameInput=()=>{this.nameInputRef?.focus()};close=()=>{this.layoutWidget.close()};#t(e){this.setState({loading:false},(()=>{if(e.errors?.length>0){if(e.errors[0].code===L){I({parentWidget:this.layoutWidget,subdepartmentCreationCase:true,onClose:this.focusOnNameInput})}else{if(this.showToastAfterCreationError){R({message:s.getMessage("M_INTRANET_CREATE_DEPARTMENT_SAVE_TOAST_ERROR_MESSAGE")},this.layoutWidget)}this.props.onError?.(e,this.layoutWidget,this)}}}))}}r.exports={CreateDepartment:W,showAccessRestrictionBox:I,fetchDepartmentPermissions:H}}));
//# sourceMappingURL=extension.map.js