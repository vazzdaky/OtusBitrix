{"version":3,"file":"work-time-button.bundle.js","sources":["../src/work-time-button.js"],"sourcesContent":["import { Extension, Loc } from 'main.core';\nimport { BaseEvent, EventEmitter } from 'main.core.events';\nimport { AirButtonStyle, Button, ButtonIcon } from 'ui.buttons';\n\nimport 'timeman';\nimport 'CJSTask';\nimport 'planner';\nimport 'tasks_planner_handler';\nimport 'calendar_planner_handler';\nimport 'ajax';\nimport 'timer';\nimport 'popup';\nimport 'ls';\nimport 'ui.fonts.opensans';\nimport 'ui.layout-form';\nimport 'ui.analytics';\n\nimport './work-time-button.css';\n\ntype Data = {\n\tworkReport: Object,\n\tinfo: Object & {\n\t\tSTATE: string,\n\t\tCAN_OPEN?: string,\n\t\tINFO: Object & {\n\t\t\tDATE_START: number,\n\t\t\tTIME_LEAKS: number,\n\t\t},\n\t},\n\tsiteId: string,\n};\n\nconst State = Object.freeze({\n\tClosed: 'CLOSED',\n\tOpened: 'OPENED',\n\tPaused: 'PAUSED',\n\tExpired: 'EXPIRED',\n});\nconst Action = Object.freeze({\n\tOpen: 'OPEN',\n\tReopen: 'REOPEN',\n});\n\nexport class WorkTimeButton\n{\n\t#data: Data = {};\n\t#button: Button;\n\t#node: HTMLElement;\n\t#timerInterval: number;\n\n\tconstructor()\n\t{\n\t\tconst settings = Extension.getSettings('timeman.work-time-button');\n\n\t\tthis.#data.workReport = settings.get('workReport');\n\t\tthis.#data.info = settings.get('info');\n\t\tthis.#data.siteId = settings.get('siteId');\n\n\t\tthis.#button = new Button({\n\t\t\tsize: Button.Size.MEDIUM,\n\t\t\ttext: this.#getButtonText(),\n\t\t\ticon: this.#getButtonIcon(),\n\t\t\tuseAirDesign: true,\n\t\t\tstyle: this.#getButtonStyle(),\n\t\t\tnoCaps: true,\n\t\t\twide: true,\n\t\t\tevents: {\n\t\t\t\tclick: this.#handleClick.bind(this),\n\t\t\t},\n\t\t\tclassName: 'timeman-work-time-button',\n\t\t});\n\t\tthis.#node = this.#button.render();\n\n\t\tEventEmitter.subscribe('onTimemanInit', this.#init.bind(this));\n\t\tEventEmitter.subscribe('onTimeManDataRecieved', this.#updateState.bind(this));\n\n\t\twindow.BX.timeman('bx_tm', this.#data.info, this.#data.siteId);\n\t}\n\n\trender(): HTMLElement\n\t{\n\t\treturn this.#node;\n\t}\n\n\t#getState(): string\n\t{\n\t\treturn this.#data.info.STATE;\n\t}\n\n\t#getAvailableAction(): ?string\n\t{\n\t\treturn this.#data.info?.CAN_OPEN ?? null;\n\t}\n\n\t#getDateStart(): number\n\t{\n\t\treturn this.#data.info.INFO.DATE_START;\n\t}\n\n\t#getTimeLeaks(): number\n\t{\n\t\treturn this.#data.info.INFO.TIME_LEAKS;\n\t}\n\n\t#init(): void\n\t{\n\t\tthis.#initWorkingButtonTimer();\n\n\t\twindow.BXTIMEMAN.initFormWeekly(this.#data.workReport);\n\t}\n\n\t#updateState(baseEvent: BaseEvent): void\n\t{\n\t\tconst [data] = baseEvent.getCompatData();\n\n\t\tthis.#data.info = data;\n\n\t\tthis.#button.setText(this.#getButtonText());\n\t\tthis.#button.setIcon(this.#getButtonIcon());\n\t\tthis.#button.setStyle(this.#getButtonStyle());\n\n\t\tthis.#initWorkingButtonTimer();\n\t}\n\n\t#handleClick(button: Button, event: PointerEvent): void\n\t{\n\t\tevent.stopPropagation();\n\n\t\twindow.BXTIMEMAN.setBindOptions({\n\t\t\tnode: this.#node,\n\t\t\tmode: 'popup',\n\t\t\tpopupOptions: {\n\t\t\t\tautoHide: true,\n\t\t\t\tangle: false,\n\t\t\t\toffsetTop: -40,\n\t\t\t\tcloseByEsc: true,\n\t\t\t\tbindOptions: {\n\t\t\t\t\tforceBindPosition: true,\n\t\t\t\t\tforceTop: true,\n\t\t\t\t\tforceLeft: false,\n\t\t\t\t},\n\t\t\t\tevents: {\n\t\t\t\t\tonClose: () => {},\n\t\t\t\t\tonDestroy: () => {},\n\t\t\t\t},\n\t\t\t},\n\t\t});\n\n\t\twindow.BXTIMEMAN.Open();\n\t}\n\n\t#getButtonText(): string\n\t{\n\t\tif (\n\t\t\tthis.#getState() === State.Closed\n\t\t\t&& this.#getAvailableAction() === Action.Open\n\t\t)\n\t\t{\n\t\t\treturn Loc.getMessage('TIMEMAN_WORK_TIME_BUTTON_TEXT_START');\n\t\t}\n\n\t\tif (this.#getState() === State.Opened)\n\t\t{\n\t\t\treturn this.#getWorkingButtonText();\n\t\t}\n\n\t\tif (this.#getState() === State.Paused)\n\t\t{\n\t\t\treturn Loc.getMessage('TIMEMAN_WORK_TIME_BUTTON_TEXT_CONTINUE');\n\t\t}\n\n\t\tif (\n\t\t\tthis.#getState() === State.Closed\n\t\t\t&& this.#getAvailableAction() === Action.Reopen\n\t\t)\n\t\t{\n\t\t\treturn Loc.getMessage('TIMEMAN_WORK_TIME_BUTTON_TEXT_CONTINUE');\n\t\t}\n\n\t\tif (this.#getState() === State.Expired)\n\t\t{\n\t\t\treturn Loc.getMessage('TIMEMAN_WORK_TIME_BUTTON_TEXT_EXPIRED');\n\t\t}\n\n\t\treturn '';\n\t}\n\n\t#getButtonIcon(): ?string\n\t{\n\t\tif (\n\t\t\tthis.#getState() === State.Closed\n\t\t\t&& this.#getAvailableAction() === Action.Open\n\t\t)\n\t\t{\n\t\t\treturn ButtonIcon.START;\n\t\t}\n\n\t\tif (this.#getState() === State.Opened)\n\t\t{\n\t\t\treturn ButtonIcon.START;\n\t\t}\n\n\t\tif (this.#getState() === State.Paused)\n\t\t{\n\t\t\treturn ButtonIcon.START;\n\t\t}\n\n\t\tif (\n\t\t\tthis.#getState() === State.Closed\n\t\t\t&& this.#getAvailableAction() === Action.Reopen\n\t\t)\n\t\t{\n\t\t\treturn ButtonIcon.REFRESH;\n\t\t}\n\n\t\tif (this.#getState() === State.Expired)\n\t\t{\n\t\t\treturn ButtonIcon.ALERT;\n\t\t}\n\n\t\treturn null;\n\t}\n\n\t#getButtonStyle(): string\n\t{\n\t\tif (this.#getState() === State.Opened)\n\t\t{\n\t\t\treturn AirButtonStyle.TINTED;\n\t\t}\n\n\t\tif (this.#getState() === State.Paused)\n\t\t{\n\t\t\treturn AirButtonStyle.FILLED;\n\t\t}\n\n\t\tif (\n\t\t\tthis.#getState() === State.Closed\n\t\t\t&& this.#getAvailableAction() === Action.Reopen\n\t\t)\n\t\t{\n\t\t\treturn AirButtonStyle.TINTED;\n\t\t}\n\n\t\tif (this.#getState() === State.Expired)\n\t\t{\n\t\t\treturn AirButtonStyle.TINTED_ALERT;\n\t\t}\n\n\t\treturn AirButtonStyle.FILLED;\n\t}\n\n\t#initWorkingButtonTimer(): void\n\t{\n\t\tthis.#stopWorkingButtonTimer();\n\n\t\tif (this.#getState() === State.Opened)\n\t\t{\n\t\t\tthis.#startWorkingButtonTimer();\n\t\t}\n\t}\n\n\t#startWorkingButtonTimer(): void\n\t{\n\t\tthis.#timerInterval = setInterval(() => {\n\t\t\tthis.#button.setText(this.#getWorkingButtonText());\n\t\t}, 1000);\n\t}\n\n\t#stopWorkingButtonTimer(): void\n\t{\n\t\tclearInterval(this.#timerInterval);\n\t}\n\n\t#getWorkingButtonText(): string\n\t{\n\t\tconst nowSeconds = Math.floor(Date.now() / 1000);\n\n\t\tconst workingSeconds = (nowSeconds - this.#getDateStart()) - (this.#getTimeLeaks() || 0);\n\t\tif (workingSeconds < 0)\n\t\t{\n\t\t\treturn this.#formatTime(0, 0, 0);\n\t\t}\n\n\t\tconst hours = Math.floor(workingSeconds / 3600);\n\t\tconst minutes = Math.floor((workingSeconds % 3600) / 60);\n\t\tconst seconds = workingSeconds % 60;\n\n\t\treturn this.#formatTime(hours, minutes, seconds);\n\t}\n\n\t#formatTime(hours, minutes, seconds): string\n\t{\n\t\tconst format = (value) => (value ?? 0).toString().padStart(2, '0');\n\n\t\treturn Loc.getMessage('TIMEMAN_WORK_TIME_BUTTON_TEXT_WORKING')\n\t\t\t.replace('#time#', `${format(hours)}:${format(minutes)}:${format(seconds)}`);\n\t}\n}\n"],"names":["State","Object","freeze","Closed","Opened","Paused","Expired","Action","Open","Reopen","WorkTimeButton","settings","Extension","getSettings","workReport","get","info","siteId","Button","size","Size","MEDIUM","text","icon","useAirDesign","style","noCaps","wide","events","click","bind","className","render","EventEmitter","subscribe","window","BX","timeman","STATE","CAN_OPEN","INFO","DATE_START","TIME_LEAKS","BXTIMEMAN","initFormWeekly","baseEvent","getCompatData","data","setText","setIcon","setStyle","button","event","stopPropagation","setBindOptions","node","mode","popupOptions","autoHide","angle","offsetTop","closeByEsc","bindOptions","forceBindPosition","forceTop","forceLeft","onClose","onDestroy","Loc","getMessage","ButtonIcon","START","REFRESH","ALERT","AirButtonStyle","TINTED","FILLED","TINTED_ALERT","setInterval","clearInterval","nowSeconds","Math","floor","Date","now","workingSeconds","hours","minutes","seconds","format","value","toString","padStart","replace"],"mappings":"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"}