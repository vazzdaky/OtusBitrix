{"version":3,"file":"security.bundle.js","sources":["../src/security.js"],"sourcesContent":["import {Dom, Event, Type} from 'main.core';\n\nexport class Security\n{\n\tconstructor(params = {})\n\t{\n\t\tthis.signedParameters = params.signedParameters;\n\t\tthis.componentName = params.componentName;\n\t\tthis.loader = null;\n\t\tthis.container = params.contentContainer;\n\t\tthis.userId = params.userId;\n\t\tthis.currentPage = params.currentPage;\n\t\tthis.menuContainer = params.menuContainer;\n\n\t\tthis.changeContent(this.currentPage);\n\n\t\tif (Type.isDomNode(this.menuContainer))\n\t\t{\n\t\t\tthis.menuItems = this.menuContainer.querySelectorAll(\"a\");\n\n\t\t\t(this.menuItems || []).forEach((item) => {\n\t\t\t\tEvent.bind(item, 'click', () => {\n\t\t\t\t\tthis.changeContent(item.getAttribute('data-action'));\n\t\t\t\t});\n\t\t\t});\n\t\t}\n\n\t\tBX.addCustomEvent('BX.Security.UserOtpInit:afterOtpSetup', function(event) {\n\t\t\tthis.showOtpConnectedComponent();\n\t\t}.bind(this));\n\t}\n\n\tchangeContent(action)\n\t{\n\t\tif (!action)\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tswitch (action)\n\t\t{\n\t\t\tcase \"auth\":\n\t\t\tcase \"otpConnected\":\n\t\t\tcase \"socnetEmail\":\n\t\t\t\tconst requestData = {\n\t\t\t\t\tuserId: this.userId\n\t\t\t\t};\n\t\t\t\tthis.sendAction(action, requestData);\n\t\t\t\tbreak;\n\n\t\t\tcase \"otp\":\n\t\t\tcase \"appPasswords\":\n\t\t\tcase \"synchronize\":\n\t\t\tcase \"mailingAgreement\":\n\t\t\tcase \"sso\":\n\t\t\t\tthis.sendAction(action, {});\n\t\t\t\tbreak;\n\n\t\t\tcase \"recoveryCodes\":\n\t\t\t\tthis.showRecoveryCodesComponent();\n\t\t\t\tbreak;\n\n\t\t\tcase \"socserv\":\n\t\t\t\tthis.showSocservComponent();\n\t\t\t\tbreak;\n\t\t}\n\t}\n\n\tclearHtml()\n\t{\n\t\tBX.html(this.container, \"\");\n\t\tconst uiButtons = document.getElementsByClassName(\"ui-entity-wrap\");\n\t\tif (uiButtons && uiButtons[0])\n\t\t{\n\t\t\tDom.remove(uiButtons[0]);\n\t\t}\n\t}\n\n\tsendAction(action, requestData)\n\t{\n\t\tthis.clearHtml();\n\t\tthis.loader = this.showLoader({node: this.container, loader: null, size: 100});\n\n\t\tBX.ajax.runComponentAction(this.componentName, action, {\n\t\t\tsignedParameters: this.signedParameters,\n\t\t\tmode: 'ajax',\n\t\t\tdata: requestData\n\t\t}).then(function (response) {\n\t\t\tthis.showComponentData(response, action);\n\t\t}.bind(this), function (response) {\n\t\t\tthis.showErrorPopup(response[\"errors\"][0].message);\n\t\t\tthis.hideLoader({loader: this.loader});\n\t\t}.bind(this));\n\t}\n\n\tshowOtpComponent()\n\t{\n\t\tthis.changeContent(\"otp\");\n\t}\n\n\tshowOtpConnectedComponent()\n\t{\n\t\tthis.changeContent(\"otpConnected\");\n\t}\n\n\tshowRecoveryCodesComponent(componentMode)\n\t{\n\t\tif (!componentMode)\n\t\t{\n\t\t\tcomponentMode = \"\";\n\t\t}\n\n\t\tthis.sendAction(\"recoveryCodes\", {componentMode: componentMode});\n\t}\n\n\tshowSocservComponent()\n\t{\n\t\tthis.clearHtml();\n\t\tconst socServNode = document.querySelector(\"[data-action='socserv']\");\n\t\tif (BX.type.isDomNode(socServNode))\n\t\t{\n\t\t\tconst url = BX.data(socServNode, 'url');\n\t\t\tif (top.BX.SidePanel.Instance.open(url, {\n\t\t\t\t'cacheable': false,\n\t\t\t\t'width': 840\n\t\t\t}))\n\t\t\t{\n\t\t\t\ttop.BX.addCustomEvent(top.BX.SidePanel.Instance.getSlider(url), \"SidePanel.Slider:onClose\", BX.proxy(function () {\n\t\t\t\t\tconst authNode = document.querySelector(\"[data-action='auth']\");\n\t\t\t\t\tif (BX.type.isDomNode(authNode))\n\t\t\t\t\t{\n\t\t\t\t\t\tauthNode.click();\n\t\t\t\t\t}\n\t\t\t\t}, this));\n\t\t\t}\n\t\t}\n\t}\n\n\tshowComponentData(result, pageName)\n\t{\n\t\tconst errors = BX.prop.getArray(result, \"errors\", []);\n\t\tif (errors.length > 0)\n\t\t{\n\t\t\tthis.showErrorPopup(result[\"errors\"][0].message);\n\t\t\treturn;\n\t\t}\n\n\t\tif (!result.data)\n\t\t{\n\t\t\tthis.showErrorPopup(\"Unknown error\");\n\t\t\tthis.hideLoader({loader: this.loader});\n\t\t\treturn;\n\t\t}\n\n\t\tconst promise = new Promise(BX.delegate(function(resolve, reject) {\n\t\t\tif (result.data.hasOwnProperty(\"assets\") && result.data.assets['css'].length)\n\t\t\t{\n\t\t\t\tBX.load(result.data.assets['css'], function () {\n\t\t\t\t\tif (result.data.assets['js'].length)\n\t\t\t\t\t{\n\t\t\t\t\t\tBX.load(result.data.assets['js'], function () {\n\t\t\t\t\t\t\tif (result.data.assets['string'].length)\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\tfor (var i = 0; i < result.data.assets['string'].length; i++)\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\tBX.html(null, result.data.assets['string'][i]);\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\tresolve();\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t}\n\t\t}, this));\n\n\t\tpromise.then(\n\t\t\tBX.delegate(function(){\n\t\t\t\tconst html = BX.prop.getString(result.data, \"html\", '');\n\t\t\t\tBX.html(this.container, html);\n\n\t\t\t\tconst pageTitle = BX.prop.getString(BX.prop.getObject(result.data, \"additionalParams\", ''), \"pageTitle\", \"\");\n\t\t\t\tBX.html(BX(\"pagetitle\"), pageTitle);\n\n\t\t\t\ttop.history.pushState(null, \"\", \"?page=\" + pageName);\n\t\t\t},this)\n\t\t);\n\t}\n\n\tshowLoader(params)\n\t{\n\t\tlet loader = null;\n\n\t\tif (params.node)\n\t\t{\n\t\t\tif (params.loader === null)\n\t\t\t{\n\t\t\t\tloader = new BX.Loader({\n\t\t\t\t\ttarget: params.node,\n\t\t\t\t\tsize: params.hasOwnProperty(\"size\") ? params.size : 40\n\t\t\t\t});\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tloader = params.loader;\n\t\t\t}\n\n\t\t\tloader.show();\n\t\t}\n\n\t\treturn loader;\n\t}\n\n\thideLoader(params)\n\t{\n\t\tif (params.loader !== null)\n\t\t{\n\t\t\tparams.loader.hide();\n\t\t}\n\n\t\tif (params.node)\n\t\t{\n\t\t\tDom.clean(params.node);\n\t\t}\n\n\t\tif (params.loader !== null)\n\t\t{\n\t\t\tparams.loader = null;\n\t\t}\n\t}\n\n\tshowErrorPopup(error)\n\t{\n\t\tif (!error)\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tBX.PopupWindowManager.create({\n\t\t\tid: \"intranet-user-profile-error-popup\",\n\t\t\tcontent:\n\t\t\t\tBX.create(\"div\", {\n\t\t\t\t\tprops : {\n\t\t\t\t\t\tstyle : \"max-width: 450px\"\n\t\t\t\t\t},\n\t\t\t\t\thtml: BX.util.htmlspecialchars(error)\n\t\t\t\t}),\n\t\t\tcloseIcon : true,\n\t\t\tlightShadow : true,\n\t\t\toffsetLeft : 100,\n\t\t\toverlay : false,\n\t\t\tcontentPadding: 10\n\t\t}).show();\n\t}\n}"],"names":["Security","constructor","params","signedParameters","componentName","loader","container","contentContainer","userId","currentPage","menuContainer","changeContent","Type","isDomNode","menuItems","querySelectorAll","forEach","item","Event","bind","getAttribute","BX","addCustomEvent","event","showOtpConnectedComponent","action","requestData","sendAction","showRecoveryCodesComponent","showSocservComponent","clearHtml","html","uiButtons","document","getElementsByClassName","Dom","remove","showLoader","node","size","ajax","runComponentAction","mode","data","then","response","showComponentData","showErrorPopup","message","hideLoader","showOtpComponent","componentMode","socServNode","querySelector","type","url","top","SidePanel","Instance","open","getSlider","proxy","authNode","click","result","pageName","errors","prop","getArray","length","promise","Promise","delegate","resolve","reject","hasOwnProperty","assets","load","i","getString","pageTitle","getObject","history","pushState","Loader","target","show","hide","clean","error","PopupWindowManager","create","id","content","props","style","util","htmlspecialchars","closeIcon","lightShadow","offsetLeft","overlay","contentPadding"],"mappings":"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"}