this.BX=this.BX||{};this.BX.Intranet=this.BX.Intranet||{};(function(e,t,n,i,s,o){"use strict";let a=e=>e,r,l;class p{constructor(e){this.parent=e;this.signedParameters=this.parent.signedParameters;this.componentName=this.parent.componentName;this.userInnerBlockNode=this.parent.userInnerBlockNode||"";this.timemanNode=this.parent.timemanNode;this.circleNode=this.parent.circleNode||"";this.isPopupShown=false;this.popupCurrentPage={};this.renderedUsers=[];i.Event.bind(this.userInnerBlockNode,"click",(()=>{this.showPopup("getAllOnlineUser",this.userInnerBlockNode)}));i.Event.bind(this.circleNode,"click",(()=>{this.showPopup("getAllOnlineUser",this.circleNode,-5)}));if(this.parent.isTimemanAvailable&&i.Type.isDomNode(this.parent.timemanNode)){let e=this.timemanNode.querySelector(".js-ustat-online-timeman-opened-block");let t=this.timemanNode.querySelector(".js-ustat-online-timeman-closed-block");i.Event.bind(e,"click",(()=>{this.showPopup("getOpenedTimemanUser",e)}));i.Event.bind(t,"click",(()=>{this.showPopup("getClosedTimemanUser",t)}))}}getPopupTitle(e){let t="";if(e==="getAllOnlineUser"){t=i.Loc.getMessage("INTRANET_USTAT_ONLINE_USERS")}else if(e==="getOpenedTimemanUser"){t=i.Loc.getMessage("INTRANET_USTAT_ONLINE_STARTED_DAY")}else if(e==="getClosedTimemanUser"){t=i.Loc.getMessage("INTRANET_USTAT_ONLINE_FINISHED_DAY")}return t}showPopup(e,s,o){if(this.isPopupShown){return}if(i.Type.isUndefined(o)){o=7}this.popupCurrentPage[e]=1;this.popupInnerContainer="";this.renderedUsers=[];this.allOnlineUserPopup=new t.Popup(`intranet-ustat-online-popup-${i.Text.getRandom()}`,s,{lightShadow:true,offsetLeft:e==="getClosedTimemanUser"?-60:-22,offsetTop:o,autoHide:true,closeByEsc:true,bindOptions:{position:"bottom"},animationOptions:{show:{type:"opacity-transform"},close:{type:"opacity"}},events:{onPopupDestroy:()=>{this.isPopupShown=false},onPopupClose:()=>{this.allOnlineUserPopup.destroy()},onAfterPopupShow:t=>{n.EventEmitter.emit(n.EventEmitter.GLOBAL_TARGET,"BX.Intranet.UstatOnline:showPopup",new n.BaseEvent({data:{popup:t}}));let s=i.Tag.render(r||(r=a`
						<div>
							<span class="intranet-ustat-online-popup-name-title">
								${0}
							</span>
							<div class="intranet-ustat-online-popup-container">
								<div class="intranet-ustat-online-popup-content">
									<div class="intranet-ustat-online-popup-content-box">
										<div class="intranet-ustat-online-popup-inner"></div>
									</div>
								</div>
							</div>
						</div>
					`),this.getPopupTitle(e));t.contentContainer.appendChild(s);this.popupInnerContainer=s.querySelector(".intranet-ustat-online-popup-inner");this.loader=this.showLoader({node:s.querySelector(".intranet-ustat-online-popup-content"),loader:null,size:40});this.showUsersInPopup(e);this.isPopupShown=true},onPopupFirstShow:e=>{n.EventEmitter.subscribe(n.EventEmitter.GLOBAL_TARGET,"SidePanel.Slider:onOpenStart",(()=>{e.close()}))}},className:"intranet-ustat-online-popup"});this.popupScroll(e);this.allOnlineUserPopup.show()}popupScroll(e){if(!i.Type.isDomNode(this.popupInnerContainer)){return}i.Event.bind(this.popupInnerContainer,"scroll",(()=>{if(this.popupInnerContainer.scrollTop>(this.popupInnerContainer.scrollHeight-this.popupInnerContainer.offsetHeight)/1.5){this.showUsersInPopup(e);i.Event.unbindAll(this.popupInnerContainer,"scroll")}}))}showUsersInPopup(e){if(e!=="getAllOnlineUser"&&e!=="getOpenedTimemanUser"&&e!=="getClosedTimemanUser"){return}BX.ajax.runComponentAction(this.componentName,e,{signedParameters:this.signedParameters,mode:"class",data:{pageNum:this.popupCurrentPage[e]}}).then((t=>{if(t.data){this.renderPopupUsers(t.data);this.popupCurrentPage[e]++;this.popupScroll(e)}else{if(!this.popupInnerContainer.hasChildNodes()){this.popupInnerContainer.innerText=i.Loc.getMessage("INTRANET_USTAT_ONLINE_EMPTY")}}this.hideLoader({loader:this.loader})}),(e=>{this.hideLoader({loader:this.loader})}))}renderPopupUsers(e){if(!this.allOnlineUserPopup||!i.Type.isDomNode(this.popupInnerContainer)||!i.Type.isObjectLike(e)){return}for(let t in e){if(!e.hasOwnProperty(t)||this.renderedUsers.indexOf(e[t]["ID"])>=0){continue}this.renderedUsers.push(e[t]["ID"]);let n="<i></i>";if(i.Type.isString(e[t]["AVATAR"])&&e[t]["AVATAR"]){n=`<i style="background-image: url('${encodeURI(e[t]["AVATAR"])}')"></i>`}const s=i.Tag.render(l||(l=a`
				<a 
					class="intranet-ustat-online-popup-item"
					href="${0}" 
					target="_blank"
				>
					<span class="intranet-ustat-online-popup-avatar-new">
						<div class="ui-icon ui-icon-common-user intranet-ustat-online-popup-avatar-img">
							${0}
						</div>
						<span class="intranet-ustat-online-popup-avatar-status-icon"></span>
					</span>
					<span class="intranet-ustat-online-popup-name">
						${0}
					</span>
				</a>
			`),e[t]["PATH_TO_USER_PROFILE"],n,e[t]["NAME"]);this.popupInnerContainer.appendChild(s)}}showLoader(e){let t=null;if(e.node){if(e.loader===null){t=new BX.Loader({target:e.node,size:e.hasOwnProperty("size")?e.size:40})}else{t=e.loader}t.show()}return t}hideLoader(e){if(e.loader!==null){e.loader.hide()}if(e.node){i.Dom.clean(e.node)}if(e.loader!==null){e.loader=null}}}class h{constructor(e){this.parent=e;this.signedParameters=this.parent.signedParameters;this.componentName=this.parent.componentName;this.isTimemanAvailable=this.parent.isTimemanAvailable;this.timemanNode=this.parent.timemanNode;this.containerNode=this.parent.ustatOnlineContainerNode;if(this.isTimemanAvailable&&i.Type.isDomNode(this.timemanNode)){this.timemanValueNodes=this.timemanNode.querySelectorAll(".intranet-ustat-online-value");this.timemanTextNodes=this.timemanNode.querySelectorAll(".js-ustat-online-timeman-text");this.resizeTimemanText();this.subscribePullEvent()}}resizeTimemanText(){if(!i.Type.isDomNode(this.timemanNode)){return}let e=0;let t=0;if(i.Type.isArrayLike(this.timemanTextNodes)){for(let t of this.timemanTextNodes){let n=t.textContent.length;e+=n}}if(i.Type.isArrayLike(this.timemanValueNodes)){for(let e of this.timemanValueNodes){let n=e.textContent.length;t+=n}}if(e>=17&&t>=6||e>=19&&t>=4){i.Dom.addClass(this.timemanNode,"intranet-ustat-online-info-text-resize")}else{i.Dom.removeClass(this.timemanNode,"intranet-ustat-online-info-text-resize")}}redrawTimeman(e){if(e.hasOwnProperty("OPENED")){let t=this.containerNode.querySelector(".js-ustat-online-timeman-opened");if(i.Type.isDomNode(t)){t.innerHTML=e["OPENED"]}}if(e.hasOwnProperty("CLOSED")){let t=this.containerNode.querySelector(".js-ustat-online-timeman-closed");if(i.Type.isDomNode(t)){t.innerHTML=e["CLOSED"]}}this.resizeTimemanText()}checkTimeman(){BX.ajax.runComponentAction(this.componentName,"checkTimeman",{signedParameters:this.signedParameters,mode:"class"}).then((e=>{if(e.data){this.redrawTimeman(e.data)}}))}subscribePullEvent(){s.PULL.subscribe({moduleId:"intranet",command:"timemanDayInfo",callback:e=>{this.redrawTimeman(e)}})}}const u=i.Reflection.namespace("BX.Intranet");class d{constructor(e){this.signedParameters=e.signedParameters;this.componentName=e.componentName;this.ustatOnlineContainerNode=e.ustatOnlineContainerNode||"";this.maxOnlineUserCountToday=parseInt(e.maxOnlineUserCountToday,10);this.isTimemanAvailable=e.isTimemanAvailable==="Y";if(!i.Type.isDomNode(this.ustatOnlineContainerNode)){return}this.userInnerBlockNode=this.ustatOnlineContainerNode.querySelector(".intranet-ustat-online-icon-inner");this.circleNode=this.ustatOnlineContainerNode.querySelector(".ui-graph-circle");this.timemanNode=this.ustatOnlineContainerNode.querySelector(".intranet-ustat-online-info");this.users=e.users;this.counter=parseInt(e.user_count,10);this.currentDate=this.getToday();if(i.Type.isDomNode(this.ustatOnlineContainerNode)){BX.UI.Hint.init(this.ustatOnlineContainerNode)}new p(this);this.timemanObj=new h(this);this.redrawOnline();setInterval((()=>{this.checkNewDay()}),36e5)}getToday(){const e=new Date;return new Date(e.getFullYear(),e.getMonth(),e.getDate()).valueOf()}checkNewDay(){const e=this.getToday();if(this.currentDate<e){if(this.isTimemanAvailable){this.timemanObj.checkTimeman()}this.currentDate=e;return true}return false}isDocumentVisible(){return document.visibilityState==="visible"}redrawOnline(){this.showCircleAnimation(this.circleNode,this.counter);this.renderAllUser()}renderAllUser(){for(const e in this.users){this.renderUser(this.users[e])}}renderUser(e){let t="";if(e.avatar){t=`background-image: url("${encodeURI(e.avatar)}");`}const n=`\n\t\t\tui-icon ui-icon-common-user intranet-ustat-online-icon js-ustat-online-user\n\t\t\t\t\t\t${this.isDocumentVisible()?" intranet-ustat-online-icon-show":""}\n\t\t`;this.userItem=BX.create("span",{attrs:{className:n,"data-user-id":e.id},style:{zIndex:this.userIndex},children:[BX.create("i",{attrs:{style:t}})]});i.Dom.prepend(this.userItem,this.userInnerBlockNode)}showCircleAnimation(e,t){if(t<=0){t=1}const n=t*100/this.maxOnlineUserCountToday;if(this.circle){this.circle.updateCounter(n,t)}else{this.circle=new o.Circle(e,68,n,t,true);this.circle.show()}}}u.UstatOnline=d;e.UstatOnline=d})(this.BX.Intranet.UstatOnline=this.BX.Intranet.UstatOnline||{},BX.Main,BX.Event,BX,BX,BX.UI.Graph);
//# sourceMappingURL=script.map.js