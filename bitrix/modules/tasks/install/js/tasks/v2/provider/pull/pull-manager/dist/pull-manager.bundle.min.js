this.BX=this.BX||{};this.BX.Tasks=this.BX.Tasks||{};this.BX.Tasks.V2=this.BX.Tasks.V2||{};this.BX.Tasks.V2.Provider=this.BX.Tasks.V2.Provider||{};(function(e,s,a,t,l,r,i,o,d,n){"use strict";class c{constructor(){if(new.target===c){throw new TypeError("BasePullHandler: An abstract class cannot be instantiated")}}getMap(){return{}}getDelayedMap(){return{}}}function b({AFTER:e,TASK_ID:s}){var a;const t={id:s,title:p(e.TITLE),isImportant:p(e.PRIORITY,e.PRIORITY===2),creatorId:p(e.CREATED_BY),responsibleId:p(e.RESPONSIBLE_ID),deadlineTs:p(e.DEADLINE,e.DEADLINE*1e3),checklist:undefined,groupId:p(e.GROUP_ID),stageId:p(e.STAGE,(a=e.STAGE_INFO)==null?void 0:a.id),flowId:p(e.FLOW_ID),status:p(e.STATUS,u(e.STATUS)),statusChangedTs:p(e.STATUS,Date.now()),accomplicesIds:p(e.ACCOMPLICES,v(e.ACCOMPLICES)),auditorsIds:p(e.AUDITORS,v(e.AUDITORS))};return Object.fromEntries(Object.entries(t).filter((([,e])=>!d.Type.isUndefined(e))))}function u(e){var s;return(s={2:n.TaskStatus.Pending,3:n.TaskStatus.InProgress,4:n.TaskStatus.SupposedlyCompleted,5:n.TaskStatus.Completed,6:n.TaskStatus.Deferred}[e])!=null?s:n.TaskStatus.Pending}function v(e){if(!e){return[]}return e.split(",").map((e=>Number(e)))}function p(e,s=e){return d.Type.isUndefined(e)?undefined:s}var P=babelHelpers.classPrivateFieldLooseKey("handleTaskAdded");var f=babelHelpers.classPrivateFieldLooseKey("handleTaskUpdated");var h=babelHelpers.classPrivateFieldLooseKey("handleTaskUpdatedDelayed");var F=babelHelpers.classPrivateFieldLooseKey("handleTaskViewed");var y=babelHelpers.classPrivateFieldLooseKey("handleTaskDeleted");var L=babelHelpers.classPrivateFieldLooseKey("handleDefaultDeadlineChanged");var T=babelHelpers.classPrivateFieldLooseKey("upsertStage");var B=babelHelpers.classPrivateFieldLooseKey("loadTask");var I=babelHelpers.classPrivateFieldLooseKey("needToLoadTask");var H=babelHelpers.classPrivateFieldLooseKey("loadGroup");var S=babelHelpers.classPrivateFieldLooseKey("needToLoadGroup");var g=babelHelpers.classPrivateFieldLooseKey("loadFlow");var O=babelHelpers.classPrivateFieldLooseKey("needToLoadFlow");var D=babelHelpers.classPrivateFieldLooseKey("loadUsers");var k=babelHelpers.classPrivateFieldLooseKey("needToLoadUsers");var E=babelHelpers.classPrivateFieldLooseKey("getUsersIds");var m=babelHelpers.classPrivateFieldLooseKey("loadRights");var w=babelHelpers.classPrivateFieldLooseKey("currentUserId");class K extends c{constructor(...e){super(...e);Object.defineProperty(this,w,{get:G,set:void 0});Object.defineProperty(this,m,{value:N});Object.defineProperty(this,E,{value:$});Object.defineProperty(this,k,{value:V});Object.defineProperty(this,D,{value:C});Object.defineProperty(this,O,{value:X});Object.defineProperty(this,g,{value:U});Object.defineProperty(this,S,{value:M});Object.defineProperty(this,H,{value:R});Object.defineProperty(this,I,{value:A});Object.defineProperty(this,B,{value:_});Object.defineProperty(this,T,{value:j});Object.defineProperty(this,P,{writable:true,value:e=>{const s=t.Core.getParams().features;const a=e.AFTER.USER_ID===babelHelpers.classPrivateFieldLooseBase(this,w)[w]&&s.isMiniformEnabled&&!s.isV2Enabled;if(a){var l;const s=(l=e.AFTER.URL)!=null?l:"";BX.UI.Notification.Center.notify({id:d.Text.getRandom(),content:d.Loc.getMessage("TASKS_V2_NOTIFY_TASK_CREATED"),actions:[{title:d.Loc.getMessage("TASKS_V2_NOTIFY_TASK_DO_VIEW"),events:{click:(e,a)=>{a.close();BX.SidePanel.Instance.open(s)}}}]})}}});Object.defineProperty(this,f,{writable:true,value:e=>{if(e.USER_ID===babelHelpers.classPrivateFieldLooseBase(this,w)[w]){return}babelHelpers.classPrivateFieldLooseBase(this,T)[T](e.AFTER.STAGE_INFO)}});Object.defineProperty(this,h,{writable:true,value:async e=>{if(e.USER_ID===babelHelpers.classPrivateFieldLooseBase(this,w)[w]){return}const s=b(e);if(babelHelpers.classPrivateFieldLooseBase(this,I)[I](e)){void babelHelpers.classPrivateFieldLooseBase(this,B)[B](s)}else{await Promise.all([babelHelpers.classPrivateFieldLooseBase(this,H)[H](s),babelHelpers.classPrivateFieldLooseBase(this,g)[g](s),babelHelpers.classPrivateFieldLooseBase(this,D)[D](s),babelHelpers.classPrivateFieldLooseBase(this,m)[m](s)]);const{id:e,...a}=s;void this.$store.dispatch(`${n.Model.Tasks}/update`,{id:e,fields:a})}}});Object.defineProperty(this,F,{writable:true,value:e=>{}});Object.defineProperty(this,y,{writable:true,value:e=>{a.EventEmitter.emit(n.EventName.CloseFullCard);void this.$store.dispatch(`${n.Model.Tasks}/delete`,e.TASK_ID)}});Object.defineProperty(this,L,{writable:true,value:e=>{void this.$store.dispatch(`${n.Model.Interface}/updateDefaultDeadline`,{defaultDeadlineDate:e.defaultDeadlineDate,defaultDeadlineInSeconds:e.deadline})}})}getMap(){return{task_add:babelHelpers.classPrivateFieldLooseBase(this,P)[P],task_update:babelHelpers.classPrivateFieldLooseBase(this,f)[f],task_view:babelHelpers.classPrivateFieldLooseBase(this,F)[F],task_remove:babelHelpers.classPrivateFieldLooseBase(this,y)[y],default_deadline_changed:babelHelpers.classPrivateFieldLooseBase(this,L)[L]}}getDelayedMap(){return{task_update:babelHelpers.classPrivateFieldLooseBase(this,h)[h]}}get $store(){return t.Core.getStore()}}function j(e){if(e){const s=r.GroupMappers.mapStageDtoToModel(e);void this.$store.dispatch(`${n.Model.Stages}/upsert`,s)}}function _(e){void l.taskService.getById(e.id)}function A(e){const s=new Set(["DESCRIPTION","UF_TASK_WEBDAV_FILES"]);return Object.keys(e.AFTER).some((e=>s.has(e)))}async function R(e){if(babelHelpers.classPrivateFieldLooseBase(this,S)[S](e)){await r.groupService.getGroup(e.groupId)}}function M(e){if(babelHelpers.classPrivateFieldLooseBase(this,O)[O](e)){return false}return e.groupId&&!this.$store.getters[`${n.Model.Groups}/getById`](e.groupId)}async function U(e){if(babelHelpers.classPrivateFieldLooseBase(this,O)[O](e)){await i.flowService.getFlow(e.flowId)}}function X(e){return Boolean(e.flowId)&&!this.$store.getters[`${n.Model.Flows}/getById`](e.flowId)}async function C(e){if(babelHelpers.classPrivateFieldLooseBase(this,k)[k](e)){await o.userService.list(babelHelpers.classPrivateFieldLooseBase(this,E)[E](e))}}function V(e){return!o.userService.hasUsers(babelHelpers.classPrivateFieldLooseBase(this,E)[E](e))}function $(e){var s,a;return[e.creatorId,e.responsibleId,...(s=e.accomplicesIds)!=null?s:[],...(a=e.auditorsIds)!=null?a:[]].filter((e=>e))}async function N(e){await l.taskService.getRights(e.id)}function G(){return this.$store.getters[`${n.Model.Interface}/currentUserId`]}var x=babelHelpers.classPrivateFieldLooseKey("params");var Q=babelHelpers.classPrivateFieldLooseKey("loadItemsDelay");var Y=babelHelpers.classPrivateFieldLooseKey("handlers");var W=babelHelpers.classPrivateFieldLooseKey("onBeforePull");var q=babelHelpers.classPrivateFieldLooseKey("onPull");var z=babelHelpers.classPrivateFieldLooseKey("onBeforeQueueExecute");var J=babelHelpers.classPrivateFieldLooseKey("onQueueExecute");var Z=babelHelpers.classPrivateFieldLooseKey("onReload");var ee=babelHelpers.classPrivateFieldLooseKey("executeQueue");class se{constructor(e){Object.defineProperty(this,ee,{value:oe});Object.defineProperty(this,Z,{value:ie});Object.defineProperty(this,J,{value:re});Object.defineProperty(this,z,{value:le});Object.defineProperty(this,q,{value:te});Object.defineProperty(this,W,{value:ae});Object.defineProperty(this,x,{writable:true,value:void 0});Object.defineProperty(this,Q,{writable:true,value:500});Object.defineProperty(this,Y,{writable:true,value:void 0});babelHelpers.classPrivateFieldLooseBase(this,x)[x]=e;babelHelpers.classPrivateFieldLooseBase(this,Y)[Y]=new Set([new K])}initQueueManager(){return new s.QueueManager({moduleId:n.Module.Tasks,userId:babelHelpers.classPrivateFieldLooseBase(this,x)[x].currentUserId,config:{loadItemsDelay:babelHelpers.classPrivateFieldLooseBase(this,Q)[Q]},additionalData:{},events:{onBeforePull:e=>{babelHelpers.classPrivateFieldLooseBase(this,W)[W](e)},onPull:e=>{babelHelpers.classPrivateFieldLooseBase(this,q)[q](e)}},callbacks:{onBeforeQueueExecute:e=>babelHelpers.classPrivateFieldLooseBase(this,z)[z](e),onQueueExecute:e=>babelHelpers.classPrivateFieldLooseBase(this,J)[J](e),onReload:()=>{babelHelpers.classPrivateFieldLooseBase(this,Z)[Z]()}}})}}function ae(e){const{pullData:{command:s,params:a}}=e.data;for(const e of babelHelpers.classPrivateFieldLooseBase(this,Y)[Y]){var t,l;(t=(l=e.getMap())[s])==null?void 0:t.call(l,a)}}function te(e){const{pullData:{command:s,params:a},promises:t}=e.data;for(const e of babelHelpers.classPrivateFieldLooseBase(this,Y)[Y]){if(e.getDelayedMap()[s]){var l;t.push(Promise.resolve({data:{id:(l=a.entityId)!=null?l:d.Text.getRandom(),command:s,params:a}}))}}}function le(e){return Promise.resolve()}async function re(e){await babelHelpers.classPrivateFieldLooseBase(this,ee)[ee](e)}function ie(e){}function oe(e){return new Promise((s=>{e.forEach((e=>{const{data:{command:s,params:a}}=e;for(const e of babelHelpers.classPrivateFieldLooseBase(this,Y)[Y]){var t,l;(t=(l=e.getDelayedMap())[s])==null?void 0:t.call(l,a)}}));s()}))}e.PullManager=se})(this.BX.Tasks.V2.Provider.Pull=this.BX.Tasks.V2.Provider.Pull||{},BX.Pull,BX.Event,BX.Tasks.V2,BX.Tasks.V2.Provider.Service,BX.Tasks.V2.Provider.Service,BX.Tasks.V2.Provider.Service,BX.Tasks.V2.Provider.Service,BX,BX.Tasks.V2.Const);
//# sourceMappingURL=pull-manager.bundle.map.js