"use strict";(function(){const e=function(){};const t={OfferToReceiveAudio:"true",OfferToReceiveVideo:"true"};const n=1e4;const i=3e4;const s=Object.freeze({decline:"call.Call.decline"});const o={negotiationNeeded:"Call::negotiationNeeded",connectionOffer:"Call::connectionOffer",connectionAnswer:"Call::connectionAnswer",iceCandidate:"Call::iceCandidate",voiceStarted:"Call::voiceStarted",voiceStopped:"Call::voiceStopped",microphoneState:"Call::microphoneState",cameraState:"Call::cameraState",videoPaused:"Call::videoPaused",hangup:"Call::hangup",userInviteTimeout:"Call::userInviteTimeout",repeatAnswer:"Call::repeatAnswer",usersInvited:"Call::usersInvited"};class a{constructor(e){this.uuid=e.uuid;this.instanceId=e.instanceId;this.parentUuid=e.parentUuid;this.direction=e.direction;this.associatedEntity=BX.type.isPlainObject(e.associatedEntity)?e.associatedEntity:{};this.connectionData=e.connectionData;this.scheme=e.scheme;this.userId=parseInt(env.userId,10);this.initiatorId=e.initiatorId||"";this.ready=false;this._joinStatus=BX.Call.JoinStatus.None;Object.defineProperty(this,"joinStatus",{get:this.getJoinStatus.bind(this),set:this.setJoinStatus.bind(this)});this._active=false;Object.defineProperty(this,"active",{get:this.getActive.bind(this),set:this.setActive.bind(this)});this.localStream=null;this.videoEnabled=Boolean(e.videoEnabled);this.muted=Boolean(e.muted);this.isCopilotActive=Boolean(e.isCopilotActive);this.peers={};this.signaling=new l({call:this});this.logToken=e.logToken||"";if(callEngine.getLogService()&&this.logToken){this.logger=new CallLogger(callEngine.getLogService(),this.logToken)}this.eventEmitter=new JNEventEmitter;e.events=e.events||{};if(e.events){for(let t in e.events){if(e.events.hasOwnProperty(t)){this.eventEmitter.on(t,e.events[t])}}}this._reconnectionEventCount=0;this._maxReconnectionAttempts=3;this.lastPingReceivedTimeout=null;this.waitForAnswerTimeout=null;this.created=new Date;this.__onCallDisconnectedHandler=this.__onCallDisconnected.bind(this);this.__onCallMessageReceivedHandler=this.__onCallMessageReceived.bind(this);this.__onCallEndpointAddedHandler=this.__onCallEndpointAdded.bind(this);this.__onCallReconnectingHandler=this.__onCallReconnecting.bind(this);this.__onCallReconnectedHandler=this.__onCallReconnected.bind(this);this.__onSDKLogMessageHandler=this.__onSDKLogMessage.bind(this)}get provider(){return BX.Call.Provider.Plain}get hasConnectionData(){return!!(this.connectionData.mediaServerUrl&&this.connectionData.roomData)}setConnectionData(e){this.connectionData=e}initPeers(){this.users.forEach((e=>{e=parseInt(e,10);this.peers[e]=this.createPeer(e)}))}reinitPeers(){for(const e in this.peers){if(this.peers.hasOwnProperty(e)&&this.peers[e]){this.peers[e].destroy();this.peers[e]=null}}this.initPeers()}inviteUsers(e={}){const t=e.users||[];if(t.length===0){}this.ready=true;this.getLocalMedia().then((()=>this.attachToConference())).then((()=>{if(!this.ready){this.#e();return}clearTimeout(this.waitForAnswerTimeout);this.waitForAnswerTimeout=setTimeout((()=>{this.__onNoAnswer()}),i);if(e.userData&&e.show){this.getSignaling.sendUsersInvited({users:e.userData})}if(t.length){return this.getSignaling().inviteUsers({userIds:t,video:this.videoEnabled?"Y":"N"})}})).then((e=>{for(let e=0;e<t.length;e++){let n=t[e];let i=this.getPeer(n);if(!i){i=this.createPeer(n);this.peers[n]=i}i.onInvited();this.joinStatus=BX.Call.JoinStatus.Local}}))}getConnectionData(){return true;return CallUtil.getCallConnectionDataById(this.uuid)}attachToConference(){return new Promise(((e,t)=>{if(this.plainCallJwt){return e()}const n={roomId:this.uuid,endpoint:this.connectionData.endpoint,token:this.connectionData.jwt};try{if(!this.ready){return}const n=BXClient.getInstance();n.on(BXClient.Events.LogMessage,this.__onSDKLogMessageHandler);try{if(typeof JNBXCameraManager.setResolutionConstraints==="function"){JNBXCameraManager.setResolutionConstraints(960,540)}if(!this.hasConnectionData){CallUtil.error("Signaling url is null");t({code:BX.Call.CallError.EmptySignalingUrl})}const e=this.getSignalingUrl(this.connectionData.mediaServerUrl,this.connectionData.roomData);const i={signalingUrl:e,callId:`${this.uuid}`,sendVideo:this.videoEnabled,receiveVideo:true,enableSimulcast:true,userName:this.userData,callBetaIosEnabled:callEngine.isCallBetaIosEnabled()};console.log("start plainCallJwt",i);this.plainCallJwt=n.startCall(i)}catch(e){CallUtil.error(e);return t(e)}if(!this.plainCallJwt){this.log("Error: could not create bitrix dev call");return t({code:"BITRIX_DEV_NO_CALL"})}this.bindCallEvents();const i=()=>{this.log("Call connected");this.plainCallJwt.off(JNBXCall.Events.Connected,i);this.plainCallJwt.off(JNBXCall.Events.Failed,s);this.plainCallJwt.on(JNBXCall.Events.Failed,this.__onCallDisconnectedHandler);this.plainCallJwt.sendAudio=!this.muted;this.signaling.sendMicrophoneState(!this.muted);this.signaling.sendCameraState(this.videoEnabled);if(this.videoAllowedFrom==BX.Call.UserMnemonic.none){this.signaling.sendHideAll()}else if(BX.type.isArray(this.videoAllowedFrom)){this.signaling.sendShowUsers(this.videoAllowedFrom)}e()};let s=(e,n)=>{this.log("Could not attach to conference",n);CallUtil.error("Could not attach to conference",n);if(this.plainCallJwt){this.plainCallJwt.off(JNBXCall.Events.Connected,i);this.plainCallJwt.off(JNBXCall.Events.Failed,s)}t(n)};this.plainCallJwt.on(JNBXCall.Events.Connected,i);this.plainCallJwt.on(JNBXCall.Events.Failed,s);this.plainCallJwt.start()}catch(e){this.onFatalError(e)}}))}getSignalingUrl(e,t){return e+"?auto_subscribe=1&sdk=js&version=1.6.7&protocol=8&roomData="+t}bindCallEvents(){this.plainCallJwt.on(JNBXCall.Events.EndpointAdded,this.__onCallEndpointAddedHandler);this.plainCallJwt.on(JNBXCall.Events.ReceiveMessage,this.__onCallMessageReceivedHandler);this.plainCallJwt.on(JNBXCall.Events.Reconnecting,this.__onCallReconnectingHandler);this.plainCallJwt.on(JNBXCall.Events.Reconnected,this.__onCallReconnectedHandler);this.plainCallJwt.on(JNBXCall.Events.Disconnected,this.__onCallDisconnectedHandler)}removeCallEvents(){if(this.plainCallJwt){this.plainCallJwt.off(JNBXCall.Events.EndpointAdded,this.__onCallEndpointAddedHandler);this.plainCallJwt.off(JNBXCall.Events.ReceiveMessage,this.__onCallMessageReceivedHandler);this.plainCallJwt.off(JNBXCall.Events.Reconnecting,this.__onCallReconnectingHandler);this.plainCallJwt.off(JNBXCall.Events.Reconnected,this.__onCallReconnectedHandler);this.plainCallJwt.off(JNBXCall.Events.Disconnected,this.__onCallDisconnectedHandler)}}createPeer(e){e=parseInt(e,10);return new r({call:this,userId:e,ready:e==this.userId,onStreamReceived:t=>{this.log("onStreamReceived; track kind: ",t.kind,"id: ",t.id);this.eventEmitter.emit(BX.Call.Event.onStreamReceived,[e,t])},onStreamRemoved:t=>{this.log("onStreamRemoved: ",t);this.eventEmitter.emit(BX.Call.Event.onStreamRemoved,[e])},onStateChanged:this._onPeerStateChanged.bind(this),onInviteTimeout:this._onPeerInviteTimeout.bind(this),onInitialState:e=>{this.eventEmitter.emit(BX.Call.Event.onUserFloorRequest,[e.userId,e.floorRequest]);this.eventEmitter.emit(BX.Call.Event.onUserMicrophoneState,[e.userId,e.microphoneState])},onHandRaised:e=>this.eventEmitter.emit(BX.Call.Event.onUserFloorRequest,[e.userId,e.isHandRaised]),onReconnecting:()=>{this.__onCallReconnecting()},onReconnected:()=>{this.__onCallReconnected()}})}getPeer(e){return this.peers[e]}getUsers(){let e={};for(let t in this.peers){const n=this.peers[t];e[n.userId]=n.calculatedState}return e}getJoinStatus(){return this._joinStatus}setJoinStatus(e){if(e==this._joinStatus){return}this._joinStatus=e;switch(this._joinStatus){case BX.Call.JoinStatus.Local:this.eventEmitter.emit(BX.Call.Event.onJoin,[{callUuid:this.uuid,local:true}]);break;case BX.Call.JoinStatus.Remote:this.eventEmitter.emit(BX.Call.Event.onJoin,[{callUuid:this.uuid,local:false}]);break;case BX.Call.JoinStatus.None:this.eventEmitter.emit(BX.Call.Event.onLeave,[{callUuid:this.uuid}]);break}}getActive(){return this._active}setActive(e){if(e===this._active){return}this._active=e;this.eventEmitter.emit(this.active?BX.Call.Event.onActive:BX.Call.Event.onInactive,[{callUuid:this.uuid}])}isVideoEnabled(){return this.videoEnabled}setVideoEnabled(e){e=e===true;if(this.videoEnabled==e){return}this.videoEnabled=e;if(this.videoEnabled){if(this.localStream?.getVideoTracks().length>0){MediaDevices.startCapture();this.eventEmitter.emit(BX.Call.Event.onLocalMediaReceived,[this.localStream]);this.replaceAllMedia()}else{this.getLocalMedia().then((()=>{this.replaceAllMedia()}))}}else{MediaDevices.stopCapture();this.eventEmitter.emit(BX.Call.Event.onLocalMediaStopped);this.replaceAllMedia()}this.signaling.sendCameraState(this.users,this.videoEnabled)}replaceAllMedia(){if(this.ready){for(let e in this.peers){const t=this.peers[e];t.replaceMedia()}}}setVideoPaused(e){if(this.videoPaused==e||!this.videoEnabled){return}this.videoPaused=e;this.log("call setVideoPaused "+this.videoPaused.toString());if(this.localStream&&this.localStream.getVideoTracks().length>0){this.localStream.getVideoTracks().forEach((e=>e.enabled=!this.videoPaused));this.signaling.sendVideoPaused(this.users,this.videoPaused)}}switchCamera(){if(!this.videoEnabled||!this.localStream){return}MediaDevices.switchVideoSource()}isFrontCameraUsed(){return MediaDevices.cameraDirection==="front"}setMuted(e){e=!!e;if(this.muted==e){return}this.muted=e;if(this.localStream){var t=this.localStream.getAudioTracks();if(t[0]){t[0].enabled=!this.muted}}this.signaling.sendMicrophoneState(this.users,!this.muted)}isMuted(){return this.muted}log(){let e=CallUtil.getLogMessage.apply(CallUtil,arguments);if(console&&callEngine.debugFlag){let e=["Call log ["+CallUtil.getTimeForLog()+"]: "];console.log.apply(this,e.concat(Array.prototype.slice.call(arguments)))}if(this.logger){this.logger.log(e)}}on(e,t){this.eventEmitter.on(e,t);return this}off(e,t){if(this.eventEmitter){this.eventEmitter.off(e,t)}return this}getSignaling(){return this.signaling}getLocalMedia(){return new Promise((e=>{MediaDevices.getUserMedia({audio:true,video:this.videoEnabled}).then((t=>{if(this.videoEnabled){this.eventEmitter.emit(BX.Call.Event.onLocalMediaReceived,[t])}if(!this.videoEnabled&&this.localStream){this.eventEmitter.emit(BX.Call.Event.onLocalMediaStopped)}this.localStream=t;e()}))}))}isReady(){return this.ready}sendLocalStream(e){let t=this.getPeer(e);if(!t){return}if(!t.isReady()){return}t.sendMedia()}answer(e){if(!BX.type.isPlainObject(e)){e={}}if(this.direction!==BX.Call.Direction.Incoming){throw new Error("Only incoming call could be answered")}this.ready=true;this.videoEnabled=e.useVideo===true;this.enableMicAutoParameters=e.enableMicAutoParameters!==false;return new Promise(((e,t)=>{if(this.joinStatus!=BX.Call.JoinStatus.None){return t(new CallJoinedElseWhereError)}this.getLocalMedia().then((()=>{this.joinStatus=BX.Call.JoinStatus.Local;return this.attachToConference()}),(e=>{this.#e();this.eventEmitter.emit(BX.Call.Event.onCallFailure,[e])})).then((()=>{if(!this.ready){this.#e();return}e()}))}))}addInvitedUsers(e){for(let t in e){const n=Number(t);if(n==this.userId){continue}let i=this.getPeer(n);if(i){if(i.calculatedState===BX.Call.UserState.Failed||i.calculatedState===BX.Call.UserState.Idle){i.onInvited()}}else{i=this.createPeer(n);this.peers[n]=i;i.onInvited()}if(!this.users.includes(n)){this.users.push(n)}this.eventEmitter.emit(BX.Call.Event.onUserInvited,[{userId:n,userData:{[n]:e[t]}}])}}isAnyoneParticipating(){return Oject.values(this.peers).some((e=>e.isParticipating()))}decline(e,t){this.ready=false;let n={callUuid:this.uuid,callInstanceId:this.instanceId};if(typeof e!="undefined"){n.code=e}if(typeof t!="undefined"){n.reason=t}callEngine.getRestClient().callMethod(s.decline,n).then((()=>this.destroy()))}hangup(){if(!this.ready){let e=new Error("Hangup in wrong state");this.log(e);return}let e=new Error;e.name="Call stack:";this.log("Hangup received \n"+e.stack);this.ready=false;this.connectionData={};return new Promise(((e,t)=>{for(let e in this.peers){const t=this.peers[e];t.disconnect()}this.#e();this.joinStatus=BX.Call.JoinStatus.None}))}repeatAnswerEvents(){this.signaling.sendRepeatAnswer({userId:this.userId})}runCallback(e,t){}_onPullEvent(e,t,n){let i={"Call::answer":this._onPullEventAnswer.bind(this),"Call::hangup":this._onPullEventHangup.bind(this),"Call::usersJoined":this._onPullEventUsersJoined.bind(this),"Call::usersInvited":this._onPullEventUsersInvited.bind(this),"Call::associatedEntityReplaced":this._onPullEventAssociatedEntityReplaced.bind(this),"Call::finish":this._onPullEventFinish.bind(this),[PullEvents.repeatAnswer]:this._onPullEventRepeatAnswer.bind(this)};if(i[e]){this.log("Signaling: "+e+"; Parameters: "+JSON.stringify(t));i[e].call(this,t)}}_onPullEventAnswer(e){let t=e.senderId;this.log("_onPullEventAnswer",t,this.userId);if(t==this.userId){return this._onPullEventAnswerSelf(e)}if(!this.ready){return}let n=this.getPeer(t);if(!n){return}n.setSignalingConnected(true);n.setReady(true);n.isLegacyMobile=e.isLegacyMobile===true;if(this.ready){n.sendMedia()}}_onPullEventAnswerSelf(e){if(e.callInstanceId===this.instanceId){return}this.log("Call was answered elsewhere");this.joinStatus=BX.Call.JoinStatus.Remote}_onPullEventHangup(e){let t=e.senderId;if(this.userId==t){if(this.instanceId!=e.callInstanceId){this.joinStatus=BX.Call.JoinStatus.None;this.eventEmitter.emit(BX.Call.Event.onHangup)}return}let n=this.getPeer(t);if(!n||n.endpoint){return}n.disconnect(e.code);n.setReady(false);if(e.code==603){n.setDeclined(true)}if(!this.isAnyoneParticipating()){this.hangup()}}_onPullEventNegotiationNeeded(e){console.log("_onPullEventNegotiationNeeded",e);if(!this.ready){return}let t=this.getPeer(e.senderId);if(!t){return}t.setReady(true);if(e.restart){t.reconnect()}else{t.onNegotiationNeeded()}}_onPullEventConnectionOffer=e=>{console.log("_onPullEventConnectionOffer",this.ready,e);if(!this.ready){return}let t=this.getPeer(e.senderId);if(!t){return}t.setReady(true);t.setUserAgent(e.userAgent);t.setConnectionOffer(e.connectionId,e.sdp,e.tracks)};_onPullEventConnectionAnswer=e=>{let t=this.getPeer(e.senderId);if(!this.ready){return}if(!t){return}let n=e.connectionId;t.setUserAgent(e.userAgent);t.setConnectionAnswer(n,e.sdp,e.tracks)};_onPullEventIceCandidate=e=>{if(!this.ready){return}let t=this.getPeer(e.senderId);let n;if(!t){return}try{n=e.candidates;for(var i=0;i<n.length;i++){t.addIceCandidate(e.connectionId,n[i])}}catch(e){this.log("Error parsing serialized candidate: ",e)}};_onPullEventVoiceStarted(e){}_onPullEventVoiceStopped(e){}_onPullEventMicrophoneState(e){this.eventEmitter.emit(BX.Call.Event.onUserMicrophoneState,[e.senderId,e.microphoneState])}_onPullEventVideoPaused(e){this.eventEmitter.emit(BX.Call.Event.onUserVideoPaused,[e.senderId,e.videoPaused])}_onPullEventUsersJoined(e){}_onPullEventUsersInvited(e){if(!this.ready){return}let t=e.users;this.addInvitedUsers(t)}_onPullEventUserInviteTimeout(e){this.log("__onPullEventUserInviteTimeout",e);var t=e.failedUserId;if(this.getPeer(t)){this.getPeer(t).onInviteTimeout(false)}}_onPullEventAssociatedEntityReplaced(e){}_onPullEventFinish(e){this.destroy()}_onPullEventRepeatAnswer(){if(this.ready){this.signaling.sendAnswer({userId:this.userId},true)}}_onPeerStateChanged(e){this.eventEmitter.emit(BX.Call.Event.onUserStateChanged,[e.userId,e.state,e.previousState,e.isLegacyMobile]);if(e.state==BX.Call.UserState.Failed||e.state==BX.Call.UserState.Unavailable){if(!this.isAnyoneParticipating()){this.hangup().then(this.destroy.bind(this)).catch((e=>{this.destroy()}))}}else if(e.state==BX.Call.UserState.Connected){this.signaling.sendMicrophoneState(e.userId,!this.muted);this.signaling.sendCameraState(e.userId,this.videoEnabled)}}_onPeerInviteTimeout(){}__onSDKLogMessage(e){if(this.logger){this.log(e)}}__onCallDisconnected(e){let t={};const n=e&&typeof e==="object"?e:{};const{headers:i}=n;if(i){t={...t,headers:i}}this.log("__onCallDisconnected",Object.keys(t).length?t:null);if(this.ready&&i.leaveInformation&&i.leaveInformation.reason!==BX.Call.CallError.SecurityKeyChanged){this.hangup(i.leaveInformation.code,i.leaveInformation.reason)}this.ready=false;this.muted=false;this.reinitPeers();if(i.leaveInformation?.reason!==BX.Call.CallError.SecurityKeyChanged){this.removeCallEvents();this.plainCallJwt=null;this.joinStatus=BX.Call.JoinStatus.None;return}if(i.leaveInformation?.reason===BX.Call.CallError.SecurityKeyChanged){this.onFatalError(i.leaveInformation.reason)}}__onCallReconnecting(){this._reconnectionEventCount++;this.eventEmitter.emit(BX.Call.Event.onReconnecting,[{reconnectionEventCount:this._reconnectionEventCount}]);CallUtil.getCallConnectionDataById(this.uuid).then((e=>{if(this.ready&&this.plainCallJwt){const t=this.getSignalingUrl(e.mediaServerUrl,e.roomData);this.plainCallJwt.updateSignalingUrl(t)}else{this.#e()}})).catch((()=>{if(this._reconnectionEventCount<=this._maxReconnectionAttempts){setTimeout((()=>{if(this.ready&&this.plainCallJwt){this.__onCallReconnecting()}else{this.#e()}}),5e3)}else{this.#e()}}))}__onCallReconnected(){this._reconnectionEventCount=0;this.eventEmitter.emit(BX.Call.Event.onReconnected)}onFatalError(e){if(e&&e.call){delete e.call}CallUtil.error("onFatalError",e);this.log("onFatalError",e);this.ready=false;this.muted=false;this.reinitPeers();if(typeof e==="string"){this.eventEmitter.emit(BX.Call.Event.onCallFailure,[e])}else if(e instanceof Error){this.eventEmitter.emit(BX.Call.Event.onCallFailure,[e.toString()])}else{this.eventEmitter.emit(BX.Call.Event.onCallFailure)}if(this.plainCallJwt){this.removeCallEvents();try{this.plainCallJwt.hangup({"X-Reason":"Fatal error","X-Error":typeof e==="string"?e:e.code||e.name})}catch{}this.plainCallJwt=null}}__onNoAnswer(){if(this.ready&&!this.isAnyoneParticipating()){this.destroy()}}__onCallEndpointAdded(e){clearTimeout(this.waitForAnswerTimeout);const t=typeof e.userDisplayName==="string"?e.userDisplayName:"";this.log(`__onCallEndpointAdded (${t})`);const n=()=>{const n=parseInt(t.slice(4));if(!this.peers[n]){this.peers[n]=this.createPeer(n)}this.peers[n].setEndpoint(e);this.eventEmitter.emit(BX.Call.Event.onUserJoined,[{userId:n,userData:{[n]:{name:e.userName,avatar_hr:e.avatarImage,avatar:e.avatarImage}}}]);this.peers[n].setSignalingConnected(true);this.peers[n].setReady(true);if(this.ready){this.peers[n].sendMedia()}};if(t.slice(0,4)=="user"){n()}else{e.on(JNBXEndpoint.Events.InfoUpdated,(()=>{const t=typeof e.userDisplayName==="string"?e.userDisplayName:"";this.log(`BitrixDev.EndpointEvents.InfoUpdated (${t})`,e);if(t.slice(0,4)=="user"){n()}}));this.log(`Unknown endpoint ${t}`)}}__onCallMessageReceived(e,t){let n;try{n=JSON.parse(t.message)}catch(e){this.log("Could not parse scenario message.",e);return}const i=n.eventName;console.log("__onCallMessageReceived",i);switch(i){case o.connectionOffer:{this._onPullEventConnectionOffer(n);break}case o.connectionAnswer:{this._onPullEventConnectionAnswer(n);break}case o.negotiationNeeded:{this._onPullEventNegotiationNeeded(n);break}case o.iceCandidate:{this._onPullEventIceCandidate(n);break}case o.voiceStarted:{this.eventEmitter.emit(BX.Call.Event.onUserVoiceStarted,[n.senderId]);break}case o.voiceStopped:{this.eventEmitter.emit(BX.Call.Event.onUserVoiceStopped,[n.senderId]);break}case o.microphoneState:{this.eventEmitter.emit(BX.Call.Event.onUserMicrophoneState,[n.senderId,n.microphoneState==="Y"]);break}case o.screenState:{this.eventEmitter.emit(BX.Call.Event.onUserScreenState,[n.senderId,n.screenState==="Y"]);break}case o.videoPaused:{this._onPullEventVideoPaused(n);break}case o.floorRequest:{this.eventEmitter.emit(BX.Call.Event.onUserFloorRequest,[n.senderId,n.requestActive==="Y"]);break}case o.emotion:{this.eventEmitter.emit(BX.Call.Event.onUserEmotion,[n.senderId,n.toUserId,n.emotion]);break}case"scenarioLogUrl":{CallUtil.warn(`scenario log url: ${n.logUrl}`);break}default:{this.log(`Unknown scenario event ${i}`)}}}#e(){this.removeCallEvents();if(this.plainCallJwt){this.plainCallJwt.hangup();this.plainCallJwt=null}this.unsubscribeHardwareChanges();for(let e in this.localStreams){if(this.localStreams[e]){Util.stopMediaStream(this.localStreams[e]);this.localStreams[e]=null}}if(this.prevMainStream){Util.stopMediaStream(this.prevMainStream);this.prevMainStream=null}if(this.voiceDetection){this.voiceDetection.destroy();this.voiceDetection=null}window.removeEventListener("unload",this._onUnloadHandler);clearInterval(this.statsInterval);clearInterval(this.microphoneLevelInterval)}destroy(){this.ready=null;this._active=false;this._joinStatus=BX.Call.JoinStatus.None;for(let e in this.peers){const t=this.peers[e];t.disconnect()}if(this.localStream){MediaDevices.stopStreaming();this.localStream=null}if(this.logger){this.logger.destroy();this.logger=null}clearTimeout(this.reinviteTimeout);clearTimeout(this.lastPingReceivedTimeout);this.eventEmitter.emit(BX.Call.Event.onDestroy,[{callUuid:this.uuid}]);this.eventEmitter=null;if(this.signaling){this.signaling.call=null;this.signaling=null}}}class r{constructor(t={}){this.userId=t.userId;this.ready=!!t.ready;this.calling=false;this.inviteTimeout=false;this.declined=false;this.busy=false;this.videoSender=null;this.audioSender=null;this.call=t.call;this.userAgent="";this.isLegacyMobile=!!t.isLegacyMobile;this.peerConnection=null;this.pendingIceCandidates={};this.localIceCandidates=[];this.trackList={};this._incomingVideoTrack=null;this._incomingScreenTrack=null;Object.defineProperty(this,"incomingVideoTrack",{get:()=>this._incomingVideoTrack,set:e=>{if(this._incomingVideoTrack!=e){this._incomingVideoTrack=e;if(this._incomingScreenTrack){}else{if(this._incomingVideoTrack){this.callbacks.onStreamReceived(this._incomingVideoTrack)}else{this.callbacks.onStreamRemoved()}}}}});Object.defineProperty(this,"incomingScreenTrack",{get:()=>this._incomingScreenTrack,set:e=>{if(this._incomingScreenTrack!=e){this._incomingScreenTrack=e;if(this._incomingScreenTrack){this.callbacks.onStreamReceived(e)}else{if(this._incomingVideoTrack){this.callbacks.onStreamReceived(this._incomingVideoTrack)}else{this.callbacks.onStreamRemoved()}}}}});this.callbacks={onStateChanged:BX.type.isFunction(t.onStateChanged)?t.onStateChanged:e,onInviteTimeout:BX.type.isFunction(t.onInviteTimeout)?t.onInviteTimeout:e,onStreamReceived:BX.type.isFunction(t.onStreamReceived)?t.onStreamReceived:e,onStreamRemoved:BX.type.isFunction(t.onStreamRemoved)?t.onStreamRemoved:e,onRTCStatsReceived:BX.type.isFunction(t.onRTCStatsReceived)?t.onRTCStatsReceived:e,onReconnecting:BX.type.isFunction(t.onReconnecting)?t.onReconnecting:e,onReconnected:BX.type.isFunction(t.onReconnected)?t.onReconnected:e,onInitialState:BX.type.isFunction(t.onInitialState)?t.onInitialState:BX.DoNothing,onHandRaised:BX.type.isFunction(t.onHandRaised)?t.onHandRaised:BX.DoNothing};this._onPeerConnectionIceCandidateHandler=this._onPeerConnectionIceCandidate.bind(this);this._onPeerConnectionIceConnectionStateChangeHandler=this._onPeerConnectionIceConnectionStateChange.bind(this);this._onPeerConnectionIceGatheringStateChangeHandler=this._onPeerConnectionIceGatheringStateChange.bind(this);this._onPeerConnectionNegotiationNeededHandler=this._onPeerConnectionNegotiationNeeded.bind(this);this._onPeerConnectionTrackHandler=this._onPeerConnectionTrack.bind(this);this._onPeerConnectionRemoveTrackHandler=this._onPeerConnectionRemoveTrack.bind(this);this._onPeerConnectionAddStreamHandler=this._onPeerConnectionAddStream.bind(this);this._onPeerConnectionRemoveStreamHandler=this._onPeerConnectionRemoveStream.bind(this);this._onPeerConnectionSignalingStateChangeHandler=CallUtil.debounce(this._onPeerConnectionSignalingStateChange.bind(this),100);this.answerTimeout=null;this.callingTimeout=null;this.connectionTimeout=null;this.signalingConnectionTimeout=null;this.candidatesTimeout=null;this.__onEndpointRemovedHandler=this.__onEndpointRemoved.bind(this);this.__onEndpointHandRaisedHandler=this.__onEndpointHandRaised.bind(this);this.connectionAttempt=0}setReady(e){if(this.ready==e){return}this.ready=e;if(this.ready){this.declined=false;this.busy=false}if(this.calling){clearTimeout(this.callingTimeout);this.calling=false}this.updateCalculatedState()}setDeclined(e){this.declined=e;if(this.calling){clearTimeout(this.callingTimeout);this.calling=false}this.updateCalculatedState()}onInvited(){this.ready=false;this.inviteTimeout=false;this.declined=false;this.calling=true;if(this.callingTimeout){clearTimeout(this.callingTimeout)}this.callingTimeout=setTimeout((()=>this.onInviteTimeout(true)),i);this.updateCalculatedState()}onInviteTimeout(e){clearTimeout(this.callingTimeout);this.calling=false;this.inviteTimeout=true;if(e){this.callbacks.onInviteTimeout({userId:this.userId})}this.updateCalculatedState()}setEndpoint(e){this.log(`Adding endpoint with ${e.remoteVideoStreams.length} remote video streams`);this.setReady(true);this.inviteTimeout=false;this.declined=false;if(this.endpoint){this.removeEndpointEventHandlers();this.endpoint=null}this.endpoint=e;if(this.endpoint.remoteVideoStreams.length>0){this.callbacks.onStreamReceived({userId:this.userId,stream:this.getPriorityStream()})}this.updateCalculatedState();this.bindEndpointEventHandlers();if(e.initialState){this.callbacks.onInitialState({userId:this.userId,microphoneState:e.initialState.microphoneState,floorRequest:e.initialState.floorRequest})}}bindEndpointEventHandlers(){this.endpoint.on(JNBXEndpoint.Events.Removed,this.__onEndpointRemovedHandler);this.endpoint.on(JNBXEndpoint.Events.HandRaised,this.__onEndpointHandRaisedHandler)}removeEndpointEventHandlers(){this.endpoint.off(JNBXEndpoint.Events.Removed,this.__onEndpointRemovedHandler);this.endpoint.off(JNBXEndpoint.Events.HandRaised,this.__onEndpointHandRaisedHandler)}setSignalingConnected(e){}setUserAgent(e){this.userAgent=e;this.isLegacyMobile=e==="Bitrix Legacy Mobile"}isReady(){return this.ready}isInitiator(){return this.call&&this.call.userId<this.userId}updateCalculatedState(){var e=this.calculateState();if(this.calculatedState!=e){this.callbacks.onStateChanged({userId:this.userId,state:e,previousState:this.calculatedState,isLegacyMobile:this.isLegacyMobile});this.calculatedState=e}}calculateState(){if(this.peerConnection){if(this.peerConnection.iceConnectionState==="connected"||this.peerConnection.iceConnectionState==="completed"){return BX.Call.UserState.Connected}return BX.Call.UserState.Connecting}else{if(this.failureReason){return BX.Call.UserState.Failed}}if(this.calling){return BX.Call.UserState.Calling}if(this.inviteTimeout){return BX.Call.UserState.Unavailable}if(this.declined){return BX.Call.UserState.Declined}if(this.busy){return BX.Call.UserState.Busy}if(this.ready){return BX.Call.UserState.Ready}return BX.Call.UserState.Idle}isParticipating(){if(this.calling){return true}if(this.declined||this.busy){return false}if(this.peerConnection){var e=this.peerConnection.iceConnectionState;if(e=="checking"||e=="connected"||e=="completed"){return true}}return false}isRenegotiationSupported(){return true}getSignaling(){return this.call?this.call.signaling:null}log(){this.call&&this.call.log.apply(this.call,arguments)}sendIceCandidates(){if(this.candidatesTimeout){clearTimeout(this.candidatesTimeout);this.candidatesTimeout=null}if(!this.call){return}this.log("User "+this.userId+": sending ICE candidates due to the timeout");if(this.localIceCandidates.length>0){this.getSignaling().sendIceCandidate({userId:this.userId,connectionId:this.peerConnection._id,candidates:this.localIceCandidates});this.localIceCandidates=[]}else{this.log("User "+this.userId+": ICE candidates pool is empty")}}sendMedia(e){if(!this.peerConnection){if(!this.isInitiator()){this.log("waiting for the other side to send connection offer");this.sendNegotiationNeeded(false);return}let e=callEngine.getUuidv4();this._createPeerConnection(e)}this.updateOutgoingTracks();if(!e){this.createAndSendOffer()}}updateOutgoingTracks(){if(!this.peerConnection){return}let e;let t;if(this.call.localStream&&this.call.localStream.getAudioTracks().length>0){e=this.call.localStream.getAudioTracks()[0]}if(this.call.videoEnabled&&this.call.localStream&&this.call.localStream.getVideoTracks().length>0){t=this.call.localStream.getVideoTracks()[0]}let n=[];if(e){n.push(e.id+" (audio)")}if(t){n.push(t.id+" ("+t.kind+")")}if(this.videoSender&&t){}if(!this.videoSender&&t){this.videoSender=this.peerConnection.addTrack(t,this.call.localStream)}if(this.videoSender&&!t){this.peerConnection.removeTrack(this.videoSender);this.videoSender=null}if(this.audioSender&&e){}if(!this.audioSender&&e){this.audioSender=this.peerConnection.addTrack(e,this.call.localStream)}if(this.audioSender&&!e){this.peerConnection.removeTrack(this.audioSender);this.audioSender=null}}getSenderMid(e){if(!e||!this.peerConnection){return null}const t=this.peerConnection.getTransceivers().find((t=>{if(t.sender.track&&e.track){return t.sender.track.id===e.track.id}return false}));return t?t.mid:null}replaceMedia(){console.log("replaceMedia");if(!this.isReady()){return}if(this.isRenegotiationSupported()){this.updateOutgoingTracks();this.createAndSendOffer()}else{this.reconnect()}}setConnectionOffer(e,t,n){console.log("setConnectionOffer",this.call.isReady(),this.isReady(),!!this.peerConnection,this.peerConnection?._id,e,n);this.log("User "+this.userId+": received connection offer for connection "+e);clearTimeout(this.negotiationNeededReplyTimeout);this.negotiationNeededReplyTimeout=null;if(!this.call.isReady()){return}if(!this.isReady()){return}if(n){this.trackList=CallUtil.array_flip(n)}if(this.peerConnection){if(this.peerConnection._id!==e){this._destroyPeerConnection();this._createPeerConnection(e)}}else{this._createPeerConnection(e)}this.applyOfferAndSendAnswer(t)}createAndSendOffer(e){let n=Object.assign({},t,e);this.peerConnection.createOffer(n).then((e=>{this.log("User "+this.userId+": Created connection offer.");this.log("Applying local description");this.pendingLocalDescription=e;this.sendOffer()}))}sendOffer(){let e=this.peerConnection._id;clearTimeout(this.connectionOfferReplyTimeout);this.connectionOfferReplyTimeout=setTimeout((()=>this._onConnectionOfferReplyTimeout(e)),n);this.getSignaling().sendConnectionOffer({userId:this.userId,connectionId:e,sdp:this.pendingLocalDescription.sdp,userAgent:"Bitrix Mobile",tracks:{audio:this.getSenderMid(this.audioSender),video:this.getSenderMid(this.videoSender)}})}onNegotiationNeeded(){if(this.peerConnection){if(this.peerConnection.signalingState=="have-local-offer"){this.sendOffer()}else{this.createAndSendOffer({iceRestart:true})}}else{this.sendMedia()}}sendNegotiationNeeded(e){e=e===true;clearTimeout(this.negotiationNeededReplyTimeout);this.negotiationNeededReplyTimeout=setTimeout((()=>this._onNegotiationNeededReplyTimeout()),n);let t={userId:this.userId};if(e){t.restart=true}this.getSignaling().sendNegotiationNeeded(t)}applyOfferAndSendAnswer(e){console.log("applyOfferAndSendAnswer start",this.userId);let t={type:"offer",sdp:e};this.log("User: "+this.userId+"; Applying remote offer");this.log("User: "+this.userId+"; Peer ice connection state ",this.peerConnection.iceConnectionState);this.peerConnection.setRemoteDescription(t).then((()=>{if(this.peerConnection.iceConnectionState==="new"){this.sendMedia(true)}return this.peerConnection.createAnswer()})).then((e=>{console.log("applyOfferAndSendAnswer answer created");this.log("Created connection answer.");this.log("Applying local description.");return this.peerConnection.setLocalDescription(e)})).then((()=>{console.log("applyOfferAndSendAnswer answer set");this.applyPendingIceCandidates();this.getSignaling().sendConnectionAnswer({userId:this.userId,connectionId:this.peerConnection._id,sdp:this.peerConnection.localDescription().sdp,userAgent:"Bitrix Mobile",tracks:{audio:this.getSenderMid(this.audioSender),video:this.getSenderMid(this.videoSender)}})})).catch((e=>{console.log("applyOfferAndSendAnswer error");this.failureReason=e.toString();this.updateCalculatedState();this.log("Could not apply remote offer",e);console.error("Could not apply remote offer",e)}))}setConnectionAnswer(e,t,n){if(!this.peerConnection){return}clearTimeout(this.connectionOfferReplyTimeout);if(this.peerConnection._id!=e){this.log("Could not apply answer, for unknown connection "+e);return}if(n){this.trackList=CallUtil.array_flip(n)}let i={type:"answer",sdp:t};if(this.peerConnection.signalingState!=="have-local-offer"&&!this.pendingLocalDescription){this.log("Could not apply answer, wrong peer connection signaling state "+this.peerConnection.signalingState);return}this.log("User: "+this.userId+"; Applying remote answer");this.maybeSetPendingLocalOffer().then((()=>this.peerConnection.setRemoteDescription(i))).then((()=>this.applyPendingIceCandidates())).catch((e=>{this.failureReason=e.toString();this.updateCalculatedState();this.log(e)}))}maybeSetPendingLocalOffer(){return new Promise(((e,t)=>{if(this.pendingLocalDescription){this.peerConnection.setLocalDescription(this.pendingLocalDescription).then((()=>{this.pendingLocalDescription=null;e()})).catch((e=>t(e)))}else{e()}}))}addIceCandidate(e,t){if(!this.peerConnection){return}if(this.peerConnection._id!=e){this.log("Error: Candidate for unknown connection "+e);return}if(this.peerConnection.remoteDescription()&&this.peerConnection.remoteDescription().type){this.peerConnection.addIceCandidate(t).then((()=>{this.log("User: "+this.userId+"; Added remote ICE candidate: "+(t?t.candidate:t))})).catch((e=>{this.log(e)}))}else{if(!this.pendingIceCandidates[e]){this.pendingIceCandidates[e]=[]}this.pendingIceCandidates[e].push(t)}}applyPendingIceCandidates(){if(!this.peerConnection||!this.peerConnection.remoteDescription().type){return}var e=this.peerConnection._id;if(BX.type.isArray(this.pendingIceCandidates[e])){this.pendingIceCandidates[e].forEach((e=>{this.peerConnection.addIceCandidate(e).then((()=>{this.log("User: "+this.userId+"; Added remote ICE candidate: "+(e?e.candidate:e))}))}));this.pendingIceCandidates[e]=[]}}updateCandidatesTimeout(){if(this.candidatesTimeout){clearTimeout(this.candidatesTimeout)}this.candidatesTimeout=setTimeout(this.sendIceCandidates.bind(this),500)}reconnect(){clearTimeout(this.reconnectAfterDisconnectTimeout);this.connectionAttempt++;if(!this.call){return}if(this.connectionAttempt>3){this.log("Error: Too many reconnection attempts, giving up");this.failureReason="Could not connect to user in time";this._destroyPeerConnection();this.updateCalculatedState();return}this.callbacks.onReconnecting();console.trace("Trying to restore ICE connection. Attempt "+this.connectionAttempt);this.log("Trying to restore ICE connection. Attempt "+this.connectionAttempt);if(this.isInitiator()){this._destroyPeerConnection();this.sendMedia()}else{this.sendNegotiationNeeded(true)}}_createPeerConnection(e){const t=BX.componentParameters.get("turnServer","");const n=BX.componentParameters.get("turnServerLogin","");const i=BX.componentParameters.get("turnServerPassword","");let s={iceServers:[{urls:["stun:"+t],username:n,credential:i},{urls:["turn:"+t],username:n,credential:i}]};this.log("creating peer connection "+e);this.localIceCandidates=[];this.peerConnection=new RTCPeerConnection(s);this.peerConnection._id=e;this.peerConnection.on(JNRTCPeerConnection.Events.IceCandidate,this._onPeerConnectionIceCandidateHandler);this.peerConnection.on(JNRTCPeerConnection.Events.IceConnectionStateChange,this._onPeerConnectionIceConnectionStateChangeHandler);this.peerConnection.on(JNRTCPeerConnection.Events.IceGatheringStateChange,this._onPeerConnectionIceGatheringStateChangeHandler);this.peerConnection.on(JNRTCPeerConnection.Events.NegotiationNeeded,this._onPeerConnectionNegotiationNeededHandler);this.peerConnection.on(JNRTCPeerConnection.Events.Track,this._onPeerConnectionTrackHandler);this.peerConnection.on(JNRTCPeerConnection.Events.RemoveTrack,this._onPeerConnectionRemoveTrackHandler);this.peerConnection.on(JNRTCPeerConnection.Events.AddStream,this._onPeerConnectionAddStreamHandler);this.peerConnection.on(JNRTCPeerConnection.Events.RemoveStream,this._onPeerConnectionRemoveStreamHandler);this.peerConnection.on(JNRTCPeerConnection.Events.SignalingStateChange,this._onPeerConnectionSignalingStateChangeHandler)}_destroyPeerConnection(){if(!this.peerConnection){return}var e=this.peerConnection._id;this.log("User "+this.userId+": Destroying peer connection "+e);this.peerConnection.off(JNRTCPeerConnection.Events.IceCandidate,this._onPeerConnectionIceCandidateHandler);this.peerConnection.off(JNRTCPeerConnection.Events.IceConnectionStateChange,this._onPeerConnectionIceConnectionStateChangeHandler);this.peerConnection.off(JNRTCPeerConnection.Events.IceGatheringStateChange,this._onPeerConnectionIceGatheringStateChangeHandler);this.peerConnection.off(JNRTCPeerConnection.Events.NegotiationNeeded,this._onPeerConnectionNegotiationNeededHandler);this.peerConnection.off(JNRTCPeerConnection.Events.Track,this._onPeerConnectionTrackHandler);this.peerConnection.off(JNRTCPeerConnection.Events.RemoveStream,this._onPeerConnectionRemoveStreamHandler);this.peerConnection.off(JNRTCPeerConnection.Events.SignalingStateChange,this._onPeerConnectionSignalingStateChangeHandler);this.localIceCandidates=[];if(this.pendingIceCandidates[e]){delete this.pendingIceCandidates[e]}this.peerConnection.close();this.peerConnection=null}_hasIncomingVideo(){if(!this.peerConnection){return false}return this.peerConnection.getTransceivers().some((e=>(e.currentDirection=="sendrecv"||e.currentDirection=="recvonly")&&(e.receiver&&e.receiver.track&&e.receiver.track.kind==="video")))}_onPeerConnectionIceCandidate(e){this.log("User "+this.userId+": ICE candidate discovered. Candidate: "+JSON.stringify(e));if(e){this.getSignaling().getPublishingState().then((t=>{if(t){this.getSignaling().sendIceCandidate({userId:this.userId,connectionId:this.peerConnection._id,candidates:[e]})}else{this.localIceCandidates.push(e);this.updateCandidatesTimeout()}})).catch((e=>console.error(e)))}}_onPeerConnectionIceConnectionStateChange(){console.log("_onPeerConnectionIceConnectionStateChange",this.peerConnection.iceConnectionState);this.log("User "+this.userId+": ICE connection state changed. New state: "+this.peerConnection.iceConnectionState);if(this.peerConnection.iceConnectionState==="connected"||this.peerConnection.iceConnectionState==="completed"){this.connectionAttempt=0;this.failureReason="";this.callbacks.onReconnected();clearTimeout(this.reconnectAfterDisconnectTimeout)}else if(this.peerConnection.iceConnectionState==="failed"){this.log("ICE connection failed. Trying to restore connection immediately");this.reconnect()}else if(this.peerConnection.iceConnectionState==="disconnected"){this.log("ICE connection lost. Waiting 5 seconds before trying to restore it");clearTimeout(this.reconnectAfterDisconnectTimeout);this.reconnectAfterDisconnectTimeout=setTimeout((()=>this.reconnect()),5e3)}this.updateCalculatedState()}_onPeerConnectionIceGatheringStateChange(){}_onPeerConnectionNegotiationNeeded(){this.log("_onPeerConnectionNegotiationNeeded")}_getTrackMid(e){if(!this.peerConnection){return null}let t=this.peerConnection.getTransceivers().find((t=>t.receiver&&t.receiver.track&&t.receiver.track.id==e));if(!t){return null}return t.mid}_onPeerConnectionTrack(e){let{track:t}=e;this.log("_onPeerConnectionTrack; kind: ",t.kind,"id: ",t.id)}_onPeerConnectionRemoveTrack(e){let{track:t}=e;this.call.log("_onPeerConnectionRemoveTrack; kind: ",t.kind,"id: ",t.id)}_onPeerConnectionAddStream(e){this.call.log("_onPeerConnectionAddStream",e)}_onPeerConnectionRemoveStream(e){this.call.log("_onPeerConnectionRemoveStream",e)}_onPeerConnectionSignalingStateChange(){let e=null;let t=null;if(this.peerConnection.signalingState=="stable"){this.peerConnection.getTransceivers().forEach((n=>{if((n.currentDirection=="sendrecv"||n.currentDirection=="recvonly")&&(n.receiver&&n.receiver.track)){let i=n.receiver.track;console.log(`track received. mid: ${n.mid} kind: ${i.kind}`);if(i.kind==="audio"){}if(i.kind==="video"){if(this.trackList[n.mid]==="screen"){e=i}else{t=i}}}}))}if(e){this.incomingScreenTrack=e;this.incomingVideoTrack=t}else{this.incomingVideoTrack=t;this.incomingScreenTrack=e}}stopSignalingTimeout(){clearTimeout(this.signalingConnectionTimeout)}refreshSignalingTimeout(){clearTimeout(this.signalingConnectionTimeout);this.signalingConnectionTimeout=setTimeout(this._onLostSignalingConnection.bind(this),signalingConnectionRefreshPeriod)}_onLostSignalingConnection(){this.setSignalingConnected(false)}_onConnectionOfferReplyTimeout(e){console.log("_onConnectionOfferReplyTimeout",e);this.log("did not receive connection answer for connection "+e);this.reconnect()}_onNegotiationNeededReplyTimeout(){console.log("_onNegotiationNeededReplyTimeout");this.log("did not receive connection offer in time");this.reconnect()}__onEndpointRemoved(e){this.log("Endpoint removed");if(this.endpoint){this.removeEndpointEventHandlers();this.endpoint=null}this.updateCalculatedState()}__onEndpointHandRaised(e){this.log("Endpoint hand raised");this.callbacks.onHandRaised({userId:this.userId,isHandRaised:e.isHandRaised})}disconnect(){clearTimeout(this.reconnectAfterDisconnectTimeout);this._destroyPeerConnection()}destroy(){this._destroyPeerConnection();clearTimeout(this.answerTimeout);this.answerTimeout=null;clearTimeout(this.connectionTimeout);this.connectionTimeout=null;clearTimeout(this.signalingConnectionTimeout);this.signalingConnectionTimeout=null;clearTimeout(this.reconnectAfterDisconnectTimeout);this.reconnectAfterDisconnectTimeout=null;this.callbacks.onStateChanged=e;this.callbacks.onStreamReceived=e;this.callbacks.onStreamRemoved=e;this.callbacks.onInitialState=BX.DoNothing;this.callbacks.onHandRaised=BX.DoNothing;this.call=null}}class l{constructor(e){this.call=e.call}isIceTricklingAllowed(){return this.isPublishingSupported()}getPublishingState(){return BX.PULL.getPublishingState()}inviteUsers(e){return this.__runRestAction(s.invite,e)}sendUsersInvited(e){this.__sendMessage(o.usersInvited,e)}sendConnectionOffer(e){this.__sendMessage(o.connectionOffer,e)}sendConnectionAnswer(e){this.__sendMessage(o.connectionAnswer,e)}sendIceCandidate(e){this.__sendMessage(o.iceCandidate,e)}sendNegotiationNeeded(e){this.__sendMessage(o.negotiationNeeded,e)}sendVoiceStarted(e){this.__sendMessage(o.voiceStarted,e)}sendVoiceStopped(e){this.__sendMessage(o.voiceStopped,e)}sendMicrophoneState(e,t){this.__sendMessage(o.microphoneState,{userId:e,microphoneState:t},0)}sendCameraState(e,t){this.__sendMessage(o.cameraState,{userId:e,cameraState:t},0)}sendVideoPaused(e,t){this.__sendMessage(o.videoPaused,{userId:e,videoPaused:t},0)}sendRepeatAnswer(e){this.__sendMessage(o.repeatAnswer,e)}sendUserInviteTimeout(e){this.__sendMessage(o.userInviteTimeout,e)}__sendMessage(e,t){if(!this.call.plainCallJwt){return}if(!BX.type.isPlainObject(t)){t={}}t.eventName=e;t.requestId=callEngine.getUuidv4();t.senderId=this.call.userId;console.log("__sendMessage",e,!!this.call.plainCallJwt,t);try{this.call.plainCallJwt.send1To1Message(JSON.stringify(t))}catch(e){console.log("__sendMessage error",e)}}__runRestAction(e,t){if(!BX.type.isPlainObject(t)){t={}}t.callUuid=this.call.uuid;t.callInstanceId=this.call.instanceId;t.requestId=callEngine.getUuidv4();this.call.log("Sending ajax-based signaling event "+e+"; "+JSON.stringify(t));return callEngine.getRestClient().callMethod(e,t).catch((function(e){console.error(e)}))}}window.PlainCallJwt=a})();
//# sourceMappingURL=extension.map.js