{"version":3,"file":"script.js","sources":["script.es6.js"],"sourcesContent":["import { MessageBox } from 'ui.dialogs.messagebox';\nimport { Reflection, Loc, Text, ajax as Ajax } from 'main.core';\nimport { EventEmitter } from 'main.core.events';\nimport { Button, ButtonColor, CancelButton } from 'ui.buttons';\n\ntype Props = {\n\tgridId: ?string,\n\tisNeedShowTopMenuGuide: boolean,\n\tisNeedShowDraftGuide: boolean,\n};\n\n/**\n * @namespace BX.BIConnector\n */\nclass ExternalDatasetManager\n{\n\t#grid: BX.Main.grid;\n\t#filter: BX.Main.Filter;\n\n\tconstructor(props: Props)\n\t{\n\t\tthis.#grid = BX.Main.gridManager.getById(props.gridId)?.instance;\n\t\tthis.#filter = BX.Main.filterManager.getById(props.gridId);\n\t\tthis.#subscribeToEvents();\n\t\tthis.#initHints();\n\t}\n\n\t#initHints(): void\n\t{\n\t\tconst manager = BX.UI.Hint.createInstance({\n\t\t\tpopupParameters: {\n\t\t\t\tautoHide: true,\n\t\t\t},\n\t\t});\n\t\tmanager.init(this.#grid.getContainer());\n\t}\n\n\t#subscribeToEvents()\n\t{\n\t\tEventEmitter.subscribe('SidePanel.Slider:onMessage', (event) => {\n\t\t\tconst [messageEvent] = event.getData();\n\t\t\tif (messageEvent.getEventId() === 'BIConnector.dataset-import:onDatasetCreated')\n\t\t\t{\n\t\t\t\tthis.#grid.reload();\n\t\t\t}\n\t\t});\n\n\t\tEventEmitter.subscribe('Grid::updated', () => {\n\t\t\tthis.#initHints();\n\t\t});\n\t}\n\n\thandleCreatedByClick(ownerData: Object)\n\t{\n\t\tthis.handleDatasetFilterChange({\n\t\t\tfieldId: 'CREATED_BY_ID',\n\t\t\t...ownerData,\n\t\t});\n\t}\n\n\thandleUpdatedByClick(ownerData: Object)\n\t{\n\t\tthis.handleDatasetFilterChange({\n\t\t\tfieldId: 'UPDATED_BY_ID',\n\t\t\t...ownerData,\n\t\t});\n\t}\n\n\thandleSourceClick(sourceData: Object)\n\t{\n\t\tthis.handleDatasetFilterChange({\n\t\t\tfieldId: 'SOURCE.ID',\n\t\t\t...sourceData,\n\t\t});\n\t}\n\n\thandleDatasetFilterChange(fieldData: Object)\n\t{\n\t\tconst filterFieldsValues = this.#filter.getFilterFieldsValues();\n\t\tlet currentFilteredField = filterFieldsValues[fieldData.fieldId] ?? [];\n\t\tlet currentFilteredFieldLabel = filterFieldsValues[`${fieldData.fieldId}_label`] ?? [];\n\n\t\tif (fieldData.IS_FILTERED)\n\t\t{\n\t\t\tcurrentFilteredField = currentFilteredField.filter((value) => parseInt(value, 10) !== fieldData.ID);\n\t\t\tcurrentFilteredFieldLabel = currentFilteredFieldLabel.filter((value) => value !== fieldData.TITLE);\n\t\t}\n\t\telse if (!currentFilteredField.includes(fieldData.ID))\n\t\t{\n\t\t\tcurrentFilteredField.push(fieldData.ID);\n\t\t\tcurrentFilteredFieldLabel.push(fieldData.TITLE);\n\t\t}\n\n\t\tconst filterApi = this.#filter.getApi();\n\t\tconst filterToExtend = {};\n\t\tfilterToExtend[fieldData.fieldId] = currentFilteredField;\n\t\tfilterToExtend[`${fieldData.fieldId}_label`] = currentFilteredFieldLabel;\n\n\t\tfilterApi.extendFilter(filterToExtend);\n\t\tfilterApi.apply();\n\t}\n\n\tdeleteDataset(id: number) {\n\t\tconst messageBox = new MessageBox({\n\t\t\tmessage: Loc.getMessage('BICONNECTOR_SUPERSET_EXTERNAL_DATASET_GRID_DELETE_POPUP_DESCRIPTION'),\n\t\t\ttitle: Loc.getMessage('BICONNECTOR_SUPERSET_EXTERNAL_DATASET_GRID_DELETE_POPUP_TITLE'),\n\t\t\tbuttons: [\n\t\t\t\tnew Button({\n\t\t\t\t\tcolor: ButtonColor.DANGER,\n\t\t\t\t\ttext: Loc.getMessage('BICONNECTOR_SUPERSET_EXTERNAL_DATASET_GRID_DELETE_POPUP_CAPTION_YES'),\n\t\t\t\t\tonclick: (button) => {\n\t\t\t\t\t\tbutton.setWaiting();\n\t\t\t\t\t\tthis.deleteDatasetAjaxAction(id)\n\t\t\t\t\t\t\t.then(() => {\n\t\t\t\t\t\t\t\tthis.#grid.reload();\n\t\t\t\t\t\t\t\tmessageBox.close();\n\t\t\t\t\t\t\t})\n\t\t\t\t\t\t\t.catch((response) => {\n\t\t\t\t\t\t\t\tmessageBox.close();\n\t\t\t\t\t\t\t\tif (response.errors)\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\tthis.#notifyErrors(response.errors);\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t});\n\t\t\t\t\t},\n\t\t\t\t}),\n\t\t\t\tnew CancelButton({\n\t\t\t\t\ttext: Loc.getMessage('BICONNECTOR_SUPERSET_EXTERNAL_DATASET_GRID_DELETE_POPUP_CAPTION_NO'),\n\t\t\t\t\tonclick: () => messageBox.close(),\n\t\t\t\t}),\n\t\t\t],\n\t\t});\n\n\t\tmessageBox.show();\n\t}\n\n\tdeleteDatasetAjaxAction(datasetId: number): Promise\n\t{\n\t\treturn Ajax.runAction('biconnector.externalsource.dataset.delete', {\n\t\t\tdata: {\n\t\t\t\tid: datasetId,\n\t\t\t},\n\t\t});\n\t}\n\n\tcreateChart(datasetId: number): void\n\t{\n\t\tthis.#grid.tableFade();\n\t\tAjax.runAction(\n\t\t\t'biconnector.externalsource.dataset.getEditUrl',\n\t\t\t{\n\t\t\t\tdata: {\n\t\t\t\t\tid: datasetId,\n\t\t\t\t},\n\t\t\t},\n\t\t)\n\t\t\t.then((response) => {\n\t\t\t\tconst link = response.data;\n\t\t\t\tif (link)\n\t\t\t\t{\n\t\t\t\t\twindow.open(link, '_blank').focus();\n\t\t\t\t}\n\t\t\t\tthis.#grid.tableUnfade();\n\t\t\t})\n\t\t\t.catch((response) => {\n\t\t\t\tthis.#grid.tableUnfade();\n\t\t\t\tif (response.errors)\n\t\t\t\t{\n\t\t\t\t\tthis.#notifyErrors(response.errors);\n\t\t\t\t}\n\t\t\t})\n\t\t;\n\t}\n\n\tshowSupersetError(): void\n\t{\n\t\tBX.UI.Notification.Center.notify({\n\t\t\tcontent: Text.encode(Loc.getMessage('BICONNECTOR_SUPERSET_EXTERNAL_DATASET_GRID_ERROR_SUPERSET')),\n\t\t});\n\t}\n\n\t#notifyErrors(errors: Array): void\n\t{\n\t\tif (errors[0] && errors[0].message)\n\t\t{\n\t\t\tBX.UI.Notification.Center.notify({\n\t\t\t\tcontent: Text.encode(errors[0].message),\n\t\t\t});\n\t\t}\n\t}\n}\n\nReflection.namespace('BX.BIConnector').ExternalDatasetManager = ExternalDatasetManager;\n"],"names":["ExternalDatasetManager","props","BX","Main","gridManager","getById","gridId","instance","filterManager","ownerData","handleDatasetFilterChange","fieldId","sourceData","fieldData","filterFieldsValues","getFilterFieldsValues","currentFilteredField","currentFilteredFieldLabel","IS_FILTERED","filter","value","parseInt","ID","TITLE","includes","push","filterApi","getApi","filterToExtend","extendFilter","apply","id","messageBox","MessageBox","message","Loc","getMessage","title","buttons","Button","color","ButtonColor","DANGER","text","onclick","button","setWaiting","deleteDatasetAjaxAction","then","reload","close","response","errors","CancelButton","show","datasetId","Ajax","runAction","data","tableFade","link","window","open","focus","tableUnfade","UI","Notification","Center","notify","content","Text","encode","manager","Hint","createInstance","popupParameters","autoHide","init","getContainer","EventEmitter","subscribe","event","getData","messageEvent","getEventId","Reflection","namespace"],"mappings":"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"}