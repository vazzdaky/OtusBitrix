(function(){BX.namespace("BX.Call.AI");const t=BX.Call.Lib?.Analytics;const e=BX.Call.Util?.isNewFollowUpSliderEnabled();BX.Call.AI.Tabs={callId:null,tabsList:[],tabTitle:[],tabContents:[],contentWrapper:[],tabButtons:[],taskButtons:[],meetingButtons:[],mensionElements:[],userListAppInstance:null,audioPlayerInstance:{},playbackMarks:[],scrolling:false,scrollTimer:null,deletePopupInstance:null,init:function(){this.tabsList=document.getElementsByClassName("bx-call-component-call-ai__tab-content");this.callId=document.getElementsByClassName("bx-call-component-call-ai")[0]?.dataset.callId;this.hideAllTabs();this.initEvents();this.initAudioPlayer();this.initUserList();this.initPlaybackMarks();this.initGradeChart()},onTabClick:function(e){const{tabId:n,tabName:l}=e.target.dataset;this.hideAllTabs();t.getInstance().copilot.onOpenFollowUpTab({callId:this.callId,tabName:l});for(let t=0;t<this.tabButtons.length;t++){this.tabButtons[t].className=this.tabButtons[t].className.replace(" --active-button","")}document.getElementById(n).style.display="flex";e.currentTarget.className+=" --active-button"},hideAllTabs:function(){for(let t=0;t<this.tabsList.length;t++){this.tabsList[t].style.display="none"}},onCreateTaskClick:function(e){t.getInstance().copilot.onFollowUpCreateTaskClick({callId:this.callId});const{userId:n,description:l,auditors:a}=e.target.dataset;const i=`/company/personal/user/${n}/tasks/task/edit/0/`;BX.SidePanel.Instance.open(i,{requestMethod:"post",requestParams:{AUDITORS:a,DESCRIPTION:l,RESPONSIBLE_ID:n},cacheable:false})},onCreateMeetingClick:function(e){t.getInstance().copilot.onFollowUpCreateEventClick({callId:this.callId});const{meetingDescription:n,meetingId:l,meetingIdType:a}=e.target.dataset;new(window.top.BX||window.BX).Calendar.SliderLoader(0,{entryDescription:n,sliderId:l,type:a}).show()},getTimeInSeconds:function(t){const e=this.playbackMarks[t].innerText.split(/[-\u2014\u2013]/)[0];const[n,l,a]=e.split(":").map(Number).reverse();return a===undefined?l*60+n:a*3600+l*60+n},initEvents:function(){this.tabButtons=document.getElementsByClassName("bx-call-component-call-ai__tab-header-button");for(let t=0;t<this.tabButtons.length;t++){this.tabButtons[t].addEventListener("click",this.onTabClick.bind(this))}if(this.tabButtons.length){this.tabButtons[0].click()}this.tabTitle=document.querySelectorAll(".bx-call-component-call-ai__tab-title");for(let t=0;t<this.tabTitle.length;t++){this.tabTitle[t].addEventListener("click",this.scrollToTab.bind(this))}this.tabContents=document.querySelectorAll(".bx-call-component-call-ai__tab-details");this.contentWrapper=document.querySelector(".bx-call-component-call-ai__tab-content-wrapper");this.contentWrapper.addEventListener("scroll",this.changeTitleForScroll.bind(this));this.taskButtons=document.getElementsByClassName("bx-call-component-call-ai__task-button");for(let t=0;t<this.taskButtons.length;t++){this.taskButtons[t].addEventListener("click",this.onCreateTaskClick.bind(this))}this.meetingButtons=document.getElementsByClassName("bx-call-component-call-ai__meetings-button");for(let t=0;t<this.meetingButtons.length;t++){this.meetingButtons[t].addEventListener("click",this.onCreateMeetingClick.bind(this))}this.mensionElements=document.getElementsByClassName("bx-call-component-call-ai__user-mention");for(let t=0;t<this.mensionElements.length;t++){this.mensionElements[t].addEventListener("click",this.clickMension.bind(this))}const t=document.getElementsByClassName("bx-call-component-call-ai__disclaimer-link");t[0]?.addEventListener("click",this.clickDisclaimer.bind(this));const e=document.getElementsByClassName("bx-call-component-call-ai__delete");e[0]?.addEventListener("click",this.deleteFollowUp.bind(this))},initAudioPlayer:function(){if(!BX.Vue3){return}const e=BX.Vue3.BitrixVue;const n=document.getElementsByClassName("bx-call-component-call-ai__call-audio-record");if(!n.length){return}const l=this.callId;for(let a=0;a<n.length;a++){const{audioSrc:i,audioId:s}=n[a].dataset;if(!i){continue}this.audioPlayerInstance[s]=e.createApp({components:{AudioPlayer:BX.Call.Component.Elements.AudioPlayer},data(){return{audioSrc:i,analyticsCallback:()=>{t.getInstance().copilot.onAIPlayRecord({callId:l})}}},template:`\n\t\t\t\t\t\t<AudioPlayer :src="audioSrc" :analyticsCallback="analyticsCallback" ref="AudioPlayerRef"/>\n\t\t\t\t\t`}).mount(`#bx-call-component-call-ai__call-audio-record-${s}`)}},initUserList:function(){if(!BX.Vue3){return}const t=BX.Vue3.BitrixVue;const n=document.getElementsByClassName("bx-call-component-call-ai-page__title-users-container");if(n.length===0){return}const{callId:l}=n[0].dataset;if(!l){return}t.createApp({components:{UserList:BX.Call.Component.UserList},data(){return{isLoadingUsers:true,callId:l,usersData:[],withBorder:!e,withIcon:e}},created(){BX.ajax.runComponentAction("bitrix:call.ai","getUsers",{mode:"ajax",data:{callId:l}}).then((t=>{this.isLoadingUsers=false;this.usersData=Object.values(t.data.users)})).catch((t=>{this.isLoadingUsers=false}))},template:`\n\t\t\t\t\t<UserList :loading="isLoadingUsers" :usersData="usersData" :withBorder="withBorder" :withIcon="withIcon"/>\n\t\t\t\t`}).mount(".bx-call-component-call-ai-page__title-users-container")},initPlaybackMarks:function(){if(Object.keys(this.audioPlayerInstance).length===0){return}this.playbackMarks=document.getElementsByClassName("bx-call-component-call-ai__time-code");Object.keys(this.audioPlayerInstance).forEach((e=>{for(let n=0;n<this.playbackMarks.length;n++){const{audioId:l}=this.playbackMarks[n].dataset;if(l!==e){continue}this.playbackMarks[n].addEventListener("click",(()=>{t.getInstance().copilot.onAIRecordTimeCodeClick({callId:this.callId});this.audioPlayerInstance[e].$refs.AudioPlayerRef.choosePlaybackTime(this.getTimeInSeconds(n))}))}}))},clickMension:function(t){const{userId:e}=t.target.dataset;if(!e){return}BX.Messenger.Public.openChat(e)},clickDisclaimer:function(){const t=top.BX.Helper||window.top.BX.Helper;const e="20412666";if(!t){return}if(t.isOpen()){t.close()}t.show(`redirect=detail&code=${e}`)},scrollToTab:function(t){this.scrolling=true;const e=t.target.dataset.tabId;const n=document.getElementById(e);if(n){for(let t=0;t<this.tabTitle.length;t++){this.tabTitle[t].classList.remove("--active")}t.target.classList.add("--active");const e=n.offsetParent;const l=n.getBoundingClientRect();const a=e.getBoundingClientRect();const i=l.top-a.top+e.scrollTop;const s=parseFloat(window.getComputedStyle(n).marginTop);e.scrollTo({top:i-s,behavior:"smooth"})}if(this.scrollTimer){clearTimeout(this.scrollTimer);this.scrollTimer=null}this.scrollTimer=setTimeout((()=>{this.scrolling=false;this.scrollTimer=null}),1e3)},changeTitleForScroll:function(){if(this.scrolling){return}let t=null;this.tabContents.forEach(((e,n)=>{const l=e.getBoundingClientRect();const a=this.contentWrapper.getBoundingClientRect();if(l.top<=a.top+100&&l.bottom>=a.top+100){t=this.tabTitle[n]}}));if(t){this.tabTitle.forEach((t=>t.classList.remove("--active")));t.classList.add("--active")}},generateGradientElevent:function(t,e,n,l){const a="http://www.w3.org/2000/svg";const i=document.createElementNS(a,l);i.setAttribute("id",t);i.setAttribute("x1","0%");i.setAttribute("y1","0%");i.setAttribute("x2","100%");i.setAttribute("y2","100%");const s=document.createElementNS(a,"stop");s.setAttribute("offset","0%");s.setAttribute("stop-color",e);i.appendChild(s);const o=document.createElementNS(a,"stop");o.setAttribute("offset","100%");o.setAttribute("stop-color",n);i.appendChild(o);const c=document.createElementNS(a,"svg");c.setAttribute("width","0");c.setAttribute("height","0");c.appendChild(i);document.body.appendChild(c);return t},initGradeChart:function(){const t=document.getElementsByClassName("bx-call-component-call-ai__grade-value-wrapper");if(t.length===0){return}let{efficiencyValue:e}=t[0].dataset;if(!e){e=0}this.generateGradientElevent("bx-call-component-call-ai__gradient-primary","#29D887","#30AC73","linearGradient");this.generateGradientElevent("bx-call-component-call-ai__gradient-secondary","#EBF0F3","#DBDBDB","radialGradient");let n=[];let l=[];if(Number(e)===100){n=[{percentage:100}];l=["url(#bx-call-component-call-ai__gradient-primary)"]}else if(Number(e)>0){n=[{percentage:1},{percentage:e},{percentage:1},{percentage:100-e-2}];l=["#F8F6FD","url(#bx-call-component-call-ai__gradient-primary)","#F8F6FD","url(#bx-call-component-call-ai__gradient-secondary)"]}else{n=[{percentage:100}];l=["url(#bx-call-component-call-ai__gradient-secondary)"]}AmCharts.makeChart("bx-call-component-call-ai__grade-chart",{type:"pie",dataProvider:n,titleField:"status",valueField:"percentage",balloonText:"",labelText:"",innerRadius:"85%",colors:l,legend:{enabled:false},responsive:{enabled:true,addDefaultRules:true,rules:[{minWidth:200,minHeight:200,overrides:{innerRadius:"85%"}}]},startDuration:0,width:"100%",height:"100%",pullOutRadius:0,pullOutOnlyOne:false,outlineAlpha:0,startEffect:"elastic",pullOutEffect:"elastic",listeners:[{event:"clickSlice",method:t=>false}]})},deleteFollowUp:function(){if(!BX.Vue3||!e){return}const t=BX.Vue3.BitrixVue;if(this.deletePopupInstance){this.deletePopupInstance.unmount();this.deletePopupInstance=null}const n=this.callId;this.deletePopupInstance=t.createApp({components:{CallActionPopup:BX.Call.Component.Elements.CallActionPopup},data(){return{titleText:BX.Loc.getMessage("CALL_COMPONENT_DELETE_FOLLOWUP_TITLE"),descriptionText:BX.Loc.getMessage("CALL_COMPONENT_DELETE_FOLLOWUP_DESCRIPTION"),okText:BX.Loc.getMessage("CALL_COMPONENT_DELETE_FOLLOWUP_OK_BTN"),okAction:()=>{BX.ajax.runAction("call.FollowUp.drop",{data:{callId:n}}).then((()=>{const t=BX.SidePanel.Instance.getTopSlider();if(t){t.close()}})).catch((t=>{console.error("FollowUp delete error",t)}))}}},template:`\n\t\t\t\t\t<CallActionPopup\n\t\t\t\t\t\t:titleText="titleText"\n\t\t\t\t\t\t:descriptionText="descriptionText"\n\t\t\t\t\t\t:okText="okText"\n\t\t\t\t\t\t:okAction="okAction"\n\t\t\t\t\t/>\n\t\t\t\t`});this.deletePopupInstance.mount(".bx-call-component-call-ai__delete-popup")}};document.addEventListener("DOMContentLoaded",(()=>{BX.Call.AI.Tabs.init()}))})();
//# sourceMappingURL=script.map.js