this.BX=this.BX||{};(function(t,e,i,s){"use strict";let n=t=>t,a,o;class r{constructor(t={}){this.container=t.container;if(!e.Type.isDomNode(this.container)){return}this.entityType=t.entityType||"";this.entityId=t.entityId||"";if(!this.entityType||!this.entityId){return}this.items=t.items||[];this.mainItem=t.mainItem||"videocall";this.entityData=t.entityData||{};let i=t.analyticsLabel||{};if(this.items.length===0){switch(this.entityType){case"task":{this.items=["chat","videocall","blog_post","calendar_event"];break}case"calendar_event":{this.items=["chat","videocall","blog_post","task"];break}case"workgroup":{this.items=["chat","videocall"];break}default:{this.items=["chat","videocall","blog_post","task","calendar_event"]}}}this.contextBx=window.top.BX||window.BX;this.sliderId=`controlButton:${this.entityType+this.entityId}${Math.floor(Math.random()*1e3)}`;this.isVideoCallEnabled=e.Reflection.getClass(`${this.contextBx}.Call.Util`)?this.contextBx.Call.Util.isWebRTCSupported():true;this.chatLockCounter=0;if(!e.Type.isPlainObject(i)){i={}}this.analyticsLabel={entity:this.entityType,...i};this.analytics=t.analytics||{};if(!e.Type.isPlainObject(this.analytics)){this.analytics={}}this.buttonClassName=t.buttonClassName||"";this.airDesign=t.airDesign===true;this.renderButton();this.subscribeEvents()}destroy(){this.contextBx.Event.EventEmitter.unsubscribe("BX.Calendar:onEntrySave",this.onCalendarSave);this.contextBx.Event.EventEmitter.unsubscribe("SidePanel.Slider:onMessage",this.onPostSave)}subscribeEvents(){this.contextBx.Event.EventEmitter.subscribe("BX.Calendar:onEntrySave",this.onCalendarSave.bind(this));this.contextBx.Event.EventEmitter.subscribe("SidePanel.Slider:onMessage",this.onPostSave.bind(this))}onCalendarSave(t){if(t instanceof this.contextBx.Event.BaseEvent){const e=t.getData();if(e.sliderId===this.sliderId){const t={postEntityType:this.entityType.toUpperCase(),sourceEntityType:this.entityType.toUpperCase(),sourceEntityId:this.entityId,sourceEntityData:this.entityData,entityType:"CALENDAR_EVENT",entityId:e.responseData.entryId};this.addEntityComment(t)}}}onPostSave(t){const[e]=t.getCompatData();if(e.getEventId()==="Socialnetwork.PostForm:onAdd"){const t=e.getData();if(t.originatorSliderId===this.sliderId){const e={postEntityType:this.entityType.toUpperCase(),sourceEntityType:this.entityType.toUpperCase(),sourceEntityId:this.entityId,sourceEntityData:this.entityData,entityType:"BLOG_POST",entityId:t.successPostId};this.addEntityComment(e)}}}renderButton(){const t=!this.isVideoCallEnabled||this.mainItem==="chat";const i=t?this.openChat.bind(this):this.startVideoCall.bind(this);const s=t?e.Loc.getMessage("INTRANET_JS_CONTROL_BUTTON_CHAT"):e.Loc.getMessage("INTRANET_JS_CONTROL_BUTTON_NAME_MSG_1");let r="";if(this.airDesign){r="--air ui-btn-no-caps ui-btn-sm ui-icon-set__scope --style-filled";if(t){r+=" --with-left-icon ui-btn-icon-chat"}else{r+=" --with-left-icon ui-btn-icon-camera"}}else{r=t?"ui-btn-icon-chat-blue":"ui-btn-icon-camera-blue";r+=` intranet-control-btn ui-btn-light-border ui-btn-icon-inline ${this.buttonClassName}`}this.button=this.items.length>1?e.Tag.render(a||(a=n`
					<div class="ui-btn-split ${0}">
						<button class="ui-btn-main" onclick="${0}">
							<span class="ui-btn-text">${0}</span>
						</button>
						<button class="ui-btn-menu" onclick="${0}"></button> 
					</div>
				`),r,i,s,this.showMenu.bind(this)):e.Tag.render(o||(o=n`
					<button class="ui-btn ${0}" onclick="${0}">
						<span class="ui-btn-text">${0}</span>
					</button>
				`),r,i,s);e.Dom.append(this.button,this.container)}showLoader(){e.Dom.addClass(this.button,"ui-btn-wait")}hideLoader(){e.Dom.removeClass(this.button,"ui-btn-wait")}getAvailableItems(){return new Promise(((t,i)=>{const s=window.sessionStorage.getItem("b24-controlbutton-available-items");if(s){t(s);return}this.showLoader();e.ajax.runAction("intranet.controlbutton.getAvailableItems",{data:{}}).then((e=>{window.sessionStorage.setItem("b24-controlbutton-available-items",e.data);this.hideLoader();t(e.data)}))}))}showMenu(){this.getAvailableItems().then((t=>{this.items=this.items.filter((e=>e&&t.includes(e)));const s=[];this.items.forEach((t=>{switch(t){case"videocall":if(this.isVideoCallEnabled){s.push({text:e.Loc.getMessage("INTRANET_JS_CONTROL_BUTTON_VIDEOCALL"),className:"menu-popup-item-videocall",onclick:()=>{this.startVideoCall();this.popupMenu.close()}})}break;case"chat":s.push({text:e.Loc.getMessage("INTRANET_JS_CONTROL_BUTTON_CHAT"),className:"menu-popup-item-chat",onclick:()=>{this.openChat();this.popupMenu.close()}});break;case"task":s.push({text:e.Loc.getMessage("INTRANET_JS_CONTROL_BUTTON_TASK"),className:"menu-popup-item-task",onclick:()=>{this.openTaskSlider();this.popupMenu.close()}});break;case"calendar_event":s.push({text:e.Loc.getMessage("INTRANET_JS_CONTROL_BUTTON_MEETING"),className:"menu-popup-item-meeting",onclick:()=>{this.openCalendarSlider();this.popupMenu.close()}});break;case"blog_post":s.push({text:e.Loc.getMessage("INTRANET_JS_CONTROL_BUTTON_POST"),className:"menu-popup-item-post",onclick:()=>{this.openPostSlider();this.popupMenu.close()}});break}}));this.popupMenu=new i.Menu({bindElement:this.button,items:s,offsetLeft:80,offsetTop:5});this.popupMenu.show()}))}openChat(){this.showLoader();const t=this.analytics.openChat||{};e.ajax.runAction("intranet.controlbutton.getChat",this.getAjaxConfig(t)).then((t=>{if(t.data){s.Messenger.openChat(`chat${parseInt(t.data,10)}`)}this.chatLockCounter=0;this.hideLoader()}),(t=>{if(t.errors[0].code==="lock_error"&&this.chatLockCounter<4){this.chatLockCounter++;this.openChat()}else{this.showHintPopup(t.errors[0].message);this.hideLoader()}}))}startVideoCall(t=null){this.showLoader();const i=this.analytics.startVideoCall||{};if(e.Type.isPlainObject(i)&&e.Type.isStringFilled(i.c_sub_section)&&t){i.c_sub_section=t}e.ajax.runAction("intranet.controlbutton.getVideoCallChat",this.getAjaxConfig(i)).then((t=>{if(t.data){s.Messenger.startVideoCall(`chat${t.data}`,true)}this.chatLockCounter=0;this.hideLoader()}),(t=>{if(t.errors[0].code==="lock_error"&&this.chatLockCounter<4){this.chatLockCounter++;this.startVideoCall()}else{this.showHintPopup(t.errors[0].message);this.hideLoader()}}))}addEntityComment(t){e.ajax.runAction("socialnetwork.api.livefeed.createEntityComment",{data:{params:t}})}openCalendarSlider(){this.showLoader();const t=this.analytics.openCalendarSlider||{};e.ajax.runAction("intranet.controlbutton.getCalendarLink",this.getAjaxConfig(t)).then((t=>{let i=[];if(e.Type.isArrayLike(t.data.userIds)){i=t.data.userIds.map((t=>({id:parseInt(t,10),entityId:"user"})))}new(window.top.BX||window.BX).Calendar.SliderLoader(0,{sliderId:this.sliderId,participantsEntityList:i,entryName:t.data.name,entryDescription:t.data.desc}).show();this.hideLoader()}))}openTaskSlider(){this.showLoader();const t=this.analytics.openTaskSlider||{};e.ajax.runAction("intranet.controlbutton.getTaskLink",this.getAjaxConfig(t)).then((t=>{BX.SidePanel.Instance.open(t.data.link,{requestMethod:"post",requestParams:t.data});this.hideLoader()}))}openPostSlider(){this.showLoader();const t=this.analytics.openPostSlider||{};e.ajax.runAction("intranet.controlbutton.getPostLink",this.getAjaxConfig(t)).then((t=>{BX.SidePanel.Instance.open(t.data.link,{requestMethod:"post",requestParams:{POST_TITLE:t.data.title,POST_MESSAGE:t.data.message,destTo:t.data.destTo},data:{sliderId:this.sliderId}});this.hideLoader()}))}getAjaxConfig(t){const i={data:{entityType:this.entityType,entityId:this.entityId,entityData:this.entityData}};if(e.Type.isPlainObject(t)&&e.Type.isStringFilled(t.event)&&e.Type.isStringFilled(t.tool)){i.analytics=t}else{i.analyticsLabel=this.analyticsLabel}return i}showHintPopup(t){if(!t){return}new i.Popup(`inviteHint${e.Text.getRandom(8)}`,this.button,{content:t,zIndex:15e3,angle:true,offsetTop:0,offsetLeft:50,closeIcon:false,autoHide:true,darkMode:true,overlay:false,maxWidth:400,events:{onAfterPopupShow(){setTimeout((()=>{this.close()}),5e3)}}}).show()}}t.ControlButton=r})(this.BX.Intranet=this.BX.Intranet||{},BX,BX.Main,BX.Messenger.v2.Lib);
//# sourceMappingURL=control-button.bundle.map.js