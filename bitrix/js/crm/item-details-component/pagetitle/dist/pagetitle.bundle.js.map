{"version":3,"file":"pagetitle.bundle.js","sources":["../src/logger.js","../src/category-changer.js"],"sourcesContent":["export class Logger\n{\n\t#prefix: string;\n\n\tconstructor(prefix: string)\n\t{\n\t\tthis.#prefix = prefix;\n\t}\n\n\twarn(message: string, ...params): void\n\t{\n\t\t// eslint-disable-next-line no-console\n\t\tconsole.warn(this.#format(message), ...params);\n\t}\n\n\terror(message: string, ...params): void\n\t{\n\t\t// eslint-disable-next-line no-console\n\t\tconsole.error(this.#format(message), ...params);\n\t}\n\n\t#format(message: string): string\n\t{\n\t\treturn `${this.#prefix}: ${message}`;\n\t}\n}\n\nexport const logger = new Logger('crm.item-details-component.pagetitle');\n","import { CategoryModel } from 'crm.category-model';\nimport { ajax as Ajax, Dom, Loc, Tag, Text, Type, Uri } from 'main.core';\nimport { EventEmitter } from 'main.core.events';\nimport { type MenuItemOptions, MenuManager } from 'main.popup';\nimport 'ui.notification';\nimport { MessageBox, MessageBoxButtons } from 'ui.dialogs.messagebox';\nimport { type Logger, logger } from './logger';\n\nexport type CategoryChangerParams = {\n\tentityTypeId: number,\n\tentityId: number,\n\tcategoryId: number,\n\tcategories: CategoryModel[],\n\teditorGuid: string,\n\tlabelTemplate: ?string,\n};\n\n/**\n * Renders category change control, typically in the details card header near title.\n * WARNING! On successful change, the page is reloaded with window.location.reload or window.location.href.\n * It's a feature :)\n *\n * @memberOf BX.Crm.ItemDetailsComponent.PageTitle\n *\n * @mixes EventEmitter\n *\n * @emits BX.Crm.ItemDetailsComponent.CategoryChanger:onProgressStart\n * @emits BX.Crm.ItemDetailsComponent.CategoryChanger:onProgressStop\n */\nexport class CategoryChanger\n{\n\t#entityTypeId: number;\n\t#id: number;\n\t#categoryId: number;\n\t#categories: CategoryModel[];\n\t#editorGuid: ?string = null;\n\t#labelTemplate: string;\n\t#logger: Logger;\n\t#isProgress: boolean = false;\n\n\tconstructor({ entityTypeId, entityId, categoryId, categories, editorGuid, labelTemplate }: CategoryChangerParams)\n\t{\n\t\tthis.#entityTypeId = entityTypeId;\n\t\tthis.#id = entityId;\n\t\tthis.#categoryId = categoryId;\n\t\tthis.#categories = categories;\n\t\tthis.#editorGuid = editorGuid;\n\t\tthis.#labelTemplate = Type.isStringFilled(labelTemplate) ? labelTemplate : '#CATEGORY#';\n\n\t\tthis.#logger = logger;\n\n\t\tEventEmitter.makeObservable(this, 'BX.Crm.ItemDetailsComponent.CategoryChanger');\n\t}\n\n\tstatic renderToTarget(target: string | HTMLElement, params: CategoryChangerParams & {categories: Array[]}): ?CategoryChanger\n\t{\n\t\tconst changer = new CategoryChanger({\n\t\t\t...params,\n\t\t\tcategories: params.categories.map((category) => new CategoryModel(category)),\n\t\t});\n\n\t\tconst realTarget = Type.isDomNode(target) ? target : document.querySelector(target);\n\t\tif (!realTarget)\n\t\t{\n\t\t\tlogger.warn('target not found, skip rendering');\n\n\t\t\treturn null;\n\t\t}\n\n\t\tDom.append(changer.render(), realTarget);\n\n\t\treturn changer;\n\t}\n\n\trender(): ?HTMLElement\n\t{\n\t\tconst current = this.#getCurrentCategory();\n\t\tif (!current)\n\t\t{\n\t\t\tthis.#logger.warn('current category not found, skip rendering');\n\n\t\t\treturn null;\n\t\t}\n\n\t\tconst label = this.#labelTemplate.replace('#CATEGORY#', current.getName());\n\n\t\tconst element = Tag.render`\n\t\t\t<div class=\"crm-details-pagetitle-legend-container\">\n\t\t\t\t<a href=\"#\" onclick=\"${this.#onCategorySelectorClick.bind(this)}\">\n\t\t\t\t\t${Text.encode(label)}\n\t\t\t\t</a>\n\t\t\t</div>\n\t\t`;\n\n\t\tif (this.#isNew())\n\t\t{\n\t\t\tDom.addClass(element, '--new');\n\t\t}\n\n\t\treturn element;\n\t}\n\n\t#onCategorySelectorClick(event: BaseEvent): void\n\t{\n\t\tconst items: MenuItemOptions[] = [];\n\t\tfor (const category of this.#getAllCategoriesExceptCurrent())\n\t\t{\n\t\t\titems.push({\n\t\t\t\ttext: category.getName(),\n\t\t\t\tonclick: this.#onCategorySelect.bind(this, category.getId()),\n\t\t\t});\n\t\t}\n\n\t\tMenuManager.show({\n\t\t\tid: `item-category-changer-${this.#entityTypeId}-${this.#id}`,\n\t\t\tbindElement: event.target,\n\t\t\titems,\n\t\t});\n\t}\n\n\t#onCategorySelect(wantCategoryId: number): void\n\t{\n\t\tif (this.#isProgress)\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tif (this.#isEditorChanged())\n\t\t{\n\t\t\tthis.#showUnsavedChangesDialog(this.#changeCategory.bind(this, wantCategoryId));\n\t\t}\n\t\telse\n\t\t{\n\t\t\tthis.#changeCategory(wantCategoryId);\n\t\t}\n\t}\n\n\t#changeCategory(wantCategoryId: number): void\n\t{\n\t\tthis.#startProgress();\n\n\t\tif (this.#isNew())\n\t\t{\n\t\t\tthis.#reloadPageWhenCategoryChanged(wantCategoryId);\n\t\t}\n\t\telse\n\t\t{\n\t\t\tthis.#changeCategoryViaAjax(wantCategoryId);\n\t\t}\n\t}\n\n\t#reloadPageWhenCategoryChanged(wantCategoryId: number): void\n\t{\n\t\tconst url = new Uri(window.location.href);\n\t\t// for factory-based details\n\t\turl.setQueryParam('categoryId', wantCategoryId);\n\t\t// for crm.deal.details\n\t\turl.setQueryParam('category_id', wantCategoryId);\n\n\t\tsetTimeout(() => {\n\t\t\twindow.location.href = url.toString();\n\t\t\tthis.#stopProgress();\n\t\t});\n\t}\n\n\t#changeCategoryViaAjax(wantCategoryId: number): void\n\t{\n\t\tAjax.runAction('crm.controller.item.update', {\n\t\t\tanalyticsLabel: 'crmItemDetailsChangeCategory',\n\t\t\tdata: {\n\t\t\t\tentityTypeId: this.#entityTypeId,\n\t\t\t\tid: this.#id,\n\t\t\t\tfields: {\n\t\t\t\t\tcategoryId: wantCategoryId,\n\t\t\t\t},\n\t\t\t},\n\t\t}).then(() => {\n\t\t\tsetTimeout(() => {\n\t\t\t\twindow.location.reload();\n\t\t\t\tthis.#stopProgress();\n\t\t\t});\n\t\t}).catch((response) => {\n\t\t\tthis.#logger.warn('error changing category via ajax', response);\n\n\t\t\tconst message = response?.errors?.[0]?.message || 'Something went wrong';\n\n\t\t\tBX.UI.Notification.Center.notify({\n\t\t\t\tcontent: message,\n\t\t\t\tposition: 'top-right',\n\t\t\t\tautoHideDelay: 3000,\n\t\t\t});\n\n\t\t\tthis.#stopProgress();\n\t\t});\n\t}\n\n\t#showUnsavedChangesDialog(onOk: () => void): void\n\t{\n\t\tconst entityTypeName = BX.CrmEntityType?.resolveName(this.#entityTypeId);\n\n\t\tconst message = Loc.getMessage(`CRM_ITEM_PAGETITLE_CATEGORY_CHANGER_CONFIRM_DIALOG_MESSAGE_${entityTypeName}`)\n\t\t\t|| Loc.getMessage('CRM_ITEM_PAGETITLE_CATEGORY_CHANGER_CONFIRM_DIALOG_MESSAGE')\n\t\t;\n\n\t\tMessageBox.show({\n\t\t\tmodal: true,\n\t\t\ttitle: Loc.getMessage('CRM_ITEM_PAGETITLE_CATEGORY_CHANGER_CONFIRM_DIALOG_TITLE'),\n\t\t\tmessage,\n\t\t\tminHeight: 100,\n\t\t\tbuttons: MessageBoxButtons.OK_CANCEL,\n\t\t\tokCaption: Loc.getMessage('CRM_ITEM_PAGETITLE_CATEGORY_CHANGER_CONFIRM_DIALOG_OK_BTN'),\n\t\t\tonOk: (messageBox) => {\n\t\t\t\tmessageBox.close();\n\t\t\t\tonOk();\n\t\t\t},\n\t\t\tonCancel: (messageBox) => messageBox.close(),\n\t\t});\n\t}\n\n\t#startProgress(): void\n\t{\n\t\tif (this.#isProgress)\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tthis.#isProgress = true;\n\t\tthis.emit('onProgressStart');\n\t}\n\n\t#stopProgress(): void\n\t{\n\t\tif (!this.#isProgress)\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tthis.#isProgress = false;\n\t\tthis.emit('onProgressStop');\n\t}\n\n\t#isEditorChanged(): boolean\n\t{\n\t\tconst editor = this.#getEditor();\n\n\t\treturn Boolean(editor?.hasChangedControls() || editor?.hasChangedControllers());\n\t}\n\n\t#getEditor(): ?BX.Crm.EntityEditor\n\t{\n\t\tif (this.#editorGuid)\n\t\t{\n\t\t\treturn BX.Crm?.EntityEditor?.get(this.#editorGuid);\n\t\t}\n\n\t\treturn BX.Crm?.EntityEditor?.getDefault();\n\t}\n\n\t#isNew(): boolean\n\t{\n\t\treturn this.#id <= 0;\n\t}\n\n\t#getCurrentCategory(): ?CategoryModel\n\t{\n\t\treturn this.#categories.find((category) => category.getId() === this.#categoryId);\n\t}\n\n\t#getAllCategoriesExceptCurrent(): CategoryModel[]\n\t{\n\t\treturn this.#categories.filter((category) => category.getId() !== this.#categoryId);\n\t}\n}\n"],"names":["Logger","constructor","prefix","warn","message","params","console","error","logger","CategoryChanger","entityTypeId","entityId","categoryId","categories","editorGuid","labelTemplate","Type","isStringFilled","EventEmitter","makeObservable","renderToTarget","target","changer","map","category","CategoryModel","realTarget","isDomNode","document","querySelector","Dom","append","render","current","label","replace","getName","element","Tag","bind","Text","encode","addClass","event","items","push","text","onclick","getId","MenuManager","show","id","bindElement","wantCategoryId","url","Uri","window","location","href","setQueryParam","setTimeout","toString","Ajax","runAction","analyticsLabel","data","fields","then","reload","catch","response","errors","BX","UI","Notification","Center","notify","content","position","autoHideDelay","onOk","entityTypeName","CrmEntityType","resolveName","Loc","getMessage","MessageBox","modal","title","minHeight","buttons","MessageBoxButtons","OK_CANCEL","okCaption","messageBox","close","onCancel","emit","editor","Boolean","hasChangedControls","hasChangedControllers","Crm","EntityEditor","get","getDefault","find","filter"],"mappings":"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"}