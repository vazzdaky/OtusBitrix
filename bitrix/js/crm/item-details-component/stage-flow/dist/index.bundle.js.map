{"version":3,"file":"index.bundle.js","sources":["../src/chart.js"],"sourcesContent":["import { Dom, Text } from 'main.core';\nimport { StageFlow } from 'ui.stageflow';\nimport { Button } from 'ui.buttons';\nimport { PermissionChecker as StagePermissionChecker } from 'crm.stage.permission-checker';\nimport { StageModel } from 'crm.stage-model';\n\nimport './css/chart.css';\n\nexport class Chart extends StageFlow.Chart\n{\n\tpermissionChecker: StagePermissionChecker;\n\tgetStageModelCallback: (id: number) => ?StageModel;\n\tisNewItem: boolean = false;\n\n\t#isLoadingCallback: () => boolean;\n\t#showLoadingNotificationCallback: () => void;\n\n\tconstructor(\n\t\tparams: Object, /** @see StageFlow.Chart */\n\t\tstages: Array,\n\t\tpermissionChecker: StagePermissionChecker,\n\t\tgettingStageModelCallback: (id: number) => StageModel,\n\t\tisLoadingCallback: () => boolean,\n\t\tshowLoadingNotificationCallback: () => void,\n\t\tisNewItem: boolean = false,\n\t)\n\t{\n\t\tsuper(params, stages);\n\n\t\tthis.permissionChecker = permissionChecker;\n\t\tthis.getStageModelCallback = gettingStageModelCallback;\n\t\tthis.isNewItem = isNewItem;\n\n\t\tthis.#isLoadingCallback = isLoadingCallback;\n\t\tthis.#showLoadingNotificationCallback = showLoadingNotificationCallback;\n\n\t\tif (!this.isNewItem)\n\t\t{\n\t\t\tthis.#adjustDisableStages();\n\t\t}\n\t}\n\n\tonStageMouseHover(stage: Stage): void\n\t{\n\t\tthis.increaseStageWidthForNameVisibility(stage);\n\t\tif (stage.isDisabled())\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tsuper.onStageMouseHover(stage);\n\t}\n\n\tonStageClick(stage: Stage): void\n\t{\n\t\tif (this.isLoading())\n\t\t{\n\t\t\tthis.showLoadingNotification();\n\n\t\t\treturn;\n\t\t}\n\n\t\tif (!this.#isHasPermissionToMove(stage.getId()))\n\t\t{\n\t\t\tthis.permissionChecker.showMissPermissionError();\n\n\t\t\treturn;\n\t\t}\n\n\t\tsuper.onStageClick(stage);\n\t}\n\n\tonFinalStageClick(stage: Stage): void\n\t{\n\t\tif (this.isLoading())\n\t\t{\n\t\t\tthis.showLoadingNotification();\n\n\t\t\treturn;\n\t\t}\n\n\t\tif (!this.#isHasPermissionToMoveAtLeastOneTerminationStage())\n\t\t{\n\t\t\tthis.permissionChecker.showMissPermissionError();\n\n\t\t\treturn;\n\t\t}\n\n\t\tsuper.onFinalStageClick(stage);\n\t}\n\n\tsetCurrentStageId(stageId: number): Chart\n\t{\n\t\tsuper.setCurrentStageId(stageId);\n\n\t\tthis.adjust();\n\n\t\treturn this;\n\t}\n\n\tgetSemanticPopupSuccessButton(): Button\n\t{\n\t\tconst successButton = super.getSemanticPopupSuccessButton();\n\t\tif (!this.#isHasPermissionToMoveSuccessStage())\n\t\t{\n\t\t\tthis.#prepareDisableSemanticButton(successButton);\n\t\t}\n\n\t\treturn successButton;\n\t}\n\n\tgetSemanticPopupFailureButton(): ?Button\n\t{\n\t\tconst failureButton = super.getSemanticPopupFailureButton();\n\t\tif (failureButton === null)\n\t\t{\n\t\t\treturn null;\n\t\t}\n\n\t\tif (!this.#isHasPermissionToMoveAtLeastOneFailureStages())\n\t\t{\n\t\t\tthis.#prepareDisableSemanticButton(failureButton);\n\t\t}\n\n\t\treturn failureButton;\n\t}\n\n\tgetFinalStagePopupFailStage(stage: Stage): HTMLElement\n\t{\n\t\tconst finalStage = super.getFinalStagePopupFailStage(stage);\n\n\t\tif (!this.#isHasPermissionToMove(stage.getId()))\n\t\t{\n\t\t\tfinalStage.onclick = (event: MouseEvent) => {\n\t\t\t\tevent.preventDefault();\n\t\t\t\tthis.permissionChecker.showMissPermissionError();\n\t\t\t};\n\n\t\t\tDom.addClass(finalStage, '--disabled');\n\t\t}\n\n\t\treturn finalStage;\n\t}\n\n\tsetCheckedStageInFailStagesWrapper(failStageListWrapper: HTMLElement): void\n\t{\n\t\tconst failStages = [...this.extractFinalStagePopupFailStages(failStageListWrapper)];\n\t\tconst failStageInputs = failStages.map((radioButtonNode) => {\n\t\t\treturn radioButtonNode.querySelector('input');\n\t\t});\n\n\t\tconst firstAvailableFailStage = this.getFirstFailStage();\n\t\tif (!firstAvailableFailStage)\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tconst relatedRadioButton = failStageInputs.find((radioButton: HTMLInputElement) => {\n\t\t\tconst stageId = radioButton?.dataset?.stageId;\n\t\t\tif (stageId)\n\t\t\t{\n\t\t\t\treturn firstAvailableFailStage.getId() === Text.toInteger(stageId);\n\t\t\t}\n\n\t\t\treturn false;\n\t\t});\n\n\t\tif (relatedRadioButton)\n\t\t{\n\t\t\trelatedRadioButton.checked = true;\n\t\t}\n\t}\n\n\tgetFirstFailStage(): ?Stage\n\t{\n\t\tconst stages = [...this.stages.values()];\n\n\t\treturn stages.find((stage: Stage) => stage.isFail() && this.#isHasPermissionToMove(stage.getId()));\n\t}\n\n\tgetFirstFailStageName(): ?string\n\t{\n\t\t// get first fail stage name without permissions check\n\t\treturn super.getFirstFailStage()?.getName();\n\t}\n\n\t#prepareDisableSemanticButton(button: Button): void\n\t{\n\t\tbutton\n\t\t\t.setDisabled()\n\t\t\t.setProps({ disabled: null }) // necessary in order to show a notification about miss permissions\n\t\t\t.bindEvent('click', this.permissionChecker.showMissPermissionError)\n\t\t;\n\t}\n\n\t#getCurrentStage(): ?StageModel\n\t{\n\t\treturn this.getStageModelCallback(this.currentStage);\n\t}\n\n\t#getCurrentStatusId(): ?string\n\t{\n\t\treturn this.#getCurrentStage()?.getStatusId();\n\t}\n\n\t#getStage(id: number): ?StageModel\n\t{\n\t\treturn this.getStageModelCallback(id);\n\t}\n\n\t#isHasPermissionToMove(stageFlowId: number): boolean\n\t{\n\t\tconst compareStage = this.#getStage(stageFlowId);\n\t\tif (!compareStage)\n\t\t{\n\t\t\treturn false;\n\t\t}\n\n\t\treturn this.permissionChecker.isHasPermissionToMove(this.#getCurrentStatusId(), compareStage.getStatusId());\n\t}\n\n\t#isHasPermissionToMoveAtLeastOneTerminationStage(): boolean\n\t{\n\t\treturn this.permissionChecker.isHasPermissionToMoveAtLeastOneTerminationStage(this.#getCurrentStatusId());\n\t}\n\n\t#isHasPermissionToMoveSuccessStage(): boolean\n\t{\n\t\treturn this.permissionChecker.isHasPermissionToMoveSuccessStage(this.#getCurrentStatusId());\n\t}\n\n\t#isHasPermissionToMoveAtLeastOneFailureStages(): boolean\n\t{\n\t\treturn this.permissionChecker.isHasPermissionToMoveAtLeastOneFailureStage(this.#getCurrentStatusId());\n\t}\n\n\t#isDisableStageFlow(flowStage: Stage): boolean\n\t{\n\t\tif (this.isLoading())\n\t\t{\n\t\t\treturn true;\n\t\t}\n\n\t\tif (flowStage.isFinal())\n\t\t{\n\t\t\treturn false;\n\t\t}\n\n\t\tif (flowStage === this.getFinalStage())\n\t\t{\n\t\t\treturn !this.#isHasPermissionToMoveAtLeastOneTerminationStage();\n\t\t}\n\n\t\treturn !this.#isHasPermissionToMove(flowStage.getId());\n\t}\n\n\tadjust(): void\n\t{\n\t\tthis.#adjustDisableStages();\n\t\tthis.#adjustSemanticsSelectorPopupButtons();\n\t}\n\n\t#adjustDisableStages(): void\n\t{\n\t\tthis.stages.forEach((stage: Stage) => {\n\t\t\tstage.setDisable(this.#isDisableStageFlow(stage));\n\t\t});\n\t}\n\n\t#adjustSemanticsSelectorPopupButtons(): void\n\t{\n\t\tconst popup = super.getSemanticSelectorPopup();\n\t\tpopup.setButtons([\n\t\t\tthis.getSemanticPopupSuccessButton(),\n\t\t\tthis.getSemanticPopupFailureButton(),\n\t\t]);\n\t}\n\n\tisLoading(): boolean\n\t{\n\t\treturn this.#isLoadingCallback();\n\t}\n\n\tshowLoadingNotification(): void\n\t{\n\t\treturn this.#showLoadingNotificationCallback();\n\t}\n}\n"],"names":["Chart","StageFlow","constructor","params","stages","permissionChecker","gettingStageModelCallback","isLoadingCallback","showLoadingNotificationCallback","isNewItem","super","Object","value","this","writable","getStageModelCallback","babelHelpers","onStageMouseHover","stage","increaseStageWidthForNameVisibility","isDisabled","onStageClick","isLoading","showLoadingNotification","getId","showMissPermissionError","onFinalStageClick","setCurrentStageId","stageId","adjust","getSemanticPopupSuccessButton","successButton","getSemanticPopupFailureButton","failureButton","getFinalStagePopupFailStage","finalStage","onclick","event","preventDefault","Dom","addClass","setCheckedStageInFailStagesWrapper","failStageListWrapper","failStageInputs","extractFinalStagePopupFailStages","map","radioButtonNode","querySelector","firstAvailableFailStage","getFirstFailStage","relatedRadioButton","find","radioButton","dataset","_radioButton$dataset","Text","toInteger","checked","values","isFail","getFirstFailStageName","_super$getFirstFailSt","getName","button","setDisabled","setProps","disabled","bindEvent","currentStage","_babelHelpers$classPr","getStatusId","id","stageFlowId","compareStage","isHasPermissionToMove","isHasPermissionToMoveAtLeastOneTerminationStage","isHasPermissionToMoveSuccessStage","isHasPermissionToMoveAtLeastOneFailureStage","flowStage","isFinal","getFinalStage","forEach","setDisable","getSemanticSelectorPopup","setButtons"],"mappings":"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"}