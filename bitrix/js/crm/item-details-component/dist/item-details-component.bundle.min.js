this.BX=this.BX||{};(function(exports,crm_itemDetailsComponent_pagetitle,crm_itemDetailsComponent_stageFlow,crm_messagesender,crm_stageModel,crm_stage_permissionChecker,main_core,main_core_events,main_loader,ui_dialogs_messagebox,ui_stageflow){"use strict";function ownKeys(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,r)}return i}function _objectSpread(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?ownKeys(Object(i),!0).forEach((function(t){babelHelpers.defineProperty(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):ownKeys(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}var BACKGROUND_COLOR="d3d7dc";var ItemDetailsComponent=function(){function ItemDetailsComponent(e){var t=this;babelHelpers.classCallCheck(this,ItemDetailsComponent);babelHelpers.defineProperty(this,"categoryId",null);babelHelpers.defineProperty(this,"permissionChecker",null);babelHelpers.defineProperty(this,"receiversJSONString","");babelHelpers.defineProperty(this,"targetUpdateStage",null);babelHelpers.defineProperty(this,"stageBeforeUpdate",null);if(main_core.Type.isPlainObject(e)){this.entityTypeId=main_core.Text.toInteger(e.entityTypeId);this.entityTypeName=e.entityTypeName;this.id=main_core.Text.toInteger(e.id);if(BX.Crm.PartialEditorDialog&&e.serviceUrl){this.partialEditorId="partial_editor_"+this.entityTypeId+"_"+this.id;BX.Crm.PartialEditorDialog.registerEntityEditorUrl(this.entityTypeId,e.serviceUrl)}if(e.hasOwnProperty("editorContext")){this.editorContext=e.editorContext}if(e.hasOwnProperty("categoryId")){this.categoryId=main_core.Text.toInteger(e.categoryId);this.categories=e.categories}if(main_core.Type.isElementNode(e.errorTextContainer)){this.errorTextContainer=e.errorTextContainer}if(main_core.Type.isArray(e.stages)){this.stages=[];e.stages.forEach((function(e){t.stages.push(new crm_stageModel.StageModel(e))}));this.permissionChecker=crm_stage_permissionChecker.PermissionChecker.createFromStageModels(this.stages)}this.currentStageId=e.currentStageId;this.messages=e.messages;this.signedParameters=e.signedParameters;this.userFieldCreateUrl=e.userFieldCreateUrl;this.editorGuid=e.editorGuid;this.isStageFlowActive=e.isStageFlowActive;this.pullTag=e.pullTag;this.bizprocStarterConfig=e.bizprocStarterConfig;this.automationCheckAutomationTourGuideData=main_core.Type.isPlainObject(e.automationCheckAutomationTourGuideData)?e.automationCheckAutomationTourGuideData:null;if(main_core.Type.isString(e.receiversJSONString)){this.receiversJSONString=e.receiversJSONString}if(main_core.Type.isStringFilled(e.categorySelectorTarget)){this.categorySelectorTarget=e.categorySelectorTarget}}this.container=document.querySelector('[data-role="crm-item-detail-container"]');this.handleClosePartialEntityEditor=this.handleClosePartialEntityEditor.bind(this);this.handleErrorPartialEntityEditor=this.handleErrorPartialEntityEditor.bind(this)}babelHelpers.createClass(ItemDetailsComponent,[{key:"isNew",value:function e(){return this.id<=0}},{key:"getLoader",value:function e(){if(!this.loader){this.loader=new main_loader.Loader({size:200,offset:{left:"-100px",top:"-200px"}});this.loader.layout.style.zIndex=300}return this.loader}},{key:"startProgress",value:function e(){this.isProgress=true;if(!this.getLoader().isShown()&&this.container){this.getLoader().show(this.container)}this.hideErrors()}},{key:"stopProgress",value:function e(){this.isProgress=false;this.getLoader().hide()}},{key:"startStageUpdateProgress",value:function e(t){this.isProgress=true;this.targetUpdateStage=t;this.stageflowChart.adjust()}},{key:"stopStageUpdateProgress",value:function e(){this.isProgress=false;this.targetUpdateStage=null;this.stageflowChart.adjust()}},{key:"showStageUpdatingNotification",value:function e(){if(this.targetUpdateStage===null||!this.messages.stageLoadingMessage){return}var t=main_core.Text.encode(this.targetUpdateStage.getName());BX.UI.Notification.Center.notify({content:this.messages.stageLoadingMessage.replace("#stage#",t),autoHideDelay:3e3})}},{key:"isStageUpdating",value:function e(){return this.targetUpdateStage!==null&&this.isProgress}},{key:"getStageById",value:function e(t){var i=null;var r=0;while(true){if(!this.stages[r]){break}var a=this.stages[r];if(a.getId()===t){i=a;break}r++}return i}},{key:"getStageByStatusId",value:function e(t){var i=null;var r=0;while(true){if(!this.stages[r]){break}var a=this.stages[r];if(a.getStatusId()===t){i=a;break}r++}return i}},{key:"init",value:function e(){this.initStageFlow();this.bindEvents();this.initReceiversRepository();this.initCategoriesSelector();if(!this.isNew()){this.initPull();this.initTours()}}},{key:"initReceiversRepository",value:function e(){crm_messagesender.ReceiverRepository.onDetailsLoad(this.entityTypeId,this.id,this.receiversJSONString)}},{key:"initCategoriesSelector",value:function e(){if(!main_core.Type.isArrayFilled(this.categories)||!main_core.Type.isStringFilled(this.categorySelectorTarget)){return}var t=crm_itemDetailsComponent_pagetitle.CategoryChanger.renderToTarget(this.categorySelectorTarget,{entityTypeId:this.entityTypeId,entityId:this.id,categoryId:this.categoryId,categories:this.categories,editorGuid:this.editorGuid});if(!t){return}t.subscribe("onProgressStart",this.startProgress.bind(this));t.subscribe("onProgressStop",this.stopProgress.bind(this))}},{key:"initStageFlow",value:function e(){if(!this.stages){return}var t=this.prepareStageFlowStagesData();var i=document.querySelector('[data-role="stageflow-wrap"]');if(!i){return}var r={backgroundColor:BACKGROUND_COLOR,currentStage:this.currentStageId,isActive:this.isStageFlowActive===true,onStageChange:this.onStageChange.bind(this),labels:{finalStageName:main_core.Loc.getMessage("CRM_ITEM_DETAIL_STAGEFLOW_FINAL_STAGE_NAME"),finalStagePopupTitle:main_core.Loc.getMessage("CRM_ITEM_DETAIL_STAGEFLOW_FINAL_STAGE_POPUP"),finalStagePopupFail:main_core.Loc.getMessage("CRM_ITEM_DETAIL_STAGEFLOW_FINAL_STAGE_POPUP_FAIL"),finalStageSelectorTitle:main_core.Loc.getMessage("CRM_ITEM_DETAIL_STAGEFLOW_FINAL_STAGE_SELECTOR")}};this.stageflowChart=new crm_itemDetailsComponent_stageFlow.Chart(r,t,this.permissionChecker,this.getStageById.bind(this),this.isStageUpdating.bind(this),main_core.Runtime.throttle(this.showStageUpdatingNotification.bind(this),300),this.isNew());main_core.Dom.append(this.stageflowChart.render(),i)}},{key:"prepareStageFlowStagesData",value:function e(){var t=this;var i=[];this.stages.forEach((function(e){var r=e.getData();var a=e.getColor().indexOf("#")===0?e.getColor().substr(1):e.getColor();if(t.isNew()){a=BACKGROUND_COLOR}r.isSuccess=e.isSuccess();r.isFail=e.isFailure();r.color=a;i.push(r)}));return i}},{key:"bindEvents",value:function e(){main_core_events.EventEmitter.subscribe("BX.Crm.ItemDetailsComponent:onClickDelete",this.handleItemDelete.bind(this));if(this.bizprocStarterConfig){main_core_events.EventEmitter.subscribe("BX.Crm.ItemDetailsComponent:onClickBizprocTemplates",this.handleBPTemplatesShow.bind(this))}if(this.editorGuid&&this.userFieldCreateUrl&&BX.SidePanel&&BX.Crm.EntityEditor){main_core_events.EventEmitter.subscribe("BX.UI.EntityConfigurationManager:onCreateClick",this.handleUserFieldCreationUrlClick.bind(this))}}},{key:"initPull",value:function e(){var t=this;var i=BX.PULL;if(!i){console.error("pull is not initialized");return}if(!this.pullTag){return}i.subscribe({moduleId:"crm",command:this.pullTag,callback:function e(i){var r,a;if(!(i!==null&&i!==void 0&&(r=i.item)!==null&&r!==void 0&&r.data)){return}var s=i.item.data.columnId;if((a=t.stageflowChart)!==null&&a!==void 0&&a.isActive){var o=t.getStageById(t.stageflowChart.currentStage);if((o===null||o===void 0?void 0:o.statusId)!==s){var n=t.getStageByStatusId(s);if(n){t.updateStage(n)}}}}});i.extendWatch(this.pullTag)}},{key:"getEditor",value:function e(){if(BX.Crm.EntityEditor){if(this.editorGuid){return BX.Crm.EntityEditor.get(this.editorGuid)}return BX.Crm.EntityEditor.getDefault()}return null}},{key:"bindPartialEntityEditorEvents",value:function e(){main_core_events.EventEmitter.subscribe("Crm.PartialEditorDialog.Close",this.handleClosePartialEntityEditor);main_core_events.EventEmitter.subscribe("Crm.PartialEditorDialog.Error",this.handleErrorPartialEntityEditor)}},{key:"unBindPartialEntityEditorEvents",value:function e(){main_core_events.EventEmitter.unsubscribe("Crm.PartialEditorDialog.Close",this.handleClosePartialEntityEditor);main_core_events.EventEmitter.unsubscribe("Crm.PartialEditorDialog.Error",this.handleErrorPartialEntityEditor)}},{key:"onStageChange",value:function e(t){var i=this;if(this.isProgress){return}var r=this.getStageById(t.getId());if(!r){console.error("Wrong stage");return}this.stageBeforeUpdate=this.getStageById(this.currentStageId);this.setStageToFlowChart(r);this.startStageUpdateProgress(r);main_core.ajax.runAction("crm.controller.item.update",{analyticsLabel:"crmItemDetailsMoveItem",data:{entityTypeId:this.entityTypeId,id:this.id,fields:{stageId:r.getStatusId()}}}).then((function(){i.stopStageUpdateProgress();var e=null;if(main_core.Reflection.getClass("BX.SidePanel.Instance.getTopSlider")){e=BX.SidePanel.Instance.getTopSlider()}if(e!==null){if(main_core.Reflection.getClass("BX.Crm.EntityEvent")){var t=null;if(e){t={sliderUrl:e.getUrl()}}BX.Crm.EntityEvent.fireUpdate(i.entityTypeId,i.id,"",t)}}i.stageBeforeUpdate=null;i.updateStage(r)}))["catch"]((function(e){i.stopStageUpdateProgress();if(i.stageBeforeUpdate!==null){i.setStageToFlowChart(i.stageBeforeUpdate);i.stageBeforeUpdate=null}if(!i.partialEditorId){i.showErrorsFromResponse(e);return}var t=[];e.errors.forEach((function(e){var i=e.code,r=e.customData;if(i==="CRM_FIELD_ERROR_REQUIRED"&&r.fieldName){t.push(r.fieldName)}}));if(t.length>0){BX.Crm.PartialEditorDialog.close(i.partialEditorId);i.partialEntityEditor=BX.Crm.PartialEditorDialog.create(i.partialEditorId,{title:BX.prop.getString(i.messages,"partialEditorTitle","Please fill in all required fields"),entityTypeName:i.entityTypeName,entityTypeId:i.entityTypeId,entityId:i.id,fieldNames:t,helpData:null,context:i.editorContext||null,isController:true,stageId:r.getStatusId()});i.bindPartialEntityEditorEvents();i.partialEntityEditor.open()}else{i.showErrorsFromResponse(e)}}))}},{key:"updateStage",value:function e(t){var i=this.getStageById(this.stageflowChart.currentStage);this.setStageToFlowChart(t);main_core_events.EventEmitter.emit("BX.Crm.ItemDetailsComponent:onStageChange",{entityTypeId:this.entityTypeId,id:this.id,stageId:t.getStatusId(),previousStageId:i?i.getStatusId():null})}},{key:"setStageToFlowChart",value:function e(t){this.stageflowChart.setCurrentStageId(t.getId())}},{key:"showError",value:function e(t){if(main_core.Type.isElementNode(this.errorTextContainer)){this.errorTextContainer.innerText=t;this.errorTextContainer.parentElement.style.display="block"}else{console.error(t)}}},{key:"showErrors",value:function e(t){var i="";t.forEach((function(e){i=i+e+" "}));this.showError(i)}},{key:"hideErrors",value:function e(){if(main_core.Type.isElementNode(this.errorTextContainer)){this.errorTextContainer.innerText="";this.errorTextContainer.parentElement.style.display="none"}}},{key:"showErrorsFromResponse",value:function e(t){var i=t.errors;this.stopProgress();var r=[];i.forEach((function(e){var t=e.message;return r.push(t)}));this.showErrors(r)}},{key:"normalizeUrl",value:function e(t){return t.setHost("")}},{key:"handleItemDelete",value:function e(){var t=this;if(this.isProgress){return}ui_dialogs_messagebox.MessageBox.show({title:this.messages.deleteItemTitle,message:this.messages.deleteItemMessage,modal:true,buttons:ui_dialogs_messagebox.MessageBoxButtons.YES_CANCEL,onYes:function e(i){t.startProgress();main_core.ajax.runAction("crm.controller.item.delete",{analyticsLabel:"crmItemDetailsDeleteItem",data:{entityTypeId:t.entityTypeId,id:t.id}}).then((function(e){var i=e.data;t.stopProgress();var r=null;if(main_core.Reflection.getClass("BX.SidePanel.Instance.getTopSlider")){r=BX.SidePanel.Instance.getTopSlider()}if(r!==null){if(main_core.Reflection.getClass("BX.Crm.EntityEvent")){var a=null;if(r){a={sliderUrl:r.getUrl()}}BX.Crm.EntityEvent.fireDelete(t.entityTypeId,t.id,"",a)}r.close()}else{var s=i.redirectUrl;if(main_core.Type.isStringFilled(s)){var o=t.normalizeUrl(new main_core.Uri(s));location.href=o.toString()}}}))["catch"](t.showErrorsFromResponse.bind(t));i.close()}})}},{key:"handleBPTemplatesShow",value:function handleBPTemplatesShow(event){if(this.bizprocStarterConfig.availabilityLock){eval(this.bizprocStarterConfig.availabilityLock);return}var starter=new BX.Bizproc.Starter(this.bizprocStarterConfig);starter.showTemplatesMenu(event.data.button.button)}},{key:"handleClosePartialEntityEditor",value:function e(t){this.unBindPartialEntityEditorEvents();this.stopProgress();var i=t.getData();if(main_core.Type.isArray(i)&&i.length===2){var r=i[1];if(r.isCancelled){return}var a=this.getStageByStatusId(r.stageId);if(!a){return}this.updateStage(a)}}},{key:"handleErrorPartialEntityEditor",value:function e(t){this.unBindPartialEntityEditorEvents();this.stopProgress();var i=t.getData();if(main_core.Type.isArray(i)&&i[1]&&main_core.Type.isArray(i[1].errors)){this.showErrorsFromResponse({errors:i[1].errors})}}},{key:"handleUserFieldCreationUrlClick",value:function e(t){var i=t.getData();if(i.hasOwnProperty("isCanceled")){t.setData(_objectSpread(_objectSpread({},i),{isCanceled:true}));BX.SidePanel.Instance.open(this.userFieldCreateUrl,{allowChangeHistory:false,cacheable:false,events:{onClose:this.onCreateUserFieldSliderClose.bind(this)}})}}},{key:"onCreateUserFieldSliderClose",value:function e(t){var i=t.getSlider();var r=i.getData();var a=r.get("userFieldData");if(a&&main_core.Type.isString(a)){this.reloadPageIfNotChanged()}}},{key:"reloadPageIfNotChanged",value:function e(){var t=this.getEditor();if(t){if(t.isChanged()){ui_dialogs_messagebox.MessageBox.alert(this.messages.onCreateUserFieldAddMessage)}else{window.location.reload()}}}},{key:"initTours",value:function e(){var t=this;if(this.automationCheckAutomationTourGuideData){main_core.Runtime.loadExtension("bizproc.automation.guide").then((function(e){var i=e.CrmCheckAutomationGuide;if(i){var r;i.showCheckAutomation(t.entityTypeName,(r=t.categoryId)!==null&&r!==void 0?r:0,t.automationCheckAutomationTourGuideData["options"])}}))}}}]);return ItemDetailsComponent}();exports.ItemDetailsComponent=ItemDetailsComponent})(this.BX.Crm=this.BX.Crm||{},BX.Crm.ItemDetailsComponent.PageTitle,BX.Crm.ItemDetailsComponent,BX.Crm.MessageSender,BX.Crm.Models,BX.Crm.Stage,BX,BX.Event,BX,BX.UI.Dialogs,BX.UI);
//# sourceMappingURL=item-details-component.bundle.map.js