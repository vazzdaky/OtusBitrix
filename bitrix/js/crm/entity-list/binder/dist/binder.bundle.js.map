{"version":3,"file":"binder.bundle.js","sources":["../src/binder.js","../src/entity-selector.js","../src/manager.js"],"sourcesContent":["import { ajax as Ajax, Text } from 'main.core';\nimport { UI } from 'ui.notification';\n\nexport class Binder\n{\n\t#parentEntityId: number;\n\t#parentEntityTypeId: number;\n\t#childEntityTypeId: number;\n\t#gridId: string;\n\n\tconstructor(parentEntityTypeId: number, parentEntityId: number, childEntityTypeId: number, gridId: string)\n\t{\n\t\t// eslint-disable-next-line no-param-reassign\n\t\tparentEntityTypeId = Text.toInteger(parentEntityTypeId);\n\t\tif (parentEntityTypeId > 0)\n\t\t{\n\t\t\tthis.#parentEntityTypeId = parentEntityTypeId;\n\t\t}\n\n\t\t// eslint-disable-next-line no-param-reassign\n\t\tparentEntityId = Text.toInteger(parentEntityId);\n\t\tif (parentEntityId > 0)\n\t\t{\n\t\t\tthis.#parentEntityId = parentEntityId;\n\t\t}\n\n\t\t// eslint-disable-next-line no-param-reassign\n\t\tchildEntityTypeId = Text.toInteger(childEntityTypeId);\n\t\tif (childEntityTypeId > 0)\n\t\t{\n\t\t\tthis.#childEntityTypeId = childEntityTypeId;\n\t\t}\n\n\t\tthis.#gridId = gridId;\n\t}\n\n\tgetId(): string\n\t{\n\t\treturn `relation-${this.#parentEntityTypeId}-${this.#parentEntityId}-${this.#childEntityTypeId}`;\n\t}\n\n\tgetParentEntityId(): ?number\n\t{\n\t\treturn this.#parentEntityId ?? null;\n\t}\n\n\tgetParenEntityTypeId(): ?number\n\t{\n\t\treturn this.#parentEntityTypeId ?? null;\n\t}\n\n\tgetChildEntityTypeId(): ?number\n\t{\n\t\treturn this.#childEntityTypeId ?? null;\n\t}\n\n\tasync bind(selectedIds): Promise\n\t{\n\t\tconst data = {\n\t\t\tparentEntityTypeId: this.#parentEntityTypeId,\n\t\t\tparentEntityId: this.#parentEntityId,\n\t\t\tchildEntityTypeId: this.#childEntityTypeId,\n\t\t\tselectedIds,\n\t\t};\n\n\t\t// eslint-disable-next-line no-async-promise-executor\n\t\treturn new Promise(async (resolve, reject) => {\n\t\t\tAjax.runAction('crm.controller.item.relation.update', {\n\t\t\t\tdata,\n\t\t\t}).then((response) => {\n\t\t\t\tresolve(response);\n\t\t\t\tthis.refreshLayout();\n\t\t\t}).catch((response) => {\n\t\t\t\tif (response.errors)\n\t\t\t\t{\n\t\t\t\t\tresponse.errors.forEach(({ message }) => {\n\t\t\t\t\t\tthis.showError(message);\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t});\n\t\t});\n\t}\n\n\tshowError(message)\n\t{\n\t\tUI.Notification.Center.notify({\n\t\t\tcontent: message,\n\t\t\tautoHideDelay: 5000,\n\t\t});\n\t}\n\n\trefreshLayout()\n\t{\n\t\tBX.Main.gridManager.getInstanceById(this.#gridId).reload();\n\t}\n}\n","import { ApplyButton, ButtonColor, CancelButton } from 'ui.buttons';\nimport { Dialog } from 'ui.entity-selector';\nimport { UI } from 'ui.notification';\nimport { Binder } from './binder';\nimport { Loc, Type } from 'main.core';\n\nexport class EntitySelector\n{\n\t#dialogProp: ?Dialog = null;\n\t#binder: Binder;\n\t#target: ?HTMLElement;\n\n\tconstructor(binder: Binder, target: ?HTMLElement = null)\n\t{\n\t\tif (binder instanceof Binder)\n\t\t{\n\t\t\tthis.#binder = binder;\n\t\t}\n\n\t\tif (Type.isDomNode(target) || Type.isNil(target))\n\t\t{\n\t\t\tthis.#target = target;\n\t\t}\n\n\t\tif (!this.#binder)\n\t\t{\n\t\t\tconsole.error('Invalid constructor params:', { binder: binder });\n\n\t\t\tthrow new Error('Invalid constructor params');\n\t\t}\n\t}\n\n\tget #dialog(): Dialog\n\t{\n\t\tif (this.#dialogProp)\n\t\t{\n\t\t\treturn this.#dialogProp;\n\t\t}\n\n\t\tconst applyButton = new ApplyButton({\n\t\t\tcolor: ButtonColor.SUCCESS,\n\t\t\tonclick: () => {\n\t\t\t\tvoid this.hide();\n\n\t\t\t\tthis.#linking();\n\t\t\t},\n\t\t});\n\t\tconst cancelButton = new CancelButton({\n\t\t\tonclick: () => {\n\t\t\t\tvoid this.hide();\n\t\t\t},\n\t\t});\n\n\t\tconst childEntityTypeName = BX.CrmEntityType.resolveName(this.#binder.getChildEntityTypeId());\n\n\t\tthis.#dialogProp = new Dialog({\n\t\t\ttargetNode: this.#target,\n\t\t\tenableSearch: true,\n\t\t\tcontext: `crm.binder.entity-selector.for-${childEntityTypeName}`,\n\t\t\tentities: [{\n\t\t\t\tid: childEntityTypeName.startsWith(BX.CrmEntityType.dynamicTypeNamePrefix) ? 'DYNAMIC' : childEntityTypeName,\n\t\t\t\tdynamicLoad: true,\n\t\t\t\tdynamicSearch: true,\n\t\t\t\toptions: {\n\t\t\t\t\tentityTypeId: this.#binder.getChildEntityTypeId(),\n\t\t\t\t\tsourceTypeId: this.#binder.getParenEntityTypeId(),\n\t\t\t\t\tnotLinkedOnly: true,\n\t\t\t\t\twithoutRecentItems: true,\n\t\t\t\t\twithoutGlobalRecentItems: true,\n\t\t\t\t},\n\t\t\t}],\n\t\t\tfooter: [applyButton.render(), cancelButton.render()],\n\t\t\tfooterOptions: {\n\t\t\t\tcontainerStyles: {\n\t\t\t\t\tdisplay: 'flex',\n\t\t\t\t\t'justify-content': 'center',\n\t\t\t\t},\n\t\t\t},\n\t\t\ttagSelectorOptions: {\n\t\t\t\ttextBoxWidth: 565, // same as default dialog width\n\t\t\t},\n\t\t});\n\n\t\t// this.#dialogProp.subscribe('Item:onSelect', this.#handleItemSelect.bind(this));\n\n\t\treturn this.#dialogProp;\n\t}\n\n\t#linking(): void\n\t{\n\t\tconst data = [];\n\n\t\tif (this.#dialog.getSelectedItems().length === 0)\n\t\t{\n\t\t\tUI.Notification.Center.notify({\n\t\t\t\tcontent: Loc.getMessage('ENTITY_BINDER_ITEMS_NOT_SELECTED'),\n\t\t\t\tautoHideDelay: 5000,\n\t\t\t});\n\n\t\t\treturn;\n\t\t}\n\n\t\tthis.#dialog.getSelectedItems().forEach((item) => {\n\t\t\tdata.push(item.getId());\n\t\t});\n\n\t\tthis.#binder.bind(data);\n\t}\n\n\tshow(): Promise\n\t{\n\t\treturn new Promise((resolve) => {\n\t\t\tthis.#dialog.subscribeOnce('onShow', resolve);\n\n\t\t\tthis.#dialog.show();\n\t\t});\n\t}\n\n\thide(): Promise\n\t{\n\t\treturn new Promise((resolve) => {\n\t\t\tthis.#dialog.subscribeOnce('onHide', resolve);\n\n\t\t\tthis.#dialog.hide();\n\t\t});\n\t}\n\n\tdestroy(): Promise\n\t{\n\t\treturn new Promise((resolve) => {\n\t\t\tthis.#dialog.destroy();\n\n\t\t\tresolve();\n\t\t});\n\t}\n}","import { Binder } from './binder';\nimport { EntitySelector } from './entity-selector';\n\nlet instance = null;\n\nexport class Manager\n{\n\t#binders: Object<string, Binder> = {};\n\n\tstatic get Instance(): Manager\n\t{\n\t\tif (instance === null)\n\t\t{\n\t\t\tinstance = new Manager();\n\t\t}\n\n\t\treturn instance;\n\t}\n\n\tinitializeBinder(\n\t\tparentEntityTypeId: number,\n\t\tparentEntityId: number,\n\t\tchildEntityTypeId: number,\n\t\tgridId: string,\n\t): Binder\n\t{\n\t\tconst binder = new Binder(parentEntityTypeId, parentEntityId, childEntityTypeId, gridId);\n\n\t\tthis.#binders[binder.getId()] = binder;\n\n\t\treturn binder;\n\t}\n\n\tgetBinder(binderId: string): ?Binder\n\t{\n\t\treturn this.#binders[binderId];\n\t}\n\n\tcreateRelatedSelector(binderId: string, target: ?string = null): ?EntitySelector\n\t{\n\t\tconst binder = this.getBinder(binderId);\n\t\tif (!binder)\n\t\t{\n\t\t\tconsole.error('Binder with given id not found', binderId, this);\n\n\t\t\treturn null;\n\t\t}\n\n\t\tif (!binder.getParenEntityTypeId() || !binder.getParentEntityId() || !binder.getChildEntityTypeId())\n\t\t{\n\t\t\tconsole.error('Not well configured binder', binderId, binder);\n\n\t\t\treturn null;\n\t\t}\n\n\t\treturn new EntitySelector(binder, document.getElementById(target));\n\t}\n}\n"],"names":["Binder","constructor","parentEntityTypeId","parentEntityId","childEntityTypeId","gridId","Text","toInteger","getId","getParentEntityId","getParenEntityTypeId","getChildEntityTypeId","bind","selectedIds","data","Promise","resolve","reject","Ajax","runAction","then","response","refreshLayout","catch","errors","forEach","message","showError","UI","Notification","Center","notify","content","autoHideDelay","BX","Main","gridManager","getInstanceById","reload","EntitySelector","binder","target","Type","isDomNode","isNil","console","error","Error","show","subscribeOnce","hide","destroy","applyButton","ApplyButton","color","ButtonColor","SUCCESS","onclick","cancelButton","CancelButton","childEntityTypeName","CrmEntityType","resolveName","Dialog","targetNode","enableSearch","context","entities","id","startsWith","dynamicTypeNamePrefix","dynamicLoad","dynamicSearch","options","entityTypeId","sourceTypeId","notLinkedOnly","withoutRecentItems","withoutGlobalRecentItems","footer","render","footerOptions","containerStyles","display","tagSelectorOptions","textBoxWidth","getSelectedItems","length","Loc","getMessage","item","push","instance","Manager","Instance","initializeBinder","getBinder","binderId","createRelatedSelector","document","getElementById"],"mappings":"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"}