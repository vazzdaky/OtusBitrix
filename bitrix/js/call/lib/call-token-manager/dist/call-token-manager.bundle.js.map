{"version":3,"file":"call-token-manager.bundle.js","sources":["../src/call-token-manager.js"],"sourcesContent":["import { Type, Loc } from 'main.core';\n\nclass TokenManager\n{\n\t#tokenList;\n\t#pendingTokenList;\n\t#queryParams;\n\t#userToken;\n\n\tconstructor()\n\t{\n\t\tthis.#tokenList = {};\n\t\tthis.#pendingTokenList = {};\n\t\tthis.#queryParams = {};\n\t\tthis.#userToken = Loc.getMessage('user_jwt');\n\t}\n\n\tsetQueryParams(queryParams)\n\t{\n\t\tif (!Type.isPlainObject(queryParams) )\n\t\t{\n\t\t\treturn;\n\t\t}\n\t\tthis.#queryParams = queryParams;\n\t}\n\n\tgetTokenCached(chatId): ?string\n\t{\n\t\treturn this.#tokenList[chatId];\n\t}\n\n\tasync getToken(chatId): Promise<?string>\n\t{\n\t\tconst token = this.#tokenList[chatId];\n\t\tconst pendingToken = this.#pendingTokenList[chatId];\n\n\t\tif (token)\n\t\t{\n\t\t\treturn token;\n\t\t}\n\t\telse if (pendingToken)\n\t\t{\n\t\t\treturn pendingToken;\n\t\t}\n\n\t\tthis.#pendingTokenList[chatId] = new Promise((resolve) =>\n\t\t{\n\t\t\tthis.#loadToken(chatId).then(() =>\n\t\t\t{\n\t\t\t\tdelete this.#pendingTokenList[chatId];\n\t\t\t\tresolve(this.#tokenList[chatId]);\n\t\t\t});\n\t\t});\n\n\t\treturn this.#pendingTokenList[chatId];\n\t}\n\n\tsetToken(chatId, token): void\n\t{\n\t\tthis.#tokenList[chatId] = token;\n\t}\n\n\tasync getUserToken(chatId): Promise<?string>\n\t{\n\t\tconst pendingToken = this.#pendingTokenList[chatId];\n\n\t\tif (this.#userToken)\n\t\t{\n\t\t\treturn this.#userToken;\n\t\t}\n\t\telse if (pendingToken)\n\t\t{\n\t\t\treturn pendingToken;\n\t\t}\n\n\t\tthis.#pendingTokenList[chatId] = new Promise((resolve) =>\n\t\t{\n\t\t\tthis.#loadToken(chatId).then(() =>\n\t\t\t{\n\t\t\t\tdelete this.#pendingTokenList[chatId];\n\t\t\t\tresolve(this.#userToken);\n\t\t\t});\n\t\t});\n\n\t\treturn this.#pendingTokenList[chatId];\n\t}\n\n\tsetUserToken(token): void\n\t{\n\t\tthis.#userToken = token;\n\t}\n\n\tclearTokenList(): void\n\t{\n\t\tthis.#tokenList = {};\n\t\tthis.#pendingTokenList = {};\n\t\tthis.#userToken = null;\n\t}\n\n\tasync #loadToken(chatId): void\n\t{\n\t\ttry\n\t\t{\n\t\t\tconst params = {\n\t\t\t\tchatId,\n\t\t\t\t...this.#queryParams,\n\t\t\t};\n\t\t\tconst response = await BX.rest.callMethod('call.Call.getCallToken', params);\n\t\t\tconst callToken = response.data()?.callToken;\n\t\t\tconst userToken = response.data()?.userToken;\n\n\t\t\tif (callToken)\n\t\t\t{\n\t\t\t\tthis.setToken(chatId, callToken);\n\t\t\t}\n\n\t\t\tif (userToken)\n\t\t\t{\n\t\t\t\tthis.setUserToken(userToken);\n\t\t\t}\n\t\t}\n\t\tcatch (error)\n\t\t{\n\t\t\tconsole.error('Error during call token retrieving', error);\n\t\t}\n\t}\n}\n\nexport const CallTokenManager = new TokenManager();"],"names":["TokenManager","constructor","Loc","getMessage","setQueryParams","queryParams","Type","isPlainObject","getTokenCached","chatId","getToken","token","pendingToken","Promise","resolve","then","setToken","getUserToken","setUserToken","clearTokenList","params","response","BX","rest","callMethod","callToken","data","userToken","error","console","CallTokenManager"],"mappings":"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"}