{"version":3,"file":"editable-columns.bundle.js","sources":["../src/editable-column-manager.js"],"sourcesContent":["import { ajax as Ajax, Dom, Type, Event, Tag, Text } from 'main.core';\nimport './css/editable-columns.css';\n\ntype Field = {\n\tname: string,\n\tsaveEndpoint: string,\n\tonValueCheck: (newValue: string) => boolean,\n\tonSave: (rowId: any, newValue: string) => boolean,\n}\n\nexport class EditableColumnManager\n{\n\tstatic instances = new Map();\n\n\tconstructor(gridId, field: Field)\n\t{\n\t\tthis.gridId = gridId;\n\t\tthis.grid = BX.Main.gridManager.getById(gridId)?.instance;\n\n\t\tthis.columnId = field.name;\n\t\tthis.saveEndpoint = field.saveEndpoint;\n\t\tthis.onSave = field.onSave;\n\t\tthis.onValueCheck = field.onValueCheck;\n\n\t\tif (!EditableColumnManager.instances.has(field.name))\n\t\t{\n\t\t\tEditableColumnManager.instances.set(field.name, this);\n\t\t}\n\t}\n\n\tstatic init(gridId: string, fields: Field[]): void\n\t{\n\t\tfields.forEach((field) => {\n\t\t\tnew EditableColumnManager(gridId, field);\n\t\t});\n\t}\n\n\tstatic editCell(columnId: string, rowId: string)\n\t{\n\t\tconst instance = EditableColumnManager.instances.get(columnId);\n\t\tif (!instance)\n\t\t{\n\t\t\treturn;\n\t\t}\n\t\tinstance.#editCell(rowId);\n\t}\n\n\t#editCell(rowId: string)\n\t{\n\t\tconst row = this.grid.getRows().getById(rowId);\n\t\tif (!row)\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tDom.removeClass(row.getNode(), 'editable-column-edited');\n\t\tconst cell = row.getCellById(this.columnId);\n\t\tlet currentValue = row.getEditData()[this.columnId];\n\t\tif (!currentValue)\n\t\t{\n\t\t\tcurrentValue = '';\n\t\t}\n\t\tconst wrapper = cell.querySelector('.editable-column-wrapper');\n\t\tif (!wrapper)\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tconst editor = this.#buildEditor(rowId, currentValue);\n\n\t\tconst preview = wrapper.querySelector('.editable-column-preview');\n\t\tif (preview)\n\t\t{\n\t\t\tDom.style(preview, {\n\t\t\t\tdisplay: 'none',\n\t\t\t});\n\t\t}\n\t\tDom.append(editor, wrapper);\n\n\t\tconst actionsClickHandler = () => {\n\t\t\tEvent.unbind(row.getActionsButton(), 'click', actionsClickHandler);\n\n\t\t\tthis.#cancelEdit(rowId);\n\t\t};\n\n\t\tEvent.bind(row.getActionsButton(), 'click', actionsClickHandler);\n\t}\n\n\t#buildEditor(rowId, value): HTMLElement\n\t{\n\t\tconst input = Tag.render`<input class=\"main-grid-editor main-grid-editor-text\" type=\"text\">`;\n\t\tinput.value = value;\n\n\t\tconst applyButton = Tag.render`\n\t\t\t<a>\n\t\t\t\t<i class=\"ui-icon-set --check\"></i>\n\t\t\t</a>\n\t\t`;\n\n\t\tconst cancelButton = Tag.render`\n\t\t\t<a>\n\t\t\t\t<i class=\"ui-icon-set --cross-60\"></i>\n\t\t\t</a>\n\t\t`;\n\n\t\tconst onSave = (newValue) => {\n\t\t\tDom.removeClass(input, 'editable-column-input-danger');\n\n\t\t\tif (!this.onValueCheck(newValue))\n\t\t\t{\n\t\t\t\tDom.addClass(input, 'editable-column-input-danger');\n\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tthis.#saveValue(rowId, newValue);\n\t\t};\n\n\t\tconst onCancel = () => {\n\t\t\tthis.#cancelEdit(rowId);\n\t\t};\n\n\t\tEvent.bind(applyButton, 'click', (event) => {\n\t\t\tevent.preventDefault();\n\t\t\tonSave(input.value);\n\t\t});\n\t\tEvent.bind(cancelButton, 'click', (event) => {\n\t\t\tevent.preventDefault();\n\t\t\tonCancel();\n\t\t});\n\n\t\tEvent.bind(input, 'keydown', (event) => {\n\t\t\tif (event.keyCode === 13)\n\t\t\t{\n\t\t\t\tonSave(input.value);\n\t\t\t\tevent.preventDefault();\n\t\t\t}\n\t\t\telse if (event.keyCode === 27)\n\t\t\t{\n\t\t\t\tonCancel();\n\t\t\t\tevent.preventDefault();\n\t\t\t}\n\t\t});\n\n\t\treturn Tag.render`\n\t\t\t<div class=\"editable-column-wrapper__item editable-column-edit\">\n\t\t\t\t${input}\n\t\t\t\t<div class=\"editable-column-wrapper__buttons-wrapper\">\n\t\t\t\t\t<div class=\"editable-column-wrapper__buttons\">\n\t\t\t\t\t\t${applyButton}\n\t\t\t\t\t\t${cancelButton}\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t`;\n\t}\n\n\t#cancelEdit(rowId: Object)\n\t{\n\t\tconst row = this.grid.getRows().getById(rowId);\n\t\tconst cell = row.getCellById(this.columnId);\n\t\tconst wrapper = cell.querySelector('.editable-column-wrapper');\n\t\tconst editor = wrapper.querySelector('.editable-column-edit');\n\t\tconst preview = wrapper.querySelector('.editable-column-preview');\n\n\t\tif (editor)\n\t\t{\n\t\t\teditor.remove();\n\t\t}\n\n\t\tif (preview)\n\t\t{\n\t\t\tDom.style(preview, {\n\t\t\t\tdisplay: 'flex',\n\t\t\t});\n\t\t}\n\t}\n\n\t#saveValue(rowId: string, newValue)\n\t{\n\t\tAjax.runAction(this.saveEndpoint, {\n\t\t\tdata: {\n\t\t\t\tid: rowId,\n\t\t\t\tcolumnId: this.columnId,\n\t\t\t\tvalue: newValue,\n\t\t\t},\n\t\t}).then(() => {\n\t\t\tthis.onSave(rowId, newValue);\n\n\t\t\tconst row = this.grid.getRows().getById(rowId);\n\t\t\tconst cell = row.getCellById(this.columnId);\n\t\t\tconst wrapper = cell.querySelector('.editable-column-wrapper');\n\t\t\tconst content = wrapper.querySelector('.editable-column-content');\n\n\t\t\tDom.addClass(row.getNode(), 'editable-column-edited');\n\n\t\t\tconst rowEditData = row.getEditData();\n\t\t\trowEditData[this.columnId] = newValue;\n\t\t\tconst editableData = this.grid.getParam('EDITABLE_DATA');\n\t\t\tif (Type.isPlainObject(editableData))\n\t\t\t{\n\t\t\t\teditableData[row.getId()] = rowEditData;\n\t\t\t}\n\n\t\t\tif (content)\n\t\t\t{\n\t\t\t\tcontent.innerText = newValue;\n\t\t\t\tDom.style(content, {\n\t\t\t\t\tdisplay: 'flex',\n\t\t\t\t});\n\t\t\t}\n\t\t\tthis.#cancelEdit(rowId);\n\t\t}).catch((response) => {\n\t\t\tif (response.errors)\n\t\t\t{\n\t\t\t\tthis.#notifyErrors(response.errors);\n\t\t\t}\n\t\t});\n\t}\n\n\t#notifyErrors(errors: Array): void\n\t{\n\t\tif (errors[0] && errors[0].message)\n\t\t{\n\t\t\tBX.UI.Notification.Center.notify({\n\t\t\t\tcontent: Text.encode(errors[0].message),\n\t\t\t});\n\t\t}\n\t}\n}\n"],"names":["EditableColumnManager","constructor","gridId","field","grid","BX","Main","gridManager","getById","instance","columnId","name","saveEndpoint","onSave","onValueCheck","instances","has","set","init","fields","forEach","editCell","rowId","get","row","getRows","Dom","removeClass","getNode","cell","getCellById","currentValue","getEditData","wrapper","querySelector","editor","preview","style","display","append","actionsClickHandler","Event","unbind","getActionsButton","bind","value","input","Tag","render","applyButton","cancelButton","newValue","addClass","onCancel","event","preventDefault","keyCode","remove","Ajax","runAction","data","id","then","content","rowEditData","editableData","getParam","Type","isPlainObject","getId","innerText","catch","response","errors","message","UI","Notification","Center","notify","Text","encode","Map"],"mappings":"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"}